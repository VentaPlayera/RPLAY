<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPLAY - Tienda Online (Preventa)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body { background-color: #f8f9fa; }
        .product-card {
            border: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            position: relative;
        }
        .product-card:hover { transform: translateY(-5px); }
        .stock-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
            z-index: 10;
        }
        .stock-badge.in-stock { background-color: #28a745; /* Verde para Preventa */ }
        .stock-badge.out-stock { background-color: #dc3545; /* Rojo para Agotado */ }
        .btn-buy { background-color: #dc3545; color: white; } /* Rojo/Danger */
        .btn-buy:hover { background-color: #c82333; color: white; }
        .price { font-size: 1.25rem; font-weight: bold; color: #dc3545; }
        .img-thumbnail { cursor: pointer; }
        .img-thumbnail.active { border: 3px solid #dc3545; }
        #quantityInput { width: 80px; text-align: center; }
        /* Clases para los pasos del modal */
        #payment-step, #transfer-info { display: none; }
    </style>
</head>
<body>

    <div class="container my-5">
        <h1 class="text-center mb-4 text-danger">RPLAY - Preventa Exclusiva</h1>
        <p class="text-center text-muted">Selecciona tu modelo y aparta el tuyo con un pago inicial.</p>
        
        <div class="row g-4" id="product-list-container">
            </div>

        <hr class="my-5">

        <div class="card bg-light mt-5 d-none">
            <div class="card-header">Panel de Administración/Debug</div>
            <div class="card-body">
                <p>Órdenes Pendientes (Persistentes):</p>
                <div id="ordersList"></div>
                <p id="noOrdersMessage" class="text-success fw-bold">No hay órdenes pendientes.</p>
                <button class="btn btn-sm btn-danger mt-3" onclick="resetAllStock()">Reiniciar Todo el Inventario</button>
            </div>
        </div>

    </div>

    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalLabel">Detalle de Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 border-end">
                            <div id="productCarousel" class="carousel slide" data-bs-interval="false">
                                <div class="carousel-inner">
                                    <div class="carousel-item active">
                                        <img id="modal-img-front" src="" class="d-block w-100" alt="Vista Frontal">
                                    </div>
                                    <div class="carousel-item">
                                        <img id="modal-img-back" src="" class="d-block w-100" alt="Vista Trasera">
                                    </div>
                                    <div class="carousel-item">
                                        <img id="modal-img-side" src="" class="d-block w-100" alt="Vista Lateral">
                                    </div>
                                </div>
                                <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Previous</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Next</span>
                                </button>
                            </div>

                            <h3 id="product-name" class="mt-3 text-danger">Nombre Producto</h3>
                            <p id="product-description" class="text-muted"></p>
                            
                            <h4 class="mt-3">Vistas</h4>
                            <div class="d-flex mb-3">
                                <img id="thumb-front" src="" class="img-thumbnail me-2 active" data-slide-to="0" alt="Frente">
                                <img id="thumb-back" src="" class="img-thumbnail me-2" data-slide-to="1" alt="Espalda">
                                <img id="thumb-side" src="" class="img-thumbnail" data-slide-to="2" alt="Lateral">
                            </div>
                        </div>

                        <div class="col-md-6">
                            
                            <div id="selection-step">
                                <h4>Selecciona Talla</h4>
                                <div id="size-options" class="mb-3">
                                    </div>

                                <h4>Cantidad</h4>
                                <div class="input-group mb-3">
                                    <span class="input-group-text">Qty</span>
                                    <input type="number" id="quantityInput" class="form-control" value="1" min="1" max="10">
                                </div>
                                <p id="quantity-status" class="small text-secondary">Selecciona una talla.</p>

                                <h4>Opciones de Pago</h4>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" value="" id="halfPaymentCheck">
                                    <label class="form-check-label" for="halfPaymentCheck">
                                        Apartar con el 50%
                                    </label>
                                </div>

                                <div class="d-flex justify-content-between my-3 border-top pt-3">
                                    <strong>Total de Artículos:</strong>
                                    <strong id="total-price">$0.00 MXN</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-4 pb-2 border-bottom">
                                    <h5 class="text-danger">Monto a Pagar Ahora:</h5>
                                    <h5 id="payment-due" class="text-danger">$0.00 MXN</h5>
                                </div>
                            </div>

                            <div id="payment-step">
                                <h4>Confirma tus Datos</h4>
                                <div class="mb-3">
                                    <label for="clientName" class="form-label">Nombre Completo</label>
                                    <input type="text" class="form-control" id="clientName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="clientPhone" class="form-label">Teléfono WhatsApp</label>
                                    <input type="tel" class="form-control" id="clientPhone" required>
                                </div>
                                <div class="mb-3">
                                    <label for="clientAddress" class="form-label">Dirección de Envío Completa</label>
                                    <textarea class="form-control" id="clientAddress" rows="3" required></textarea>
                                </div>
                                <div class="alert alert-danger p-2" role="alert" id="payment-error" style="display:none;">
                                    Por favor, llena todos los campos de datos.
                                </div>

                                <h5 class="mt-4">Resumen del Pedido:</h5>
                                <ul class="list-group">
                                    <li class="list-group-item">Cantidad: <strong id="final-quantity-display"></strong>, Talla: <strong id="final-size-display"></strong></li>
                                    <li class="list-group-item list-group-item-danger">Monto a Pagar Ahora: <strong id="final-price-display"></strong></li>
                                </ul>
                            </div>

                            <div id="transfer-info" class="text-center">
                                <h4 class="text-success">¡Listo para Apartar!</h4>
                                <p>Revisa la información de pago y envía el comprobante.</p>
                                <p class="alert alert-danger fw-bold">El monto a transferir/depositar es: <span id="final-amount-conf"></span></p>
                                <p>Tienes **24 horas** para realizar el pago. **Al presionar WhatsApp, se aparta tu playera y se descuenta del stock.**</p>
                                
                                <h5 class="mt-4">Datos de Pago:</h5>
                                <p class="mb-1">**Banco:** BBVA</p>
                                <p class="mb-1">**Cuenta:** XXXXXXXXXX</p>
                                <p class="mb-1">**CLABE:** 012XXXXXXXXXXXXXXX</p>
                                <p class="mb-4">**Beneficiario:** Nombre Apellido</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="modal-close-button">Cerrar</button>
                    <a href="#" id="whatsapp-confirm-button" class="btn btn-success d-none" target="_blank">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp" style="width: 20px; margin-right: 5px;">
                        Apartar y Enviar Comprobante por WhatsApp
                    </a>
                    <button type="button" class="btn btn-danger" id="modal-main-button">Pagar Ahora</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        // --- CONSTANTES GLOBALES ---
        const MAX_PRODUCTS = 41; // Número máximo de productos a inicializar
        const FIXED_PRICE = 399.00; // Precio fijo del producto
        const DEFAULT_STOCK_PER_SIZE = 1; // Stock por defecto si no hay override
        const PRODUCT_LIST_CONTAINER = document.getElementById('product-list-container');
        const WHATSAPP_NUMBER = '529991480151'; // NÚMERO DE TELÉFONO SOLICITADO

        // --- ESTADO GLOBAL ---
        const productData = []; // Lista de objetos de producto
        const productInventory = {}; // { id: { M: stock, L: stock, XL: stock } }
        let currentOrderData = null; // Almacena la orden temporalmente antes del click de WhatsApp

        // --- 1. GENERACIÓN DEL CATÁLOGO INICIAL (DATOS COMPLETOS RESTAURADOS) ---
        function generateInitialInventory() {
            for (let i = 1; i <= MAX_PRODUCTS; i++) {
                let mainImg, frontImg, backImg, sideImg;
                let modelSizes = ['M', 'L', 'XL'];
                const id = i.toString(); // Usamos la I como ID
                const initialStockOverrides = {};

                // --- INICIO DE DEFINICIÓN DE PRODUCTOS ---
                
                // Modelos 1 y 2 (archivos subidos)
                if (i === 1) { 
                    mainImg = 'MOCKUP BP D1NEGRA.jpg';
                    frontImg = 'MOCKUP BP D1NEGRA.jpg';
                    backImg = 'MOCKUP BP D2NEGRA.jpg';
                    sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                    modelSizes = ['M', 'L', 'XL'];
                    initialStockOverrides.M = 1; initialStockOverrides.L = 1; initialStockOverrides.XL = 1;
                } else if (i === 2) {
                    mainImg = 'MOCKUP BP D2NEGRA.jpg';
                    frontImg = 'MOCKUP BP D2NEGRA.jpg';
                    backImg = 'MOCKUP BP D1NEGRA.jpg';
                    sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                    modelSizes = ['M', 'L', 'XL'];
                    initialStockOverrides.M = 1; initialStockOverrides.L = 1; initialStockOverrides.XL = 1;
                } 
                // Modelos 3 al 19 (Rellenos genéricos para conservar la estructura de 41)
                else if (i >= 3 && i <= 19) { 
                    mainImg = `https://ventaplayera.github.io/RPLAY/placeholder${i}.png`; // Genérico
                    frontImg = `https://ventaplayera.github.io/RPLAY/placeholder${i}_f.png`;
                    backImg = `https://ventaplayera.github.io/RPLAY/placeholder${i}_b.png`;
                    sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                    modelSizes = ['M', 'L', 'XL'];
                    initialStockOverrides.M = 1; initialStockOverrides.L = 1; initialStockOverrides.XL = 1;
                }
                // Modelos 20 al 41 (URLs detalladas)
                else if (i === 20) { 
                    mainImg = 'https://ventaplayera.github.io/RPLAY/Alli3.png'; 
                    frontImg = 'https://ventaplayera.github.io/RPLAY/Alli3.png';
                    backImg = 'https://ventaplayera.github.io/RPLAY/Alli4.png';
                    sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                    modelSizes = ['M', 'L', 'XL'];
                    initialStockOverrides.M = 1; initialStockOverrides.L = 1; initialStockOverrides.XL = 1;
                } else if (i === 21) { 
                    mainImg = 'https://ventaplayera.github.io/RPLAY/Ale1.png'; 
                    frontImg = 'https://ventaplayera.github.io/RPLAY/Ale1.png';
                    backImg = 'https://ventaplayera.github.io/RPLAY/Ale2.png';
                    sideImg = 'https://ventaplayera.github.io/RPLAY/arena.png'; 
                    modelSizes = ['M', 'L', 'XL'];
                    initialStockOverrides.M = 1; initialStockOverrides.L = 1; initialStockOverrides.XL = 1;
                } else if (i === 22) { 
                    mainImg = 'https://ventaplayera.github.io/RPLAY/Ale3.png'; 
                    frontImg = 'https://ventaplayera.github.io/RPLAY/Ale3.png';
                    backImg = 'https://ventaplayera.github.io/RPLAY/Ale4.png';
                    sideImg = 'https://ventaplayera.github.io/RPLAY/arena.png'; 
                    modelSizes = ['M', 'L', 'XL'];
                    initialStockOverrides.M = 1; initialStockOverrides.L = 1; initialStockOverrides.XL = 1;
                } else if (i === 23) { 
                    mainImg = 'https://ventaplayera.github.io/RPLAY/Miri1.png'; 
                    frontImg = 'https://ventaplayera.github.io/RPLAY/Miri1.png';
                    backImg = 'https://ventaplayera.github.io/RPLAY/Miri2.png';
                    sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                    modelSizes = ['M', 'L', 'XL'];
                    initialStockOverrides.M = 1; initialStockOverrides.L = 1; initialStockOverrides.XL = 1;
                } else if (i === 24) { 
                    mainImg = 'https://ventaplayera.github.io/RPLAY/Miri3.png'; 
                    frontImg = 'https://ventaplayera.github.io/RPLAY/Miri3.png';
                    backImg = 'https://ventaplayera.github.io/RPLAY/Miri4.png';
                    sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                    modelSizes = ['M', 'L', 'XL'];
                    initialStockOverrides.M = 1; initialStockOverrides.L = 1; initialStockOverrides.XL = 1;
                } else if (i === 25) { 
                    mainImg = 'https://ventaplayera.github.io/RPLAY/Didi1.png'; 
                    frontImg = 'https://ventaplayera.github.io/RPLAY/Didi1.png';
                    backImg = 'https://ventaplayera.github.io/RPLAY/Didi2.png';
                    sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                    modelSizes = ['M', 'L', 'XL'];
                    initialStockOverrides.M = 1; initialStockOverrides.L = 1; initialStockOverrides.XL = 1;
                } else if (i === 26) { 
                    mainImg = 'https://ventaplayera.github.io/RPLAY/Didi3.png'; 
                    frontImg = 'https://ventaplayera.github.io/RPLAY/Didi3.png';
                    backImg = 'https://ventaplayera.github.io/RPLAY/Didi4.png';
                    sideImg = 'https://ventaplayera.github.io/RPLAY/arena.png'; 
                    modelSizes = ['M', 'L', 'XL'];
                    initialStockOverrides.M = 1; initialStockOverrides.L = 1; initialStockOverrides.XL = 1;
                } else if (i === 27) { 
                    mainImg = 'https://ventaplayera.github.io/RPLAY/Vale1.png'; 
                    frontImg = 'https://ventaplayera.github.io/RPLAY/Vale1.png';
                    backImg = 'https://ventaplayera.github.io/RPLAY/Vale2.png';
                    sideImg = 'https://ventaplayera.github.io/RPLAY/arena.png'; 
                    modelSizes = ['M', 'L', 'XL'];
                    initialStockOverrides.M = 1; initialStockOverrides.L = 1; initialStockOverrides.XL = 1;
                } else if (i === 28) { 
                    mainImg = 'https://ventaplayera.github.io/RPLAY/Vale3.png'; 
                    frontImg = 'https://ventaplayera.github.io/RPLAY/Vale3.png';
                    backImg = 'https://ventaplayera.github.io/RPLAY/Vale4.png';
                    sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                    modelSizes = ['M', 'L', 'XL'];
                    initialStockOverrides.M = 1; initialStockOverrides.L = 1; initialStockOverrides.XL = 1;
                } else if (i === 29) { 
                    mainImg = 'https://ventaplayera.github.io/RPLAY/Caro1.png'; 
                    frontImg = 'https://ventaplayera.github.io/RPLAY/Caro1.png';
                    backImg = 'https://ventaplayera.github.io/RPLAY/Caro2.png';
                    sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                    modelSizes = ['M', 'L', 'XL'];
                    initialStockOverrides.M = 1; initialStockOverrides.L = 1; initialStockOverrides.XL = 1;
                } else if (i === 30) { 
                    mainImg = 'https://ventaplayera.github.io/RPLAY/Caro3.png'; 
                    frontImg = 'https://ventaplayera.github.io/RPLAY/Caro3.png';
                    backImg = 'https://ventaplayera.github.io/RPLAY/Caro4.png';
                    sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                    modelSizes = ['M', 'L', 'XL'];
                    initialStockOverrides.M = 1; initialStockOverrides.L = 1; initialStockOverrides.XL = 1;
                } else if (i === 31) { 
                    mainImg = 'https://ventaplayera.github.io/RPLAY/Gon1.png'; 
                    frontImg = 'https://ventaplayera.github.io/RPLAY/Gon1.png';
                    backImg = 'https://ventaplayera.github.io/RPLAY/Gon2.png';
                    sideImg = 'https://ventaplayera.github.io/RPLAY/blanco.png'; 
                    modelSizes = ['M', 'L', 'XL'];
                    initialStockOverrides.M = 1; initialStockOverrides.L = 1; initialStockOverrides.XL = 1;
                } else if (i === 32) { 
                    mainImg = 'https://ventaplayera.github.io/RPLAY/Katy3.png'; 
                    frontImg = 'https://ventaplayera.github.io/RPLAY/Katy3.png';
                    backImg = 'https://ventaplayera.github.io/RPLAY/Katy4.png';
                    sideImg = 'https://ventaplayera.github.io/RPLAY/blanco.png'; 
                    modelSizes = ['M', 'L', 'XL'];
                    initialStockOverrides.M = 1; initialStockOverrides.L = 1; initialStockOverrides.XL = 1;
                } else if (i === 33) { 
                    mainImg = 'https://ventaplayera.github.io/RPLAY/Katy3.png'; 
                    frontImg = 'https://ventaplayera.github.io/RPLAY/Katy3.png';
                    backImg = 'https://ventaplayera.github.io/RPLAY/Katy4.png';
                    sideImg = 'https://ventaplayera.github.io/RPLAY/blanco.png'; 
                    modelSizes = ['M', 'L', 'XL'];
                    initialStockOverrides.M = 1; initialStockOverrides.L = 1; initialStockOverrides.XL = 1;
                } else if (i === 34) { 
                    mainImg = 'https://ventaplayera.github.io/RPLAY/Katy3.png'; 
                    frontImg = 'https://ventaplayera.github.io/RPLAY/Katy3.png';
                    backImg = 'https://ventaplayera.github.io/RPLAY/Katy4.png';
                    sideImg = 'https://ventaplayera.github.io/RPLAY/blanco.png'; 
                    modelSizes = ['M', 'L', 'XL'];
                    initialStockOverrides.M = 1; initialStockOverrides.L = 1; initialStockOverrides.XL = 1;
                } else if (i === 35) { 
                    mainImg = 'https://ventaplayera.github.io/RPLAY/Dan1.png'; 
                    frontImg = 'https://ventaplayera.github.io/RPLAY/Dan1.png';
                    backImg = 'https://ventaplayera.github.io/RPLAY/Dan2.png';
                    sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                    modelSizes = ['M', 'L', 'XL'];
                    initialStockOverrides.M = 1; initialStockOverrides.L = 1; initialStockOverrides.XL = 1;
                } else if (i === 36) { 
                    mainImg = 'https://ventaplayera.github.io/RPLAY/Dan3.png'; 
                    frontImg = 'https://ventaplayera.github.io/RPLAY/Dan3.png';
                    backImg = 'https://ventaplayera.github.io/RPLAY/Dan4.png';
                    sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                    modelSizes = ['M', 'L', 'XL'];
                    initialStockOverrides.M = 1; initialStockOverrides.L = 1; initialStockOverrides.XL = 1;
                } else if (i === 37) { 
                    mainImg = 'https://ventaplayera.github.io/RPLAY/Gera1.png'; 
                    frontImg = 'https://ventaplayera.github.io/RPLAY/Gera1.png';
                    backImg = 'https://ventaplayera.github.io/RPLAY/Gera2.png';
                    sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                    modelSizes = ['M', 'L', 'XL'];
                    initialStockOverrides.M = 1; initialStockOverrides.L = 1; initialStockOverrides.XL = 1;
                } else if (i === 38) { 
                    mainImg = 'https://ventaplayera.github.io/RPLAY/Gera3.png'; 
                    frontImg = 'https://ventaplayera.github.io/RPLAY/Gera3.png';
                    backImg = 'https://ventaplayera.github.io/RPLAY/Gera4.png';
                    sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                    modelSizes = ['M', 'L', 'XL'];
                    initialStockOverrides.M = 1; initialStockOverrides.L = 1; initialStockOverrides.XL = 1;
                } else if (i === 39) { 
                    mainImg = 'https://ventaplayera.github.io/RPLAY/Bra1.png'; 
                    frontImg = 'https://ventaplayera.github.io/RPLAY/Bra1.png';
                    backImg = 'https://ventaplayera.github.io/RPLAY/Bra2.png';
                    sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                    modelSizes = ['M', 'L', 'XL'];
                    initialStockOverrides.M = 1; initialStockOverrides.L = 1; initialStockOverrides.XL = 1;
                } else if (i === 40) { 
                    mainImg = 'https://ventaplayera.github.io/RPLAY/Bra3.png'; 
                    frontImg = 'https://ventaplayera.github.io/RPLAY/Bra3.png';
                    backImg = 'https://ventaplayera.github.io/RPLAY/Bra4.png';
                    sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                    modelSizes = ['M', 'L', 'XL'];
                    initialStockOverrides.M = 1; initialStockOverrides.L = 1; initialStockOverrides.XL = 1;
                } else if (i === 41) { 
                    mainImg = 'https://ventaplayera.github.io/RPLAY/Adri1.png'; 
                    frontImg = 'https://ventaplayera.github.io/RPLAY/Adri1.png';
                    backImg = 'https://ventaplayera.github.io/RPLAY/Adri2.png';
                    sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                    modelSizes = ['M', 'L', 'XL'];
                    initialStockOverrides.M = 1; initialStockOverrides.L = 1; initialStockOverrides.XL = 1;
                } else {
                     continue; 
                }
                // --- FIN DE DEFINICIÓN DE PRODUCTOS ---

                // 1. Crear el objeto de stock para este producto
                const stock = {};
                modelSizes.forEach(size => {
                    stock[size] = initialStockOverrides[size] !== undefined ? initialStockOverrides[size] : DEFAULT_STOCK_PER_SIZE;
                });
                // 2. Asignar al inventario global
                productInventory[id] = stock;
                // 3. Añadir a la lista de productos
                productData.push({
                    id: id,
                    name: `Playera Modelo No. ${i}`,
                    price: FIXED_PRICE.toFixed(2), 
                    description: `Diseño exclusivo #${i} con estampado digital de alta calidad. Tela de algodón 100%.`,
                    img_main: mainImg,
                    img_front: frontImg,
                    img_back: backImg,
                    img_side: sideImg 
                });
            }
        }


        // --- 2. GESTIÓN DE STOCK Y ESTADO ---
        let currentProductID = null;
        let currentProductSize = null;
        let currentQuantity = 1;
        let currentPrice = 0;
        let currentProductName = '';
        
        function getStock(id, size) {
            return productInventory[id] && productInventory[id][size] !== undefined ? productInventory[id][size] : 0;
        }

        function updateProductBadge(id) {
            const stockElement = document.getElementById(`badge-${id}`);
            if (!stockElement) return;

            const sizes = Object.keys(productInventory[id] || {});
            let totalStock = sizes.reduce((sum, size) => sum + getStock(id, size), 0);

            stockElement.textContent = totalStock > 0 ? `preventa` : 'Agotado'; 
            stockElement.className = 'stock-badge';
            if (totalStock > 0) { 
                stockElement.classList.add('in-stock'); 
            } else {
                stockElement.classList.add('out-stock');
            }
        }
        
        // --- 3. RENDERIZADO DE LA INTERFAZ ---
        function renderProductCards() {
            let html = '';
            productData.forEach(product => {
                html += `
                    <div class="col-lg-3 col-md-4 col-sm-6 d-flex">
                        <div class="card product-card flex-fill" data-product-id="${product.id}">
                            <span class="stock-badge" id="badge-${product.id}"></span> 
                            <img src="${product.img_main}" class="card-img-top" alt="Playera ${product.name}">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">${product.name}</h5>
                                <p class="card-text text-muted">${product.description.substring(0, 50)}...</p>
                                <div class="mt-auto">
                                    <p class="price mb-2">$${product.price} MXN</p>
                                    <button 
                                        class="btn btn-block btn-buy w-100" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#paymentModal" 
                                        data-product-id="${product.id}"
                                        data-price="${product.price}" 
                                        data-name="${product.name}"
                                        data-description="${product.description}"
                                        data-img-front="${product.img_front}" 
                                        data-img-back="${product.img_back}"
                                        data-img-side="${product.img_side}">
                                        Ver Detalle y Comprar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            PRODUCT_LIST_CONTAINER.innerHTML = html;
            productData.forEach(product => updateProductBadge(product.id)); 
        }

        // --- 4. GESTIÓN DEL MODAL ---
        const paymentModal = document.getElementById('paymentModal');
        const quantityInput = document.getElementById('quantityInput');
        const halfPaymentCheck = document.getElementById('halfPaymentCheck');
        const modalMainButton = document.getElementById('modal-main-button');
        const productCarousel = document.getElementById('productCarousel');


        // Función para crear botones de talla
        function createSizeButtons(id) {
            const sizeOptions = document.getElementById('size-options');
            sizeOptions.innerHTML = '';
            
            if (!productInventory[id]) return;

            Object.keys(productInventory[id]).forEach(size => {
                const stock = getStock(id, size);
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'btn btn-outline-secondary me-2 mb-2';
                button.textContent = size;
                button.setAttribute('data-size', size);
                
                if (stock <= 0) {
                    button.disabled = true;
                    button.classList.add('text-danger');
                    button.title = 'Agotado';
                }

                button.addEventListener('click', () => {
                    currentProductSize = size;
                    document.querySelectorAll('#size-options button').forEach(btn => {
                        btn.classList.remove('active', 'btn-danger');
                        btn.classList.add('btn-outline-secondary');
                    });
                    button.classList.add('active', 'btn-danger');
                    button.classList.remove('btn-outline-secondary');
                    updateQuantityStatus();
                    checkModalButtonState();
                });
                sizeOptions.appendChild(button);
            });
        }

        // Función para actualizar el estado del stock de la cantidad
        function updateQuantityStatus() {
            const statusElement = document.getElementById('quantity-status');
            const stock = getStock(currentProductID, currentProductSize);
            currentQuantity = parseInt(quantityInput.value);

            if (!currentProductSize) {
                statusElement.textContent = "Selecciona una talla.";
                modalMainButton.disabled = true;
                return;
            }

            if (currentQuantity > stock) {
                statusElement.textContent = `Solo quedan ${stock} piezas en talla ${currentProductSize}.`;
                statusElement.classList.remove('text-secondary');
                statusElement.classList.add('text-danger');
                quantityInput.max = stock;
                if (currentQuantity > stock) quantityInput.value = stock; 
                currentQuantity = parseInt(quantityInput.value);
            } else if (stock > 0) {
                statusElement.textContent = `Disponible para preventa: ${stock}.`; 
                statusElement.classList.remove('text-danger');
                statusElement.classList.add('text-secondary');
                quantityInput.max = stock; 
            } else {
                statusElement.textContent = `Agotado en talla ${currentProductSize}.`;
                statusElement.classList.remove('text-secondary');
                statusElement.classList.add('text-danger');
                quantityInput.max = 0;
            }
            checkModalButtonState();
        }

        // Función para actualizar los precios
        function updatePriceDisplays() {
            const isHalfPayment = halfPaymentCheck.checked;
            const total = currentPrice * currentQuantity;
            const paymentDue = isHalfPayment ? total / 2 : total;

            document.getElementById('total-price').textContent = `$${total.toFixed(2)} MXN`;
            document.getElementById('payment-due').textContent = `$${paymentDue.toFixed(2)} MXN`;
        }

        // Función para verificar si el botón de "Pagar Ahora" debe estar activo
        function checkModalButtonState() {
            const stock = getStock(currentProductID, currentProductSize);
            const canProceed = currentProductSize !== null && currentQuantity > 0 && stock >= currentQuantity;
            modalMainButton.disabled = !canProceed;
        }

        // Manejo de clicks en miniaturas
        function setupThumbnailEvents(carousel) {
            document.querySelectorAll('#thumb-front, #thumb-back, #thumb-side').forEach(thumb => {
                thumb.addEventListener('click', (e) => {
                    const slideTo = e.target.getAttribute('data-slide-to');
                    carousel.to(parseInt(slideTo));
                    document.querySelectorAll('.img-thumbnail').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                });
            });
            productCarousel.addEventListener('slid.bs.carousel', (e) => {
                const activeIndex = e.to;
                document.querySelectorAll('.img-thumbnail').forEach(t => t.classList.remove('active'));
                document.querySelector(`.img-thumbnail[data-slide-to="${activeIndex}"]`).classList.add('active');
            });
        }


        // Eventos en el Modal
        paymentModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            
            // 1. Cargar datos del producto
            currentProductID = button.getAttribute('data-product-id');
            currentProductName = button.getAttribute('data-name');
            currentPrice = parseFloat(button.getAttribute('data-price')); 
            
            document.getElementById('product-name').textContent = currentProductName;
            document.getElementById('product-description').textContent = button.getAttribute('data-description');
            
            // Carga de las tres imágenes principales y miniaturas
            const imgFrontUrl = button.getAttribute('data-img-front');
            const imgBackUrl = button.getAttribute('data-img-back');
            const imgSideUrl = button.getAttribute('data-img-side');

            document.getElementById('modal-img-front').src = imgFrontUrl;
            document.getElementById('modal-img-back').src = imgBackUrl;
            document.getElementById('modal-img-side').src = imgSideUrl; 

            document.getElementById('thumb-front').src = imgFrontUrl;
            document.getElementById('thumb-back').src = imgBackUrl;
            document.getElementById('thumb-side').src = imgSideUrl;

            // 2. Resetear la vista y generar botones
            resetModalView();
            createSizeButtons(currentProductID);
            updatePriceDisplays();

            // 3. Configurar carrusel y miniaturas
            const carousel = bootstrap.Carousel.getOrCreateInstance(productCarousel);
            setupThumbnailEvents(carousel);
        });

        quantityInput.addEventListener('input', () => {
            if (currentProductID) {
                updateQuantityStatus();
                updatePriceDisplays();
            }
        });

        halfPaymentCheck.addEventListener('change', updatePriceDisplays);


        // --- 5. LÓGICA DE FLUJO DE COMPRA ---

        modalMainButton.addEventListener('click', () => {
            if (modalMainButton.textContent === 'Pagar Ahora') {
                // Paso 1: Pasar a la captura de datos
                document.getElementById('selection-step').style.display = 'none';
                document.getElementById('payment-step').style.display = 'block';

                // Mostrar resumen
                const total = currentPrice * currentQuantity;
                const paymentDue = halfPaymentCheck.checked ? total / 2 : total;

                document.getElementById('final-quantity-display').textContent = currentQuantity;
                document.getElementById('final-size-display').textContent = currentProductSize;
                document.getElementById('final-price-display').textContent = `$${paymentDue.toFixed(2)} MXN`;
                
                modalMainButton.textContent = 'Continuar Pedido'; 
                modalMainButton.disabled = false; 

            } else if (modalMainButton.textContent === 'Continuar Pedido') {
                // Paso 2: Validar datos y generar orden TEMPORAL

                const name = document.getElementById('clientName').value.trim();
                const phone = document.getElementById('clientPhone').value.trim();
                const address = document.getElementById('clientAddress').value.trim();

                if (name === '' || phone === '' || address === '') {
                    document.getElementById('payment-error').style.display = 'block';
                    return;
                }
                document.getElementById('payment-error').style.display = 'none';

                // Generar orden TEMPORAL (NO se descuenta stock aquí)
                currentOrderData = createTemporaryOrder(name, phone, address);

                // Pasar al paso final de confirmación de pago
                showTransferInfo(currentOrderData);
            }
        });

        // Evento del botón de WhatsApp (PUNTO DE APARTADO y DESCUENTO DE STOCK)
        document.getElementById('whatsapp-confirm-button').addEventListener('click', (e) => {
            if (currentOrderData) {
                // 1. Ejecutar la acción de apartado (descuento de stock y guardado)
                finalizeOrder(currentOrderData); 
                
                // 2. Permitir que el enlace de WhatsApp se ejecute (redirección)
            } else {
                e.preventDefault();
                alert('Error: La orden no fue generada correctamente. Vuelve al inicio del proceso.');
            }
        });


        // --- 6. GESTIÓN DE ORDEN E INVENTARIO PERSISTENTE ---

        // NOTA: Estas variables persisten a través de localStorage para simular un backend simple
        const PENDING_ORDERS = JSON.parse(localStorage.getItem('RPLAY_PENDING_ORDERS')) || [];
        const INVENTORY_STORAGE = JSON.parse(localStorage.getItem('RPLAY_INVENTORY')) || {};

        function loadInventoryStorage() {
             Object.keys(INVENTORY_STORAGE).forEach(productId => {
                if (productInventory[productId]) {
                    Object.keys(INVENTORY_STORAGE[productId]).forEach(size => {
                        if(productInventory[productId][size] !== undefined) {
                            productInventory[productId][size] = INVENTORY_STORAGE[productId][size];
                        }
                    });
                }
            });
        }

        // Crea el objeto de orden, pero NO descuenta stock.
        function createTemporaryOrder(name, phone, address) {
            const orderID = Date.now();
            const total = currentPrice * currentQuantity;
            const paymentDue = halfPaymentCheck.checked ? total / 2 : total;

            return {
                id: orderID,
                productID: currentProductID,
                productName: currentProductName,
                size: currentProductSize,
                quantity: currentQuantity,
                totalPrice: total,
                paymentDue: paymentDue,
                isHalfPayment: halfPaymentCheck.checked,
                clientName: name,
                clientPhone: phone,
                clientAddress: address,
                timestamp: Date.now(),
                expiration: Date.now() + (24 * 60 * 60 * 1000) 
            };
        }

        // Descuenta stock y guarda la orden de forma permanente.
        function finalizeOrder(order) {
            // 1. Descontar stock del inventario global
            productInventory[order.productID][order.size] -= order.quantity;
            localStorage.setItem('RPLAY_INVENTORY', JSON.stringify(productInventory));
            updateProductBadge(order.productID);
            
            // 2. Guardar la orden pendiente
            PENDING_ORDERS.push(order);
            localStorage.setItem('RPLAY_PENDING_ORDERS', JSON.stringify(PENDING_ORDERS));

            renderOrdersList();
        }


        function showTransferInfo(order) {
            document.getElementById('payment-step').style.display = 'none';
            document.getElementById('transfer-info').style.display = 'block';

            document.getElementById('final-amount-conf').textContent = `$${order.paymentDue.toFixed(2)} MXN`;

            // Botón de WhatsApp - genera el mensaje con la data de la orden temporal
            const paymentType = order.isHalfPayment ? "un apartado del 50%" : "el pago total";
            
            // Mensaje completo para enviar el comprobante
            const message = `¡Hola! Acabo de generar mi pedido y voy a proceder con el pago (#${order.id}).\n\n- Producto: ${order.productName}\n- Talla: ${order.size}\n- Cantidad: ${order.quantity}\n- Monto por ${paymentType}: $${order.paymentDue.toFixed(2)} MXN.\n- Mi nombre es: ${order.clientName}\n- Mi dirección es: ${order.clientAddress}\n\n*Adjunto mi comprobante*`;
            
            // Enlace de WhatsApp: usa el número fijo y el mensaje generado
            const whatsappUrl = `https://api.whatsapp.com/send?phone=${WHATSAPP_NUMBER}&text=${encodeURIComponent(message)}`;
            
            document.getElementById('whatsapp-confirm-button').href = whatsappUrl;
            document.getElementById('whatsapp-confirm-button').style.display = 'block';
            
            // Modificación solicitada: El botón principal de flujo se cambia a "Cerrar" en el paso final
            modalMainButton.textContent = 'Cerrar';
            modalMainButton.classList.remove('btn-danger');
            modalMainButton.classList.add('btn-secondary');
            modalMainButton.setAttribute('data-bs-dismiss', 'modal'); 
            modalMainButton.disabled = false;
        }

        // --- 7. FUNCIONES DE UTILIDAD Y ADMINISTRACIÓN ---

        function renderOrdersList() {
            const list = document.getElementById('ordersList');
            const noOrdersMessage = document.getElementById('noOrdersMessage');
            if (!list || !noOrdersMessage) return; 

            list.innerHTML = '';
            
            if (PENDING_ORDERS.length === 0) {
                noOrdersMessage.style.display = 'block';
                return;
            }
            noOrdersMessage.style.display = 'none';

            PENDING_ORDERS.forEach(order => {
                const elapsedHours = ((Date.now() - order.timestamp) / 3600000).toFixed(1);
                const expired = Date.now() > order.expiration;
                const cardClass = expired ? 'border-danger' : 'border-warning';
                
                list.innerHTML += `
                    <div class="card mb-2 ${cardClass}">
                        <div class="card-body p-2">
                            <p class="mb-1">
                                <strong>Pedido #${order.id}</strong> (${order.productName} T: ${order.size} x${order.quantity}) - Pagó: $${order.paymentDue.toFixed(2)} MXN
                            </p>
                            <p class="mb-1 small text-muted">Cliente: ${order.clientName} | Tel: ${order.clientPhone}</p>
                            <p class="mb-1 small text-danger ${expired ? 'fw-bold' : ''}">
                                Apartado hace ${elapsedHours} hrs. ${expired ? '(¡EXPIRADO!)' : ''}
                            </p>
                            <button class="btn btn-sm btn-outline-danger mt-1" onclick="releaseStock(${order.id}, '${order.productID}', '${order.size}', ${order.quantity})">
                                Liberar Stock
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        // Funciones accesibles desde la consola (F12) para administración
        window.releaseStock = (orderId, productId, size, quantity) => {
            if (productInventory[productId] && productInventory[productId][size] !== undefined) {
                productInventory[productId][size] += quantity;
                localStorage.setItem('RPLAY_INVENTORY', JSON.stringify(productInventory));
                updateProductBadge(productId);
            }
            
            const index = PENDING_ORDERS.findIndex(order => order.id === orderId);
            if (index > -1) {
                PENDING_ORDERS.splice(index, 1);
                localStorage.setItem('RPLAY_PENDING_ORDERS', JSON.stringify(PENDING_ORDERS));
            }
            renderOrdersList(); 
            renderProductCards(); 
        }

        window.resetAllStock = () => {
            if (confirm("ADVERTENCIA: ¿Estás seguro de que quieres REINICIAR TODO EL INVENTARIO A SU ESTADO INICIAL? Esto borra el stock y todas las órdenes pendientes.")) {
                localStorage.removeItem('RPLAY_INVENTORY');
                localStorage.removeItem('RPLAY_PENDING_ORDERS');
                window.location.reload();
            }
        }

        window.setStock = (id, size, count) => {
             if (productInventory[id] && productInventory[id][size] !== undefined) {
                productInventory[id][size] = count;
                updateProductBadge(id);
                if (currentProductID === id && currentProductSize === size) {
                    updateQuantityStatus();
                }
                localStorage.setItem('RPLAY_INVENTORY', JSON.stringify(productInventory));
            }
        }


        function resetModalView() {
            // Reiniciar vistas del modal y estado
            document.getElementById('selection-step').style.display = 'block';
            document.getElementById('payment-step').style.display = 'none';
            document.getElementById('transfer-info').style.display = 'none';
            document.getElementById('payment-error').style.display = 'none';
            document.getElementById('clientName').value = '';
            document.getElementById('clientPhone').value = '';
            document.getElementById('clientAddress').value = '';
            quantityInput.value = 1;
            halfPaymentCheck.checked = false;
            currentProductSize = null;
            currentQuantity = 1;
            currentOrderData = null; // Limpiar la orden temporal
            
            // Botón principal (restablecer a "Pagar Ahora")
            modalMainButton.textContent = 'Pagar Ahora';
            modalMainButton.disabled = true;
            modalMainButton.style.display = 'block';
            modalMainButton.classList.remove('btn-secondary');
            modalMainButton.classList.add('btn-danger');
            modalMainButton.removeAttribute('data-bs-dismiss');

            document.getElementById('whatsapp-confirm-button').style.display = 'none';
            document.getElementById('modal-close-button').textContent = 'Cerrar'; // El botón izquierdo siempre es Cerrar

            const carouselElement = document.getElementById('productCarousel');
            if (carouselElement) {
                const carousel = bootstrap.Carousel.getOrCreateInstance(carouselElement);
                carousel.to(0);
                document.querySelectorAll('.img-thumbnail').forEach(t => t.classList.remove('active'));
                document.getElementById('thumb-front').classList.add('active');
            }
        }
        
        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            generateInitialInventory();
            loadInventoryStorage();
            renderProductCards();
        });

    </script>
</body>
</html>
