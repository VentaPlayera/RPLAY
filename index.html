<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPLAY - Venta de Playeras</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .product-card {
            border: 1px solid #ddd;
            transition: transform 0.2s;
            margin-bottom: 20px;
            position: relative;
        }
        .product-card:hover {
            transform: translateY(-5px);
        }
        .btn-buy {
            background-color: #ff3366;
            color: white;
            border: none;
        }
        .btn-buy:hover {
            background-color: #e6004b;
            color: white;
        }
        .carousel-item img {
            max-height: 500px;
            object-fit: contain;
        }
        .stock-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
            opacity: 0.9;
        }
        #ordersCounter {
            font-weight: bold;
            font-size: 1.25rem;
            color: #ff3366;
        }
        .product-card .card-img-top {
            height: 300px;
            object-fit: cover;
        }
    </style>
</head>
<body>

    <header class="bg-white shadow-sm mb-4">
        <div class="container d-flex justify-content-between align-items-center py-3">
            <h1 class="h3 mb-0">
                <img id="logo-image" src="" alt="RPLAY Logo" style="height: 40px; margin-right: 10px;">
                RPLAY Store
            </h1>
            <button class="btn btn-outline-secondary position-relative" data-bs-toggle="modal" data-bs-target="#ordersModal" onclick="openOrdersModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-cart" viewBox="0 0 16 16">
                    <path d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5M3.102 4l1.313 7h8.17l1.313-7zM5 12a2 2 0 1 0 0 4 2 2 0 0 0 0-4m7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4m-7 1a1 1 0 1 1 0 2 1 1 0 0 1 0-2m7 0a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/>
                </svg>
                <span id="ordersCounter" class="ms-2">0</span>
            </button>
        </div>
    </header>

    <main class="container">
        <h2 class="mb-4 text-center">Cat치logo de Playeras</h2>
        <div class="row" id="product-list">
            <div class="col-12 text-center my-5" id="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2">Cargando inventario en tiempo real de Firebase...</p>
            </div>
        </div>
    </main>

    <div class="modal fade" id="productDetailModal" tabindex="-1" aria-labelledby="productDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productDetailModalLabel">Detalle de Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="modalProductId">
                    <div class="row">
                        <div class="col-md-6">
                            <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
                                <div class="carousel-indicators" id="carouselIndicators"></div>
                                <div class="carousel-inner" id="carouselInner"></div>
                                <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Anterior</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Siguiente</span>
                                </button>
                            </div>
                            <div class="text-center mt-3">
                                <span id="stockIndicator" class="badge rounded-pill bg-warning text-dark d-none">Stock: </span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h2 id="modalProductName"></h2>
                            <p id="modalProductDescription" class="text-muted"></p>
                            <h3 class="text-success fw-bold" id="modalProductPrice"></h3>

                            <form id="orderForm">
                                <div class="mb-3" id="colorSelectContainer" style="display: none;">
                                    <label for="colorSelect" class="form-label">Color:</label>
                                    <select class="form-select" id="colorSelect" required></select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="sizeSelect" class="form-label">Talla:</label>
                                    <select class="form-select" id="sizeSelect" required></select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="quantityInput" class="form-label">Cantidad:</label>
                                    <input type="number" class="form-control" id="quantityInput" value="1" min="1" required>
                                </div>

                                <button type="submit" class="btn btn-buy btn-lg w-100 mt-3" id="addToOrderButton" disabled>
                                    A침adir 1 a Pedido
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="ordersModal" tabindex="-1" aria-labelledby="ordersModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ordersModalLabel">Tu Pedido Actual</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="list-group mb-4" id="currentOrdersList">
                        <li class="list-group-item text-center text-muted" id="emptyOrdersMessage" style="display: none;">
                            Tu pedido est치 vac칤o.
                        </li>
                        </ul>

                    <div id="paymentDetailsSection" style="display: none;">
                        <h6 class="mt-4">Detalles de Pago</h6>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" value="" id="halfPaymentCheck">
                            <label class="form-check-label" for="halfPaymentCheck">
                                Pagar 50% de Anticipo (<span id="halfPaymentAmount">$0.00</span>)
                            </label>
                        </div>
                        <h4 class="text-end">Total a Pagar: <span class="text-success" id="ordersTotal">$0.00</span></h4>
                    </div>
                    

                    <form id="clientDataForm" style="display: none;" class="mt-4">
                        <h6>Datos de Env칤o</h6>
                        <div class="mb-3">
                            <input type="text" class="form-control" id="clientName" placeholder="Tu Nombre Completo" required>
                        </div>
                        <div class="mb-3">
                            <input type="tel" class="form-control" id="clientPhone" placeholder="Tu Tel칠fono (WhatsApp)" required>
                        </div>
                        <div class="mb-3">
                            <textarea class="form-control" id="clientAddress" placeholder="Direcci칩n completa de env칤o (calle, n칰mero, colonia, CP)" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Seguir Comprando</button>
                    <button type="button" class="btn btn-buy" id="finalizeOrderButton" onclick="sendOrderToWhatsapp()" disabled>
                        Finalizar Pedido y Enviar a WhatsApp
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        // La CORRECCI칍N clave: Usar 'type="module"' y las rutas CDN para la importaci칩n
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // =======================================================
        // CONFIGURACI칍N DE FIREBASE
        // =======================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCtgsjjbNiS0lv5aLDb8nkpN_9-4sXIJvE",
            authDomain: "rplay-f04dc.firebaseapp.com",
            projectId: "rplay-f04dc",
            storageBucket: "rplay-f04dc.firebasestorage.app",
            messagingSenderId: "787828282738",
            appId: "1:787828282738:web:00c1ff1a7008c0e02b79eb",
            measurementId: "G-XEKR4KEDMR"
        };
        
        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        // Inicializar Database
        const db = getDatabase(app); 
        const inventoryRef = ref(db, 'inventario'); // <-- NODO CLAVE EN FIREBASE

        // =======================================================
        // DECLARACI칍N DE VARIABLES GLOBALES Y CONSTANTES
        // =======================================================
        const PRODUCT_PRICE = 250.00; 
        const MINIMUM_TO_SHIP = 1;   
        const WHATSAPP_NUMBER = '529991480151'; 
        
        // Rutas de im치genes (ajusta 'GITHUB_BASE_URL' si cambias de hosting)
        // 游뚿 SI SIGUES TENIENDO ERRORES 404, CAMBIA ESTO A '.jpg' o la extensi칩n correcta
        const DEFAULT_EXTENSION = '.png'; 
        const UPPERCASE_EXTENSION = '.PNG'; 
        const GITHUB_BASE_URL = 'https://ventaplayera.github.io/RPLAY/';
        
        const MUST_BE_LOWERCASE = ['xime1', 'negro', 'blanco', 'negro2', 'blanco2', 'medidas', 'logo', 'arena', 'fallback_default']; 
        
        const GENERIC_SIDE_IMAGE_BASE = 'medidas'; 
        const GENERIC_SIDE_PLACEHOLDER = 'generic_side_image_placeholder';

        let productData = []; 
        let productInventory = {}; // Mantiene el stock actual de Firebase
        let currentOrder = []; 

        let orderIdCounter = 0;
        let PENDING_ORDERS = []; 


        // =======================================================
        // L칍GICA DE NOMBRES Y RUTAS DE IMAGEN
        // =======================================================
        
        function formatFileName(rawName) {
            if (!rawName) return null;
            
            let baseName = rawName.split('.')[0]; 
            const lowerBaseName = baseName.toLowerCase();
            
            if (MUST_BE_LOWERCASE.includes(lowerBaseName)) {
                baseName = lowerBaseName; 
            } else {
                if (baseName.length > 0) {
                    baseName = baseName.charAt(0).toUpperCase() + baseName.slice(1);
                }
            }
            
            let extension = DEFAULT_EXTENSION;
            if (lowerBaseName.startsWith('gon')) {
                 extension = UPPERCASE_EXTENSION;
            }
            
            return { name: baseName, ext: extension };
        }

        function getImageUrl(fileBase) {
            if (!fileBase || fileBase === GENERIC_SIDE_PLACEHOLDER) {
                const fallback = formatFileName('fallback_default');
                return `${GITHUB_BASE_URL}${fallback.name}${fallback.ext}`;
            }

            if (fileBase === GENERIC_SIDE_IMAGE_BASE) {
                const measures = formatFileName(GENERIC_SIDE_IMAGE_BASE);
                return `${GITHUB_BASE_URL}${measures.name}${measures.ext}`;
            }
            
            const fileInfo = formatFileName(fileBase);
            return `${GITHUB_BASE_URL}${fileInfo.name}${fileInfo.ext}`; 
        }

        // =======================================================
        // DEFINICI칍N DE PRODUCTOS (METADATOS BASE - EL STOCK SE LEE DE FIREBASE)
        // =======================================================
        const ORIGINAL_PRODUCTS_DEFINITION = [
            // HE MANTENIDO LA ESTRUCTURA DE TUS MODELOS ORIGINALES
            { i: 1, name: 'BTS', description: 'Playera Modelo 1', stock: { 'M': 1, 'L' :1, 'XL': 1}, frontFile: 'xime1', backFile: 'Xime2', sideFile: 'blanco' },
            { i: 2, name: 'BTS', description: 'Playera Modelo 2', stock: { 'M': 1, 'L' :1, 'XL': 1}, frontFile: 'Xime3', backFile: 'Xime4', sideFile: 'negro' },
            { i: 3, name: 'MICHAEL JACKSON', description: 'Playera Modelo 3', stock:{ 'S':1, 'M':1, 'L': 1 },  frontFile: 'Abi1', backFile: 'Abi2', sideFile: 'blanco' },
            { i: 4, name: 'MICHAEL JACKSON', description: 'Playera Modelo 4', stock: {'L': 1 }, frontFile: 'Abi3', backFile: 'Abi4', sideFile: 'negro' },
            // ... (AQU칈 CONTIN칔AN TUS OTROS 41 MODELOS)
            { i: 5, name: 'ADO', description: 'Playera Modelo 5', stock: {'XL': 1 }, frontFile: 'Lucy1', backFile: 'Lucy2', sideFile: 'blanco' },
            { i: 6, name: 'ADO', description: 'Playera Modelo 6', stock: { 'M': 1, 'L': 1, 'XL':2 }, frontFile: 'Lucy3', backFile: 'Lucy4', sideFile: 'negro' },
            { i: 7, name: 'BRUNO MARS', description: 'Playera Modelo 7', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Raul1', backFile: 'Raul2', sideFile: 'negro' },
            { i: 8, name: 'BRUNO MARS', description: 'Playera Modelo 8', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Raul3', backFile: 'Raul4', sideFile: 'negro' },
            { i: 9, name: 'LATIN MAFIA', description: 'Playera Modelo 9', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Dani1', backFile: 'Dani2', sideFile: 'blanco' },
            { i: 10, name: 'LATIN MAFIA', description: 'Playera Modelo 10', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Dani3', backFile: 'Dani4', sideFile: 'negro' },
            { i: 11, name: 'AESPA', description: 'Playera Modelo 11', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Dali1', backFile: 'Dali2', sideFile: 'negro' },
            { i: 12, name: 'AESPA', description: 'Playera Modelo 12', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Dali3', backFile: 'Dali4', sideFile: 'negro' },
            { i: 13, name: 'BILLIE EILISH', description: 'Playera Modelo 13', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Yose1', backFile: 'Yose2', sideFile: 'negro' },
            { i: 14, name: 'BILLIE EILISH', description: 'Playera Modelo 14', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Yose3', backFile: 'Yose4', sideFile: 'negro' },
            { i: 15, name: 'LANA DEL REY', description: 'Playera Modelo 15', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Keila1', backFile: 'Keila2', sideFile: 'blanco' },
            { i: 16, name: 'LANA DEL REY', description: 'Playera Modelo 16', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Keila3', backFile: 'Keila4', sideFile: 'negro' },
            { i: 17, name: 'MY CHEMICAL ROMANCE', description: 'Playera Modelo 17', stock: { 'M': 1, 'L': 1, 'XL':1 },  frontFile: 'Kenji1', backFile: 'Kenji2', sideFile: 'negro' },
            { i: 18, name: 'MY CHEMICAL ROMANCE', description: 'Playera Modelo 18', stock: { 'M': 1, 'L': 1, 'XL':1 },  frontFile: 'Kenji3', backFile: 'Kenji4', sideFile: 'negro' },
            { i: 19, name: 'TWENTY ONE PILOTS', description: 'Playera Modelo 19', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Alli1', backFile: 'Alli2', sideFile: 'negro' },
            { i: 20, name: 'TWENTY ONE PILOTS', description: 'Playera Modelo 20', stock: { 'M': 1, 'L': 1, 'XL':1 },frontFile: 'Alli3', backFile: 'Alli4', sideFile: 'negro' },
            { i: 21, name: 'SELENA QUINTANILLA', description: 'Playera Modelo 21', stock: { 'XL':1 }, frontFile: 'Ale1', backFile: 'Ale2', sideFile: 'arena' },
            { i: 22, name: 'OLIVIA RODRIGO', description: 'Playera Modelo 22', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Miri1', backFile: 'Miri2', sideFile: 'negro' },
            { i: 23, name: 'OLIVIA RODRIGO', description: 'Playera Modelo 23', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Miri3', backFile: 'Miri4', sideFile: 'negro' },
            { i: 24, name: 'BAD BUNNY', description: 'Playera Modelo 24', stock: { 'M': 1, 'XL':1 }, frontFile: 'Didi1', backFile: 'Didi2', sideFile: 'negro' },
            { i: 25, name: 'BAD BUNNY', description: 'Playera Modelo 25', stock: { 'L': 1, 'XL':1 }, frontFile: 'Didi3', backFile: 'Didi4', sideFile: 'arena' },
            { i: 26, name: 'Taylor SWIFT', description: 'Playera Modelo 26', stock:{ 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Vale1', backFile: 'Vale2', sideFile: 'arena' },
            { i: 27, name: 'TAYLOR SWIFT', description: 'Playera Modelo 27', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Vale3', backFile: 'Vale4', sideFile: 'negro' },
            { i: 28, name: 'HUMBE', description: 'Playera Modelo 28', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Caro1', backFile: 'Caro2', sideFile: 'arena' },
            { i: 29, name: 'HUMBE', description: 'Playera Modelo 29', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Caro3', backFile: 'Caro4', sideFile: 'arena' },
            { i: 30, name: 'KATY PERRY', description: 'Playera Modelo 30', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Gon1', backFile: 'Gon2', sideFile: 'negro' },
            { i: 31, name: 'KATY PERRY', description: 'Playera Modelo 31', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Katy3', backFile: 'Katy4', sideFile: 'blanco' },
            { i: 32, name: 'TAYLOR SWIFT', description: 'Playera Modelo 32', stock: { 'S': 1, 'M': 1, 'L':1 }, frontFile: 'Bere1', backFile: 'Bere2', sideFile: 'blanco2' },
            { i: 33, name: 'TAYLOR SWIFT', description: 'Playera Modelo 33', stock: { 'S': 1, 'M': 1, 'L':1 },frontFile: 'Bere3', backFile: 'Bere4', sideFile: 'negro2' },
            { i: 34, name: 'BTS', description: 'Playera Modelo 34', stock: { 'S': 1, 'M': 1, 'L':1 }, frontFile: 'Dan1', backFile: 'Dan2', sideFile: 'negro2' },
            { i: 35, name: 'BTS', description: 'Playera Modelo 35', stock: { 'S': 1, 'M': 1, 'L':1 }, frontFile: 'Dan3', backFile: 'Dan4', sideFile: 'negro2' },
            { i: 36, name: 'NCT DREAM', description: 'Playera Modelo 36', stock: { 'S': 1, 'M': 1, 'L':1 }, frontFile: 'Gera1', backFile: 'Gera2', sideFile: 'negro2' },
            { i: 37, name: 'NCT DREAM', description: 'Playera Modelo 37', stock: { 'S': 1, 'M': 1, 'L':1 }, frontFile: 'Gera3', backFile: 'Gera4', sideFile: 'negro2' },
            { i: 38, name: 'HUNTRIX/SAJA BOYS', description: 'Playera Modelo 38', stock: { 'S': 1, 'M': 1, 'L':1 }, frontFile: 'Bra1', backFile: 'Bra2', sideFile: 'negro2' },
            { i: 39, name: 'HUNTRIX/SAJA BOYS', description: 'Playera Modelo 39', stock: { 'S': 1, 'M': 1, 'L':1 }, frontFile: 'Bra3', backFile: 'Bra4', sideFile: 'negro2' },
            { i: 40, name: 'HOZIER', description: 'Playera Modelo 40', stock:  { 'S': 1, 'M': 1, 'L':1 }, frontFile: 'Adri1', backFile: 'Adri2', sideFile: 'negro2' },
            { i: 41, name: 'HOZIER', description: 'Playera Modelo 41', stock:  { 'S': 1, 'M': 1, 'L':1 }, frontFile: 'Adri3', backFile: 'Adri4', sideFile: 'blanco2' },
           
            // --- MODELOS CON OPCI칍N DE COLOR ---
            { 
                i: 42, 
                name: 'BLACKPINK', 
                description: 'Modelo 42 con opci칩n de color', 
                colors: ['Negro', 'Blanco'], 
                isColorProduct: true,
                stockByColor: { 
                    'Blanco': { 'S': 1, 'M': 1 },
                    'Negro': { 'L': 1 }
                },
                colorMap: { 
                    'Negro': { front: 'Aro1', back: 'Aro2', side: 'negro2' },
                    'Blanco': { front: 'Aro3', back: 'Aro4', side: 'blanco2' }
                }
            },
            { 
                i: 43, 
                name: 'BLACKPINK', 
                description: 'Modelo 43 con opci칩n de color', 
                colors: [ 'Negro','Blanco'], 
                isColorProduct: true,
                stockByColor: { 
                    'Blanco': { 'S': 1, 'M': 1 },
                    'Negro': { 'L': 1 }
                },
                colorMap: { 
                    'Negro': { front: 'Aro5', back: 'Aro6', side: 'negro2' },
                    'Blanco': { front: 'Aro7', back: 'Aro8', side: 'blanco2'}
                }
            },
        ];


        // =======================================================
        // FUNCIONES DE CARGA Y PROCESAMIENTO (AS칈NCRONO CON FIREBASE)
        // =======================================================

        async function loadInventoryFromFirebase() {
            try {
                // 1. Obtener los valores de stock en tiempo real
                const snapshot = await get(child(inventoryRef, '/'));
                if (snapshot.exists()) {
                    productInventory = snapshot.val();
                } else {
                    console.warn("No se encontraron datos de inventario en Firebase. Intentando inicializar con valores por defecto.");
                    // Si no existe, intenta inicializar el inventario con los valores del HTML
                    await initializeFirebaseInventory(); 
                }

                // 2. Procesar los metadatos de los productos (Igual que antes, para definir tallas, colores e im치genes)
                productData.length = 0; 
                const initialProducts = ORIGINAL_PRODUCTS_DEFINITION;
                
                initialProducts.forEach(prod => {
                    const i = prod.i;
                    const id = `PROD_${String(i).padStart(3, '0')}`;
                    let modelSizes = [];
                    let mainImg = '';
                    
                    if (prod.isColorProduct) {
                         // L칩gica para productos con color
                        const availableColors = Object.keys(prod.stockByColor || {});
                        availableColors.forEach(color => {
                            const colorStock = prod.stockByColor[color] || {};
                            Object.keys(colorStock).forEach(size => {
                                if (!modelSizes.includes(size)) {
                                    modelSizes.push(size);
                                }
                            });
                        });
                        
                        if (prod.colors.length > 0 && prod.colorMap[prod.colors[0]]) {
                            mainImg = getImageUrl(prod.colorMap[prod.colors[0]].front); 
                        } else {
                            mainImg = getImageUrl('fallback_default'); 
                        }
                        
                    } else {
                        // L칩gica para productos sin color
                        modelSizes = Object.keys(prod.stock || {});
                        mainImg = getImageUrl(prod.frontFile);
                    }

                    const product = {
                        id: id,
                        name: prod.name,
                        description: prod.description,
                        price: PRODUCT_PRICE,
                        sizes: modelSizes.sort(), 
                        colors: prod.colors || [], 
                        isColorProduct: prod.isColorProduct || false,
                        colorMap: prod.colorMap || {},
                        stockByColor: prod.stockByColor || {},
                        mainImg: mainImg,
                        frontFileBase: prod.frontFile || '',
                        backFileBase: prod.backFile || '',
                        sideFileBase: prod.sideFile || GENERIC_SIDE_PLACEHOLDER,
                    };

                    productData.push(product);
                });
                
            } catch (error) {
                console.error("Error al cargar o conectar con el inventario de Firebase:", error);
                alert("Hubo un error al conectar con el inventario en tiempo real. Revisa tu conexi칩n de Firebase y las reglas de seguridad.");
            }
        }
        
        // Funci칩n para inicializar Firebase (solo se llama si no hay datos)
        async function initializeFirebaseInventory() {
            const initialInventory = {};
            ORIGINAL_PRODUCTS_DEFINITION.forEach(prod => {
                const id = `PROD_${String(prod.i).padStart(3, '0')}`;
                if (prod.isColorProduct) {
                    for (const color in prod.stockByColor) {
                        for (const size in prod.stockByColor[color]) {
                            const key = `${id}_${color}_${size}`;
                            initialInventory[key] = prod.stockByColor[color][size];
                        }
                    }
                } else {
                    for (const size in prod.stock) {
                        const key = `${id}_${size}`;
                        initialInventory[key] = prod.stock[size];
                    }
                }
            });

            try {
                // Usamos SET para escribir la estructura inicial completa
                await set(inventoryRef, initialInventory);
                productInventory = initialInventory;
                console.log("Inventario inicial creado en Firebase con 칠xito.");
            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                alert("Error al intentar crear el inventario inicial en Firebase.");
            }
        }


        // =======================================================
        // FUNCIONES DE ALMACENAMIENTO (SOLO 칍RDENES LOCALES)
        // =======================================================
        
        function saveOrdersStorage() {
            localStorage.setItem('pendingOrders', JSON.stringify(PENDING_ORDERS));
            localStorage.setItem('orderIdCounter', orderIdCounter);
            document.getElementById('ordersCounter').textContent = currentOrder.length;
        }

        function loadOrdersStorage() {
            const storedOrders = localStorage.getItem('pendingOrders');
            if (storedOrders) {
                PENDING_ORDERS = JSON.parse(storedOrders);
            }
            const storedCounter = localStorage.getItem('orderIdCounter');
            if (storedCounter) {
                orderIdCounter = parseInt(storedCounter);
            }
        }

        // =======================================================
        // L칍GICA DE STOCKS
        // =======================================================

        function getStock(productId, size, color = null) {
            let key;
            // Genera la clave compuesta para buscar en el objeto productInventory de Firebase
            if (color) {
                key = `${productId}_${color}_${size}`;
            } else {
                key = `${productId}_${size}`;
            }
            // Retorna el stock de la variable local que se carg칩 de Firebase, o 0 si no existe
            return productInventory[key] || 0; 
        }


        // =======================================================
        // RENDERIZACI칍N Y L칍GICA DE MODAL (SIN CAMBIOS RESPECTO A LA L칍GICA PREVIA)
        // =======================================================

        function renderProductCards() {
            const list = document.getElementById('product-list');
            list.innerHTML = ''; 

            if (productData.length === 0) {
                 list.innerHTML = '<h2 class="col-12 text-center text-danger">No se pudieron cargar los productos.</h2>';
                return;
            }
            
            productData.forEach(product => {
                let maxStock = 0;
                
                // Calcula el stock m치ximo para el badge de la tarjeta
                if (product.isColorProduct) {
                    for (const color in product.stockByColor) {
                        const colorStock = product.stockByColor[color];
                        for (const size in colorStock) {
                            maxStock = Math.max(maxStock, getStock(product.id, size, color));
                        }
                    }
                } else {
                    product.sizes.forEach(size => {
                        maxStock = Math.max(maxStock, getStock(product.id, size));
                    });
                }
                
                const status = maxStock >= MINIMUM_TO_SHIP ? 'Disponible' : 'Agotado'; 
                const statusClass = maxStock >= MINIMUM_TO_SHIP ? 'bg-success' : 'bg-danger';

                const card = `
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card product-card h-100">
                            <span class="stock-badge ${statusClass} badge fs-6 p-2 rounded-0">${status}</span> 
                            <img src="${product.mainImg}" class="card-img-top p-2" alt="${product.name}"
                                onerror="this.onerror=null;this.src='${getImageUrl('fallback_default')}';">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">${product.name}</h5>
                                <p class="card-text text-success fw-bold">$${product.price.toFixed(2)}</p>
                                <button class="btn btn-buy mt-auto btn-block btn-lg" data-product-id="${product.id}" 
                                        ${maxStock === 0 ? 'disabled' : ''}>
                                    ${maxStock === 0 ? 'Agotado' : (product.isColorProduct ? 'Ver Colores / Pedir' : 'Ver / Pedir')}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                list.innerHTML += card;
            });
        }
        
        function updateSizesForSelectedColor(product, selectedColor) {
            const sizeSelect = document.getElementById('sizeSelect');
            sizeSelect.innerHTML = '';
            let firstAvailableSize = null;
            
            let sizesToProcess = product.sizes;
            
            if (product.isColorProduct && product.stockByColor[selectedColor]) {
                sizesToProcess = Object.keys(product.stockByColor[selectedColor]).sort();
            }
            
            const sizeOrder = ['XS', 'S', 'M', 'L', 'XL', 'XXL', '3XL', '4XL'];
            sizesToProcess.sort((a, b) => {
                const aIndex = sizeOrder.indexOf(a.toUpperCase());
                const bIndex = sizeOrder.indexOf(b.toUpperCase());
                return (aIndex > -1 ? aIndex : 100) - (bIndex > -1 ? bIndex : 100);
            });
            
            sizesToProcess.forEach(size => {
                const stock = getStock(product.id, size, selectedColor);
                
                if (stock > 0) {
                    const option = document.createElement('option');
                    option.value = size;
                    option.textContent = `${size} (Stock: ${stock})`; 
                    sizeSelect.appendChild(option);

                    if (!firstAvailableSize) {
                        firstAvailableSize = size;
                    }
                }
            });
            
            if (firstAvailableSize) {
                sizeSelect.value = firstAvailableSize;
            }
            updateTotalAndCheckStock(); 
        }


        function openModalDetail(productId) {
            const product = productData.find(p => p.id === productId);
            if (!product) return;

            document.getElementById('modalProductId').value = productId;
            document.getElementById('modalProductName').textContent = product.name;
            document.getElementById('modalProductDescription').textContent = product.description;
            document.getElementById('modalProductPrice').textContent = `$${product.price.toFixed(2)}`;
            
            const colorContainer = document.getElementById('colorSelectContainer');
            const colorSelect = document.getElementById('colorSelect');
            
            let defaultColor = null;

            if (product.isColorProduct && product.colors && product.colors.length > 0) {
                colorContainer.style.display = 'block';
                colorSelect.innerHTML = '';
                
                product.colors.forEach(color => {
                    const option = document.createElement('option');
                    option.value = color;
                    option.textContent = color;
                    colorSelect.appendChild(option);
                });
                
                defaultColor = product.colors[0]; 
                
                colorSelect.onchange = () => {
                    const selectedColor = colorSelect.value;
                    renderCarousel(product, selectedColor);
                    updateSizesForSelectedColor(product, selectedColor);
                };

            } else {
                colorContainer.style.display = 'none';
                colorSelect.innerHTML = '';
                defaultColor = null; 
            }
            
            renderCarousel(product, defaultColor);
            updateSizesForSelectedColor(product, defaultColor);

            document.getElementById('quantityInput').value = 1;

            const modal = new bootstrap.Modal(document.getElementById('productDetailModal'));
            modal.show();
            
            const sizeSelect = document.getElementById('sizeSelect');
            sizeSelect.onchange = updateTotalAndCheckStock;
            
            updateTotalAndCheckStock(); 
        }
        
        function renderCarousel(product, color = null) {
            const indicators = document.getElementById('carouselIndicators');
            const inner = document.getElementById('carouselInner');
            indicators.innerHTML = '';
            inner.innerHTML = '';
            
            let imageVariants = [];

            if (product.isColorProduct && color && product.colorMap[color]) {
                const map = product.colorMap[color];
                imageVariants = [
                    { variant: `Frente (${color})`, fileBase: map.front, alt: 'Frente' }, 
                    { variant: `Espalda (${color})`, fileBase: map.back, alt: 'Espalda' },
                    { variant: `Lateral`, fileBase: map.side, alt: 'Lateral' }
                ];
                
            } else {
                imageVariants = [
                    { variant: 'Frente', fileBase: product.frontFileBase, alt: 'Frente' }, 
                    { variant: 'Espalda', fileBase: product.backFileBase, alt: 'Espalda' },
                    { variant: 'Lateral', fileBase: product.sideFileBase, alt: 'Lateral' }
                ];
            }


            let index = 0;
            
            imageVariants.forEach((item) => {
                const imgUrl = getImageUrl(item.fileBase);
                let altText = `${product.name} ${item.alt}`;

                indicators.innerHTML += `
                    <button type="button" data-bs-target="#productCarousel" data-bs-slide-to="${index}" 
                        class="${index === 0 ? 'active' : ''}" aria-current="${index === 0 ? 'true' : 'false'}" 
                        aria-label="Slide ${index + 1}">
                    </button>
                `;
                
                inner.innerHTML += `
                    <div class="carousel-item ${index === 0 ? 'active' : ''}">
                        <img src="${imgUrl}" class="d-block w-100" alt="${altText}"
                            onerror="this.onerror=null;this.src='${getImageUrl('fallback_default')}';">
                    </div>
                `;
                index++;
            });
        }


        function updateTotalAndCheckStock() {
            const productId = document.getElementById('modalProductId').value;
            const size = document.getElementById('sizeSelect').value;
            const quantityInput = document.getElementById('quantityInput');
            const colorSelect = document.getElementById('colorSelect');
            
            const product = productData.find(p => p.id === productId);
            const selectedColor = product && product.isColorProduct ? colorSelect.value : null;

            let quantity = parseInt(quantityInput.value);
            const stock = getStock(productId, size, selectedColor); 
            const addButton = document.getElementById('addToOrderButton');

            if (quantity < 1 || isNaN(quantity)) {
                quantityInput.value = 1;
                quantity = 1;
            }

            if (stock > 0) {
                addButton.disabled = false;
                
                if (quantity > stock) {
                    quantityInput.value = stock;
                    quantity = stock;
                }
                
                addButton.textContent = `A침adir ${quantity} a Pedido`;
                
            } else {
                addButton.disabled = true;
                addButton.textContent = 'A침adir al Pedido (Agotado)';
                quantityInput.value = 0;
            }
        }

        document.getElementById('orderForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const productId = document.getElementById('modalProductId').value;
            const product = productData.find(p => p.id === productId);
            const size = document.getElementById('sizeSelect').value;
            const quantity = parseInt(document.getElementById('quantityInput').value);

            const colorSelect = document.getElementById('colorSelect');
            const color = product && product.isColorProduct ? colorSelect.value : null;

            if (!product || quantity <= 0) return;

            const stock = getStock(productId, size, color); 

            if (quantity > stock) {
                const colorText = color ? ` para el color ${color}` : '';
                alert(`Error: Solo quedan ${stock} unidades disponibles en talla ${size}${colorText}. Por favor, reduce la cantidad.`);
                return;
            }

            const existingItemIndex = currentOrder.findIndex(item => 
                item.productId === productId && item.size === size && item.color === color
            );

            if (existingItemIndex !== -1) {
                currentOrder[existingItemIndex].quantity += quantity;
            } else {
                currentOrder.push({
                    productId: productId,
                    name: product.name,
                    description: product.description,
                    size: size,
                    color: color, 
                    quantity: quantity,
                    price: product.price
                });
            }

            const detailModal = bootstrap.Modal.getInstance(document.getElementById('productDetailModal'));
            detailModal.hide();
            openOrdersModal(); 
        });
        
        function openOrdersModal() {
            renderOrdersList();
            const modal = new bootstrap.Modal(document.getElementById('ordersModal'));
            modal.show();
        }

        function renderOrdersList() {
            const list = document.getElementById('currentOrdersList');
            const emptyMessage = document.getElementById('emptyOrdersMessage');
            
            list.querySelectorAll('li:not(#emptyOrdersMessage)').forEach(item => {
                if(item !== emptyMessage) item.remove();
            });
            
            if (currentOrder.length === 0) {
                emptyMessage.style.display = 'block';
                document.getElementById('finalizeOrderButton').disabled = true;
                updateOrdersCounter(0);
                updateModalUI(false);
                updateOrdersTotal(); 
                return;
            }

            emptyMessage.style.display = 'none';
            let totalItems = 0;

            currentOrder.forEach((item, index) => {
                const totalPrice = item.quantity * item.price;
                totalItems += item.quantity;
                
                const colorText = item.color ? ` (${item.color})` : '';

                const listItem = document.createElement('li');
                listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                listItem.innerHTML = `
                    <div>
                        <span class="fw-bold">${item.name}</span> (${item.size})${colorText} x ${item.quantity}
                        <div class="text-muted small">$${item.price.toFixed(2)} c/u</div>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="fw-bold text-primary me-3">$${totalPrice.toFixed(2)}</span>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeItemFromOrder(${index})">
                            &times;
                        </button>
                    </div>
                `;
                list.insertBefore(listItem, emptyMessage);
            });
            
            updateOrdersCounter(currentOrder.length);
            updateModalUI(true);
            updateOrdersTotal(); 
        }

        window.removeItemFromOrder = function(index) {
            currentOrder.splice(index, 1);
            renderOrdersList();
        }

        function updateOrdersTotal() {
            const totalElement = document.getElementById('ordersTotal');
            const halfPaymentElement = document.getElementById('halfPaymentAmount');
            const halfPaymentCheck = document.getElementById('halfPaymentCheck');
            
            const subtotal = currentOrder.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            
            const halfAmount = subtotal / 2;
            halfPaymentElement.textContent = `$${halfAmount.toFixed(2)}`;

            if (halfPaymentCheck.checked) {
                totalElement.textContent = `$${halfAmount.toFixed(2)}`;
            } else {
                totalElement.textContent = `$${subtotal.toFixed(2)}`;
            }
        }
        
        document.getElementById('halfPaymentCheck').addEventListener('change', updateOrdersTotal); 

        function updateOrdersCounter(count) {
            document.getElementById('ordersCounter').textContent = currentOrder.length; 
        }

        function updateModalUI(hasItems) {
            const finalizeButton = document.getElementById('finalizeOrderButton');
            const clientDataForm = document.getElementById('clientDataForm');
            const paymentDetailsSection = document.getElementById('paymentDetailsSection');
            
            if (hasItems) {
                finalizeButton.disabled = !document.getElementById('clientDataForm').checkValidity();
                clientDataForm.style.display = 'block';
                paymentDetailsSection.style.display = 'block';
            } else {
                finalizeButton.disabled = true;
                clientDataForm.style.display = 'none';
                paymentDetailsSection.style.display = 'none';
            }
        }
        
        document.getElementById('clientDataForm').addEventListener('input', () => {
            if (currentOrder.length > 0) {
                document.getElementById('finalizeOrderButton').disabled = !document.getElementById('clientDataForm').checkValidity();
            }
        });

        // =======================================================
        // L칍GICA DE ENV칈O POR WHATSAPP Y DESCUENTO DE STOCK EN FIREBASE
        // =======================================================

        window.sendOrderToWhatsapp = async function() {
            if (currentOrder.length === 0 || !document.getElementById('clientDataForm').checkValidity()) {
                alert("Por favor, a침ade productos al pedido y completa tus datos de env칤o.");
                return;
            }
            
            // 0. Preparar el lote de actualizaciones para Firebase
            const updates = {};
            // Recargar el inventario justo antes de actualizar para asegurar la atomicidad (solo para verificar)
            await loadInventoryFromFirebase(); 

            // 0.1 Verificar y preparar el descuento de stock
            for (const item of currentOrder) {
                let key;
                if (item.color) {
                    key = `${item.productId}_${item.color}_${item.size}`;
                } else {
                    key = `${item.productId}_${item.size}`;
                }
                
                const currentStock = productInventory[key] || 0;
                const newStock = currentStock - item.quantity;

                if (newStock < 0) {
                    alert(`Error: El stock de ${item.name} (${item.size}${item.color ? ' ' + item.color : ''}) se agot칩 o fue modificado. Stock actual: ${currentStock}.`);
                    renderProductCards();
                    return;
                }
                
                updates[key] = newStock;
            }


            // 1. Escribir todas las actualizaciones de stock a Firebase
            if (Object.keys(updates).length > 0) {
                try {
                    // Usamos SET en el nodo ra칤z de inventario con el objeto combinado para actualizar
                    await set(inventoryRef, { ...productInventory, ...updates }); 
                    
                    // Actualiza la variable local despu칠s del 칠xito en Firebase
                    productInventory = { ...productInventory, ...updates }; 

                } catch (error) {
                    alert("Error cr칤tico: No se pudo actualizar el inventario en Firebase. El pedido no se procesar치.");
                    console.error("Firebase SET error:", error);
                    return; 
                }
            }


            // 2. Generar mensaje de WhatsApp
            const clientName = document.getElementById('clientName').value;
            const clientAddress = document.getElementById('clientAddress').value;
            const clientPhone = document.getElementById('clientPhone').value;
            const isHalfPayment = document.getElementById('halfPaymentCheck').checked;
            
            const total = currentOrder.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            const amountToPay = isHalfPayment ? total / 2 : total;

            let orderText = `*PEDIDO #${orderIdCounter + 1} - RPLAY*\n\n`;
            orderText += `*Total a Pagar:* $${amountToPay.toFixed(2)} (${isHalfPayment ? 'Anticipo 50%' : 'Pago Completo'})\n`;
            orderText += `*Productos:*\n`;
            
            currentOrder.forEach((item, index) => {
                const colorText = item.color ? ` (${item.color})` : '';
                orderText += `${index + 1}. *${item.name}* (${item.size})${colorText} x ${item.quantity} pza(s) - $${(item.quantity * item.price).toFixed(2)}\n`;
            });

            orderText += `\n*Datos del Cliente:*\n`;
            orderText += `Nombre: ${clientName}\n`;
            orderText += `Tel칠fono: ${clientPhone}\n`;
            orderText += `Direcci칩n: ${clientAddress}\n`;
            orderText += `\n*IMPORTANTE:* Adjunta aqu칤 tu comprobante de pago o transferencia para confirmar tu pedido.`;

            const whatsappURL = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(orderText)}`;

            // 3. Guardar orden en historial local
            orderIdCounter++;
            PENDING_ORDERS.push({
                id: orderIdCounter,
                items: JSON.parse(JSON.stringify(currentOrder)), 
                client: { name: clientName, address: clientAddress, phone: clientPhone },
                total: total,
                amountPaid: amountToPay,
                date: new Date().toLocaleString()
            });

            // 4. Limpiar el pedido actual y guardar todo
            currentOrder = [];
            saveOrdersStorage(); 
            
            // 5. Cerrar el modal y redirigir
            const ordersModal = bootstrap.Modal.getInstance(document.getElementById('ordersModal'));
            ordersModal.hide();

            // 6. Rerenderizar las tarjetas (para reflejar el nuevo stock de Firebase)
            renderProductCards();
            
            console.log("九 춰STOCK DESCONTADO EN FIREBASE! Procediendo a WhatsApp.");
            
            window.open(whatsappURL, '_blank');
        }

        // =======================================================
        // INICIALIZACI칍N FINAL
        // =======================================================

        document.addEventListener('DOMContentLoaded', async () => {
            
            const logoImage = document.getElementById('logo-image');
            if (logoImage) {
                 logoImage.src = getImageUrl('logo');
            }

            // 1. Cargar historial de 칩rdenes locales
            loadOrdersStorage();
            
            // 2. Cargar el inventario de forma AS칈NCRONA desde Firebase
            const spinner = document.getElementById('loading-spinner');
            if(spinner) spinner.style.display = 'block';

            await loadInventoryFromFirebase();
            
            if(spinner) spinner.style.display = 'none';

            // 3. Configurar Event Listeners (sin cambios)
            document.getElementById('product-list').addEventListener('click', (e) => {
                const target = e.target.closest('.btn-buy');
                if (target && !target.disabled) {
                    const productId = target.getAttribute('data-product-id');
                    openModalDetail(productId); 
                }
            });
            
            const quantityInput = document.getElementById('quantityInput');
            if (quantityInput) {
                quantityInput.addEventListener('change', updateTotalAndCheckStock);
                quantityInput.addEventListener('input', updateTotalAndCheckStock);
            }
            
            // 4. Renderizar las tarjetas con el stock de Firebase
            renderProductCards();
        });
    </script>
</body>
</html>
