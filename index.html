<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPLAY </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type='image/png' href="https://ventaplayera.github.io/RPLAY/logo.png">
    <style>
        /* Estilos Generales */
        body { background-color: #f7f7f7; }
        .price { font-size: 1.5rem; font-weight: 700; color: #ff3366; }
        .btn-buy { background-color: #ff3366; color: white; border: none; transition: background-color 0.3s; }
        .btn-buy:hover { background-color: #e6004c; color: white; }
        
        /* Estilos de las Tarjetas de Producto */
        .product-card {
            border: none; border-radius: 12px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease; margin-bottom: 25px; overflow: hidden; background-color: white;
            position: relative; 
        }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); }
        /* Imagen de producto adaptada a m√≥viles */
        .product-card img { 
            height: 250px; 
            object-fit: contain;
            background-color: #f0f0f0;
            border-top-left-radius: 12px; 
            border-top-right-radius: 12px; 
            width: 100%; /* Asegura que la imagen ocupe el ancho completo */
        }

        /* Estilos del Badge de Stock */
        .stock-badge {
            position: absolute; top: 10px; right: 10px;
            padding: 5px 10px; border-radius: 5px;
            font-weight: 700; font-size: 0.85rem;
            z-index: 10;
        }
        .stock-badge.agotado { background-color: #6c757d; color: white; } 
        .stock-badge.ultima { background-color: #ffc107; color: #343a40; } 

        /* Estilos para los Botones de Talla */
        .size-btn {
            border: 1px solid #ccc; padding: 5px 15px; margin-right: 5px; cursor: pointer;
            border-radius: 5px; transition: all 0.2s; background-color: white; display: inline-block;
        }
        .size-btn:hover:not(.selected):not(.disabled) { border-color: #ff3366; color: #ff3366; }
        .size-btn.selected { background-color: #ff3366; color: white; border-color: #ff3366; }
        .size-btn.disabled {
            background-color: #f7f7f7; color: #ccc; text-decoration: line-through;
            cursor: not-allowed; border-color: #f7f7f7;
        }
        
        /* Ajustes para el Modal de Detalle en m√≥viles */
        @media (max-width: 767.98px) {
            .modal-body .row > div {
                margin-bottom: 15px;
            }
        }

        /* üîí OCULTAR PANELES DE ADMINISTRACI√ìN POR DEFECTO üîí */
        #manualManagementPanel { display: none; } 
    </style>
</head>
<body>

    <div class="container my-5">
        
        <div class="d-flex align-items-center justify-content-center mb-5">
             <div class="d-flex align-items-center justify-content-center mb-5">
    <img src="https://imgur.com/mpCQaZg.jpg" alt="Logo de mi tienda" style="max-width: 250px; height: auto;">
</div>
            <h1 style="color: #ff3366; margin: 0;"> <link rel="icon" type="logo.png" href='logo.png'>RPLAY</h1>
        </div>
        
        <div class="container mb-5" id="manualManagementPanel">
            <h3 class="text-danger mb-3">Administraci√≥n de Pedidos Apartados</h3>
            <p class="text-muted small">Haz clic en "Liberar Stock" si el cliente no confirm√≥ el pago (gesti√≥n manual de las 24 horas).</p>
            <div id="ordersList" class="p-3 border rounded bg-white">
                <p class="text-center text-secondary" id="noOrdersMessage">No hay pedidos pendientes actualmente.</p>
            </div>
            <hr>
            <button class="btn btn-sm btn-outline-secondary" onclick="resetAllStock()">REINICIAR TODO EL INVENTARIO</button>
            <p class="text-muted small mt-2">
                Para **modificar el stock inicial**, usa la funci√≥n `setStock` en la consola (F12).
                <br>Ejemplo: **`setStock('PROD_001', 'M', 5)`**
            </p>
        </div>
        
        <div class="row" id="product-list">
            </div>
    </div>

    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalLabel">Detalle y Pago</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
                                <div class="carousel-inner">
                                    <div class="carousel-item active">
                                        <img id="modal-img-front" src="" class="d-block w-100" alt="Delantera de la Playera">
                                    </div>
                                    <div class="carousel-item">
                                        <img id="modal-img-back" src="" class="d-block w-100" alt="Espalda de la Playera">
                                    </div>
                                </div>
                                <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                </button>
                            </div>
                        </div>

                        <div class="col-md-6">
                            
                            <div id="selection-step">
                                <h4 class="mt-3" id="product-name"></h4>
                                <p class="text-muted" id="product-description"></p>
                                
                                <div class="mb-4">
                                    <h6>Talla:</h6>
                                    <div id="size-options"></div>
                                    <small id="size-status" class="text-secondary mt-2"></small>
                                </div>
                                
                                <div class="mb-4">
                                    <h6>Cantidad de Piezas:</h6>
                                    <input type="number" id="quantityInput" class="form-control" value="1" min="1" max="10" style="width: 100px;">
                                    <small id="quantity-status" class="text-secondary mt-2"></small>
                                </div>
                                
                                <hr>
                                
                                <p>Precio Total: <strong id="total-price" class="text-danger"></strong></p>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" value="" id="halfPaymentCheck" checked>
                                    <label class="form-check-label" for="halfPaymentCheck">Pagar la Mitad Ahora (Apartar)</label>
                                </div>
                                <p>Monto a Pagar Ahora: <strong id="payment-due" style="font-size: 1.4rem; color: green;"></strong></p>
                                <small class="text-muted">El resto se pagar√° al momento de la entrega el 28 de Noviembre.</small>
                            </div>

                            <div id="payment-step" style="display:none;">
                                <h4 class="mt-3 mb-4">Datos del Comprador y Env√≠o</h4>
                                <p class="alert alert-info small">
                                    Est√°s comprando <strong id="final-quantity-display">1</strong> pieza(s) talla <strong id="final-size-display"></strong> por <strong id="final-price-display"></strong>.
                                    Llena tus datos para guardar el pedido y ver las instrucciones de pago por transferencia.
                                </p>

                                <div class="mb-3">
                                    <label for="clientName" class="form-label">Nombre Completo (*):</label>
                                    <input type="text" class="form-control" id="clientName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="clientPhone" class="form-label">Tel√©fono/WhatsApp (*):</label>
                                    <input type="tel" class="form-control" id="clientPhone" required>
                                </div>
                                <div class="mb-3">
                                    <label for="clientAddress" class="form-label">Direcci√≥n de Env√≠o Completa (*):</label>
                                    <textarea class="form-control" id="clientAddress" rows="2" required></textarea>
                                </div>
                                
                                <div id="payment-error" class="text-danger mb-3" style="display:none;">Por favor, completa todos los campos requeridos (*).</div>
                            </div>
                            
                            <div id="transfer-info" style="display:none;">
                                <h4 class="mt-3 mb-4 text-success">¬°Pedido Generado!</h4>
                                <p>Hola <strong id="client-name-display"></strong>. Para confirmar tu compra de <span id="final-qty-conf">1</span> playera(s) (<span id="final-item-display"></span>, Talla <span id="final-size-conf"></span>), realiza la transferencia por el monto de <strong id="final-amount-conf" class="text-success"></strong> a la siguiente cuenta:</p>
                                <hr>
                                
                                <h5 class="text-primary">Datos de Transferencia Bancaria</h5>
                                <p class="mb-1"><strong>Banco:</strong> BANCOMER (BBVA)</p>
                                <p class="mb-1"><strong>N√∫mero de Cuenta:</strong> 0123 4567 8901 2345</p>
                                <p class="mb-1"><strong>CLABE Interbancaria:</strong> 012000000000000000</p>
                                <p class="mb-1"><strong>Beneficiario:</strong> MI TIENDA DE PLAYERAS S.A. DE C.V.</p>
                                
                                <hr>
                                <p class="text-center">¬°Haz clic en el bot√≥n de WhatsApp abajo para enviar tus datos y el comprobante!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <a href="#" target="_blank" class="btn btn-success" id="whatsapp-confirm-button" style="display:none;">
                        Enviar Comprobante por WhatsApp
                    </a>
                    
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="modal-close-button">Cerrar</button>
                    
                    <button type="button" class="btn btn-buy" id="modal-main-button" disabled>Pagar Ahora</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        
        // --- 1. GENERACI√ìN DIN√ÅMICA DE INVENTARIO INICIAL (34 Productos) ---
        const productInventory = {};
        const productData = [];
        const sizes = ["M", "L", "XL"]; 
        const FIXED_PRICE = 250.00; 
        const DEFAULT_STOCK = 2; // *** STOCK BASE ESTABLECIDO EN 2 ***

        for (let i = 1; i <= 34; i++) {
            const id = `PROD_${String(i).padStart(3, '0')}`;
            
            const stock = {};
            sizes.forEach(size => {
                stock[size] = DEFAULT_STOCK; 
            });
            
            // Stock de demostraci√≥n inicial (Si quieres modificar el stock base de alg√∫n producto)
            if (i === 1) { 
                stock.S = 1; 
            }
            
            productInventory[id] = stock;

            let mainImg, frontImg, backImg;

            // ==========================================================
            // INICIO DE ASIGNACI√ìN DE RUTAS DE IMAGEN √öNICAS
            // *** RECUERDA CAMBIAR LAS RUTAS './images/...' POR LAS TUYAS ***
            // ==========================================================
            if (i === 1) { 
                // Playera Modelo No. 1
                mainImg = 'https://ventaplayera.github.io/RPLAY/Xime1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Xime1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Xime2.png';
            } else if (i === 2) { 
                // Playera Modelo No. 2
                mainImg = 'https://ventaplayera.github.io/RPLAY/Xime3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Xime3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Xime4.png';
            } else if (i === 3) { 
                // Playera Modelo No. 3
                mainImg = 'https://ventaplayera.github.io/RPLAY/Lucy1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Lucy1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Lucy2.png';
            }  else if (i === 4) { 
                // Playera Modelo No. 4
                mainImg = 'https://ventaplayera.github.io/RPLAY/Lucy3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Lucy3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Lucy4.png';
            }  else if (i === 5) { 
                // Playera Modelo No. 5
                mainImg = 'https://ventaplayera.github.io/RPLAY/Raul1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Raul1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Raul2.png';
            }  else if (i === 6) { 
                // Playera Modelo No. 6
                mainImg = 'https://ventaplayera.github.io/RPLAY/Raul3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Raul3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Raul4.png';
            } else if (i === 7) { 
                // Playera Modelo No. 5
                mainImg = 'https://ventaplayera.github.io/RPLAY/Abi1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Abi1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Abi2.png';
            }  else if (i === 8) { 
                // Playera Modelo No. 6
                mainImg = 'https://ventaplayera.github.io/RPLAY/Abi3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Abil3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Abi4.png';
            }  else if (i === 9) { 
                // Playera Modelo No. 6
                mainImg = 'https://ventaplayera.github.io/RPLAY/Dani1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Dani1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Dani2.png';
            }  else if (i === 10) { 
                // Playera Modelo No. 6
                mainImg = 'https://ventaplayera.github.io/RPLAY/Dani3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Dani3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Dani4.png';
            }  else if (i === 11) { 
                // Playera Modelo No. 6
                mainImg = 'https://ventaplayera.github.io/RPLAY/Dali1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Dali1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Dali2.png';
            }  else if (i === 12) { 
                // Playera Modelo No. 6
                mainImg = 'https://ventaplayera.github.io/RPLAY/Dali3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Dali3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Dali4.png';
            }  else if (i === 13) { 
                // Playera Modelo No. 6
                mainImg = 'https://ventaplayera.github.io/RPLAY/Yose1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Yose1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Yose2.png';
            }  else if (i === 14) { 
                // Playera Modelo No. 6
                mainImg = 'https://ventaplayera.github.io/RPLAY/Yose3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Yose3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Yose4.png';
            }  else if (i === 15) { 
                // Playera Modelo No. 6
                mainImg = 'https://ventaplayera.github.io/RPLAY/Keila.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Keila.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Keila2.png';
            }  else if (i === 16) { 
                // Playera Modelo No. 6
                mainImg = 'https://ventaplayera.github.io/RPLAY/Keila3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Keila3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Keila4.png';
            }  else if (i === 17) { 
                // Playera Modelo No. 6
                mainImg = 'https://ventaplayera.github.io/RPLAY/Kenji1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Kenji1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Kenji2.png';
            }  else if (i === 18) { 
                // Playera Modelo No. 6
                mainImg = 'https://ventaplayera.github.io/RPLAY/Kenji3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Kenji3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Kenji4.png';
            }  else if (i === 19) { 
                // Playera Modelo No. 6
                mainImg = 'https://ventaplayera.github.io/RPLAY/Abi3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Abil3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Abi4.png';
            }  else if (i === 20) { 
                // Playera Modelo No. 6
                mainImg = 'https://ventaplayera.github.io/RPLAY/Abi3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Abil3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Abi4.png';
            }  else if (i === 21) { 
                // Playera Modelo No. 6
                mainImg = 'https://ventaplayera.github.io/RPLAY/Abi3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Abil3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Abi4.png';
            }  else if (i === 22) { 
                // Playera Modelo No. 6
                mainImg = 'https://ventaplayera.github.io/RPLAY/Abi3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Abil3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Abi4.png';
            }  else if (i === 23) { 
                // Playera Modelo No. 6
                mainImg = 'https://ventaplayera.github.io/RPLAY/Abi3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Abil3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Abi4.png';
            }  else if (i === 24) { 
                // Playera Modelo No. 6
                mainImg = 'https://ventaplayera.github.io/RPLAY/Abi3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Abil3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Abi4.png';
            }  else if (i === 25) { 
                // Playera Modelo No. 6
                mainImg = 'https://ventaplayera.github.io/RPLAY/Abi3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Abil3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Abi4.png';
            }  else if (i === 26) { 
                // Playera Modelo No. 6
                mainImg = 'https://ventaplayera.github.io/RPLAY/Abi3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Abil3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Abi4.png';
            }  else if (i === 27) { 
                // Playera Modelo No. 6
                mainImg = 'https://ventaplayera.github.io/RPLAY/Abi3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Abil3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Abi4.png';
            }  else if (i === 28) { 
                // Playera Modelo No. 6
                mainImg = 'https://ventaplayera.github.io/RPLAY/Abi3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Abil3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Abi4.png';
            }  else if (i === 29) { 
                // Playera Modelo No. 6
                mainImg = 'https://ventaplayera.github.io/RPLAY/Abi3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Abil3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Abi4.png';
            }  else if (i === 30) { 
                // Playera Modelo No. 6
                mainImg = 'https://ventaplayera.github.io/RPLAY/Abi3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Abil3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Abi4.png';
            }  else if (i ===31) { 
                // Playera Modelo No. 6
                mainImg = 'https://ventaplayera.github.io/RPLAY/Abi3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Abil3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Abi4.png';
            }  else if (i === 32) { 
                // Playera Modelo No. 6
                mainImg = 'https://ventaplayera.github.io/RPLAY/Abi3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Abil3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Abi4.png';
            }  else if (i === 33) { 
                // Playera Modelo No. 6
                mainImg = 'https://ventaplayera.github.io/RPLAY/Abi3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Abil3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Abi4.png';
            }  else if (i === 34) { 
                // Playera Modelo No. 6
                mainImg = 'https://ventaplayera.github.io/RPLAY/Abi3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Abil3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Abi4.png';
            } 
            /*
            *** A√ëADE M√ÅS BLOQUES 'else if' AQU√ç PARA CADA MODELO QUE QUIERAS PERSONALIZAR ***
            
     
            
            */
            else {
                // Opci√≥n de reserva: Mantiene el placeholder para los productos que no has personalizado (i = 4 a 34)
                mainImg = 'https://via.placeholder.com/250x250/F4E3F5?text=Modelo+' + i;
                frontImg = 'https://via.placeholder.com/500x500/F4E3F5?text=Frente+' + i;
                backImg = 'https://via.placeholder.com/500x500/F4E3F5?text=Espalda+' + i;
            }
            // ==========================================================
            
            productData.push({
                id: id,
                name: `Playera Modelo No. ${i}`,
                price: FIXED_PRICE.toFixed(2), 
                description: `Dise√±o exclusivo #${i} con estampado digital de alta calidad. Tela de algod√≥n 100%.`,
                img_main: mainImg,
                img_front: frontImg,
                img_back: backImg
            });
        }
        
        // --- 2. INVENTARIO PERSISTENTE (Pedidos Ya Confirmados) ---
        // Carga los pedidos guardados para persistencia (el stock no se reinicia al cargar la p√°gina)
        let localOrders = JSON.parse(localStorage.getItem('simulatedOrders')) || {};
        
        // --- 3. L√≥gica del Sistema ---

        document.addEventListener('DOMContentLoaded', function () {
            
            // --- REFERENCIAS A ELEMENTOS HTML ---
            const productListContainer = document.getElementById('product-list');
            const paymentModal = document.getElementById('paymentModal');
            const selectionStep = document.getElementById('selection-step');
            const paymentStep = document.getElementById('payment-step');
            const transferInfo = document.getElementById('transfer-info');
            const sizeOptionsContainer = document.getElementById('size-options');
            const halfPaymentCheck = document.getElementById('halfPaymentCheck');
            const clientNameInput = document.getElementById('clientName');
            const clientPhoneInput = document.getElementById('clientPhone');
            const clientAddressInput = document.getElementById('clientAddress');
            const mainButton = document.getElementById('modal-main-button');
            const whatsappButton = document.getElementById('whatsapp-confirm-button'); 
            const ordersList = document.getElementById('ordersList'); 
            const sizeStatusEl = document.getElementById('size-status'); 
            // REFERENCIAS PARA CANTIDAD
            const quantityInput = document.getElementById('quantityInput');
            const quantityStatusEl = document.getElementById('quantity-status');
            
            // üîí ELEMENTOS DE ADMINISTRACI√ìN OCULTOS
            const managementPanel = document.getElementById('manualManagementPanel');

            // Variables de estado
            let currentPrice = FIXED_PRICE;
            let currentSelectedSize = null;
            let currentProductName = '';
            let currentProductID = ''; 
            const WHATSAPP_PHONE = "529991480151"; 
            
            // --- Funciones de L√≥gica ---
            
            function saveLocalOrders() {
                localStorage.setItem('simulatedOrders', JSON.stringify(localOrders));
                if (managementPanel.style.display === 'block') {
                    renderManualManagementPanel(); 
                }
            }

            /**
             * FUNCI√ìN CLAVE: Devuelve el stock real disponible 
             * (Inventario Inicial - Pedidos Apartados)
             */
            function getAvailableStock(productID, size) {
                const stock = productInventory[productID] && productInventory[productID][size] !== undefined ? productInventory[productID][size] : 0;
                const pendingOrders = localOrders[`${productID}-${size}`] || 0; 
                return stock - pendingOrders;
            }
            
            /**
             * FUNCI√ìN CRUCIAL: Modifica el stock INICIAL de un producto/talla 
             * (Para uso externo en la consola F12)
             */
            window.setStock = function(productID, size, newStock) {
                if (productInventory[productID] && productInventory[productID][size] !== undefined) {
                    productInventory[productID][size] = Math.max(0, newStock); 
                    
                    initializeBadges();
                    
                    if (currentProductID === productID) {
                        createSizeButtons(currentProductID);
                        resetModalView();
                    }
                    
                    console.log(`‚úÖ Stock inicial modificado: ${productID}, Talla ${size}. Nuevo Stock: ${productInventory[productID][size]}`);
                    alert(`Stock de ${productID} (Talla ${size}) cambiado a ${newStock}.`);

                } else {
                    console.error(`Error: Producto ID '${productID}' o Talla '${size}' no encontrados.`);
                    alert(`Error: Producto ID '${productID}' o Talla '${size}' no encontrados.`);
                }
            };
            // ----------------------------------------------------

            // DIBUJAR TARJETAS DE PRODUCTO DIN√ÅMICAMENTE
            function renderProductCards() {
                let html = '';
                productData.forEach(product => {
                    html += `
                        <div class="col-lg-3 col-md-4 col-sm-6 d-flex">
                            <div class="card product-card flex-fill" data-product-id="${product.id}">
                                <span class="stock-badge" id="badge-${product.id}"></span> 
                                <img src="${product.img_main}" class="card-img-top" alt="Playera ${product.name}">
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title">${product.name}</h5>
                                    <p class="card-text text-muted">${product.description.substring(0, 50)}...</p>
                                    <div class="mt-auto">
                                        <p class="price mb-2">$${product.price} MXN</p>
                                        <button 
                                            class="btn btn-block btn-buy w-100" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#paymentModal" 
                                            data-product-id="${product.id}"
                                            data-price="${product.price}" 
                                            data-name="${product.name}"
                                            data-description="${product.description}"
                                            data-img-front="${product.img_front}" 
                                            data-img-back="${product.img_back}">
                                            Ver Detalle y Comprar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                productListContainer.innerHTML = html;
            }

            // FUNCI√ìN: Actualiza el badge de stock en la tarjeta principal
            function updateProductBadge(productID) {
                const badgeEl = document.getElementById(`badge-${productID}`);
                if (!badgeEl) return;
                
                let totalStock = 0;
                let isLastUnit = false;

                if (productInventory[productID]) {
                    Object.keys(productInventory[productID]).forEach(size => {
                        const available = getAvailableStock(productID, size);
                        totalStock += available;
                        if (available === 1) isLastUnit = true;
                    });
                }

                badgeEl.textContent = '';
                badgeEl.className = 'stock-badge';

                if (totalStock === 0) {
                    badgeEl.textContent = 'AGOTADO';
                    badgeEl.classList.add('agotado');
                } else if (isLastUnit || totalStock <= 5) { 
                    badgeEl.textContent = '¬°POCAS UNIDADES!';
                    badgeEl.classList.add('ultima');
                }
            }

            function initializeBadges() {
                productData.forEach(product => updateProductBadge(product.id));
            }
            
            // FUNCI√ìN: Renderiza los botones de talla y maneja stock
            function createSizeButtons(productID) {
                if (!sizeOptionsContainer) return;
                const sizes = productInventory[productID] ? Object.keys(productInventory[productID]) : [];
                sizeOptionsContainer.innerHTML = ''; 
                currentSelectedSize = null; 
                sizeStatusEl.textContent = '';
                mainButton.disabled = true;
                
                // Asegurar que el input de cantidad est√© disponible pero sin datos de stock m√°ximo
                quantityInput.disabled = true;
                quantityInput.value = 1;
                quantityStatusEl.textContent = 'Selecciona una talla para continuar.';


                sizes.forEach(size => {
                    const availableStock = getAvailableStock(productID, size); 
                    const button = document.createElement('span');
                    button.textContent = size;
                    button.classList.add('size-btn');
                    button.setAttribute('data-size', size);
                    
                    if (availableStock <= 0) {
                        button.classList.add('disabled');
                        button.title = 'Talla Agotada';
                        button.textContent = `${size} (Agotada)`; 
                    } else {
                        if (availableStock === 1) {
                            button.title = '¬°√öltima Unidad!';
                        }
                        button.addEventListener('click', () => handleSizeSelection(button, size, availableStock));
                    }
                    sizeOptionsContainer.appendChild(button);
                });
            }

            function handleSizeSelection(selectedButton, size, stock) {
                document.querySelectorAll('.size-btn').forEach(btn => btn.classList.remove('selected'));
                selectedButton.classList.add('selected');
                
                currentSelectedSize = size;
                mainButton.disabled = false;
                mainButton.textContent = 'Continuar a Pago';

                // *** L√ìGICA DE CANTIDAD ***
                quantityInput.max = stock; // Establece el m√°ximo al stock disponible
                quantityInput.value = 1;   // Reinicia a 1 por defecto
                quantityInput.disabled = (stock <= 1); // Deshabilita si solo hay 1 unidad

                quantityStatusEl.textContent = `Puedes seleccionar hasta ${stock} unidad${stock !== 1 ? 'es' : ''}.`;
                // *******************************
                
                sizeStatusEl.style.display = 'block';
                if (stock === 1) {
                    sizeStatusEl.textContent = '¬°Solo queda 1 unidad! ¬°Ap√∫rate!';
                    sizeStatusEl.className = 'text-danger mt-2';
                } else if (stock <= 3) {
                    sizeStatusEl.textContent = `Quedan ${stock} unidades.`;
                    sizeStatusEl.className = 'text-warning mt-2';
                } else {
                    sizeStatusEl.textContent = `Stock disponible: ${stock} unidades.`;
                    sizeStatusEl.className = 'text-secondary mt-2';
                }
                
                // Asegurar que el precio se actualice con la cantidad actual (1)
                updatePaymentAmounts();
            }
            
            function resetModalView() {
                selectionStep.style.display = 'block';
                paymentStep.style.display = 'none';
                transferInfo.style.display = 'none';
                mainButton.textContent = 'Pagar Ahora';
                mainButton.disabled = true;
                document.getElementById('payment-error').style.display = 'none';
                whatsappButton.style.display = 'none'; 
                sizeStatusEl.style.display = 'none'; 
                quantityInput.value = 1; // Resetear cantidad
            }
            
            function saveClientData() {
                const data = {
                    name: clientNameInput.value,
                    phone: clientPhoneInput.value,
                    address: clientAddressInput.value
                };
                localStorage.setItem('clientFormData', JSON.stringify(data));
            }

            function loadClientData() {
                const data = JSON.parse(localStorage.getItem('clientFormData'));
                if (data) {
                    clientNameInput.value = data.name || '';
                    clientPhoneInput.value = data.phone || '';
                    clientAddressInput.value = data.address || '';
                }
            }
            
            // FUNCI√ìN: LIBERAR UN PEDIDO ESPEC√çFICO (Gesti√≥n Manual)
            window.releaseOrder = function(orderKey) {
                if (confirm(`¬øEst√°s seguro de liberar el stock para el pedido ${orderKey}? Esto devolver√° la unidad al inventario disponible.`)) {
                    // La clave (PROD_001-M-2) tiene la cantidad apartada
                    const [productID, size, quantityAparted] = orderKey.split('-');
                    const qty = parseInt(quantityAparted); 
                    const sizeKey = `${productID}-${size}`;
                    
                    if (localOrders[sizeKey] && localOrders[sizeKey] >= qty) {
                        localOrders[sizeKey] -= qty;
                        if (localOrders[sizeKey] === 0) {
                            delete localOrders[sizeKey];
                        }
                        saveLocalOrders(); 
                        initializeBadges();
                        if (currentProductID === productID) {
                            createSizeButtons(currentProductID);
                        }
                        alert(`Stock de ${qty} unidad(es) de ${productID} (Talla ${size}) liberado con √©xito.`);
                    }
                }
            };

            // FUNCI√ìN: REINICIO TOTAL DE STOCK (Borra localOrders y recarga)
            window.resetAllStock = function() {
                if (confirm('ADVERTENCIA: ¬øEst√°s seguro de REINICIAR TODO el inventario? Esto borrar√° todos los pedidos pendientes.')) {
                    // Borra los pedidos apartados y los datos de cliente
                    localStorage.removeItem('simulatedOrders'); 
                    localStorage.removeItem('clientFormData');
                    
                    alert('El inventario y los datos de cliente han sido reiniciados. Recargando la p√°gina para mostrar el stock completo.');
                    window.location.reload(); 
                }
            };
            
            // FUNCI√ìN: RENDERIZAR EL PANEL DE GESTI√ìN MANUAL
            function renderManualManagementPanel() {
                let html = '';
                const keys = Object.keys(localOrders).filter(key => localOrders[key] > 0);
                
                if (keys.length === 0) {
                    ordersList.innerHTML = '<p class="text-center text-secondary" id="noOrdersMessage">No hay pedidos pendientes actualmente.</p>';
                    return;
                }

                keys.forEach(key => {
                    const [productID, size] = key.split('-');
                    const quantity = localOrders[key];
                    
                    const productInfo = productData.find(p => p.id === productID);
                    const productName = productInfo ? productInfo.name : productID;
                    
                    // Se crea una clave √∫nica para la funci√≥n releaseOrder
                    const orderKeyForButton = `${productID}-${size}-${quantity}`; 

                    html += `
                        <div class="d-flex justify-content-between align-items-center p-2 mb-2 border-bottom">
                            <div>
                                <strong>${productName}</strong> (Talla: ${size})
                                <span class="badge bg-warning text-dark ms-2">${quantity} Unidad(es) Apartada(s)</span>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="releaseOrder('${orderKeyForButton}')">Liberar ${quantity} Stock</button>
                        </div>
                    `;
                });

                ordersList.innerHTML = html;
            }


            // --- EVENTO PRINCIPAL: FLUJO DE COMPRA ---
            mainButton.addEventListener('click', () => {
                const currentButtonText = mainButton.textContent;
                const quantity = parseInt(quantityInput.value) || 1;
                
                if (currentButtonText === 'Continuar a Pago' || currentButtonText === 'Pagar Ahora') {
                    if (!currentSelectedSize) {
                        alert('Por favor, selecciona una talla.');
                        return;
                    }
                    if (quantity < 1) {
                         alert('La cantidad m√≠nima es 1.');
                         return;
                    }
                    if (quantity > getAvailableStock(currentProductID, currentSelectedSize)) {
                         alert('La cantidad excede el stock disponible. Por favor, revisa.');
                         return;
                    }
                    
                    selectionStep.style.display = 'none';
                    paymentStep.style.display = 'block';
                    mainButton.textContent = 'Generar Pedido';
                    
                    document.getElementById('final-size-display').textContent = currentSelectedSize;
                    document.getElementById('final-quantity-display').textContent = quantity; // Muestra la cantidad
                    
                    loadClientData();
                    
                } else if (currentButtonText === 'Generar Pedido') {
                    
                    const clientName = clientNameInput.value.trim();
                    const clientPhone = clientPhoneInput.value.trim();
                    const clientAddress = clientAddressInput.value.trim();
                    
                    if (clientName.length < 3 || clientPhone.length < 8 || clientAddress.length < 10) {
                        document.getElementById('payment-error').style.display = 'block';
                        return;
                    }
                    
                    saveClientData();
                    
                    // Doble chequeo de stock antes de generar el pedido (por si se agot√≥ en el inter)
                    if (quantity > getAvailableStock(currentProductID, currentSelectedSize)) {
                        alert('¬°Lo sentimos! La cantidad solicitada excede el stock disponible.');
                        resetModalView();
                        createSizeButtons(currentProductID);
                        initializeBadges();
                        return;
                    }

                    const amountToPay = document.getElementById('final-amount-conf').textContent;
                    
                    const message = `Hola, acabo de generar un pedido:
*Cliente:* ${clientName}
*Producto:* ${currentProductName} (${quantity} piezas, Talla: ${currentSelectedSize})
*Monto a pagar:* ${amountToPay}
*Tel√©fono de contacto:* ${clientPhone}
*Direcci√≥n:* ${clientAddress}
Por favor, conf√≠rmame los datos. Adjunto el comprobante de pago.`;
                    
                    const encodedMessage = encodeURIComponent(message);
                    const whatsappLink = `https://wa.me/${WHATSAPP_PHONE}?text=${encodedMessage}`;
                    whatsappButton.href = whatsappLink;

                    document.getElementById('payment-error').style.display = 'none';
                    paymentStep.style.display = 'none';
                    transferInfo.style.display = 'block';
                    mainButton.style.display = 'none'; 
                    whatsappButton.style.display = 'inline-block'; 

                    document.getElementById('client-name-display').textContent = clientName;
                    document.getElementById('final-size-conf').textContent = currentSelectedSize;
                    document.getElementById('final-qty-conf').textContent = quantity; // Muestra la cantidad final
                    document.getElementById('final-item-display').textContent = currentProductName;
                }
            });

            // --- EVENTO CRUCIAL: DESCUENTO DE INVENTARIO ---
            whatsappButton.addEventListener('click', function(e) {
                if (transferInfo.style.display === 'block' && currentProductID && currentSelectedSize) {
                    const sizeKey = `${currentProductID}-${currentSelectedSize}`;
                    const quantityToApart = parseInt(quantityInput.value); 
                    
                    // Aumenta el contador de "apartados" por la cantidad elegida
                    localOrders[sizeKey] = (localOrders[sizeKey] || 0) + quantityToApart; 
                    saveLocalOrders(); 
                    
                    // Refresca la vista
                    createSizeButtons(currentProductID);
                    initializeBadges();
                } else {
                    e.preventDefault(); 
                }
            });
            // ----------------------------------------------------------------------------------

            // L√≥gica de Modal (Apertura y cierres)
            paymentModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget; 
                currentProductID = button.getAttribute('data-product-id');
                currentPrice = parseFloat(button.getAttribute('data-price'));
                currentProductName = button.getAttribute('data-name');
                
                document.getElementById('product-name').textContent = currentProductName;
                document.getElementById('product-description').textContent = button.getAttribute('data-description');
                document.getElementById('modal-img-front').src = button.getAttribute('data-img-front');
                document.getElementById('modal-img-back').src = button.getAttribute('data-img-back');

                resetModalView(); 
                document.getElementById('modal-main-button').style.display = 'inline-block';
                
                createSizeButtons(currentProductID);
                updatePaymentAmounts();
            });

            // Evento para actualizar montos cuando se cambia la cantidad o el check de mitad de pago
            quantityInput.addEventListener('input', updatePaymentAmounts);
            halfPaymentCheck.addEventListener('change', updatePaymentAmounts);
            
            function updatePaymentAmounts() {
                const dueDisplay = document.getElementById('payment-due');
                const finalPriceDisplay = document.getElementById('final-price-display');
                const finalAmountConf = document.getElementById('final-amount-conf');
                
                const quantity = parseInt(quantityInput.value) || 1; // Lee la cantidad del input

                // Validaci√≥n de cantidad para no exceder el m√°ximo (stock disponible)
                const maxStock = parseInt(quantityInput.max);
                if (quantity > maxStock) {
                    quantityInput.value = maxStock;
                    // Llamar recursivamente para recalcular con el valor m√°ximo
                    return updatePaymentAmounts(); 
                }
                
                const total = currentPrice * quantity;
                
                // Actualiza el precio total en el modal
                document.getElementById('total-price').textContent = `$${total.toFixed(2)} MXN`; 

                let amountDue = total;
                if (halfPaymentCheck.checked) {
                    amountDue = total / 2;
                }
                
                dueDisplay.textContent = `$${amountDue.toFixed(2)} MXN`;
                finalPriceDisplay.textContent = `$${amountDue.toFixed(2)} MXN`;
                finalAmountConf.textContent = `$${amountDue.toFixed(2)} MXN`;
            }
            
            // üîí L√ìGICA DE ACTIVACI√ìN SECRETA DEL MODO ADMINISTRADOR (V√çA CONSOLA)
            window.showAdminPanel = function() {
                const password = prompt("Ingrese la clave de administrador para activar el panel:");
                const SECRET_KEY = "ADMIN123"; 
                
                if (password === SECRET_KEY) {
                    if (managementPanel.style.display === 'none' || managementPanel.style.display === '') {
                        managementPanel.style.display = 'block';
                        renderManualManagementPanel();
                        alert('Modo Administrador Activado.');
                    } else {
                        managementPanel.style.display = 'none';
                        alert('Modo Administrador Desactivado.');
                    }
                } else {
                    alert('Clave incorrecta. Acceso denegado.');
                }
            };
            // ---------------------------------------------------------
            
            // üí° INICIALIZACI√ìN FINAL
            renderProductCards();
            initializeBadges();
        });
    </script>
</body>

</html>
















