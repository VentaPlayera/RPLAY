<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPLAY - Venta de Playeras</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --primary-color: #6a1b9a; /* Púrpura */
            --secondary-color: #ff9800; /* Naranja */
            --light-bg: #f3f3f3;
            --dark-bg: #1c1c1c;
            --text-light: #ffffff;
            --text-dark: #333333;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--light-bg);
            color: var(--text-dark);
            padding-top: 56px; /* Altura del navbar fijo */
        }

        .navbar {
            background-color: var(--primary-color) !important;
        }

        .navbar-brand, .nav-link, .btn-whatsapp {
            color: var(--text-light) !important;
        }

        .navbar-toggler-icon {
            filter: invert(1);
        }

        .hero-section {
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: 40px 0;
            margin-bottom: 20px;
            text-align: center;
        }

        .product-card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .product-card:hover {
            transform: translateY(-5px);
        }

        .card-img-top {
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            object-fit: contain;
            height: 300px; /* Altura fija para la imagen */
            background-color: #ffffff;
            padding: 10px;
        }

        .card-body {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .btn-buy {
            background-color: var(--secondary-color);
            color: var(--text-light);
            border: none;
            transition: background-color 0.2s;
        }

        .btn-buy:hover {
            background-color: #ffb74d; /* Tono más claro de naranja */
            color: var(--text-dark);
        }

        .cart-modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        .whatsapp-float {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #25d366; /* Verde de WhatsApp */
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
            text-decoration: none;
        }

        .whatsapp-float:hover {
            transform: scale(1.1);
            color: white;
        }

        .stock-indicator {
            font-weight: bold;
            font-size: 0.85rem;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark fixed-top shadow">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">RPLAY</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <button class="btn btn-warning btn-sm" id="cartButton" type="button" data-bs-toggle="modal" data-bs-target="#cartModal">
                            <i class="fas fa-shopping-cart"></i> Carrito (<span id="cartCount">0</span>)
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="hero-section shadow">
        <div class="container">
            <h1>¡El Merch Más Exclusivo!</h1>
            <p>Encuentra tu playera favorita de tus artistas con stock en tiempo real.</p>
        </div>
    </div>

    <div class="container my-5">
        <h2 class="text-center mb-4 text-primary">Nuestros Productos</h2>
        <div id="productsContainer" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
            <div id="loadingMessage" class="col-12 text-center text-muted">Cargando inventario...</div>
        </div>
    </div>

    <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="cartModalLabel"><i class="fas fa-shopping-cart"></i> Tu Carrito de Compras</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body cart-modal-body">
                    <div id="cartItems">
                        <p class="text-muted text-center" id="emptyCartMessage">El carrito está vacío.</p>
                    </div>
                    <hr>
                    <h5 class="text-end">Total: <span id="cartTotal">$0.00</span></h5>
                    <p class="text-muted text-center small mt-3">¡Recuerda que el stock se reserva al finalizar el pedido!</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Seguir Comprando</button>
                    <button type="button" class="btn btn-buy" id="finalizeOrderButton" data-bs-toggle="modal" data-bs-target="#ordersModal" disabled>
                        <i class="fab fa-whatsapp"></i> Finalizar Pedido
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="ordersModal" tabindex="-1" aria-labelledby="ordersModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="ordersModalLabel">Confirmar Pedido</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Al hacer clic en "Enviar Pedido por WhatsApp", tu inventario se **descontará** y se reservará para ti. Serás redirigido a WhatsApp con un mensaje preescrito.</p>
                    <div class="form-floating mb-3">
                        <textarea class="form-control" placeholder="Escribe tu dirección, nombre o cualquier nota adicional" id="customerNotes" style="height: 100px"></textarea>
                        <label for="customerNotes">Notas de tu Pedido (Opcional)</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" id="sendOrderToWhatsappButton">
                        <i class="fab fa-whatsapp"></i> Enviar Pedido por WhatsApp
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="productDetailModal" tabindex="-1" aria-labelledby="productDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="productDetailModalLabel">Detalle del Producto</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="productDetailContent">
                        </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <a href="#" class="whatsapp-float" data-bs-toggle="modal" data-bs-target="#cartModal" title="Ir al Carrito">
        <i class="fab fa-whatsapp"></i>
    </a>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script type="module">
        // Importación de módulos de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        // ====================================================================
        // 1. CONFIGURACIÓN INICIAL (DEBES REEMPLAZAR ESTOS VALORES)
        // ====================================================================

        // Configuración de tu proyecto Firebase
        const firebaseConfig = {
            apiKey: "TU_API_KEY", // Reemplaza con tu API Key
            authDomain: "TU_AUTH_DOMAIN", // Reemplaza con tu Auth Domain
            databaseURL: "TU_DATABASE_URL", // Reemplaza con tu Database URL
            projectId: "TU_PROJECT_ID", // Reemplaza con tu Project ID
            storageBucket: "TU_STORAGE_BUCKET", // Reemplaza con tu Storage Bucket
            messagingSenderId: "TU_MESSAGING_SENDER_ID", // Reemplaza con tu Messaging Sender ID
            appId: "TU_APP_ID" // Reemplaza con tu App ID
        };

        // Número de WhatsApp al que se enviarán los pedidos (con código de país)
        const WHATSAPP_NUMBER = "5215500000000"; // Ejemplo: 52 1 55 0000 0000

        // Precio base de las playeras
        const PRODUCT_PRICE = 250.00;

        // ====================================================================
        // 2. INVENTARIO INICIAL FIJO
        // ESTE ES EL ARRAY QUE DEBES REEMPLAZAR CON TU STOCK ACTUALIZADO
        // ====================================================================
        const ORIGINAL_PRODUCTS_DEFINITION = [
            {
                "i": 1,
                "name": "BTS",
                "description": "Playera Modelo 1",
                "stock": {
                    "M": 1,
                    "L": 1,
                    "XL": 1
                },
                "frontFile": "xime1",
                "backFile": "Xime2",
                "sideFile": "blanco"
            },
            {
                "i": 2,
                "name": "BTS",
                "description": "Playera Modelo 2",
                "stock": {
                    "M": 1,
                    "L": 1,
                    "XL": 1
                },
                "frontFile": "Xime3",
                "backFile": "Xime4",
                "sideFile": "negro"
            },
            {
                "i": 3,
                "name": "MICHAEL JACKSON",
                "description": "Playera Modelo 3",
                "stock": {
                    "S": 1,
                    "M": 1,
                    "L": 1
                },
                "frontFile": "Abi1",
                "backFile": "Abi2",
                "sideFile": "blanco"
            },
            {
                "i": 4,
                "name": "MICHAEL JACKSON",
                "description": "Playera Modelo 4",
                "stock": {
                    "L": 1
                },
                "frontFile": "Abi3",
                "backFile": "Abi4",
                "sideFile": "negro"
            },
            {
                "i": 5,
                "name": "ADO",
                "description": "Playera Modelo 5",
                "stock": {
                    "XL": 1
                },
                "frontFile": "Lucy1",
                "backFile": "Lucy2",
                "sideFile": "blanco"
            },
            {
                "i": 6,
                "name": "ADO",
                "description": "Playera Modelo 6",
                "stock": {
                    "M": 1,
                    "L": 1,
                    "XL": 2
                },
                "frontFile": "Lucy3",
                "backFile": "Lucy4",
                "sideFile": "negro"
            },
            {
                "i": 7,
                "name": "BRUNO MARS",
                "description": "Playera Modelo 7",
                "stock": {
                    "M": 1,
                    "L": 1,
                    "XL": 1
                },
                "frontFile": "Raul1",
                "backFile": "Raul2",
                "sideFile": "negro"
            },
            {
                "i": 8,
                "name": "BRUNO MARS",
                "description": "Playera Modelo 8",
                "stock": {
                    "M": 1,
                    "L": 1,
                    "XL": 1
                },
                "frontFile": "Raul3",
                "backFile": "Raul4",
                "sideFile": "negro"
            },
            {
                "i": 9,
                "name": "LATIN MAFIA",
                "description": "Playera Modelo 9",
                "stock": {
                    "M": 1,
                    "L": 1,
                    "XL": 1
                },
                "frontFile": "Dani1",
                "backFile": "Dani2",
                "sideFile": "blanco"
            },
            {
                "i": 10,
                "name": "LATIN MAFIA",
                "description": "Playera Modelo 10",
                "stock": {
                    "M": 1,
                    "L": 1,
                    "XL": 1
                },
                "frontFile": "Dani3",
                "backFile": "Dani4",
                "sideFile": "negro"
            },
            {
                "i": 11,
                "name": "AESPA",
                "description": "Playera Modelo 11",
                "stock": {
                    "M": 1,
                    "L": 1,
                    "XL": 1
                },
                "frontFile": "Dali1",
                "backFile": "Dali2",
                "sideFile": "negro"
            },
            {
                "i": 12,
                "name": "AESPA",
                "description": "Playera Modelo 12",
                "stock": {
                    "M": 1,
                    "L": 1,
                    "XL": 1
                },
                "frontFile": "Dali3",
                "backFile": "Dali4",
                "sideFile": "negro"
            },
            {
                "i": 13,
                "name": "BILLIE EILISH",
                "description": "Playera Modelo 13",
                "stock": {
                    "M": 1,
                    "L": 1,
                    "XL": 1
                },
                "frontFile": "Yose1",
                "backFile": "Yose2",
                "sideFile": "negro"
            },
            {
                "i": 14,
                "name": "BILLIE EILISH",
                "description": "Playera Modelo 14",
                "stock": {
                    "M": 1,
                    "L": 1,
                    "XL": 1
                },
                "frontFile": "Yose3",
                "backFile": "Yose4",
                "sideFile": "negro"
            },
            {
                "i": 15,
                "name": "LANA DEL REY",
                "description": "Playera Modelo 15",
                "stock": {
                    "M": 1,
                    "L": 1,
                    "XL": 1
                },
                "frontFile": "Keila1",
                "backFile": "Keila2",
                "sideFile": "blanco"
            },
            {
                "i": 16,
                "name": "LANA DEL REY",
                "description": "Playera Modelo 16",
                "stock": {
                    "M": 1,
                    "L": 1,
                    "XL": 1
                },
                "frontFile": "Keila3",
                "backFile": "Keila4",
                "sideFile": "negro"
            },
            {
                "i": 17,
                "name": "MY CHEMICAL ROMANCE",
                "description": "Playera Modelo 17",
                "stock": {
                    "M": 1,
                    "L": 1,
                    "XL": 1
                },
                "frontFile": "Kenji1",
                "backFile": "Kenji2",
                "sideFile": "negro"
            },
            {
                "i": 18,
                "name": "MY CHEMICAL ROMANCE",
                "description": "Playera Modelo 18",
                "stock": {
                    "M": 1,
                    "L": 1,
                    "XL": 1
                },
                "frontFile": "Kenji3",
                "backFile": "Kenji4",
                "sideFile": "negro"
            },
            {
                "i": 19,
                "name": "TWENTY ONE PILOTS",
                "description": "Playera Modelo 19",
                "stock": {
                    "M": 1,
                    "L": 1,
                    "XL": 1
                },
                "frontFile": "Alli1",
                "backFile": "Alli2",
                "sideFile": "negro"
            },
            {
                "i": 20,
                "name": "TWENTY ONE PILOTS",
                "description": "Playera Modelo 20",
                "stock": {
                    "M": 1,
                    "L": 1,
                    "XL": 1
                },
                "frontFile": "Alli3",
                "backFile": "Alli4",
                "sideFile": "negro"
            },
            {
                "i": 21,
                "name": "SELENA QUINTANILLA",
                "description": "Playera Modelo 21",
                "stock": {
                    "XL": 1
                },
                "frontFile": "Ale1",
                "backFile": "Ale2",
                "sideFile": "arena"
            },
            {
                "i": 22,
                "name": "OLIVIA RODRIGO",
                "description": "Playera Modelo 22",
                "stock": {
                    "M": 1,
                    "L": 1,
                    "XL": 1
                },
                "frontFile": "Miri1",
                "backFile": "Miri2",
                "sideFile": "negro"
            },
            {
                "i": 23,
                "name": "OLIVIA RODRIGO",
                "description": "Playera Modelo 23",
                "stock": {
                    "M": 1,
                    "L": 1,
                    "XL": 1
                },
                "frontFile": "Miri3",
                "backFile": "Miri4",
                "sideFile": "negro"
            },
            {
                "i": 24,
                "name": "BAD BUNNY",
                "description": "Playera Modelo 24",
                "stock": {
                    "M": 1,
                    "XL": 1
                },
                "frontFile": "Didi1",
                "backFile": "Didi2",
                "sideFile": "negro"
            },
            {
                "i": 25,
                "name": "BAD BUNNY",
                "description": "Playera Modelo 25",
                "stock": {
                    "L": 1,
                    "XL": 1
                },
                "frontFile": "Didi3",
                "backFile": "Didi4",
                "sideFile": "arena"
            },
            {
                "i": 26,
                "name": "Taylor SWIFT",
                "description": "Playera Modelo 26",
                "stock": {
                    "M": 1,
                    "L": 1,
                    "XL": 1
                },
                "frontFile": "Vale1",
                "backFile": "Vale2",
                "sideFile": "arena"
            },
            {
                "i": 27,
                "name": "TAYLOR SWIFT",
                "description": "Playera Modelo 27",
                "stock": {
                    "M": 1,
                    "L": 1,
                    "XL": 1
                },
                "frontFile": "Vale3",
                "backFile": "Vale4",
                "sideFile": "negro"
            },
            {
                "i": 28,
                "name": "HUMBE",
                "description": "Playera Modelo 28",
                "stock": {
                    "M": 1,
                    "L": 1,
                    "XL": 1
                },
                "frontFile": "Caro1",
                "backFile": "Caro2",
                "sideFile": "arena"
            },
            {
                "i": 29,
                "name": "HUMBE",
                "description": "Playera Modelo 29",
                "stock": {
                    "M": 1,
                    "L": 1,
                    "XL": 1
                },
                "frontFile": "Caro3",
                "backFile": "Caro4",
                "sideFile": "arena"
            },
            {
                "i": 30,
                "name": "KATY PERRY",
                "description": "Playera Modelo 30",
                "stock": {
                    "M": 1,
                    "L": 1,
                    "XL": 1
                },
                "frontFile": "Gon1.PNG",
                "backFile": "Gon2.PNG",
                "sideFile": "negro"
            },
            {
                "i": 31,
                "name": "KATY PERRY",
                "description": "Playera Modelo 31",
                "stock": {
                    "M": 1,
                    "L": 1,
                    "XL": 1
                },
                "frontFile": "Katy3",
                "backFile": "Katy4",
                "sideFile": "blanco"
            },
            {
                "i": 32,
                "name": "TAYLOR SWIFT",
                "description": "Playera Modelo 32",
                "stock": {
                    "S": 1,
                    "M": 1,
                    "L": 1
                },
                "frontFile": "Bere1",
                "backFile": "Bere2",
                "sideFile": "blanco2"
            },
            {
                "i": 33,
                "name": "TAYLOR SWIFT",
                "description": "Playera Modelo 33",
                "stock": {
                    "S": 1,
                    "M": 1,
                    "L": 1
                },
                "frontFile": "Bere3",
                "backFile": "Bere4",
                "sideFile": "negro2"
            },
            {
                "i": 34,
                "name": "BTS",
                "description": "Playera Modelo 34",
                "stock": {
                    "S": 1,
                    "M": 1,
                    "L": 1
                },
                "frontFile": "Dan1",
                "backFile": "Dan2",
                "sideFile": "negro2"
            },
            {
                "i": 35,
                "name": "BTS",
                "description": "Playera Modelo 35",
                "stock": {
                    "S": 1,
                    "M": 1,
                    "L": 1
                },
                "frontFile": "Dan3",
                "backFile": "Dan4",
                "sideFile": "negro2"
            },
            {
                "i": 36,
                "name": "NCT DREAM",
                "description": "Playera Modelo 36",
                "stock": {
                    "S": 1,
                    "M": 1,
                    "L": 1
                },
                "frontFile": "Gera1",
                "backFile": "Gera2",
                "sideFile": "negro2"
            },
            {
                "i": 37,
                "name": "NCT DREAM",
                "description": "Playera Modelo 37",
                "stock": {
                    "S": 1,
                    "M": 1,
                    "L": 1
                },
                "frontFile": "Gera3",
                "backFile": "Gera4",
                "sideFile": "negro2"
            },
            {
                "i": 38,
                "name": "HUNTRIX/SAJA BOYS",
                "description": "Playera Modelo 38",
                "stock": {
                    "S": 1,
                    "M": 1,
                    "L": 1
                },
                "frontFile": "Bra1",
                "backFile": "Bra2",
                "sideFile": "negro2"
            },
            {
                "i": 39,
                "name": "HUNTRIX/SAJA BOYS",
                "description": "Playera Modelo 39",
                "stock": {
                    "S": 1,
                    "M": 1,
                    "L": 1
                },
                "frontFile": "Bra3",
                "backFile": "Bra4",
                "sideFile": "negro2"
            },
            {
                "i": 40,
                "name": "HOZIER",
                "description": "Playera Modelo 40",
                "stock": {
                    "S": 1,
                    "M": 1,
                    "L": 1
                },
                "frontFile": "Adri1",
                "backFile": "Adri2",
                "sideFile": "negro2"
            },
            {
                "i": 41,
                "name": "HOZIER",
                "description": "Playera Modelo 41",
                "stock": {
                    "S": 1,
                    "M": 1,
                    "L": 1
                },
                "frontFile": "Adri3",
                "backFile": "Adri4",
                "sideFile": "blanco2"
            },
            {
                "i": 42,
                "name": "BLACKPINK",
                "description": "Modelo 42 con opción de color",
                "colors": [
                    "Negro",
                    "Blanco"
                ],
                "isColorProduct": true,
                "stockByColor": {
                    "Blanco": {
                        "S": 1,
                        "M": 1
                    },
                    "Negro": {
                        "L": 1
                    }
                },
                "colorMap": {
                    "Negro": {
                        "front": "Aro1",
                        "back": "Aro2",
                        "side": "negro2"
                    },
                    "Blanco": {
                        "front": "Aro3",
                        "back": "Aro4",
                        "side": "blanco2"
                    }
                }
            },
            {
                "i": 43,
                "name": "BLACKPINK",
                "description": "Modelo 43 con opción de color",
                "colors": [
                    "Negro",
                    "Blanco"
                ],
                "isColorProduct": true,
                "stockByColor": {
                    "Blanco": {
                        "S": 1,
                        "M": 1
                    },
                    "Negro": {
                        "L": 1
                    }
                },
                "colorMap": {
                    "Negro": {
                        "front": "Aro5",
                        "back": "Aro6",
                        "side": "negro2"
                    },
                    "Blanco": {
                        "front": "Aro7",
                        "back": "Aro8",
                        "side": "blanco2"
                    }
                }
            }
        ];
        // ====================================================================
        // FIN DEL INVENTARIO INICIAL
        // ====================================================================


        // Inicialización de Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Referencia a la raíz de tu inventario en Realtime Database
        // CORRECCIÓN: Apunta al nodo 'inventory'
        const stockRef = ref(database, 'inventory'); 

        let allProducts = [];
        let globalStock = {};
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let orderIdCounter = parseInt(localStorage.getItem('orderIdCounter')) || 0; // Contador de pedidos

        // ====================================================================
        // 3. FUNCIONES PRINCIPALES
        // ====================================================================

        // Función de utilidad para obtener la URL de la imagen
        function getImageUrl(fileName) {
            // Asume que las imágenes están en la carpeta 'RPLAY' y usa la extensión correcta (.png por defecto o la que se haya especificado)
            const extension = fileName.includes('.') ? '' : '.png'; // Permite Gon1.PNG o xime1
            return `./RPLAY/${fileName}${extension}`;
        }

        // Dibuja los productos en la interfaz
        function renderProducts() {
            const container = document.getElementById('productsContainer');
            if (!container) return;
            container.innerHTML = '';
            document.getElementById('loadingMessage').style.display = 'none';

            allProducts.forEach(product => {
                let availableStockCount = 0;
                let stockHTML = '';

                if (product.isColorProduct) {
                    stockHTML = '<div class="stock-indicator text-muted small">Disponible en varios colores/tallas</div>';
                } else {
                    const productStock = globalStock[product.i] || {};
                    const sizes = Object.keys(product.stock || {});
                    
                    if (sizes.length === 0) {
                        stockHTML = '<div class="stock-indicator text-danger">AGOTADO</div>';
                    } else {
                        const stockText = sizes.map(size => {
                            const count = productStock[size] !== undefined ? productStock[size] : product.stock[size] || 0;
                            availableStockCount += count;
                            const color = count > 0 ? 'text-success' : 'text-danger';
                            return `<span class="${color}">${size}: ${count}</span>`;
                        }).join(' | ');

                        if (availableStockCount === 0) {
                            stockHTML = '<div class="stock-indicator text-danger">AGOTADO</div>';
                        } else {
                             stockHTML = `<div class="stock-indicator text-secondary">Stock: ${stockText}</div>`;
                        }
                    }
                }
                
                const isDisabled = availableStockCount === 0 && !product.isColorProduct;

                const cardHtml = `
                    <div class="col">
                        <div class="card product-card" data-id="${product.i}">
                            <img src="${getImageUrl(product.frontFile)}" class="card-img-top" alt="${product.name} ${product.description}" loading="lazy">
                            <div class="card-body">
                                <h5 class="card-title">${product.name}</h5>
                                <p class="card-text">${product.description}</p>
                                <p class="card-text text-primary fs-5 fw-bold">$${PRODUCT_PRICE.toFixed(2)}</p>
                                ${stockHTML}
                                <button class="btn btn-buy mt-3 w-100" data-product-id="${product.i}" data-bs-toggle="modal" data-bs-target="#productDetailModal" ${isDisabled ? 'disabled' : ''}>
                                    ${isDisabled ? 'AGOTADO' : 'Ver y Añadir'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', cardHtml);
            });
        }

        // Muestra los detalles del producto y las opciones de stock
        function showProductDetail(productId) {
            const product = allProducts.find(p => p.i === productId);
            if (!product) return;

            let detailHTML = `
                <div class="row">
                    <div class="col-md-6 text-center">
                        <img id="detailImage" src="${getImageUrl(product.frontFile)}" class="img-fluid rounded" alt="${product.name}" style="max-height: 400px; object-fit: contain;">
                        <div class="mt-3">
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="changeDetailView(${productId}, 'front')">Frente</button>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="changeDetailView(${productId}, 'back')">Atrás</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="changeDetailView(${productId}, 'side')">Lado</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h2>${product.name}</h2>
                        <p class="text-muted">${product.description}</p>
                        <h3 class="text-primary">$${PRODUCT_PRICE.toFixed(2)}</h3>
                        <hr>
            `;

            if (product.isColorProduct) {
                 // Producto con opciones de color
                detailHTML += `
                    <div class="mb-3">
                        <label for="colorSelect" class="form-label">Color:</label>
                        <select class="form-select" id="colorSelect">
                            ${product.colors.map(color => `<option value="${color}">${color}</option>`).join('')}
                        </select>
                    </div>
                    <div id="stockOptions" class="mb-3">
                        </div>
                `;
            } else {
                // Producto sin opciones de color (stock directo)
                detailHTML += `
                    <div id="stockOptions" class="mb-3">
                        <label for="sizeSelect" class="form-label">Talla:</label>
                        <select class="form-select" id="sizeSelect" onchange="updateDetailStock(${productId})">
                            ${Object.keys(product.stock).map(size => `<option value="${size}">${size}</option>`).join('')}
                        </select>
                        <p id="detailStockMessage" class="mt-2"></p>
                    </div>
                `;
            }

            detailHTML += `
                        <div class="d-flex align-items-center mb-3">
                            <label for="quantityInput" class="form-label me-3 mb-0">Cantidad:</label>
                            <input type="number" id="quantityInput" class="form-control" value="1" min="1" max="10" style="width: 80px;">
                        </div>
                        <button class="btn btn-buy w-100" id="addToCartBtn" data-product-id="${productId}">Añadir al Carrito</button>
                    </div>
                </div>
            `;

            document.getElementById('productDetailContent').innerHTML = detailHTML;

            // Inicializar y vincular eventos
            if (product.isColorProduct) {
                const colorSelect = document.getElementById('colorSelect');
                colorSelect.onchange = () => updateStockOptions(productId);
                updateStockOptions(productId); // Carga inicial
            } else {
                updateDetailStock(productId);
            }
            
            document.getElementById('addToCartBtn').onclick = () => addToCart(productId);
        }

        // Cambia la imagen de vista en el modal de detalle
        window.changeDetailView = function(productId, view) {
            const product = allProducts.find(p => p.i === productId);
            if (!product) return;

            let fileName = '';
            if (product.isColorProduct) {
                const selectedColor = document.getElementById('colorSelect') ? document.getElementById('colorSelect').value : product.colors[0];
                const map = product.colorMap[selectedColor];
                if (view === 'front') fileName = map.front;
                else if (view === 'back') fileName = map.back;
                else if (view === 'side') fileName = map.side;
            } else {
                if (view === 'front') fileName = product.frontFile;
                else if (view === 'back') fileName = product.backFile;
                else if (view === 'side') fileName = product.sideFile;
            }

            if (fileName) {
                document.getElementById('detailImage').src = getImageUrl(fileName);
            }
        };


        // Actualiza el stock para productos sin opción de color
        window.updateDetailStock = function(productId) {
            const product = allProducts.find(p => p.i === productId);
            const sizeSelect = document.getElementById('sizeSelect');
            const stockMessage = document.getElementById('detailStockMessage');
            const quantityInput = document.getElementById('quantityInput');
            const addToCartBtn = document.getElementById('addToCartBtn');
            
            if (!product || !sizeSelect || !stockMessage || !quantityInput || !addToCartBtn) return;

            const selectedSize = sizeSelect.value;
            const currentStock = globalStock[productId]?.[selectedSize] || 0;
            const maxQuantity = Math.min(10, currentStock); // Límite de 10 o el stock actual

            if (currentStock > 0) {
                stockMessage.innerHTML = `<span class="text-success">¡${currentStock} en stock!</span>`;
                addToCartBtn.disabled = false;
                quantityInput.setAttribute('max', maxQuantity);
                quantityInput.value = Math.min(1, maxQuantity);
            } else {
                stockMessage.innerHTML = `<span class="text-danger">Agotado en talla ${selectedSize}</span>`;
                addToCartBtn.disabled = true;
                quantityInput.setAttribute('max', 0);
                quantityInput.value = 0;
            }
        };

        // Actualiza las opciones de stock para productos con color
        function updateStockOptions(productId) {
            const product = allProducts.find(p => p.i === productId);
            const colorSelect = document.getElementById('colorSelect');
            const stockOptionsContainer = document.getElementById('stockOptions');
            const addToCartBtn = document.getElementById('addToCartBtn');
            
            if (!product || !colorSelect || !stockOptionsContainer) return;

            const selectedColor = colorSelect.value;
            const stockByColor = globalStock[productId]?.[selectedColor] || {};
            const sizes = Object.keys(stockByColor);
            
            let stockHtml = `
                <label for="sizeSelect" class="form-label">Talla:</label>
                <select class="form-select" id="sizeSelect">
                    <option value="" disabled selected>Selecciona Talla</option>
            `;
            let totalAvailable = 0;

            sizes.forEach(size => {
                const count = stockByColor[size] || 0;
                if (count > 0) {
                    stockHtml += `<option value="${size}">${size} (${count} disponibles)</option>`;
                    totalAvailable += count;
                } else {
                    stockHtml += `<option value="${size}" disabled>${size} (Agotado)</option>`;
                }
            });

            stockHtml += `</select>
            <p id="detailStockMessage" class="mt-2"></p>`;
            stockOptionsContainer.innerHTML = stockHtml;

            const sizeSelect = document.getElementById('sizeSelect');
            sizeSelect.onchange = () => updateDetailStockColor(productId, selectedColor);

            if (totalAvailable > 0) {
                addToCartBtn.disabled = false;
                // Intentar seleccionar la primera talla disponible por defecto
                if (sizeSelect.options.length > 1) {
                    sizeSelect.selectedIndex = 1;
                    updateDetailStockColor(productId, selectedColor);
                }
            } else {
                addToCartBtn.disabled = true;
                document.getElementById('detailStockMessage').innerHTML = '<span class="text-danger">Todas las tallas agotadas en este color.</span>';
            }
            
            // Asegúrate de que la imagen de vista previa se actualice al cambiar el color
            changeDetailView(productId, 'front');
        }

        // Actualiza stock específico para producto con color
        function updateDetailStockColor(productId, color) {
            const sizeSelect = document.getElementById('sizeSelect');
            const stockMessage = document.getElementById('detailStockMessage');
            const quantityInput = document.getElementById('quantityInput');
            const addToCartBtn = document.getElementById('addToCartBtn');

            if (!sizeSelect || !stockMessage || !quantityInput || !addToCartBtn) return;
            
            const selectedSize = sizeSelect.value;
            if (!selectedSize) {
                stockMessage.innerHTML = '';
                addToCartBtn.disabled = true;
                return;
            }

            const currentStock = globalStock[productId]?.[color]?.[selectedSize] || 0;
            const maxQuantity = Math.min(10, currentStock);

            if (currentStock > 0) {
                stockMessage.innerHTML = `<span class="text-success">¡${currentStock} en stock!</span>`;
                addToCartBtn.disabled = false;
                quantityInput.setAttribute('max', maxQuantity);
                quantityInput.value = Math.min(1, maxQuantity);
            } else {
                stockMessage.innerHTML = `<span class="text-danger">Agotado en talla ${selectedSize}</span>`;
                addToCartBtn.disabled = true;
                quantityInput.setAttribute('max', 0);
                quantityInput.value = 0;
            }
        }


        // Añade un producto al carrito
        function addToCart(productId) {
            const product = allProducts.find(p => p.i === productId);
            const quantity = parseInt(document.getElementById('quantityInput').value);
            const size = document.getElementById('sizeSelect') ? document.getElementById('sizeSelect').value : null;
            const color = document.getElementById('colorSelect') ? document.getElementById('colorSelect').value : null;
            
            if (quantity < 1 || !product) {
                alert('La cantidad mínima es 1.');
                return;
            }
            
            // Validar talla/color
            if ((!product.isColorProduct && !size) || (product.isColorProduct && (!size || !color))) {
                alert('Por favor, selecciona una talla y/o color válidos.');
                return;
            }

            let key = product.i;
            let stockCheck = globalStock[key];
            
            if (product.isColorProduct) {
                key = `${product.i}_${color}`;
                stockCheck = globalStock[product.i]?.[color];
            } 

            // Verificar stock
            const currentStock = stockCheck ? (product.isColorProduct ? stockCheck[size] || 0 : stockCheck[size] || 0) : 0;
            
            if (quantity > currentStock) {
                alert(`Solo quedan ${currentStock} unidades de ${product.name} talla ${size} (${color || 'N/A'}).`);
                return;
            }

            const cartItem = {
                id: product.i,
                name: product.name,
                description: product.description,
                price: PRODUCT_PRICE,
                size: size,
                color: color,
                quantity: quantity,
                isColorProduct: product.isColorProduct
            };

            // Busca si ya existe el mismo artículo (mismo ID, talla y color)
            const existingItemIndex = cart.findIndex(item => 
                item.id === cartItem.id && 
                item.size === cartItem.size && 
                item.color === cartItem.color
            );

            if (existingItemIndex > -1) {
                // Si existe, incrementa la cantidad (verificando el stock una vez más)
                const newQuantity = cart[existingItemIndex].quantity + quantity;
                if (newQuantity > currentStock) {
                    alert(`El stock máximo es ${currentStock}. Ya tienes ${cart[existingItemIndex].quantity} en el carrito.`);
                    return;
                }
                cart[existingItemIndex].quantity = newQuantity;
            } else {
                // Si no existe, lo añade
                cart.push(cartItem);
            }

            saveCart();
            // Cierra el modal de detalle
            const modalElement = document.getElementById('productDetailModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) modal.hide();
            
            // Muestra un mensaje de éxito rápido
            alert(`${quantity}x ${product.name} talla ${size} ${color ? '(' + color + ')' : ''} añadido al carrito.`);
        }

        // Guarda el carrito en localStorage y actualiza la UI
        function saveCart() {
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartUI();
        }

        // Actualiza el contador y el contenido del carrito en el modal
        function updateCartUI() {
            const cartCountElement = document.getElementById('cartCount');
            const cartItemsElement = document.getElementById('cartItems');
            const cartTotalElement = document.getElementById('cartTotal');
            const finalizeButton = document.getElementById('finalizeOrderButton');
            const emptyMessage = document.getElementById('emptyCartMessage');

            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const totalAmount = cart.reduce((sum, item) => sum + (item.quantity * item.price), 0);

            cartCountElement.textContent = totalItems;
            cartTotalElement.textContent = `$${totalAmount.toFixed(2)}`;
            finalizeButton.disabled = totalItems === 0;
            emptyMessage.style.display = totalItems === 0 ? 'block' : 'none';

            let cartHtml = '';
            if (totalItems > 0) {
                cart.forEach((item, index) => {
                    const colorText = item.color ? ` (${item.color})` : '';
                    cartHtml += `
                        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                            <div>
                                <h6>${item.name} - ${item.description}</h6>
                                <p class="mb-0 small text-muted">Talla: ${item.size}${colorText} | Cantidad: ${item.quantity}</p>
                            </div>
                            <div class="text-end">
                                <p class="mb-0 fw-bold">$${(item.quantity * item.price).toFixed(2)}</p>
                                <button class="btn btn-danger btn-sm mt-1" onclick="removeFromCart(${index})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            cartItemsElement.innerHTML = cartHtml;
            
            // Re-renderiza los productos para reflejar el stock actual
            renderProducts();
        }

        // Elimina un ítem del carrito
        window.removeFromCart = function(index) {
            cart.splice(index, 1);
            saveCart();
        }

        // ====================================================================
        // 4. LÓGICA DE FIREBASE Y PEDIDOS
        // ====================================================================

        // Carga los productos de Firebase y establece el listener
        function loadStockFromFirebase() {
            console.log("Cargando inventario desde Firebase.");
            
            onValue(stockRef, (snapshot) => {
                if (snapshot.exists()) {
                    globalStock = snapshot.val();
                    console.log("Inventario cargado desde Firebase.");
                    renderProducts();
                    updateCartUI(); // Actualiza el carrito por si hay cambios de stock
                } else {
                    console.warn("No hay datos en Firebase. Inicializando con el array fijo.");
                    // Si no hay datos, inicializa la base de datos con el array fijo
                    saveStockToFirebase();
                }
            }, (error) => {
                 // Manejo de errores de conexión/permisos (CRÍTICO)
                console.error("Hubo un error al conectar con el inventario en tiempo real. Revisa tu conexión de Firebase y las reglas de seguridad.", error);
                
                // Muestra un error visible al usuario si hay un fallo de permisos
                alert(`Hubo un error al conectar con el inventario en tiempo real. Revisa tu conexión de Firebase y las reglas de seguridad. (${error.message})`);
                
                // Usa el inventario inicial como fallback solo para mostrar productos, pero deshabilita la compra
                globalStock = ORIGINAL_PRODUCTS_DEFINITION.reduce((acc, product) => {
                    acc[product.i] = product.isColorProduct ? product.stockByColor : product.stock;
                    return acc;
                }, {});
                renderProducts(); 
                document.getElementById('finalizeOrderButton').disabled = true;
                
            });
            
            // Combina los productos fijos con el stock dinámico
            allProducts = ORIGINAL_PRODUCTS_DEFINITION;
        }

        // Sube el stock inicial al nodo de Firebase
        function saveStockToFirebase() {
            // Convierte el array ORIGINAL_PRODUCTS_DEFINITION en la estructura de Firebase (ID como clave)
            const stockData = ORIGINAL_PRODUCTS_DEFINITION.reduce((acc, product) => {
                acc[product.i] = product.isColorProduct ? product.stockByColor : product.stock;
                return acc;
            }, {});

            set(stockRef, stockData)
                .then(() => {
                    console.log("Inventario inicial actualizado exitosamente en Firebase.");
                })
                .catch((error) => {
                    console.error("Error al guardar el inventario inicial en Firebase:", error);
                });
        }
        
        // Función principal para procesar el pedido y enviar por WhatsApp
        function sendOrderToWhatsapp(notes) {
            if (cart.length === 0) {
                alert('El carrito está vacío.');
                return;
            }

            // 1. Obtener el nuevo ID de Pedido
            orderIdCounter++;
            localStorage.setItem('orderIdCounter', orderIdCounter); // Guarda el nuevo contador

            // 2. Preparar la actualización de stock
            const updates = {};
            let whatsappMessage = `*¡NUEVO PEDIDO #${orderIdCounter} - RPLAY!* \n\n`;
            whatsappMessage += `*Productos:*\n`;
            
            let totalAmount = 0;
            let stockIsValid = true;
            
            // Clonar el stock actual para hacer la simulación del descuento
            const tempStock = JSON.parse(JSON.stringify(globalStock));
            
            // Construir mensaje de WhatsApp y preparar descuentos
            cart.forEach(item => {
                const itemTotal = item.quantity * item.price;
                totalAmount += itemTotal;
                const colorText = item.color ? ` (${item.color})` : '';
                
                whatsappMessage += `- ${item.quantity}x Playera ${item.name} (${item.size}${colorText}) - $${itemTotal.toFixed(2)}\n`;
                
                const productId = item.id;
                const size = item.size;

                let currentStockPath;
                let currentStockCount;
                
                if (item.isColorProduct) {
                    currentStockPath = `${productId}/${item.color}/${size}`;
                    currentStockCount = tempStock[productId]?.[item.color]?.[size] || 0;
                    
                    if (!tempStock[productId]) tempStock[productId] = {};
                    if (!tempStock[productId][item.color]) tempStock[productId][item.color] = {};
                    tempStock[productId][item.color][size] = currentStockCount - item.quantity;
                } else {
                    currentStockPath = `${productId}/${size}`;
                    currentStockCount = tempStock[productId]?.[size] || 0;
                    
                    if (!tempStock[productId]) tempStock[productId] = {};
                    tempStock[productId][size] = currentStockCount - item.quantity;
                }

                // Validación final de stock (Aunque se hizo al añadir, se reconfirma por seguridad)
                if (currentStockCount < item.quantity) {
                    stockIsValid = false;
                    alert(`ERROR: No hay suficiente stock para ${item.name} (${item.size}${colorText}). Solo quedan ${currentStockCount}.`);
                }
                
                // Prepara la actualización a Firebase (solo si el stock sigue siendo >= 0)
                if (tempStock[productId][size] >= 0) {
                     updates[currentStockPath] = tempStock[productId][size];
                }
            });

            if (!stockIsValid) {
                orderIdCounter--; // Revierte el contador si falla la validación
                localStorage.setItem('orderIdCounter', orderIdCounter);
                return; // Detiene la ejecución si el stock es inválido
            }

            // 3. Finalizar mensaje
            whatsappMessage += `\n*TOTAL: $${totalAmount.toFixed(2)}*\n\n`;
            
            if (notes) {
                whatsappMessage += `*Notas del Cliente:* ${notes}\n\n`;
            }

            whatsappMessage += `_**Por favor, confirme la disponibilidad y el envío de este pedido. Gracias.**_`;
            
            const encodedMessage = encodeURIComponent(whatsappMessage);
            const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodedMessage}`;

            // 4. Actualizar el stock en Firebase
            update(stockRef, updates)
                .then(() => {
                    console.log("¡STOCK GLOBALMENTE DESCONTADO! PASO CRÍTICO MANUAL:");
                    console.log("Para que el stock quede fijo, ejecuta:");
                    console.log("window.exportInitialProductsArray();");
                    console.log("Y sube el nuevo 'aplay.html' con el stock actualizado a GitHub.");
                    console.log("Inventario actualizado exitosamente en Firebase.");
                    
                    // 5. Limpiar el carrito y redirigir
                    cart = [];
                    saveCart();
                    window.open(whatsappUrl, '_blank');
                    
                    // Cerrar el modal de órdenes
                    const ordersModalElement = document.getElementById('ordersModal');
                    const ordersModal = bootstrap.Modal.getInstance(ordersModalElement);
                    if (ordersModal) ordersModal.hide();
                    
                    // Cierra el modal de carrito si sigue abierto
                    const cartModalElement = document.getElementById('cartModal');
                    const cartModal = bootstrap.Modal.getInstance(cartModalElement);
                    if (cartModal) cartModal.hide();

                })
                .catch((error) => {
                    console.error("Error al actualizar el stock en Firebase:", error);
                    alert("Error al guardar el stock en la base de datos. Por favor, inténtalo de nuevo.");
                });
        }

        // ====================================================================
        // 5. COMANDOS DE ADMINISTRACIÓN (DISPONIBLES EN CONSOLA)
        // ====================================================================

        // Función de utilidad para administradores: Exportar el array de productos con stock actual
        window.exportInitialProductsArray = function() {
            if (!confirm("ADVERTENCIA (ADMIN): Esto exportará el stock actual de Firebase para USARLO como el NUEVO stock inicial fijo en aplay.html. ¿Continuar?")) {
                return;
            }
            
            const newProductsDefinition = ORIGINAL_PRODUCTS_DEFINITION.map(product => {
                const newProduct = JSON.parse(JSON.stringify(product));
                
                if (newProduct.isColorProduct) {
                    newProduct.stockByColor = globalStock[newProduct.i] || newProduct.stockByColor;
                } else {
                    newProduct.stock = globalStock[newProduct.i] || newProduct.stock;
                }
                return newProduct;
            });
            
            console.log("====================================================================");
            console.log("COPIA TODO EL TEXTO ABAJO Y REEMPLAZA ORIGINAL_PRODUCTS_DEFINITION EN aplay.html");
            console.log("====================================================================");
            console.log(JSON.stringify(newProductsDefinition, null, 4));
            console.log("====================================================================");
            alert("El nuevo array de productos se ha copiado en la consola (F12).");
        };
        
        // Función de utilidad para administradores: Resetear Inventario y Pedidos
        window.resetInventoryAndOrders = function() {
            if (!confirm("ADVERTENCIA (ADMIN): ¿Estás seguro de que quieres REINICIAR el inventario y todos los pedidos? Esto es SOLO para pruebas.")) {
                return;
            }
            // 1. Resetear stock en Firebase
            saveStockToFirebase();
            
            // 2. Resetear contador de pedidos en localStorage
            localStorage.setItem('orderIdCounter', 0);
            
            alert("Inventario y órdenes reiniciados. Recarga la página (F5).");
        };
        
        // Función de utilidad para administradores: Forzar la subida del stock actual de aplay.html
        window.saveStockToFirebase = saveStockToFirebase;


        // ====================================================================
        // 6. EVENT LISTENERS
        // ====================================================================

        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar la carga del inventario
            loadStockFromFirebase();

            // Evento al abrir el modal de detalle
            const productDetailModal = document.getElementById('productDetailModal');
            productDetailModal.addEventListener('show.bs.modal', event => {
                const button = event.relatedTarget;
                const productId = parseInt(button.getAttribute('data-product-id'));
                showProductDetail(productId);
            });
            
            // Vincular el botón de WhatsApp a la función final
            const sendOrderButton = document.getElementById('sendOrderToWhatsappButton');
            sendOrderButton.onclick = () => {
                const notes = document.getElementById('customerNotes').value;
                sendOrderToWhatsapp(notes);
            };

            // Asegurar que el modal del carrito actualice la UI al mostrarse
            const cartModalElement = document.getElementById('cartModal');
            cartModalElement.addEventListener('show.bs.modal', updateCartUI);

            // Exportar la función sendOrderToWhatsapp al scope global para que los botones la encuentren
            window.sendOrderToWhatsapp = sendOrderToWhatsapp;
            window.updateStockOptions = updateStockOptions; // Exportar para uso en onchange

            // Cargar el array de productos
            allProducts = ORIGINAL_PRODUCTS_DEFINITION;
            
        });
    </script>
</body>
</html>
