<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPLAY - Venta de Playeras</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .product-card {
            border: 1px solid #ddd;
            transition: transform 0.2s;
            margin-bottom: 20px;
        }
        .product-card:hover {
            transform: translateY(-5px);
        }
        .btn-buy {
            background-color: #ff3366;
            color: white;
            border: none;
        }
        .btn-buy:hover {
            background-color: #e6004b;
            color: white;
        }
        /* ESTO OCULTA EL BADGE DE STOCK EN LA TARJETA Y EN EL MODAL DE DETALLE */
        .stock-badge, #stockIndicator {
            display: none !important; 
        }
        .carousel-item img {
            max-height: 500px;
            object-fit: contain;
        }
        /* Estilo para el bot칩n de WhatsApp fijo */
        .whatsapp-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: #25d366;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 60px;
            font-size: 30px;
            z-index: 1000;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .whatsapp-button:hover {
            background-color: #128c7e;
        }
        .whatsapp-button i {
            display: inline-block;
            transform: translateY(10%);
        }
        /* Estilos para el carrusel de im치genes */
        .carousel-indicators [data-bs-target] {
            background-color: #ff3366;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            opacity: 0.5;
        }
        .carousel-indicators .active {
            opacity: 1;
        }
        
        /* Estilos para los items del carrito detallado */
        .cart-item-detail {
            display: flex;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }
        .cart-item-detail img {
            width: 70px;
            height: 70px;
            object-fit: cover;
            margin-right: 15px;
            border: 1px solid #ddd;
        }
        .cart-item-info {
            flex-grow: 1;
        }
        .cart-item-info strong {
            display: block;
            font-size: 1.0em;
            margin-bottom: 2px;
        }
        .cart-item-info span {
            font-size: 0.85em;
            color: #555;
        }
        .cart-item-remove-btn {
            flex-shrink: 0;
        }
    </style>
</head>
<body>

    <a href="https://wa.me/529991480151" target="_blank" class="whatsapp-button" title="Haz tu pedido por WhatsApp">
        &#x2705; 
    </a>

    <header class="p-3 mb-4 bg-white shadow-sm">
        <div class="container d-flex justify-content-between align-items-center">
            <img src='https://ventaplayera.github.io/RPLAY/logo.png' style="max-width: 150px; height: auto;" alt="RPLAY Logo">
            <h1 class="h3 text-primary d-none d-md-block">RPLAY</h1>
            <button class="btn btn-outline-secondary" onclick="window.openOrdersModal()">
                Pedidos <span class="badge text-bg-primary" id="ordersCounter">0</span>
            </button>
        </div>
    </header>

    <main class="container">
        <div class="row" id="product-list">
             <h2 class="text-center">Cargando inventario desde Cloud Firestore...</h2>
        </div>
    </main>

    <div class="modal fade" id="productDetailModal" tabindex="-1" aria-labelledby="productDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productDetailModalLabel">Detalles del Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
                                <div class="carousel-indicators" id="carouselIndicators"></div>
                                <div class="carousel-inner" id="carouselInner"></div>
                                <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Previous</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Next</span>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h2 id="modalProductName" class="text-primary"></h2>
                            <p id="modalProductDescription" class="text-muted"></p>
                            
                            <h3 id="modalProductPrice" class="my-3 text-success"></h3>
                            
                            <form id="orderForm">
                                <input type="hidden" id="modalProductId" name="productId">

                                <div class="mb-3" id="colorSelectContainer" style="display:none;">
                                    <label for="colorSelect" class="form-label">Color:</label>
                                    <select class="form-select" id="colorSelect" name="color"></select>
                                </div>
                                <div class="mb-3">
                                    <label for="sizeSelect" class="form-label">Talla:</label>
                                    <select class="form-select" id="sizeSelect" name="size" required></select>
                                </div>

                                <div class="mb-3">
                                    <label for="quantityInput" class="form-label">Cantidad:</label>
                                    <input type="number" class="form-control" id="quantityInput" name="quantity" value="1" min="1" required>
                                </div>

                                <div class="mb-3">
                                    <span id="stockIndicator" class="badge"></span>
                                </div>

                                <button type="submit" class="btn btn-buy w-100" id="addToOrderButton">A침adir al Pedido</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="ordersModal" tabindex="-1" aria-labelledby="ordersModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="ordersModalLabel">Mi Pedido</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="list-group mb-4" id="currentOrdersList">
                        <li class="list-group-item text-center text-muted" id="emptyOrdersMessage" style="display: none;">Tu pedido est치 vac칤o.</li>
                    </ul>

                    <h4 class="mb-3">Total a Pagar: <span id="ordersTotal" class="text-success">$0.00</span></h4>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" value="" id="halfPaymentCheck">
                        <label class="form-check-label" for="halfPaymentCheck">
                            Pagar el 50% de anticipo (<span id="halfPaymentAmount">$0.00</span>)
                        </label>
                    </div>

                    <hr>

                    <form id="clientDataForm" class="mt-4">
                        <h5 class="text-primary">Datos para Env칤o y Contacto</h5>
                        <div class="mb-3">
                            <label for="clientName" class="form-label">Nombre Completo:</label>
                            <input type="text" class="form-control" id="clientName" required>
                        </div>
                        <div class="mb-3">
                            <label for="clientAddress" class="form-label">Direcci칩n de Correo</label>
                            <textarea class="form-control" id="clientAddress" rows="2" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="clientPhone" class="form-label">Tel칠fono (WhatsApp):</label>
                            <input type="tel" class="form-control" id="clientPhone" required>
                        </div>
                    </form>

                    <div id="paymentDetailsSection" style="display: none;">
                        <hr>
                        <h5 class="text-primary">Datos de Transferencia Bancaria</h5>
                        <p class="mb-1"><strong>Banco:</strong>BBVA</p>
                        <p class="mb-1"><strong>N칰mero de Cuenta:</strong> 4152314029419622</p>
                        <p class="mb-1"><strong>Beneficiario:</strong> RPLAY</p>
                        
                        <p class="mt-3 text-muted">Una vez hecha la transferencia o dep칩sito, presiona "Enviar Pedido por WhatsApp" y adjunta tu comprobante.</p>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Seguir Comprando</button>
                    <button type="button" class="btn btn-buy" id="finalizeOrderButton" disabled onclick="window.sendOrderToWhatsapp()">
                        Enviar Pedido por WhatsApp
                    </button>
                </div>
            </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script type="module">
        // 游뚿 CONFIGURACI칍N DE FIREBASE 
        const firebaseConfig = {
            apiKey: "AIzaSyCtgsjjbNIS0lv5aLD8nkpN_9-4sXIJVE", 
            authDomain: "rplay-f04dc.firebaseapp.com",
            projectId: "rplay-f04dc",
            storageBucket: "rplay-f04dc.appspot.com",
            messagingSenderId: "787828282738",
            appId: "1:787828282738:web:00c1ff1a7008c0e02b79eb",
            measurementId: "G-XEKR4KEDMR"
        };
        
        // 游뚿 IMPORTAR LIBRER칈AS DE FIREBASE (Cloud Firestore)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
        // Importaci칩n correcta para Cloud Firestore
        import { getFirestore, collection, getDocs, doc, runTransaction } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore.js";

        // Inicializar Firebase y Cloud Firestore
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app); 

        // =======================================================
        // DECLARACI칍N DE VARIABLES GLOBALES Y CONSTANTES
        // =======================================================
        const PRODUCT_PRICE = 250.00; 
        const MINIMUM_TO_SHIP = 1;   
        const WHATSAPP_NUMBER = '529991480151'; 
        
        const IMAGE_EXTENSION = '.png'; 
        const GITHUB_BASE_URL = 'https://ventaplayera.github.io/RPLAY/';
        const GENERIC_SIDE_IMAGE_BASE = 'medidas'; 
        
        // 游뚿 V8.6: Lista de nombres de archivos que deben ser forzados a min칰sculas
        const MUST_BE_LOWERCASE = ['xim1', 'negro', 'blanco', 'negro2', 'blanco2', 'medidas', 'logo']; 

        // Variables que ser치n llenadas con datos de Firebase
        window.inventory = []; 
        window.currentOrder = JSON.parse(localStorage.getItem('currentOrder') || '[]'); 
        window.currentProductInModal = null; 
        
        // =================================================================================
        // FUNCI칍N CLAVE: CARGAR PRODUCTOS DESDE FIRESTORE
        // =================================================================================

        window.loadProductsFromFirebase = async function() {
            try {
                const list = document.getElementById('product-list');
                list.innerHTML = '<h2 class="text-center">Cargando inventario desde Cloud Firestore...</h2>';

                const querySnapshot = await getDocs(collection(db, 'products')); 
                
                if (!querySnapshot.empty) {
                    window.inventory = querySnapshot.docs.map(doc => ({
                        id: doc.id,
                        price: doc.data().price || PRODUCT_PRICE, 
                        ...doc.data()
                    }));
                    
                    console.log(`Inventario cargado: ${window.inventory.length} productos.`);
                    window.renderProductCards();
                } else {
                    console.log("No hay productos en la colecci칩n de Firestore /products.");
                    list.innerHTML = '<h2 class="text-center text-danger">춰Inventario vac칤o en la nube! Revisa la colecci칩n /products.</h2>';
                }
            } catch (e) {
                console.error("Error al cargar productos desde Firestore:", e);
                list.innerHTML = '<h2 class="text-center text-danger">Error al cargar inventario. Revisa la Consola y las Reglas de Firestore.</h2>';
            }
        }
        
        // =================================================================================
        // FUNCI칍N AUXILIAR DE FORMATO DE NOMBRE (V8.6: FUERZA CAPITALIZACI칍N)
        // =================================================================================
        function formatFileName(rawName) {
            if (!rawName) return null;
            
            let baseName = rawName.split('.')[0]; 
            const lowerBaseName = baseName.toLowerCase();
            
            if (MUST_BE_LOWERCASE.includes(lowerBaseName)) {
                // Si es una excepci칩n (xim1, blanco, negro, etc.), forzar min칰sculas
                baseName = lowerBaseName; 
            } else {
                // Si NO es una excepci칩n (Abi1, Gon3, etc.), forzar may칰scula inicial
                if (baseName.length > 0) {
                    baseName = baseName.charAt(0).toUpperCase() + baseName.slice(1);
                }
            }
            
            return { name: baseName, ext: IMAGE_EXTENSION };
        }

        function getImageUrl(fileBase) {
             // Tratamiento de la imagen de medidas
             if (fileBase === GENERIC_SIDE_IMAGE_BASE) {
                return `${GITHUB_BASE_URL}${GENERIC_SIDE_IMAGE_BASE}${IMAGE_EXTENSION}`;
            }
            
            const fileInfo = formatFileName(fileBase);
            if (!fileInfo) return `${GITHUB_BASE_URL}fallback_default${IMAGE_EXTENSION}`; 
            
            // Genera la URL usando el nombre con la capitalizaci칩n correcta (Ej: /RPLAY/Abi1.png o /RPLAY/blanco.png)
            return `${GITHUB_BASE_URL}${fileInfo.name}${fileInfo.ext}`;
        }


        // =======================================================
        // L칍GICA DE STOCKS (ASEGURANDO LA LECTURA COMO N칔MERO)
        // =======================================================
        function getStock(product, size, color = null) {
            if (product.isColorProduct && color) {
                return Number(product.stockByColor?.[color]?.[size]) || 0; 
            } else {
                return Number(product.stock?.[size]) || 0;
            }
        }

        // =======================================================
        // RENDERIZACI칍N DE TARJETAS DE PRODUCTO
        // =======================================================

        window.renderProductCards = function() {
            const list = document.getElementById('product-list');
            list.innerHTML = ''; 

            if (!window.inventory || window.inventory.length === 0) {
                list.innerHTML = '<h2 class="text-center">No se encontraron productos disponibles.</h2>';
                return;
            }

            window.inventory.forEach(product => {
                let maxStock = 0;
                
                if (product.isColorProduct && product.stockByColor) {
                    for (const color in product.stockByColor) {
                        for (const size in product.stockByColor[color]) {
                            maxStock = Math.max(maxStock, getStock(product, size, color)); 
                        }
                    }
                } else if (product.stock) {
                    for (const size in product.stock) {
                        maxStock = Math.max(maxStock, getStock(product, size)); 
                    }
                }
                
                const status = maxStock >= MINIMUM_TO_SHIP ? 'Disponible' : 'Agotado'; 
                const statusClass = maxStock >= MINIMUM_TO_SHIP ? 'bg-success' : 'bg-danger';

                let frontFileBase = product.frontFileBase || '';
                if (product.isColorProduct && product.colors && product.colorMap && product.colorMap[product.colors[0]]) {
                     frontFileBase = product.colorMap[product.colors[0]].front;
                }

                const card = `
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card product-card h-100">
                            <span class="stock-badge ${statusClass} badge fs-6 p-2 rounded-0">${status}</span> 
                            <img src="${getImageUrl(frontFileBase)}" class="card-img-top p-2" alt="${product.name}" 
                                 onerror="this.onerror=null;this.src='${GITHUB_BASE_URL}fallback_default${IMAGE_EXTENSION}';">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">${product.name}</h5>
                                <p class="card-text text-success fw-bold">$${product.price.toFixed(2)}</p>
                                <button class="btn btn-buy mt-auto btn-block btn-lg" data-product-id="${product.id}" 
                                        ${maxStock === 0 ? 'disabled' : ''}>
                                    ${maxStock === 0 ? 'Agotado' : (product.isColorProduct ? 'Ver Colores / Pedir' : 'Ver / Pedir')}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                list.innerHTML += card;
            });
        }
        
        // =======================================================
        // L칍GICA DE MODAL DE DETALLE Y CARRUSEL
        // =======================================================

        function getFileBase(product, view, color = null) {
            if (product.isColorProduct && color && product.colorMap[color]) {
                return product.colorMap[color][view] || product[`${view}FileBase`];
            }
            return product[`${view}FileBase`];
        }

        window.openModalDetail = function(productId) {
            const product = window.inventory.find(p => p.id === productId);
            if (!product) return;
            window.currentProductInModal = product;

            document.getElementById('modalProductId').value = productId;
            document.getElementById('modalProductName').textContent = product.name;
            document.getElementById('modalProductDescription').textContent = product.description;
            document.getElementById('modalProductPrice').textContent = `$${product.price.toFixed(2)}`;
            
            const colorContainer = document.getElementById('colorSelectContainer');
            const colorSelect = document.getElementById('colorSelect');
            
            let defaultColor = null;

            if (product.isColorProduct && product.colors && product.colors.length > 0) {
                colorContainer.style.display = 'block';
                colorSelect.innerHTML = '';
                
                product.colors.forEach(color => {
                    const option = document.createElement('option');
                    option.value = color;
                    option.textContent = color;
                    colorSelect.appendChild(option);
                });
                
                defaultColor = product.colors[0]; 
                
                colorSelect.onchange = () => {
                    const selectedColor = colorSelect.value;
                    renderCarousel(product, selectedColor);
                    updateSizesForSelectedColor(product, selectedColor);
                };

            } else {
                colorContainer.style.display = 'none';
                defaultColor = null; 
            }
            
            renderCarousel(product, defaultColor);
            updateSizesForSelectedColor(product, defaultColor);

            document.getElementById('quantityInput').value = 1;

            const modal = new bootstrap.Modal(document.getElementById('productDetailModal'));
            modal.show();
            
            const sizeSelect = document.getElementById('sizeSelect');
            sizeSelect.onchange = updateTotalAndCheckStock;
            
            updateTotalAndCheckStock(); 
        }
        
        function renderCarousel(product, color = null) {
            const indicators = document.getElementById('carouselIndicators');
            const inner = document.getElementById('carouselInner');
            indicators.innerHTML = '';
            inner.innerHTML = '';
            
            const frontFileBase = getFileBase(product, 'front', color);
            const backFileBase = getFileBase(product, 'back', color);
            const sideFileBase = getFileBase(product, 'side', color) || GENERIC_SIDE_IMAGE_BASE; 
            
            const colorText = color ? ` (${color})` : '';

            const imageVariants = [
                { variant: `Frente${colorText}`, fileBase: frontFileBase, alt: 'Frente' }, 
                { variant: `Espalda${colorText}`, fileBase: backFileBase, alt: 'Espalda' },
                { variant: 'Lateral (Medidas)', fileBase: sideFileBase, alt: 'Lateral' }
            ];

            imageVariants.forEach((item, index) => {
                const imgUrl = getImageUrl(item.fileBase);
                
                indicators.innerHTML += `
                    <button type="button" data-bs-target="#productCarousel" data-bs-slide-to="${index}" 
                        class="${index === 0 ? 'active' : ''}" aria-current="${index === 0 ? 'true' : 'false'}" 
                        aria-label="Slide ${index + 1}">
                    </button>
                `;
                
                inner.innerHTML += `
                    <div class="carousel-item ${index === 0 ? 'active' : ''}">
                        <img src="${imgUrl}" class="d-block w-100" alt="${product.name} ${item.alt}"
                            onerror="this.onerror=null;this.src='${GITHUB_BASE_URL}fallback_default${IMAGE_EXTENSION}';">
                    </div>
                `;
            });
        }

        function updateSizesForSelectedColor(product, selectedColor) {
            const sizeSelect = document.getElementById('sizeSelect');
            sizeSelect.innerHTML = '';
            let firstAvailableSize = null;
            
            let stockMap = product.stock || {};
            
            if (product.isColorProduct && selectedColor && product.stockByColor) {
                stockMap = product.stockByColor[selectedColor] || {};
            }
            
            // Obtener tallas ordenadas (S, M, L, XL, etc.)
            const sizesToProcess = Object.keys(stockMap).sort((a, b) => {
                const order = ['XS', 'S', 'M', 'L', 'XL', 'XXL', '3XL', '4XL'];
                const aIndex = order.indexOf(a.toUpperCase());
                const bIndex = order.indexOf(b.toUpperCase());
                return (aIndex > -1 ? aIndex : 100) - (bIndex > -1 ? bIndex : 100);
            });
            
            sizesToProcess.forEach(size => {
                const stock = Number(stockMap[size]) || 0; 
                
                if (stock > 0) {
                    const option = document.createElement('option');
                    option.value = size;
                    option.textContent = `${size} (Stock: ${stock})`; 
                    sizeSelect.appendChild(option);

                    if (!firstAvailableSize) {
                        firstAvailableSize = size;
                    }
                }
            });
            
            if (firstAvailableSize) {
                sizeSelect.value = firstAvailableSize;
            }
            updateTotalAndCheckStock(); 
        }


        function updateTotalAndCheckStock() {
            const productId = document.getElementById('modalProductId').value;
            const size = document.getElementById('sizeSelect').value;
            const quantityInput = document.getElementById('quantityInput');
            const colorSelect = document.getElementById('colorSelect');
            
            const product = window.inventory.find(p => p.id === productId);
            const selectedColor = product && product.isColorProduct ? colorSelect.value : null;

            let quantity = parseInt(quantityInput.value);
            const stock = getStock(product, size, selectedColor); 
            const addButton = document.getElementById('addToOrderButton');

            if (quantity < 1 || isNaN(quantity)) {
                quantityInput.value = 1;
                quantity = 1;
            }

            const cartItemId = `${productId}-${selectedColor || 'N/A'}-${size}`;
            const existingItem = window.currentOrder.find(item => item.cartItemId === cartItemId);
            const currentInCart = existingItem ? existingItem.quantity : 0;
            
            const maxToAdd = stock - currentInCart;

            if (stock > 0 && maxToAdd > 0) {
                addButton.disabled = false;
                
                if (quantity > maxToAdd) {
                    quantityInput.value = maxToAdd;
                    quantity = maxToAdd;
                }
                addButton.textContent = `A침adir ${quantity} a Pedido`;
                
            } else {
                addButton.disabled = true;
                if (stock > 0 && maxToAdd <= 0) {
                     addButton.textContent = 'Stock m치ximo en pedido (Ver Carrito)';
                } else {
                    addButton.textContent = 'A침adir al Pedido (Agotado)';
                }
                
                quantityInput.value = 0;
            }
        }

        document.getElementById('orderForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const productId = document.getElementById('modalProductId').value;
            const product = window.inventory.find(p => p.id === productId);
            const size = document.getElementById('sizeSelect').value;
            const quantity = parseInt(document.getElementById('quantityInput').value);

            const colorSelect = document.getElementById('colorSelect');
            const color = product && product.isColorProduct ? colorSelect.value : null;
            const finalColor = color || '칔nico';

            if (!product || quantity <= 0) return;

            const stock = getStock(product, size, color); 
            
            const cartItemId = `${productId}-${finalColor}-${size}`;
            const existingItem = window.currentOrder.find(item => item.cartItemId === cartItemId);
            const currentInCart = existingItem ? existingItem.quantity : 0;
            
            if (currentInCart + quantity > stock) {
                alert(`Error: Solo quedan ${stock - currentInCart} unidades disponibles en talla ${size} ${finalColor} para a침adir. Stock total: ${stock}.`);
                return;
            }

            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                window.currentOrder.push({
                    cartItemId: cartItemId,
                    productId: productId,
                    name: product.name,
                    description: product.description,
                    size: size,
                    color: finalColor, 
                    quantity: quantity,
                    price: product.price,
                    isColorProduct: product.isColorProduct,
                    frontFileBase: getFileBase(product, 'front', color)
                });
            }

            localStorage.setItem('currentOrder', JSON.stringify(window.currentOrder));

            const detailModal = bootstrap.Modal.getInstance(document.getElementById('productDetailModal'));
            detailModal.hide();
            window.openOrdersModal(); 
        });

        // =======================================================
        // L칍GICA DE MODAL DE PEDIDOS (CARRITO DETALLADO)
        // =======================================================

        window.openOrdersModal = function() {
            window.renderOrdersList();
            const modal = new bootstrap.Modal(document.getElementById('ordersModal'));
            modal.show();
        }

        window.renderOrdersList = function() {
            const list = document.getElementById('currentOrdersList');
            const emptyMessage = document.getElementById('emptyOrdersMessage');
            
            list.innerHTML = ''; 
            list.appendChild(emptyMessage);
            
            if (window.currentOrder.length === 0) {
                emptyMessage.style.display = 'block';
                document.getElementById('finalizeOrderButton').disabled = true;
                updateOrdersCounter(0);
                updateModalUI(false);
                updateOrdersTotal(); 
                return;
            }

            emptyMessage.style.display = 'none';
            let totalItems = 0;

            window.currentOrder.forEach((item, index) => {
                const totalPrice = item.quantity * item.price;
                totalItems += item.quantity;
                
                const product = window.inventory.find(p => p.id === item.productId);
                
                const frontFileBase = item.frontFileBase || (product ? product.frontFileBase : null);
                const imageUrl = getImageUrl(frontFileBase);
                
                const colorText = item.color && item.color !== '칔nico' ? ` | Color: ${item.color}` : '';

                const itemDiv = document.createElement('li');
                itemDiv.className = 'list-group-item cart-item-detail';
                itemDiv.innerHTML = `
                    <img src="${imageUrl}" alt="${item.name}" onerror="this.onerror=null;this.src='${GITHUB_BASE_URL}fallback_default${IMAGE_EXTENSION}'"/>
                    <div class="cart-item-info">
                        <strong>${item.name}</strong>
                        <span>Modelo: ${item.description} | Talla: ${item.size}${colorText}</span>
                        <span>Cantidad: ${item.quantity} | Precio c/u: $${item.price.toFixed(2)}</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="fw-bold text-primary me-3">$${totalPrice.toFixed(2)}</span>
                        <button class="btn btn-sm btn-outline-danger cart-item-remove-btn" onclick="window.removeItemFromOrder(${index})">
                            &times;
                        </button>
                    </div>
                `;
                list.appendChild(itemDiv);
            });
            
            updateOrdersCounter(window.currentOrder.length);
            updateModalUI(true);
            updateOrdersTotal(); 
        }

        window.removeItemFromOrder = function(index) {
            window.currentOrder.splice(index, 1);
            localStorage.setItem('currentOrder', JSON.stringify(window.currentOrder));
            window.renderOrdersList();
        }

        function updateOrdersTotal() {
            const totalElement = document.getElementById('ordersTotal');
            const halfPaymentElement = document.getElementById('halfPaymentAmount');
            const halfPaymentCheck = document.getElementById('halfPaymentCheck');
            
            const subtotal = window.currentOrder.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            
            const halfAmount = subtotal / 2;
            halfPaymentElement.textContent = `$${halfAmount.toFixed(2)}`;

            if (halfPaymentCheck.checked) {
                totalElement.textContent = `$${halfAmount.toFixed(2)}`;
            } else {
                totalElement.textContent = `$${subtotal.toFixed(2)}`;
            }
        }
        
        document.getElementById('halfPaymentCheck').addEventListener('change', updateOrdersTotal); 

        function updateOrdersCounter(count) {
            document.getElementById('ordersCounter').textContent = count; 
        }

        function updateModalUI(hasItems) {
            const finalizeButton = document.getElementById('finalizeOrderButton');
            const clientDataForm = document.getElementById('clientDataForm');
            const paymentDetailsSection = document.getElementById('paymentDetailsSection');
            
            const clientFormValid = document.getElementById('clientDataForm').checkValidity();

            if (hasItems) {
                finalizeButton.disabled = !clientFormValid;
                clientDataForm.style.display = 'block';
                paymentDetailsSection.style.display = 'block';
            } else {
                finalizeButton.disabled = true;
                clientDataForm.style.display = 'none';
                paymentDetailsSection.style.display = 'none';
            }
        }
        
        document.getElementById('clientDataForm').addEventListener('input', () => {
            if (window.currentOrder.length > 0) {
                document.getElementById('finalizeOrderButton').disabled = !document.getElementById('clientDataForm').checkValidity();
            }
        });

        // =======================================================
        // L칍GICA DE ENV칈O POR WHATSAPP Y DESCUENTO DE STOCK
        // =======================================================

        window.sendOrderToWhatsapp = async function() {
            if (window.currentOrder.length === 0 || !document.getElementById('clientDataForm').checkValidity()) {
                alert("Por favor, a침ade productos al pedido y completa tus datos de env칤o.");
                return;
            }

            const clientName = document.getElementById('clientName').value;
            const clientAddress = document.getElementById('clientAddress').value;
            const clientPhone = document.getElementById('clientPhone').value;
            const isHalfPayment = document.getElementById('halfPaymentCheck').checked;
            
            const total = window.currentOrder.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            const amountToPay = isHalfPayment ? total / 2 : total;

            let orderText = `*PEDIDO RPLAY*\n\n`;
            orderText += `*Total a Pagar:* $${amountToPay.toFixed(2)} (${isHalfPayment ? 'Anticipo 50%' : 'Pago Completo'})\n`;
            orderText += `*Productos:*\n`;
            
            const transactionPromises = [];
            const firestoreDB = getFirestore(app);

            for (const [index, item] of window.currentOrder.entries()) {
                const colorText = item.color && item.color !== '칔nico' ? ` (${item.color})` : '';
                orderText += `${index + 1}. *${item.name}* - ${item.description} (${item.size})${colorText} - ${item.quantity} pza(s) - $${(item.quantity * item.price).toFixed(2)}\n`;
                
                const productRef = doc(firestoreDB, 'products', item.productId);

                const transactionPromise = runTransaction(firestoreDB, async (transaction) => {
                    const docSnapshot = await transaction.get(productRef);
                    if (!docSnapshot.exists()) {
                        throw new Error(`Documento de producto con ID ${item.productId} no encontrado.`);
                    }

                    const currentProduct = docSnapshot.data();
                    let currentStock = 0;
                    let stockMap = {};

                    if (item.isColorProduct) {
                        stockMap = currentProduct.stockByColor?.[item.color] || {};
                        currentStock = Number(stockMap[item.size]) || 0; 
                    } else {
                        stockMap = currentProduct.stock || {};
                        currentStock = Number(stockMap[item.size]) || 0; 
                    }
                    
                    const newStock = currentStock - item.quantity;
                    
                    if (newStock >= 0) {
                        const updatedStockMap = { ...stockMap, [item.size]: newStock };
                        
                        let updateData = {};
                        if (item.isColorProduct) {
                            updateData = { 
                                stockByColor: {
                                    ...currentProduct.stockByColor,
                                    [item.color]: updatedStockMap
                                }
                            };
                        } else {
                            updateData = { stock: updatedStockMap };
                        }
                        
                        transaction.update(productRef, updateData);
                        return currentProduct;
                    } else {
                        throw new Error(`Stock insuficiente para ${item.name} (${item.color}, ${item.size}).`);
                    }
                });
                
                transactionPromises.push(transactionPromise);
            }

            try {
                await Promise.all(transactionPromises);

                orderText += `\n*Datos del Cliente:*\n`;
                orderText += `Nombre: ${clientName}\n`;
                orderText += `Tel칠fono: ${clientPhone}\n`;
                orderText += `Direcci칩n: ${clientAddress}\n`;
                orderText += `\n*IMPORTANTE:* Adjunta aqu칤 tu comprobante de pago o transferencia para confirmar tu pedido.`;

                const whatsappURL = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(orderText)}`;

                window.currentOrder = [];
                localStorage.setItem('currentOrder', JSON.stringify(window.currentOrder));
                
                const ordersModal = bootstrap.Modal.getInstance(document.getElementById('ordersModal'));
                ordersModal.hide();
                
                window.loadProductsFromFirebase();

                alert("춰Pedido enviado! El stock ha sido actualizado en la base de datos de Firestore. Redirigiendo a WhatsApp.");
                
                window.open(whatsappURL, '_blank');

            } catch (error) {
                console.error("Error al finalizar la compra y actualizar stock:", error);
                alert("Hubo un error al procesar el pedido. Por favor, verifica el stock.");
            }
        }


        // =======================================================
        // INICIALIZACI칍N
        // =======================================================

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('product-list').addEventListener('click', (e) => {
                const target = e.target.closest('.btn-buy');
                if (target && !target.disabled) {
                    const productId = target.getAttribute('data-product-id');
                    window.openModalDetail(productId); 
                }
            });
            
            const quantityInput = document.getElementById('quantityInput');
            if (quantityInput) {
                quantityInput.addEventListener('change', updateTotalAndCheckStock);
                quantityInput.addEventListener('input', updateTotalAndCheckStock);
            }
            
            // Inicia la carga de productos desde Firebase
            window.loadProductsFromFirebase();
        });

    </script>
</body>
</html>
