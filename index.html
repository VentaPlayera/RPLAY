<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPLAY - Preventa Exclusiva</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- ESTILOS GENERALES Y MODERNOS --- */
        :root {
            --primary-color: #d63384; /* Rosa fuerte */
            --secondary-color: #343a40; 
            --accent-color: #ffc107; /* Amarillo para advertencias */
            --preventa-color: #007bff; /* Azul para Preventa */
        }
        body { 
            background-color: #f4f7f6; 
            font-family: 'Arial', sans-serif; 
            font-size: 16px; 
        }
        .container { 
            margin-top: 30px; 
            padding-left: 15px; 
            padding-right: 15px; 
        }
        h1 { 
            color: var(--secondary-color); 
            font-weight: 700; 
            margin-bottom: 40px; 
            font-size: 2.5rem; 
        }
        
        /* --- TARJETA DE PRODUCTO --- */
        .logo-img { 
            max-width: 150px; 
            margin-bottom: 20px;
            height: auto; 
        }
        .product-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 8px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s, box-shadow 0.3s;
            overflow: hidden;
            position: relative;
            margin-bottom: 20px; 
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 25px rgba(0,0,0,0.15);
        }
        .product-card img {
            height: 320px; 
            width: 100%;
            object-fit: cover;
            border-bottom: 1px solid #eee;
            background-color: #fff;
        }
        .btn-buy {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .btn-buy:hover {
            background-color: #b82b71;
            border-color: #b82b71;
            color: white;
        }

        /* --- BADGES Y STOCK (SOLO AGOTADO Y PREVENTA) --- */
        .stock-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 5px 10px;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: bold;
            z-index: 10;
        }
        .stock-badge.agotado { 
            background-color: #dc3545; /* Rojo */
            color: white; 
            animation: pulse 1.5s infinite; 
        }
        .stock-badge.preventa { 
            background-color: var(--preventa-color); /* Azul */
            color: white; 
        }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* --- MODAL Y SELECCI√ìN DE TALLAS --- */
        .modal-header, .modal-footer { border: none; }
        .size-options .size-btn {
            cursor: pointer;
            padding: 8px 16px;
            margin: 4px;
            border: 2px solid #ccc;
            border-radius: 5px;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 0.9rem; 
        }
        .size-options .size-btn:not(.disabled):hover { border-color: var(--primary-color); }
        .size-options .size-btn.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .size-options .size-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            text-decoration: line-through;
        }
        
        /* --- ESTILOS RESPONSIVOS PARA EL CARRUSEL EN EL MODAL --- */
        #productCarousel {
            max-width: 100%; 
            margin: auto; 
            background-color: #fff; 
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        #productCarousel .carousel-inner {
            height: 50vh; /* Altura responsiva: 50% de la altura de la ventana */
            min-height: 300px; /* Altura m√≠nima para asegurar visibilidad */
            max-height: 550px; /* Altura m√°xima en desktops */
            display: flex; 
            align-items: center; 
            justify-content: center; 
            overflow: hidden; 
            border-radius: 10px;
        }

        #productCarousel .carousel-item {
            height: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }

        #productCarousel .carousel-item img {
            max-width: 100%; 
            max-height: 100%; 
            object-fit: contain; /* Asegura que la imagen quepa completa */
            width: auto; 
            height: auto; 
            display: block; 
        }
        #productCarousel .carousel-indicators button {
            background-color: var(--primary-color);
        }

        /* MEDIA QUERIES para responsividad en m√≥viles */
        @media (max-width: 575.98px) {
            h1 { font-size: 1.8rem; margin-bottom: 20px; }
            .product-card img { height: 250px; } 
            .btn-buy { font-size: 0.9rem; padding: 10px 15px; }
            .modal-dialog { margin: 0.5rem; } 
            #productCarousel .carousel-inner {
                height: 40vh; /* Menos altura en m√≥viles */
                min-height: 250px;
            }
            .size-options .size-btn { padding: 6px 12px; font-size: 0.85rem; }
        }
    </style>
</head>
<body>

    <div class="container">
        <img src="https://ventaplayera.github.io/RPLAY/logo.png" alt="RPLAY Logo" class="logo-img img-fluid mx-auto d-block">
        <h1 class="text-center">RPLAY - Preventa Exclusiva</h1>
        
        <div id="manualManagementPanel" class="p-3 mb-4 rounded" style="display: none; background-color: #fff3cd; border: 1px solid #ffeeba;">
            <h4 class="text-warning"><i class="fas fa-exclamation-triangle"></i> Panel de Administraci√≥n - INVENTARIO</h4>
            <div id="ordersList" class="my-3"></div>
            <button class="btn btn-sm btn-danger w-100 mt-2" onclick="resetAllStock()">
                <i class="fas fa-trash-restore-alt"></i> Borrar TODAS las Reservas y Restaurar Inventario
            </button>
        </div>

        <div class="row" id="product-list">
            </div>
    </div>

    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalLabel">Apartado: <span id="modal-product-name" class="text-primary"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    
                    <div id="selection-step">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                
                                <div id="productCarousel" class="carousel slide">
                                    <div class="carousel-indicators" id="carousel-indicators-content">
                                        </div>
                                    <div class="carousel-inner" id="carousel-inner-content">
                                        </div>
                                    <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                        <span class="visually-hidden">Previous</span>
                                    </button>
                                    <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                        <span class="visually-hidden">Next</span>
                                    </button>
                                </div>
                                
                                <p class="text-muted small mt-2" id="modal-product-description"></p>
                            </div>

                            <div class="col-md-6">
                                <h4 class="mb-3">1. Selecciona tu talla:</h4>
                                    
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Talla:</label>
                                    <div id="size-options" class="size-options"></div>
                                    <small class="text-success" id="size-status">Selecciona una talla para ver la disponibilidad.</small>
                                </div>
                                    
                                <div class="mb-3" style="display:none;">
                                    <label for="quantityInput" class="form-label fw-bold">Cantidad:</label>
                                    <input type="number" id="quantityInput" class="form-control" value="1" min="1" max="1" disabled>
                                    <small class="text-muted" id="quantity-status">Solo puedes pedir 1 unidad por talla.</small>
                                </div>
                                    
                                <div class="alert alert-info mt-3">
                                    <h5 class="mb-0">Precio Unitario: <span id="modal-unit-price" class="fw-bold">$0.00 MXN</span></h5>
                                </div>

                                <div id="payment-detail-box" class="mt-4">
                                    <h4 class="mb-3">2. Elige tu Opci√≥n de Pago:</h4>
                                        
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" value="" id="halfPaymentCheck" checked>  
                                        <label class="form-check-label fw-bold" for="halfPaymentCheck">
                                            Pago Parcial (Apartado): <span class="text-muted small">(Paga la mitad ahora, el resto a la entrega)</span>
                                        </label>
                                    </div>
                                        
                                    <div class="card bg-light p-3 mb-3">
                                        <h5>Detalle del Pago</h5>
                                        <p class="mb-1">Total de la Compra: <span class="float-end fw-bold" id="total-price">$0.00 MXN</span></p>
                                        <hr class="my-2">
                                        <p class="mb-0 text-success">Monto a Pagar Ahora: <span class="float-end fw-bold fs-5" id="payment-due">$0.00 MXN</span></p>
                                    </div>
                                </div>
                                <p class="text-danger mt-3" style="display:none;" id="selection-error">
                                    <i class="fas fa-exclamation-circle"></i> Por favor, selecciona una talla antes de continuar.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div id="payment-step" style="display:none;">
                        <h4>3. Datos del Comprador y Env√≠o:</h4>
                            
                        <div id="payment-step-info-box" class="alert alert-info"></div>
                            
                        <form id="client-data-form">
                            <div class="mb-3">
                                <label for="clientName" class="form-label">Nombre Completo (*):</label>
                                <input type="text" class="form-control" id="clientName" required>
                            </div>
                            <div class="mb-3">
                                <label for="clientPhone" class="form-label">Tel√©fono/WhatsApp (*):</label>
                                <input type="tel" class="form-control" id="clientPhone" required>
                            </div>
                            <div class="mb-3">
                                <label for="clientAddress" class="form-label">Direcci√≥n de Env√≠o Completa (*):</label>
                                <textarea class="form-control" id="clientAddress" rows="3" required></textarea>
                            </div>
                                
                            <p class="text-danger mt-3" style="display:none;" id="payment-error">
                                <i class="fas fa-exclamation-circle"></i> Por favor, completa todos los campos marcados con (*) para continuar.
                            </p>
                        </form>
                    </div>

                    <div id="transfer-info" style="display:none;">
                        <h4>4. Realiza tu pago o dep√≥sito:</h4>
                        <div class="alert alert-success">
                            <p class="mb-1"><strong>¬°Pedido Pre-Aprobado!</strong> Tienes **24 horas** para realizar tu dep√≥sito y enviar tu comprobante. **Tu playera queda apartada al enviar el comprobante por WhatsApp.**</p>
                            <p class="mb-0 text-muted small">Tu pedido: <span id="final-qty-conf"></span>x <span id="final-item-display"></span> (Talla <span id="final-size-conf"></span>). Monto a Enviar: <span id="final-amount-conf" class="text-primary fw-bold"></span>.</p>
                        </div>
                            
                        <div class="card border-primary p-3">
                            <h5 class="text-primary"><i class="fas fa-university"></i> Datos de Dep√≥sito/Transferencia</h5>
                            <p class="mb-1">Banco: **BBVA**</p>
                            <p class="mb-1">Cuenta: **0123 4567 89**</p>
                            <p class="mb-1">CLABE: **0123 4567 8901 2345 67**</p>
                            <p class="mb-0 text-primary">Beneficiario: **RPLAY S.A. de C.V.**</p>
                        </div>
                    </div>
                </div>
                    
                <div class="modal-footer d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary" id="modal-close-button" data-bs-dismiss="modal">Cerrar</button>
                        
                    <button type="button" class="btn btn-primary" id="modal-main-button" disabled>
                        Continuar
                    </button>

                    <a id="whatsapp-confirm-button" class="btn btn-success" target="_blank" style="display:none;">
                        <i class="fab fa-whatsapp"></i> Enviar Comprobante por WhatsApp
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- 1. GENERACI√ìN DIN√ÅMICA DE INVENTARIO INICIAL (70 Productos) ---
        const productInventory = {};
        const productData = [];
        const DEFAULT_GLOBAL_SIZES = ["S", "M", "L", "XL"]; 
        const FIXED_PRICE = 250.00; 
        const DEFAULT_STOCK_PER_SIZE = 1; 
        const WHATSAPP_PHONE = "529991480151"; 
        const ADMIN_HASH = "819c99d25145b5c9b740751939331908"; 
        
        // FUNCI√ìN: Inicializa el inventario base
        function initializeInventory(productID, sizes, initialStockOverrides = {}) {
            productInventory[productID] = {};
            sizes.forEach(size => {
                productInventory[productID][size] = initialStockOverrides[size] !== undefined ? initialStockOverrides[size] : DEFAULT_STOCK_PER_SIZE;
            });
        }

        for (let i = 1; i <= 70; i++) {
            const id = `PROD_${String(i).padStart(3, '0')}`;
            let mainImg, frontImg, backImg, sizeGuideImg;
            let modelSizes = [...DEFAULT_GLOBAL_SIZES]; 
            let initialStockOverrides = {};
            
            // Im√°genes de placeholder para los modelos sin imagen expl√≠cita
            mainImg = 'https://via.placeholder.com/250x250/F8F8F8?text=Modelo+' + i;
            frontImg = 'https://via.placeholder.com/500x500/F8F8F8?text=Frente+' + i;
            backImg = 'https://via.placeholder.com/500x500/F8F8F8?text=Espalda+' + i;
            sizeGuideImg = 'https://via.placeholder.com/500x500/F8F8F8?text=Medidas+' + i; 
            
            // --- L√≥gica para configurar tallas y stock por modelo (MODELOS ESPEC√çFICOS) ---
            if (i === 1) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Xime1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Xime1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Xime2.png';
                sizeGuideImg = 'https://ventaplayera.github.io/RPLAY/Medidas.png'; 
                modelSizes = ['S', 'M', 'L']; 
                initialStockOverrides.S = 2; 
                initialStockOverrides.M = 1; 
                initialStockOverrides.L = 1; 
            } else if (i === 2 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Xime3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Xime3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Xime4.png';
                sizeGuideImg = 'https://ventaplayera.github.io/RPLAY/Medidas.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            }
            // --- FIN DE L√ìGICA DE MODELOS ESPEC√çFICOS ---

            initializeInventory(id, modelSizes, initialStockOverrides);

            productData.push({
                id: id,
                name: `Playera Modelo No. ${i}`,
                price: FIXED_PRICE.toFixed(2), 
                description: `Dise√±o exclusivo #${i} con estampado digital de alta calidad. Tela de algod√≥n 100%.`,
                img_main: mainImg,
                img_front: frontImg, 
                img_back: backImg,   
                img_size_guide: sizeGuideImg 
            });
        }
        
        // --- 2. INVENTARIO PERSISTENTE (Pedidos Confirmados) ---
        let localOrders = JSON.parse(localStorage.getItem('simulatedOrders')) || {};
        
        // --- 3. L√≥gica del Sistema ---
        document.addEventListener('DOMContentLoaded', function () {
            
            // --- REFERENCIAS A ELEMENTOS HTML ---
            const productListContainer = document.getElementById('product-list');
            const paymentModal = document.getElementById('paymentModal');
            const selectionStep = document.getElementById('selection-step');
            const paymentStep = document.getElementById('payment-step');
            const transferInfo = document.getElementById('transfer-info');
            const sizeOptionsContainer = document.getElementById('size-options');
            const halfPaymentCheck = document.getElementById('halfPaymentCheck');
            const clientNameInput = document.getElementById('clientName');
            const clientPhoneInput = document.getElementById('clientPhone');
            const clientAddressInput = document.getElementById('clientAddress');
            const mainButton = document.getElementById('modal-main-button');
            const whatsappButton = document.getElementById('whatsapp-confirm-button'); 
            const sizeStatusEl = document.getElementById('size-status'); 
            const quantityInput = document.getElementById('quantityInput');
            const unitPriceDisplay = document.getElementById('modal-unit-price');
            const managementPanel = document.getElementById('manualManagementPanel');
            const modalProductName = document.getElementById('modal-product-name');
            const modalProductDesc = document.getElementById('modal-product-description');
            const carouselInner = document.getElementById('carousel-inner-content'); 
            const carouselIndicators = document.getElementById('carousel-indicators-content'); 
            
            // Variables de estado
            let currentPrice = FIXED_PRICE;
            let currentSelectedSize = null;
            let currentProductName = '';
            let currentProductID = ''; 
            
            // --- Funciones de L√≥gica ---
            
            function saveLocalOrders() {
                localStorage.setItem('simulatedOrders', JSON.stringify(localOrders));
                if (managementPanel.style.display === 'block') {
                    renderManualManagementPanel(); 
                }
            }

            function getAvailableStock(productID, size) {
                const stock = productInventory[productID] && productInventory[productID][size] !== undefined ? productInventory[productID][size] : 0;
                const pendingOrders = localOrders[`${productID}-${size}`] || 0; 
                return stock - pendingOrders;
            }
            
            // FUNCI√ìN CRUCIAL: Solo AGOTADO o PREVENTA
            function updateProductBadge(productID) {
                const badgeEl = document.getElementById(`badge-${productID}`);
                if (!badgeEl) return;
                
                let totalStock = 0;

                if (productInventory[productID]) {
                    Object.keys(productInventory[productID]).forEach(size => {
                        totalStock += getAvailableStock(productID, size);
                    });
                }

                badgeEl.textContent = '';
                // Limpiamos TODAS las clases de estado antes de aplicar la nueva
                badgeEl.className = 'stock-badge'; 

                if (totalStock === 0) {
                    badgeEl.textContent = 'AGOTADO';
                    badgeEl.classList.add('agotado');
                } else { 
                    // Si hay stock disponible (> 0), siempre se muestra PREVENTA
                    badgeEl.textContent = 'PREVENTA';
                    badgeEl.classList.add('preventa');
                }
            }

            function initializeBadges() {
                productData.forEach(product => updateProductBadge(product.id));
            }

            function createSizeButtons(productID) {
                if (!sizeOptionsContainer) return;
                const sizes = productInventory[productID] ? Object.keys(productInventory[productID]) : [];
                sizeOptionsContainer.innerHTML = ''; 
                currentSelectedSize = null; 
                sizeStatusEl.textContent = 'Selecciona una talla para ver la disponibilidad.';
                mainButton.disabled = true;
                quantityInput.disabled = true;
                quantityInput.value = 1;

                sizes.forEach(size => {
                    const availableStock = getAvailableStock(productID, size); 
                    const button = document.createElement('span');
                    button.textContent = size;
                    button.classList.add('size-btn');
                    button.setAttribute('data-size', size);
                    
                    if (availableStock <= 0) {
                        button.classList.add('disabled');
                        button.title = 'Talla Agotada';
                        button.textContent = `${size} (Agotada)`; 
                    } else {
                        if (availableStock === 1) {
                            button.title = '¬°√öltima Unidad!';
                        }
                        button.addEventListener('click', () => handleSizeSelection(button, size, availableStock));
                    }
                    sizeOptionsContainer.appendChild(button);
                });
            }

            function handleSizeSelection(selectedButton, size, stock) {
                document.querySelectorAll('.size-btn').forEach(btn => btn.classList.remove('selected'));
                selectedButton.classList.add('selected');
                
                currentSelectedSize = size;
                mainButton.disabled = false;
                mainButton.textContent = 'Continuar';

                // L√ìGICA DE CANTIDAD
                quantityInput.max = stock; 
                quantityInput.value = 1; 
                quantityInput.disabled = (stock <= 1); 

                document.getElementById('quantity-status').textContent = `Puedes seleccionar hasta ${stock} unidad${stock !== 1 ? 'es' : ''}.`;
                
                // Estos mensajes S√ç pueden indicar bajo stock, ya que se refieren a la talla espec√≠fica
                sizeStatusEl.style.display = 'block';
                if (stock === 1) {
                    sizeStatusEl.textContent = '¬°Solo queda 1 unidad! ¬°Ap√∫rate!';
                    sizeStatusEl.className = 'text-danger mt-2';
                } else if (stock <= 3) {
                    sizeStatusEl.textContent = `Quedan ${stock} unidades.`;
                    sizeStatusEl.className = 'text-warning mt-2';
                } else {
                    sizeStatusEl.textContent = `Stock disponible: ${stock} unidades.`;
                    sizeStatusEl.className = 'text-success mt-2';
                }
                
                updatePaymentAmounts();
            }

            function resetModalView() {
                selectionStep.style.display = 'block';
                paymentStep.style.display = 'none';
                transferInfo.style.display = 'none';
                mainButton.textContent = 'Continuar';
                mainButton.style.display = 'inline-block';
                mainButton.disabled = true;
                document.getElementById('selection-error').style.display = 'none';
                document.getElementById('payment-error').style.display = 'none';
                whatsappButton.style.display = 'none'; 
                sizeStatusEl.style.display = 'block'; 
                quantityInput.value = 1;

                // Forzar el carrusel a la primera diapositiva al cerrar/reiniciar
                const carouselElement = document.getElementById('productCarousel');
                const carousel = bootstrap.Carousel.getInstance(carouselElement);
                if (carousel) carousel.to(0);
                else new bootstrap.Carousel(carouselElement, { interval: false }).to(0); // Asegura la inicializaci√≥n est√°tica si no exist√≠a.
            }
            
            function saveClientData() {
                const data = {
                    name: clientNameInput.value,
                    phone: clientPhoneInput.value,
                    address: clientAddressInput.value
                };
                localStorage.setItem('clientFormData', JSON.stringify(data));
            }

            function loadClientData() {
                const data = JSON.parse(localStorage.getItem('clientFormData'));
                if (data) {
                    clientNameInput.value = data.name || '';
                    clientPhoneInput.value = data.phone || '';
                    clientAddressInput.value = data.address || '';
                }
            }
            
            window.releaseOrder = function(orderKey) {
                if (localOrders[orderKey] && localOrders[orderKey] > 0) {
                    localOrders[orderKey]--;
                    if (localOrders[orderKey] === 0) delete localOrders[orderKey];
                    saveLocalOrders();
                    alert(`Orden ${orderKey} liberada. Stock ajustado.`);
                    initializeBadges();
                    if (currentProductID === orderKey.split('-')[0]) createSizeButtons(currentProductID);
                }
            };
            
            window.resetAllStock = function() {
                if (confirm("ADVERTENCIA: ¬øEst√°s seguro de que quieres borrar TODAS las reservas y restaurar el inventario inicial?")) {
                    localStorage.removeItem('simulatedOrders');
                    localOrders = {}; 
                    initializeBadges();
                    renderManualManagementPanel();
                    if (document.getElementById('paymentModal').classList.contains('show')) createSizeButtons(currentProductID);
                    alert("Inventario restaurado con √©xito.");
                }
            };
            
            function renderManualManagementPanel() {
                const productNames = productData.reduce((acc, p) => { acc[p.id] = p.name; return acc; }, {});
                let listHTML = '<h6>Reservas Activas:</h6>';
                let hasOrders = false;

                for (const key in localOrders) {
                    if (localOrders[key] > 0) {
                        hasOrders = true;
                        const [productID, size] = key.split('-');
                        const name = productNames[productID] || 'Producto Desconocido';
                        listHTML += `
                            <div class="alert alert-warning p-2 d-flex justify-content-between align-items-center">
                                <span>${name} (Talla: ${size}) - Reservadas: ${localOrders[key]}</span>
                                <button class="btn btn-sm btn-outline-danger" onclick="releaseOrder('${key}')">Liberar 1</button>
                            </div>
                        `;
                    }
                }

                if (!hasOrders) {
                    listHTML += '<p class="text-success">No hay pedidos en reserva actualmente.</p>';
                }
                ordersList.innerHTML = listHTML;
            }

            window.showAdminPanel = function(password) {
                if (password === 'admin123') { 
                    managementPanel.style.display = 'block';
                    renderManualManagementPanel();
                } else {
                    alert('Acceso denegado.');
                }
            };
            
            function renderProductCards() {
                let html = '';
                productData.forEach(product => {
                    html += `
                        <div class="col-lg-3 col-md-4 col-sm-6 d-flex">
                            <div class="card product-card flex-fill" data-product-id="${product.id}">
                                <span class="stock-badge" id="badge-${product.id}"></span> 
                                <img src="${product.img_main}" class="card-img-top" alt="Playera ${product.name}">
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title">${product.name}</h5>
                                    <p class="card-text text-muted">${product.description.substring(0, 50)}...</p>
                                    <div class="mt-auto">
                                        <p class="price mb-2">$${product.price} MXN</p>
                                        <button 
                                            class="btn btn-block btn-buy w-100" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#paymentModal" 
                                            data-product-id="${product.id}"
                                            data-price="${product.price}" 
                                            data-name="${product.name}"
                                            data-description="${product.description}"
                                            data-img-front="${product.img_front}" 
                                            data-img-back="${product.img_back}"
                                            data-size-guide="${product.img_size_guide}"> 
                                            Ver Detalle y Comprar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                productListContainer.innerHTML = html;
            }

            mainButton.addEventListener('click', () => {
                const currentButtonText = mainButton.textContent;
                const quantity = parseInt(quantityInput.value) || 1;
                
                if (currentButtonText === 'Continuar') {
                    if (!currentSelectedSize) {
                        document.getElementById('selection-error').style.display = 'block';
                        return;
                    }
                    document.getElementById('selection-error').style.display = 'none';

                    selectionStep.style.display = 'none';
                    paymentStep.style.display = 'block';
                    mainButton.textContent = 'Generar Pedido';
                    
                    loadClientData();
                    
                    const amountToPay = document.getElementById('payment-due').textContent;
                    document.getElementById('payment-step-info-box').innerHTML = `
                        <p class="mb-1">Item: <strong>${currentProductName}</strong> (Talla: <strong>${currentSelectedSize}</strong>)</p>
                        <p class="mb-0">Monto a Pagar: <strong class="text-success">${amountToPay}</strong></p>
                    `;
                    
                } else if (currentButtonText === 'Generar Pedido') {
                    
                    const clientName = clientNameInput.value.trim();
                    const clientPhone = clientPhoneInput.value.trim();
                    const clientAddress = clientAddressInput.value.trim();
                    
                    if (clientName.length < 3 || clientPhone.length < 8 || clientAddress.length < 10) {
                        document.getElementById('payment-error').style.display = 'block';
                        return;
                    }
                    
                    saveClientData();
                    
                    if (quantity > getAvailableStock(currentProductID, currentSelectedSize)) {
                        alert('¬°Lo sentimos! El stock fue liberado mientras completabas el formulario. Por favor, revisa el stock disponible y reintenta.');
                        resetModalView();
                        createSizeButtons(currentProductID);
                        initializeBadges();
                        return;
                    }

                    const amountToPay = document.getElementById('payment-due').textContent; 
                    
                    const message = `Hola, acabo de generar un pedido:
*Cliente:* ${clientName}
*Producto:* ${currentProductName} (${quantity} piezas, Talla: ${currentSelectedSize})
*Monto a pagar:* ${amountToPay}
*Tel√©fono de contacto:* ${clientPhone}
*Direcci√≥n:* ${clientAddress}
Adjunto el comprobante de pago para confirmar mi reserva.`;
                    
                    const encodedMessage = encodeURIComponent(message);
                    const whatsappLink = `https://wa.me/${WHATSAPP_PHONE}?text=${encodedMessage}`;
                    whatsappButton.href = whatsappLink;

                    document.getElementById('final-size-conf').textContent = currentSelectedSize;
                    document.getElementById('final-qty-conf').textContent = quantity; 
                    document.getElementById('final-item-display').textContent = currentProductName;
                    document.getElementById('final-amount-conf').textContent = amountToPay;
                    
                    document.getElementById('payment-error').style.display = 'none';
                    paymentStep.style.display = 'none';
                    transferInfo.style.display = 'block';
                    mainButton.style.display = 'none'; 
                    whatsappButton.style.display = 'inline-block'; 
                }
            });

            whatsappButton.addEventListener('click', function(e) {
                if (transferInfo.style.display === 'block' && currentProductID && currentSelectedSize) {
                    const sizeKey = `${currentProductID}-${currentSelectedSize}`;
                    const quantityToApart = parseInt(quantityInput.value); 
                    
                    localOrders[sizeKey] = (localOrders[sizeKey] || 0) + quantityToApart; 
                    saveLocalOrders(); 
                    
                    createSizeButtons(currentProductID);
                    initializeBadges();
                } 
            });
            
            function createCarouselItem(src, alt, isActive = false) {
                return `
                    <div class="carousel-item ${isActive ? 'active' : ''}">
                        <img src="${src}" class="d-block w-100" alt="${alt}">
                    </div>
                `;
            }

            function createCarouselIndicator(index, isActive = false) {
                return `
                    <button type="button" data-bs-target="#productCarousel" data-bs-slide-to="${index}" class="${isActive ? 'active' : ''}" aria-current="${isActive ? 'true' : 'false'}" aria-label="Slide ${index + 1}"></button>
                `;
            }

            paymentModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget; 
                currentProductID = button.getAttribute('data-product-id');
                currentPrice = parseFloat(button.getAttribute('data-price'));
                currentProductName = button.getAttribute('data-name');
                
                const imgFront = button.getAttribute('data-img-front');
                const imgBack = button.getAttribute('data-img-back');
                const sizeGuide = button.getAttribute('data-size-guide');
                
                modalProductName.textContent = currentProductName;
                modalProductDesc.textContent = button.getAttribute('data-description');
                unitPriceDisplay.textContent = `$${currentPrice.toFixed(2)} MXN`;

                const images = [
                    { src: imgFront, alt: 'Vista Frontal' },
                    { src: imgBack, alt: 'Vista Trasera' },
                    { src: sizeGuide, alt: 'Gu√≠a de Tallas' }
                ];

                let innerHTML = '';
                let indicatorsHTML = '';

                images.forEach((img, index) => {
                    innerHTML += createCarouselItem(img.src, img.alt, index === 0);
                    indicatorsHTML += createCarouselIndicator(index, index === 0);
                });

                carouselInner.innerHTML = innerHTML;
                carouselIndicators.innerHTML = indicatorsHTML;
                
                // --- SOLUCI√ìN CRUCIAL PARA CARRUSEL EST√ÅTICO ---
                // Inicializa el carrusel con un intervalo falso (o 0) para detener el movimiento autom√°tico.
                const carouselElement = document.getElementById('productCarousel');
                new bootstrap.Carousel(carouselElement, {
                    interval: false, 
                    ride: false 
                });
                // --------------------------------------------------

                resetModalView(); 
                document.getElementById('modal-main-button').style.display = 'inline-block';
                
                createSizeButtons(currentProductID);
                updatePaymentAmounts();
            });

            quantityInput.addEventListener('input', updatePaymentAmounts);
            halfPaymentCheck.addEventListener('change', updatePaymentAmounts);
            
            function updatePaymentAmounts() {
                const dueDisplay = document.getElementById('payment-due');
                const totalPriceDisplay = document.getElementById('total-price');
                
                const quantity = parseInt(quantityInput.value) || 1; 

                const maxStock = parseInt(quantityInput.max);
                if (quantity > maxStock) {
                    quantityInput.value = maxStock;
                    return updatePaymentAmounts(); 
                } else if (quantity < 1) {
                    quantityInput.value = 1;
                    return updatePaymentAmounts(); 
                }
                
                const total = currentPrice * quantity;
                
                totalPriceDisplay.textContent = `$${total.toFixed(2)} MXN`; 

                let amountDue = total;
                if (halfPaymentCheck.checked) {
                    amountDue = total / 2;
                }
                
                dueDisplay.textContent = `$${amountDue.toFixed(2)} MXN`;
            }
            
            // üí° INICIALIZACI√ìN FINAL
            renderProductCards();
            initializeBadges();
        });
    </script>
</body>
</html>
