<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venta Playera</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@200..700&family=Roboto:wght@100;400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #A000A0; /* Morado fuerte */
            --secondary-color: #D300D3; /* Morado claro */
            --dark-color: #212529;
            --light-color: #f8f9fa;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--light-color);
        }

        .navbar {
            background-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }

        .navbar-brand, .nav-link, .btn-cart {
            color: var(--light-color) !important;
            font-family: 'Oswald', sans-serif;
        }

        .navbar-brand {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .hero {
            background-color: var(--dark-color);
            color: var(--light-color);
            padding: 4rem 0;
            text-align: center;
        }

        .hero h1 {
            font-family: 'Oswald', sans-serif;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .product-card {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%; 
            display: flex;
            flex-direction: column;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,.1);
        }

        .product-card img {
            width: 100%;
            height: auto;
            max-height: 300px; 
            object-fit: cover;
        }

        .product-info {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .product-info h5 {
            font-family: 'Oswald', sans-serif;
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 5px;
        }

        .product-info p {
            font-size: 1rem;
            color: #6c757d;
            margin-bottom: auto; 
        }
        
        .product-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-top: 10px;
            margin-bottom: 15px;
        }

        .btn-buy {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            transition: background-color 0.2s;
        }

        .btn-buy:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            color: white;
        }
        
        /* Contador del Carrito */
        .cart-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            padding: 4px 8px;
            border-radius: 50%;
            background-color: #dc3545; /* Rojo */
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            line-height: 1;
            transform: translate(50%, -50%);
        }
        
        .btn-cart {
            position: relative;
            background-color: transparent !important;
            border: none;
            padding: 0;
            margin-left: 15px;
        }
        
        /* Modal de Carrito y Detalles */
        .modal-header {
            background-color: var(--primary-color);
            color: white;
            border-bottom: 1px solid var(--secondary-color);
        }
        .modal-header .btn-close {
            filter: invert(1);
        }
        
        .cart-item {
            display: flex;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        
        .cart-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            margin-right: 15px;
            border-radius: 5px;
        }
        
        .item-details {
            flex-grow: 1;
        }
        
        .item-details h6 {
            margin-bottom: 2px;
            font-family: 'Oswald', sans-serif;
        }
        
        .item-details small {
            color: #6c757d;
        }
        
        .btn-remove {
            color: #dc3545;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .cart-summary {
            font-size: 1.25rem;
            font-weight: 700;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 2px solid var(--primary-color);
        }

        .out-of-stock {
            opacity: 0.6;
            pointer-events: none;
            position: relative;
        }

        .out-of-stock::before {
            content: "AGOTADO";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 0, 0, 0.4);
            color: white;
            font-family: 'Oswald', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        .stock-level {
            font-size: 0.9rem;
            font-weight: 700;
            margin-top: 5px;
            color: #dc3545;
        }

        .stock-low {
            color: orange;
        }
        .stock-ok {
            color: green;
        }

    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand" href="#">VENTA PLAYERA</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <ul class="navbar-nav align-items-center">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#catalogue">CatÃ¡logo</a>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-cart" data-bs-toggle="modal" data-bs-target="#ordersModal">
                            <i class="fas fa-shopping-cart fa-2x"></i>
                            <span class="cart-badge" id="cart-count">0</span>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <header class="hero">
        <div class="container">
            <h1>Descubre la ColecciÃ³n Oficial</h1>
            <p class="lead">Las mejores playeras con diseÃ±os Ãºnicos, listas para tu prÃ³ximo pedido.</p>
        </div>
    </header>

    <section id="catalogue" class="py-5">
        <div class="container">
            <h2 class="text-center mb-5" style="font-family: 'Oswald', sans-serif;">ðŸ‘• CatÃ¡logo Completo</h2>
            <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4" id="products-container">
                </div>
        </div>
    </section>
    
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container text-center">
            <p>&copy; 2024 Venta Playera. Todos los derechos reservados.</p>
        </div>
    </footer>

    <div class="modal fade" id="productDetailModal" tabindex="-1" aria-labelledby="productDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productDetailModalLabel">Detalles del Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <img id="detail-front-image" src="" alt="Frente" class="img-fluid mb-3">
                            <img id="detail-back-image" src="" alt="Espalda" class="img-fluid" style="display:none;">
                            <div class="d-flex justify-content-center mt-3">
                                <button class="btn btn-sm btn-outline-secondary me-2" onclick="showFrontImage()">Frente</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="showBackImage()">Espalda</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h2 id="detail-name" class="fw-bold" style="font-family: 'Oswald', sans-serif;"></h2>
                            <p id="detail-description"></p>
                            <div class="product-price mb-3" id="detail-price"></div>
                            
                            <div class="mb-3">
                                <label for="detail-size" class="form-label fw-bold">Talla:</label>
                                <select class="form-select" id="detail-size">
                                    <option value="XS">XS</option>
                                    <option value="S">S</option>
                                    <option value="M" selected>M</option>
                                    <option value="L">L</option>
                                    <option value="XL">XL</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="detail-quantity" class="form-label fw-bold">Cantidad:</label>
                                <input type="number" class="form-control" id="detail-quantity" value="1" min="1" max="100">
                            </div>

                            <div id="detail-stock-level" class="stock-level mb-3"></div>

                            <button class="btn btn-lg btn-buy w-100" id="add-to-order-button"><i class="fas fa-shopping-cart"></i> Agregar al Pedido</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="ordersModal" tabindex="-1" aria-labelledby="ordersModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ordersModalLabel"><i class="fas fa-receipt"></i> Tu Pedido Actual</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="cart-items-container">
                        </div>
                    
                    <div class="alert alert-warning text-center" role="alert" id="empty-cart-message" style="display:none;">
                        Tu carrito estÃ¡ vacÃ­o. Â¡Agrega tu primera playera!
                    </div>

                    <div class="cart-summary d-flex justify-content-between">
                        <span>Total:</span>
                        <span id="cart-total">$0</span>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Seguir Comprando</button>
                    <button type="button" class="btn btn-success" id="finalize-order-button" style="display:none;"><i class="fab fa-whatsapp"></i> Finalizar Pedido por WhatsApp</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ====================================================================
        // === 1. CONFIGURACIÃ“N INICIAL =======================================
        // ====================================================================

        // ** LA URL DE FIREBASE HA SIDO CORREGIDA Y REEMPLAZADA **
        const firebaseConfig = {
            databaseURL: "https://rplay-f04dc-default-rtdb.firebaseio.com", 
        };

        // La carpeta donde estÃ¡n las imÃ¡genes dentro de tu repositorio (ej: RPLAY/)
        const IMAGE_PATH = "RPLAY/";

        // ID del producto actualmente abierto en el modal de detalles
        let currentProductId = null;

        // Lista de productos con el stock inicial (solo se usa si Firebase estÃ¡ vacÃ­o)
        // ESTE ES TU STOCK MAESTRO
        const ORIGINAL_PRODUCTS_DEFINITION = [
            // El formato es: [ID_ÃšNICO, Nombre, DescripciÃ³n, Precio, Archivo_Frente, Archivo_Espalda, Stock_Inicial]
            // ID: Debe ser Ãºnico.
            // Stock_Inicial: La cantidad total de unidades que tienes.
            ["P30", "Playera Gon1", "DiseÃ±o grÃ¡fico con toques abstractos en negro.", 250, "Gon1.PNG", "Gon3.PNG", 200],
            ["P1", "Playera Katy", "DiseÃ±o Minimalista de Katy.", 200, "Katy3.png", "Katy3.png", 200],
            ["P2", "Playera Bere", "DiseÃ±o Minimalista de Bere.", 200, "Bere1.png", "Bere3.png", 200],
            ["P3", "Playera Dan", "DiseÃ±o Minimalista de Dan.", 200, "Dan1.png", "Dan3.png", 200],
            ["P4", "Playera Gera", "DiseÃ±o Minimalista de Gera.", 200, "Gera1.png", "Gera3.png", 200],
            ["P5", "Playera Bra", "DiseÃ±o Minimalista de Bra.", 200, "Bra1.png", "Bra3.png", 200],
            ["P6", "Playera Adri", "DiseÃ±o Minimalista de Adri.", 200, "Adri1.png", "Adri3.png", 200],
            ["P7", "Playera Aro", "DiseÃ±o Minimalista de Aro.", 200, "Aro1.png", "Aro5.png", 200],
            ["P8", "Playera Xim", "DiseÃ±o Minimalista de Ximena.", 200, "Xim1.png", "Xim3.png", 200]
        ];


        // ====================================================================
        // === 2. VARIABLES Y ESTRUCTURAS DE DATOS ============================
        // ====================================================================
        
        let products = {}; // Objeto que almacenarÃ¡ los datos de los productos, incluyendo el stock real de Firebase
        let cart = {};     // El carrito de compras (ID_Producto_Talla: {id, name, price, size, quantity})
        let nextOrderId = 1; // Contador de pedidos. Se leerÃ¡ de Firebase.


        // ====================================================================
        // === 3. INICIALIZACIÃ“N DE FIREBASE (CORRECCIÃ“N CRÃTICA APLICADA) ====
        // ====================================================================

        // Inicializar Firebase
        // ** SE ELIMINÃ“ EL BLOQUE TRY/CATCH para evitar ReferenceError: inventoryRef is not defined **
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();
        
        // Referencias a la base de datos (Ahora son globales y accesibles)
        const inventoryRef = db.ref('inventory');
        const ordersRef = db.ref('orders');
        const orderCounterRef = db.ref('nextOrderId');
        


        // ====================================================================
        // === 4. FUNCIONES DEL INVENTARIO (Firebase) =========================
        // ====================================================================

        /**
         * Inicializa el inventario en Firebase con el stock maestro
         * si el nodo 'inventory' estÃ¡ vacÃ­o.
         */
        function initializeInventory(snapshot) {
            if (snapshot.val() === null) {
                console.log("Firebase Inventory vacÃ­o. Subiendo stock inicial...");
                const initialInventory = {};
                ORIGINAL_PRODUCTS_DEFINITION.forEach(([id, name, desc, price, front, back, stock]) => {
                    initialInventory[id] = {
                        id,
                        name,
                        description: desc,
                        price,
                        frontFile: front,
                        backFile: back,
                        stock: stock 
                    };
                });
                
                inventoryRef.set(initialInventory)
                    .then(() => {
                        console.log("Inventario inicial subido exitosamente a Firebase.");
                    })
                    .catch(error => {
                        console.error("Error al subir inventario inicial:", error);
                        alert("Error al subir el inventario inicial a Firebase.");
                    });
            } else {
                console.log("Inventario cargado desde Firebase.");
            }
        }
        
        /**
         * Lee el stock actual de Firebase, lo almacena en 'products'
         * y vuelve a renderizar el catÃ¡logo.
         */
        inventoryRef.on('value', (snapshot) => {
            initializeInventory(snapshot); // Asegura que el stock exista
            products = snapshot.val() || {};
            renderProducts();
            updateCartDisplay(); // Actualiza el carrito si el stock cambia
        }, (errorObject) => {
            console.error("Fallo la lectura del inventario:", errorObject);
            // La alerta de 'permission_denied' se verÃ¡ si las reglas no se publican.
            alert("Hubo un error al conectar con el inventario en tiempo real. Revisa tu conexiÃ³n de Firebase y las reglas de seguridad. (" + errorObject.message + ")");
        });

        /**
         * Lee el contador del prÃ³ximo pedido.
         */
        orderCounterRef.on('value', (snapshot) => {
            if (snapshot.exists()) {
                nextOrderId = snapshot.val();
                console.log(`PrÃ³ximo ID de Pedido: #${nextOrderId}`);
            } else {
                // Si el contador no existe, lo inicializa
                orderCounterRef.set(1);
                nextOrderId = 1;
            }
        }, (errorObject) => {
            console.error("Fallo la lectura del contador de pedidos:", errorObject);
        });

        // ====================================================================
        // === 5. FUNCIONES DE RENDERIZADO ====================================
        // ====================================================================

        /**
         * Genera el HTML de una tarjeta de producto.
         */
        function createProductCard(product) {
            const stock = product.stock;
            const isOutOfStock = stock <= 0;
            let stockHtml = '';
            let cardClasses = 'product-card h-100';

            if (isOutOfStock) {
                cardClasses += ' out-of-stock';
                stockHtml = '<div class="stock-level text-danger fw-bold">AGOTADO</div>';
            } else if (stock <= 5) {
                stockHtml = `<div class="stock-level stock-low"><i class="fas fa-exclamation-triangle"></i> Â¡Ãšltimas ${stock} unidades!</div>`;
            } else {
                stockHtml = `<div class="stock-level stock-ok">En Stock: ${stock}</div>`;
            }

            return `
                <div class="col">
                    <div class="${cardClasses}">
                        <img src="${IMAGE_PATH}${product.frontFile}" class="card-img-top" alt="${product.name} - Frente">
                        <div class="product-info">
                            <h5 class="card-title">${product.name}</h5>
                            <p class="card-text">${product.description}</p>
                            ${stockHtml}
                            <div class="product-price">$${product.price.toLocaleString('es-MX')}</div>
                            <button class="btn btn-buy mt-auto" onclick="openProductDetail('${product.id}')" ${isOutOfStock ? 'disabled' : ''}>
                                <i class="fas fa-eye"></i> Ver Detalles
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Renderiza todos los productos en el contenedor principal.
         */
        function renderProducts() {
            const container = document.getElementById('products-container');
            container.innerHTML = '';
            
            // Convierte el objeto products en un array y lo ordena por ID
            const productArray = Object.values(products).sort((a, b) => a.id.localeCompare(b.id));

            productArray.forEach(product => {
                const cardHtml = createProductCard(product);
                container.innerHTML += cardHtml;
            });
        }
        
        /**
         * Abre el modal de detalles del producto.
         */
        function openProductDetail(productId) {
            currentProductId = productId;
            const product = products[productId];
            
            if (!product) return;

            // Llenar el modal
            document.getElementById('detail-name').textContent = product.name;
            document.getElementById('detail-description').textContent = product.description;
            document.getElementById('detail-price').textContent = `$${product.price.toLocaleString('es-MX')}`;
            
            // ImÃ¡genes (siempre mostrar el frente por defecto)
            document.getElementById('detail-front-image').src = IMAGE_PATH + product.frontFile;
            document.getElementById('detail-back-image').src = IMAGE_PATH + (product.backFile || product.frontFile); // Si no hay back, usa front
            showFrontImage();

            // Stock
            const stock = product.stock;
            const stockElement = document.getElementById('detail-stock-level');
            const addButton = document.getElementById('add-to-order-button');
            const quantityInput = document.getElementById('detail-quantity');
            
            if (stock <= 0) {
                stockElement.innerHTML = '<span class="text-danger fw-bold">Â¡AGOTADO!</span>';
                addButton.disabled = true;
                quantityInput.max = 0;
            } else if (stock <= 5) {
                stockElement.innerHTML = `<span class="text-warning fw-bold"><i class="fas fa-exclamation-triangle"></i> Â¡Ãšltimas ${stock} unidades!</span>`;
                addButton.disabled = false;
                quantityInput.max = stock;
            } else {
                stockElement.innerHTML = `<span class="text-success fw-bold">Disponible: ${stock} unidades</span>`;
                addButton.disabled = false;
                quantityInput.max = stock;
            }
            
            // Asegura que la cantidad seleccionada no exceda el stock
            if (parseInt(quantityInput.value) > stock) {
                quantityInput.value = stock > 0 ? 1 : 0;
            }

            // Asignar evento al botÃ³n de agregar
            addButton.onclick = () => {
                const size = document.getElementById('detail-size').value;
                const quantity = parseInt(quantityInput.value);
                
                if (quantity > 0 && quantity <= stock) {
                    addToCart(productId, size, quantity);
                    // Opcional: Cerrar el modal despuÃ©s de agregar
                    const modal = bootstrap.Modal.getInstance(document.getElementById('productDetailModal'));
                    modal.hide();
                } else {
                    alert('Por favor, selecciona una cantidad vÃ¡lida (1-' + stock + ').');
                }
            };

            const detailModal = new bootstrap.Modal(document.getElementById('productDetailModal'));
            detailModal.show();
        }
        
        /**
         * Muestra la imagen del frente en el modal de detalles.
         */
        window.showFrontImage = function() {
            document.getElementById('detail-front-image').style.display = 'block';
            document.getElementById('detail-back-image').style.display = 'none';
        }
        
        /**
         * Muestra la imagen de la espalda en el modal de detalles.
         */
        window.showBackImage = function() {
            document.getElementById('detail-front-image').style.display = 'none';
            document.getElementById('detail-back-image').style.display = 'block';
        }

        // ====================================================================
        // === 6. FUNCIONES DEL CARRITO =======================================
        // ====================================================================

        /**
         * Agrega un producto al carrito.
         */
        function addToCart(id, size, quantity) {
            const key = `${id}_${size}`;
            const product = products[id];
            
            if (!product) return;

            if (cart[key]) {
                cart[key].quantity += quantity;
            } else {
                cart[key] = {
                    id: id,
                    name: product.name,
                    price: product.price,
                    size: size,
                    quantity: quantity,
                    frontFile: product.frontFile
                };
            }
            
            saveCart();
            updateCartDisplay();
            alert(`Se agregaron ${quantity} unidad(es) de ${product.name} (Talla ${size}) al pedido.`);
        }

        /**
         * Remueve un producto del carrito.
         */
        window.removeFromCart = function(key) {
            if (cart[key]) {
                delete cart[key];
                saveCart();
                updateCartDisplay();
            }
        }
        
        /**
         * Carga el carrito desde localStorage.
         */
        function loadCart() {
            const savedCart = localStorage.getItem('shoppingCart');
            if (savedCart) {
                try {
                    cart = JSON.parse(savedCart);
                } catch (e) {
                    console.error("Error al cargar el carrito de localStorage:", e);
                    cart = {};
                }
            }
            updateCartDisplay();
        }

        /**
         * Guarda el carrito en localStorage.
         */
        function saveCart() {
            localStorage.setItem('shoppingCart', JSON.stringify(cart));
        }

        /**
         * Actualiza el contador del carrito y el contenido del modal.
         */
        function updateCartDisplay() {
            const keys = Object.keys(cart);
            let totalItems = 0;
            let totalAmount = 0;
            const container = document.getElementById('cart-items-container');
            container.innerHTML = '';

            if (keys.length === 0) {
                document.getElementById('cart-count').textContent = '0';
                document.getElementById('empty-cart-message').style.display = 'block';
                document.getElementById('finalize-order-button').style.display = 'none';
                document.getElementById('cart-total').textContent = '$0';
                return;
            }

            document.getElementById('empty-cart-message').style.display = 'none';
            document.getElementById('finalize-order-button').style.display = 'block';


            keys.forEach(key => {
                const item = cart[key];
                const subtotal = item.price * item.quantity;
                totalItems += item.quantity;
                totalAmount += subtotal;
                
                // HTML del item del carrito
                const itemHtml = `
                    <div class="cart-item">
                        <img src="${IMAGE_PATH}${item.frontFile}" alt="${item.name}">
                        <div class="item-details">
                            <h6>${item.name}</h6>
                            <small>Talla: ${item.size} | Cantidad: ${item.quantity} | Subtotal: $${subtotal.toLocaleString('es-MX')}</small>
                        </div>
                        <i class="fas fa-trash btn-remove" onclick="removeFromCart('${key}')"></i>
                    </div>
                `;
                container.innerHTML += itemHtml;
            });
            
            document.getElementById('cart-count').textContent = totalItems.toString();
            document.getElementById('cart-total').textContent = `$${totalAmount.toLocaleString('es-MX')}`;
        }
        
        // ====================================================================
        // === 7. FINALIZACIÃ“N Y PEDIDO =======================================
        // ====================================================================

        document.getElementById('finalize-order-button').addEventListener('click', () => {
            const keys = Object.keys(cart);
            if (keys.length === 0) {
                alert('Tu carrito estÃ¡ vacÃ­o.');
                return;
            }

            // 1. Preguntar datos del cliente
            const clientName = prompt("Ingresa tu Nombre Completo para el pedido:");
            if (!clientName) return;

            const clientAddress = prompt("Ingresa la DirecciÃ³n de EnvÃ­o:");
            if (!clientAddress) return;
            
            const clientPhone = prompt("Ingresa tu nÃºmero de WhatsApp (cÃ³digo de paÃ­s y nÃºmero):");
            if (!clientPhone) return;

            // 2. Generar el mensaje de WhatsApp y el objeto de pedido
            let whatsappMessage = `Â¡Hola! Quiero hacer el PEDIDO #${nextOrderId} de playeras.\n\n`;
            whatsappMessage += `--- DETALLES DEL PEDIDO ---\n`;
            whatsappMessage += `Cliente: ${clientName}\n`;
            whatsappMessage += `DirecciÃ³n: ${clientAddress}\n`;
            whatsappMessage += `TelÃ©fono: ${clientPhone}\n\n`;
            whatsappMessage += `--- PRODUCTOS ---\n`;
            
            let total = 0;
            let orderItems = [];

            keys.forEach(key => {
                const item = cart[key];
                const subtotal = item.price * item.quantity;
                total += subtotal;
                
                whatsappMessage += `- ${item.quantity}x ${item.name} (Talla: ${item.size}) - $${subtotal.toLocaleString('es-MX')}\n`;
                
                orderItems.push({
                    id: item.id,
                    name: item.name,
                    size: item.size,
                    quantity: item.quantity,
                    price: item.price,
                    subtotal: subtotal
                });
            });

            whatsappMessage += `\n--- TOTAL A PAGAR ---\n`;
            whatsappMessage += `TOTAL: $${total.toLocaleString('es-MX')}\n`;
            whatsappMessage += `\nÂ¡Gracias!`;

            const orderObject = {
                id: nextOrderId,
                clientName: clientName,
                clientAddress: clientAddress,
                clientPhone: clientPhone,
                items: orderItems,
                total: total,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                status: 'Nuevo'
            };

            // 3. Procesar el pedido (Firebase y Stock)
            processOrder(orderObject, whatsappMessage);
        });
        
        /**
         * Guarda el pedido en Firebase, descuenta el stock y redirige a WhatsApp.
         */
        function processOrder(order, whatsappMessage) {
            
            // 3a. Iniciar transacciones para descontar stock
            const stockUpdatePromises = order.items.map(item => {
                // Se usa inventoryRef que ahora estÃ¡ definido globalmente
                const productRef = inventoryRef.child(item.id);
                
                return productRef.transaction((currentData) => {
                    if (currentData) {
                        const newStock = currentData.stock - item.quantity;
                        if (newStock < 0) {
                             // Si el stock es insuficiente (algo saliÃ³ mal), aborta
                            console.error(`Error de stock: ${item.name} insuficiente.`);
                            alert(`Error: Stock insuficiente para ${item.name}. Revisa el stock y la cantidad.`);
                            return; 
                        }
                        currentData.stock = newStock;
                    }
                    return currentData; // Devuelve el nuevo dato para que Firebase lo actualice
                }, (error, committed, snapshot) => {
                    if (error) {
                        console.error(`Error en la transacciÃ³n de stock para ${item.name}:`, error);
                        alert(`Error crÃ­tico al descontar el stock de ${item.name}.`);
                    } else if (!committed) {
                        console.warn(`TransacciÃ³n de stock no confirmada para ${item.name}.`);
                    } else {
                        console.log(`Stock de ${item.name} descontado. Nuevo stock: ${snapshot.val().stock}`);
                    }
                });
            });

            // 3b. Guardar el pedido y actualizar el contador SOLO si el stock se descontÃ³
            Promise.all(stockUpdatePromises)
                .then(() => {
                    // Si todas las transacciones de stock fueron exitosas (o al menos se intentaron)
                    
                    // 3c. Guardar el pedido en Firebase
                    ordersRef.child(nextOrderId).set(order)
                        .then(() => {
                            // 3d. Incrementar el contador de pedidos
                            orderCounterRef.set(nextOrderId + 1)
                                .then(() => {
                                    console.log(`Pedido #${nextOrderId} guardado. Contador actualizado a ${nextOrderId + 1}.`);
                                    
                                    // 3e. Limpiar carrito y redirigir
                                    cart = {};
                                    saveCart();
                                    updateCartDisplay();
                                    
                                    // Prepara la URL de WhatsApp
                                    const encodedMessage = encodeURIComponent(whatsappMessage);
                                    // Si no se proporcionÃ³ el telÃ©fono, se usa un nÃºmero predefinido o se le pide al cliente que lo agregue a la URL.
                                    const whatsappRecipient = order.clientPhone || 'NUMERO_ADMINISTRADOR'; 
                                    const whatsappURL = `https://wa.me/${whatsappRecipient}?text=${encodedMessage}`;
                                    
                                    alert(`Â¡Pedido #${order.id} creado exitosamente! Ahora serÃ¡s redirigido a WhatsApp para enviar los detalles.`);
                                    window.open(whatsappURL, '_blank');
                                    
                                    // Cerrar modal de pedidos
                                    const modal = bootstrap.Modal.getInstance(document.getElementById('ordersModal'));
                                    modal.hide();

                                })
                                .catch(error => {
                                    console.error("Error al actualizar el contador de pedidos:", error);
                                    alert("Error al actualizar el contador de pedidos. Revisa Firebase.");
                                });
                        })
                        .catch(error => {
                            console.error("Error al guardar el pedido:", error);
                            alert("Error al guardar el pedido en la base de datos.");
                        });
                })
                .catch(error => {
                    console.error("Error general en el proceso de pedido:", error);
                });
        }
        
        // ====================================================================
        // === 8. FUNCIONES DE CONSOLA PARA ADMINISTRACIÃ“N ====================
        // ====================================================================

        /**
         * FUNCIÃ“N PARA REINICIAR INVENTARIO Y CONTADOR (SÃ“LO ADMIN)
         * Ejecutar en la consola: window.resetInventoryAndOrders()
         */
        window.resetInventoryAndOrders = function() {
            if (confirm("ðŸš¨ ADVERTENCIA CRÃTICA: Â¿EstÃ¡s seguro de que quieres RESTABLECER TODO el INVENTARIO en Firebase al stock maestro Y REINICIAR el contador de pedidos a #1?")) {
                
                // 1. Resetear Inventario
                const initialInventory = {};
                ORIGINAL_PRODUCTS_DEFINITION.forEach(([id, name, desc, price, front, back, stock]) => {
                    initialInventory[id] = {
                        id,
                        name,
                        description: desc,
                        price,
                        frontFile: front,
                        backFile: back,
                        stock: stock 
                    };
                });
                
                inventoryRef.set(initialInventory)
                    .then(() => {
                        console.log("âœ… INVENTARIO RESTABLECIDO: Stock inicial subido exitosamente a Firebase.");
                        // 2. Resetear Contador
                        return orderCounterRef.set(1);
                    })
                    .then(() => {
                        console.log("âœ… CONTADOR RESTABLECIDO: Contador de pedidos reiniciado a #1.");
                        alert("Â¡Reiniciado Completo! Inventario en stock maestro y contador de pedidos a #1.");
                    })
                    .catch(error => {
                        console.error("âŒ ERROR CRÃTICO DURANTE EL REINICIO:", error);
                        alert("ERROR CRÃTICO: No se pudo completar el reinicio. Revisa la consola.");
                    });
            } else {
                console.log("Reiniciado cancelado.");
            }
        };

        /**
         * FUNCIÃ“N PARA EXPORTAR EL ARRAY DE PRODUCTOS CON EL STOCK ACTUAL (SÃ“LO ADMIN)
         * Ejecutar en la consola: window.exportInitialProductsArray()
         */
        window.exportInitialProductsArray = function() {
            const currentStockData = Object.values(products);
            const newArray = currentStockData.map(p => [
                p.id, p.name, p.description, p.price, p.frontFile, p.backFile, p.stock
            ]);

            const newArrayString = JSON.stringify(newArray, null, 4)
                .replace(/"/g, '') // Quita las comillas de los strings
                .replace(/,\n {4}(\[)/g, ',\n    $1') // Ajusta el formato de arrays internos
                .replace(/^\[\n {4}\[/, '[\n    ['); // Ajusta el inicio del array principal
            
            console.log("=================================================");
            console.log("âœ… PASO CRÃTICO MANUAL:");
            console.log("Para que el stock quede fijo y no dependa de Firebase, reemplaza la constante ORIGINAL_PRODUCTS_DEFINITION con la salida de abajo y sube el nuevo 'aplay.html' a GitHub.");
            console.log("=================================================");
            
            // Genera la salida de JavaScript formateada
            const output = `const ORIGINAL_PRODUCTS_DEFINITION = ${newArrayString};`;
            console.log(output);

            return output;
        };
        
        // ====================================================================
        // === 9. INICIO DE LA APLICACIÃ“N =====================================
        // ====================================================================

        document.addEventListener('DOMContentLoaded', () => {
            loadCart();
            // El renderizado se llama automÃ¡ticamente despuÃ©s de que Firebase lee el inventario
        });

    </script>
</body>
</html>
