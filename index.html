<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda RPLAY</title>
    <style>
        /* Base y Estructura */
        body { font-family: sans-serif; margin: 20px; background-color: #f8f8f8; }
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            padding: 10px 0; 
            border-bottom: 1px solid #ddd; 
        }
        #logo {
            height: 50px; /* Ajusta el tama√±o de tu logo */
            width: auto;
        }
        #products-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
        
        /* Tarjetas de Producto */
        .product-card { 
            border: 1px solid #ccc; 
            padding: 15px; 
            width: 300px; 
            text-align: center;
            background-color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .product-card img { 
            max-width: 100%; 
            height: 300px; /* Tama√±o fijo para consistencia */
            object-fit: cover; 
            margin-bottom: 10px;
        }
        .product-card button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            margin-top: 10px;
        }

        /* Modal Base */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 1000px; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }

        /* Modal de Producto Espec√≠fico */
        #modal-product-view { display: flex; gap: 40px; }
        #modal-images { flex: 1; display: flex; flex-direction: column; gap: 15px; }
        #main-product-image { 
            max-width: 100%; 
            height: 450px; 
            object-fit: contain; 
            border: 1px solid #eee;
        }
        #modal-details { flex: 1; padding-top: 20px; }
        .image-toggle-buttons button { margin-right: 5px; padding: 8px 15px; cursor: pointer; background-color: #eee; border: 1px solid #ccc; }
        
        /* Tabla de Tallas (Est√©tica Restaurada) */
        .size-chart { margin-top: 20px; }
        .size-chart h4 { color: #cc0066; border-bottom: 2px solid #cc0066; padding-bottom: 5px; }
        .size-chart table { border-collapse: collapse; width: 100%; margin-top: 10px; font-size: 0.9em; }
        .size-chart th, .size-chart td { border: 1px solid #ddd; padding: 8px; text-align: center; }

        /* Botones de Color (Est√©tica Rosa Restaurada) */
        #color-options { margin: 10px 0 20px; }
        #color-options button { 
            width: 35px; 
            height: 35px; 
            border-radius: 50%; 
            border: 2px solid transparent; 
            margin: 5px; 
            cursor: pointer;
            box-shadow: 0 0 0 1px #ff99cc; 
            transition: all 0.2s;
        }
        #color-options button.active {
            border: 3px solid #cc0066; 
            box-shadow: 0 0 0 2px white, 0 0 0 5px #cc0066; 
        }

        /* Opciones de Talla y Carrito */
        .stock-option { margin-right: 10px; padding: 8px 15px; border: 1px solid #ccc; cursor: pointer; background-color: #f0f0f0; }
        .stock-option.active { background-color: #cc0066; color: white; border-color: #cc0066; }
        #add-to-cart-button {
            background-color: #cc0066 !important; 
        }
        
        /* Estilos del Carrito Detallado */
        .cart-item-detail {
            display: flex;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }
        .cart-item-detail img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            margin-right: 15px;
        }
        .cart-item-info {
            flex-grow: 1;
        }
        .cart-item-info strong {
            display: block;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        .cart-item-info span {
            font-size: 0.9em;
            color: #555;
        }
    </style>
</head>
<body>

    <header>
        <img id="logo" src="logo.png" alt="Logo de RPLAY" onerror="this.onerror=null;this.src=''">
        <h1>Tienda RPLAY</h1>
        <button onclick="window.toggleCartModal()">üõí Carrito (<span id="cart-count">0</span>)</button>
    </header>

    <main id="products-container">
        <h2>Cargando inventario desde Realtime Database...</h2>
    </main>
    
    <div id="cart-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="window.toggleCartModal()">&times;</span>
            <h3>Tu Carrito</h3>
            <div id="cart-items">
                </div>
            <p>Total: $<span id="cart-total">0.00</span></p>
            <button onclick="window.sendOrderToWhatsapp()">Finalizar Compra por WhatsApp</button>
            <button onclick="window.clearCart()">Vaciar Carrito</button>
        </div>
    </div>

    <div id="product-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="window.closeProductModal()">&times;</span>
            <div id="modal-product-view">
                <div id="modal-images">
                    <img id="main-product-image" src="" alt="Producto">
                    <div class="image-toggle-buttons">
                        <button onclick="window.changeModalImage('front')">Frente</button>
                        <button onclick="window.changeModalImage('back')">Espalda</button>
                    </div>
                    <div class="size-chart" id="size-chart-container">
                        </div>
                </div>

                <div id="modal-details">
                    <div id="modal-content-details">
                        </div>

                    <div id="product-options">
                        </div>

                    <label for="quantity">Cantidad a agregar:</label>
                    <input type="number" id="quantity" value="1" min="1" max="100" style="width: 60px; margin-bottom: 20px;"> 

                    <button id="add-to-cart-button" onclick="" style="padding: 10px 20px; color: white; border: none; cursor: pointer;">A√±adir al Carrito</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // üö® CONFIGURACI√ìN DE FIREBASE 
        const firebaseConfig = {
            apiKey: "AIzaSyCtgsjjbNIS0lv5aLD8nkpN_9-4sXIJVE", 
            authDomain: "rplay-f04dc.firebaseapp.com",
            databaseURL: "https://rplay-f04dc-default-rtdb.firebaseio.com", 
            projectId: "rplay-f04dc",
            storageBucket: "rplay-f04dc.appspot.com",
            messagingSenderId: "787828282738",
            appId: "1:787828282738:web:00c1ff1a7008c0e02b79eb",
            measurementId: "G-XEKR4KEDMR"
        };
        
        // üö® IMPORTAR LIBRER√çAS DE FIREBASE (Realtime Database)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
        import { getDatabase, ref, get, runTransaction } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";

        // Inicializar Firebase y Realtime Database
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app); // USANDO RTDB

        // =================================================================================
        // FUNCI√ìN PRINCIPAL PARA CARGAR PRODUCTOS DESDE REALTIME DATABASE
        // =================================================================================

        window.inventory = []; 
        window.currentProductInModal = null; 

        window.loadProductsFromFirebase = async function() {
            try {
                console.log("Cargando inventario desde Realtime Database...");
                const snapshot = await get(ref(db, 'products')); 
                
                if (snapshot.exists()) {
                    const productsObject = snapshot.val();
                    window.inventory = Object.keys(productsObject).map(key => ({
                        id: key,
                        ...productsObject[key]
                    }));
                    
                    console.log(`Inventario cargado: ${window.inventory.length} productos.`);
                    window.renderProducts();
                } else {
                    console.log("No hay productos en la base de datos de RTDB.");
                    document.getElementById('products-container').innerHTML = '<h2>¬°Inventario vac√≠o! Contacta al administrador o migra los datos.</h2>';
                }
            } catch (e) {
                console.error("Error al cargar productos desde RTDB:", e);
                document.getElementById('products-container').innerHTML = '<h2>Error al cargar inventario. Revisa la Consola y las Reglas de RTDB.</h2>';
            }
        }
        
        // Ejecutar la carga al iniciar
        window.addEventListener('load', window.loadProductsFromFirebase);


        // =================================================================================
        // FUNCI√ìN PARA ACTUALIZAR STOCK TRAS LA COMPRA (ADAPTADA A RTDB)
        // =================================================================================

        window.sendOrderToWhatsapp = async function() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            if (cart.length === 0) {
                alert("Tu carrito est√° vac√≠o.");
                return;
            }

            try {
                let whatsappMessage = "¬°Hola! Quisiera hacer un pedido:\n\n";
                const transactionPromises = [];

                for (const item of cart) {
                    whatsappMessage += `- ${item.name} (${item.isColorProduct ? item.color : '√önico'}) - Talla ${item.size} x ${item.quantity} unidades\n`;
                    
                    const productRef = ref(db, `products/${item.id}`);

                    const transactionPromise = runTransaction(productRef, (currentProduct) => {
                        if (currentProduct) {
                            let newStock = 0;
                            if (item.isColorProduct) {
                                const currentStock = currentProduct.stockByColor?.[item.color]?.[item.size] || 0;
                                newStock = currentStock - item.quantity;
                                
                                if (newStock >= 0) {
                                    if (!currentProduct.stockByColor) currentProduct.stockByColor = {};
                                    if (!currentProduct.stockByColor[item.color]) currentProduct.stockByColor[item.color] = {};
                                    currentProduct.stockByColor[item.color][item.size] = newStock;
                                } else {
                                    return; 
                                }
                            } else {
                                const currentStock = currentProduct.stock?.[item.size] || 0;
                                newStock = currentStock - item.quantity;
                                
                                if (newStock >= 0) {
                                    if (!currentProduct.stock) currentProduct.stock = {};
                                    currentProduct.stock[item.size] = newStock;
                                } else {
                                    return; 
                                }
                            }
                            return currentProduct; 
                        }
                        return currentProduct;
                    });
                    
                    transactionPromises.push(transactionPromise);
                }

                await Promise.all(transactionPromises);

                whatsappMessage += `\nTotal a pagar: $${document.getElementById('cart-total').textContent}`;
                const whatsappNumber = "TUNUMEROAQUI"; 
                const encodedMessage = encodeURIComponent(whatsappMessage);
                window.open(`https://wa.me/${whatsappNumber}?text=${encodedMessage}`, '_blank');

                window.clearCart(); 
                alert("Pedido realizado y stock actualizado en la nube. ¬°Revisa WhatsApp!");
                window.loadProductsFromFirebase(); 

            } catch (error) {
                console.error("Error al finalizar la compra y actualizar stock:", error);
                alert("Hubo un error al procesar el pedido. Por favor, revisa tu stock y las reglas de RTDB.");
            }
        }
        
    </script>


    <script>
        // Funciones auxiliares
        function saveCart(cart) {
            localStorage.setItem('cart', JSON.stringify(cart));
            window.updateCartDisplay();
        }

        window.clearCart = function() {
            saveCart([]);
        }

        function calculateTotal(cart) {
            return cart.reduce((total, item) => total + (item.price * item.quantity), 0).toFixed(2);
        }

        // =================================================================================
        // FUNCI√ìN CLAVE: MOSTRAR CARRITO (CON TODOS LOS DETALLES)
        // =================================================================================
        window.updateCartDisplay = function() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const cartCountElement = document.getElementById('cart-count');
            const cartItemsContainer = document.getElementById('cart-items');
            const cartTotalElement = document.getElementById('cart-total');

            cartCountElement.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartTotalElement.textContent = calculateTotal(cart);
            cartItemsContainer.innerHTML = '';

            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p>El carrito est√° vac√≠o.</p>';
                return;
            }
            
            // Reconstruir los detalles del carrito con la informaci√≥n completa
            cart.forEach(item => {
                const productInventory = window.inventory.find(p => p.id === item.id);
                if (!productInventory) return;
                
                // Determinar el nombre del archivo de imagen
                let rawImageFile = productInventory.frontFileBase;
                if (item.isColorProduct && productInventory.colorMap && productInventory.colorMap[item.color]) {
                    rawImageFile = productInventory.colorMap[item.color].front;
                }
                const fileInfo = formatFileName(rawImageFile);
                const imagePath = fileInfo ? `${fileInfo.name}${fileInfo.ext}` : '';
                
                // Determinar el c√≥digo de producto espec√≠fico (si aplica)
                let productCode = productInventory.productCode || 'N/A';
                if (item.isColorProduct && productInventory.colorMap && productInventory.colorMap[item.color]) {
                    productCode = productInventory.colorMap[item.color].productCode || productInventory.productCode || 'N/A';
                }

                const itemDiv = document.createElement('div');
                itemDiv.className = 'cart-item-detail';
                itemDiv.innerHTML = `
                    <img src="${imagePath}" alt="${item.name} - ${item.color}" />
                    <div class="cart-item-info">
                        <strong>${item.name}</strong>
                        <span>C√≥digo: ${productCode}</span>
                        <span>Color: ${item.color} | Talla: ${item.size}</span>
                        <span>Cantidad: ${item.quantity} | Subtotal: $${(item.price * item.quantity).toFixed(2)}</span>
                        </div>
                `;
                cartItemsContainer.appendChild(itemDiv);
            });
        }

        window.toggleCartModal = function() {
            const modal = document.getElementById('cart-modal');
            if (modal.style.display === "block") {
                modal.style.display = "none";
            } else {
                window.updateCartDisplay();
                modal.style.display = "block";
            }
        }
        
        window.closeProductModal = function() {
            document.getElementById('product-modal').style.display = "none";
        }
        
        // =================================================================================
        // FUNCI√ìN AUXILIAR DE FORMATO DE NOMBRE (IMAGENES)
        // =================================================================================
        function formatFileName(rawName) {
            if (!rawName) return null;
            
            const nameWithoutExt = rawName.split('.')[0]; 
            const lowerCaseName = nameWithoutExt.toLowerCase();
            let extension = '.png'; 

            if (lowerCaseName === 'xime1') { 
                return { name: lowerCaseName, ext: extension }; 
            } 
            
            if (lowerCaseName.startsWith('gon')) {
                 extension = '.PNG'; 
            }
            
            const formattedName = nameWithoutExt.charAt(0).toUpperCase() + nameWithoutExt.slice(1);
            
            return { name: formattedName, ext: extension }; 
        }

        // =================================================================================
        // L√ìGICA DE RENDERIZADO (NO MODIFICADA, USA formatFileName)
        // =================================================================================

        window.renderProducts = function() {
            const container = document.getElementById('products-container');
            container.innerHTML = ''; 

            if (!window.inventory || window.inventory.length === 0) {
                container.innerHTML = '<h2>No se encontraron productos disponibles.</h2>';
                return;
            }

            window.inventory.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';

                const rawImageFile = product.frontFileBase || (product.isColorProduct ? product.colorMap[product.colors[0]].front : '');
                
                const fileInfo = formatFileName(rawImageFile);
                if (!fileInfo) return; 

                const imagePath = `${fileInfo.name}${fileInfo.ext}`;
                
                card.innerHTML = `
                    <h3>${product.name}</h3>
                    <img src="${imagePath}" alt="${product.name}" /> 
                    <p>${product.description}</p>
                    <p><strong>$${product.price.toFixed(2)}</strong></p>
                    <button onclick="window.showProductModal('${product.id}')">Ver / Pedir</button>
                `;
                container.appendChild(card);
            });
        }

        function getFileName(product, view, color = null) {
            const rawFileName = product.isColorProduct && color
                ? product.colorMap[color][view]
                : product[`${view}FileBase`];

            if (!rawFileName) return null;

            const fileInfo = formatFileName(rawFileName);
            
            return `${fileInfo.name}${fileInfo.ext}`;
        }

        window.changeModalImage = function(view) {
            const product = window.currentProductInModal;
            if (!product) return;

            const activeColorButton = document.querySelector('#color-options .active');
            const selectedColor = product.isColorProduct && activeColorButton ? activeColorButton.dataset.color : null;
            
            const fileName = getFileName(product, view, selectedColor);

            if (fileName) {
                document.getElementById('main-product-image').src = fileName;
            }
        }

        window.changeColorAndSize = function(product, newColor) {
            document.querySelectorAll('#color-options button').forEach(btn => btn.classList.remove('active'));
            const newActiveButton = document.querySelector(`button[data-color="${newColor}"]`);
            if(newActiveButton) {
                 newActiveButton.classList.add('active');
            }

            const fileName = getFileName(product, 'front', newColor);
            document.getElementById('main-product-image').src = fileName;

            const sizeOptionsContainer = document.getElementById('size-options');
            sizeOptionsContainer.innerHTML = generateSizeOptionsHTML(product, newColor);

            document.getElementById('add-to-cart-button').onclick = () => window.addToCart(product.id, newColor);
        }

        window.showProductModal = function(productId) {
            const product = window.inventory.find(p => p.id === productId);
            if (!product) return;
            window.currentProductInModal = product;

            const detailsHTML = `
                <h2>${product.name}</h2>
                <p>${product.description}</p>
                <p>Precio: <strong>$${product.price.toFixed(2)}</strong></p>
            `;
            document.getElementById('modal-content-details').innerHTML = detailsHTML;

            const optionsContainer = document.getElementById('product-options');
            optionsContainer.innerHTML = '';
            
            let initialColor = null;

            if (product.isColorProduct) {
                let colorButtonsHTML = '<p>Color:</p><div id="color-options">';
                initialColor = product.colors[0]; 
                
                product.colors.forEach(colorName => {
                    const colorData = product.colorMap[colorName];
                    if (!colorData || !colorData.hex) {
                        console.warn(`Advertencia: Falta el c√≥digo HEX para el color ${colorName} en Firebase.`);
                        return;
                    }
                    
                    const colorCode = colorData.hex;
                    const isActive = colorName === initialColor ? 'active' : '';
                    
                    colorButtonsHTML += `
                        <button 
                            data-color="${colorName}" 
                            style="background-color: ${colorCode};"
                            class="${isActive}"
                            onclick="window.changeColorAndSize(window.currentProductInModal, '${colorName}')"
                            title="${colorName}"
                        ></button>
                    `;
                });
                colorButtonsHTML += '</div>';
                optionsContainer.innerHTML += colorButtonsHTML;

            } else {
                optionsContainer.innerHTML += '<p>Color: √önico</p>';
                initialColor = null;
            }

            optionsContainer.innerHTML += '<div id="size-options"></div>';

            if (product.isColorProduct) {
                window.changeColorAndSize(product, initialColor);
            } else {
                document.getElementById('size-options').innerHTML = generateSizeOptionsHTML(product, null);
                const fileName = getFileName(product, 'front', null);
                document.getElementById('main-product-image').src = fileName;
                document.getElementById('add-to-cart-button').onclick = () => window.addToCart(product.id, 'N/A');
            }
            
            if (product.sizeChartHTML) {
                document.getElementById('size-chart-container').innerHTML = `
                    <h4>Tabla de Tallas</h4>
                    ${product.sizeChartHTML}
                `;
            } else {
                 document.getElementById('size-chart-container').innerHTML = '';
            }
            
            document.getElementById('quantity').value = 1;

            document.getElementById('product-modal').style.display = "block";
        }


        function generateSizeOptionsHTML(product, selectedColor) {
            let stockMap = product.stock;
            let title = 'Tallas disponibles:';
            let productCodeForTitle = product.productCode || 'N/A';

            if (product.isColorProduct && selectedColor) {
                stockMap = product.stockByColor?.[selectedColor] || {};
                title = `Tallas disponibles para ${selectedColor}:`;
                productCodeForTitle = product.colorMap[selectedColor]?.productCode || product.productCode || 'N/A';
            }
            
            const sizes = Object.keys(stockMap).sort((a, b) => {
                const order = ['XS', 'S', 'M', 'L', 'XL', 'XXL', '3XL', '4XL'];
                const aIndex = order.indexOf(a.toUpperCase());
                const bIndex = order.indexOf(b.toUpperCase());
                return (aIndex > -1 ? aIndex : 100) - (bIndex > -1 ? bIndex : 100);
            }).filter(size => stockMap[size] > 0);

            let html = `<p>C√≥digo Producto: <strong>${productCodeForTitle}</strong></p>
                        <p>${title}</p>
                        <div id="size-buttons-container">`;

            if (sizes.length === 0) {
                html += '<p>No hay stock disponible para esta selecci√≥n.</p>';
                return html + '</div>';
            }
            
            let firstSize = sizes[0];

            sizes.forEach(size => {
                const isActive = size === firstSize ? 'active' : '';
                html += `
                    <button class="stock-option ${isActive}" 
                            data-size="${size}"
                            onclick="window.selectSize('${size}')">
                        ${size} (${stockMap[size]})
                    </button>
                `;
            });
            
            html += `</div>
                     <input type="hidden" id="selected-size" value="${firstSize}">
                     <p style="margin-top: 10px;">Talla seleccionada: <strong id="display-size">${firstSize}</strong></p>`;
            
            return html;
        }

        window.selectSize = function(size) {
            document.getElementById('selected-size').value = size;
            document.getElementById('display-size').textContent = size;
            
            document.querySelectorAll('#size-buttons-container button').forEach(btn => btn.classList.remove('active'));
            const newActiveButton = document.querySelector(`button[data-size="${size}"]`);
            if(newActiveButton) {
                newActiveButton.classList.add('active');
            }
        }

        // =================================================================================
        // FUNCI√ìN PRINCIPAL DE AGREGAR AL CARRITO (STOCK CORREGIDO)
        // =================================================================================
        window.addToCart = function(productId, color) {
            const product = window.inventory.find(p => p.id === productId);
            if (!product) return;

            const quantity = parseInt(document.getElementById('quantity').value);
            const size = document.getElementById('selected-size')?.value;
            
            const finalColor = color === 'N/A' ? '√önico' : color;
            
            if (!size || quantity <= 0) {
                alert("Por favor, selecciona una talla y una cantidad v√°lida.");
                return;
            }

            let availableStock = 0;
            if (product.isColorProduct) {
                availableStock = product.stockByColor?.[finalColor]?.[size] || 0;
            } else {
                availableStock = product.stock?.[size] || 0;
            }

            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const cartItemId = `${productId}-${finalColor}-${size}`;

            const existingItemIndex = cart.findIndex(item => item.cartItemId === cartItemId);

            let currentInCart = 0;
            if (existingItemIndex > -1) {
                currentInCart = cart[existingItemIndex].quantity;
            }

            const newQuantityTotal = currentInCart + quantity;

            if (newQuantityTotal > availableStock) {
                const maxToAdd = availableStock - currentInCart;
                if (maxToAdd > 0) {
                    alert(`No puedes agregar esa cantidad. Solo puedes agregar ${maxToAdd} unidad(es) m√°s. Stock disponible: ${availableStock}.`);
                } else {
                     alert(`Stock agotado o m√°ximo alcanzado. Solo hay ${availableStock} unidad(es) disponibles.`);
                }
                return;
            }


            if (existingItemIndex > -1) {
                cart[existingItemIndex].quantity = newQuantityTotal;
            } else {
                cart.push({
                    cartItemId: cartItemId,
                    id: productId,
                    name: product.name,
                    price: product.price,
                    size: size,
                    color: finalColor,
                    isColorProduct: product.isColorProduct,
                    quantity: quantity
                });
            }

            saveCart(cart);
            window.closeProductModal();
            alert(`¬°${quantity} unidad(es) de ${product.name} (${finalColor}) a√±adida(s) al carrito!`);
        }

        // Inicializar el carrito al cargar la p√°gina
        window.addEventListener('load', window.updateCartDisplay);

    </script>
</body>
</html>
