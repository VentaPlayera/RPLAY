<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda RPLAY</title>
    </head>
<body>

    <header>
        <h1>Tienda RPLAY</h1>
        <button onclick="toggleCartModal()">üõí Carrito (<span id="cart-count">0</span>)</button>
    </header>

    <main id="products-container">
        <h2>Cargando inventario desde Realtime Database...</h2>
    </main>
    
    <div id="cart-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="toggleCartModal()">&times;</span>
            <h3>Tu Carrito</h3>
            <div id="cart-items">
                </div>
            <p>Total: $<span id="cart-total">0.00</span></p>
            <button onclick="sendOrderToWhatsapp()">Finalizar Compra por WhatsApp</button>
            <button onclick="clearCart()">Vaciar Carrito</button>
        </div>
    </div>

    <div id="product-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeProductModal()">&times;</span>
            <div id="modal-content-details">
                </div>
        </div>
    </div>

    <script type="module">
        // üö® CONFIGURACI√ìN DE FIREBASE (TU PROYECTO RPLAY)
        const firebaseConfig = {
            apiKey: "AIzaSyCtgsjjbNIS0lv5aLD8nkpN_9-4sXIJVE", //
            authDomain: "rplay-f04dc.firebaseapp.com",
            // üö® URL CORRECTA DE TU REALTIME DATABASE:
            databaseURL: "https://rplay-f04dc-default-rtdb.firebaseio.com", 
            projectId: "rplay-f04dc",
            storageBucket: "rplay-f04dc.appspot.com",
            messagingSenderId: "787828282738",
            appId: "1:787828282738:web:00c1ff1a7008c0e02b79eb",
            measurementId: "G-XEKR4KEDMR"
        };
        

        // üö® IMPORTAR LIBRER√çAS DE FIREBASE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
        import { getDatabase, ref, get, set, runTransaction } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";

        // Inicializar Firebase y Realtime Database
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // üö® EXPOSICI√ìN GLOBAL PARA EL SCRIPT DE MIGRACI√ìN (Temporal)
        window.db = db;
        window.ref = ref;
        window.get = get;
        window.set = set;
        window.runTransaction = runTransaction;

        // =================================================================================
        // FUNCI√ìN PRINCIPAL PARA CARGAR PRODUCTOS DESDE REALTIME DATABASE
        // =================================================================================

        let inventory = []; // El inventario se almacena aqu√≠ globalmente

        async function loadProductsFromFirebase() {
            try {
                console.log("Cargando inventario desde Realtime Database...");
                const snapshot = await get(ref(db, 'products'));
                
                if (snapshot.exists()) {
                    const productsObject = snapshot.val();
                    // Convertir el objeto de productos a un array
                    inventory = Object.values(productsObject); 
                    
                    console.log(`Inventario cargado: ${inventory.length} productos.`);
                    // renderProducts(); // Llama a tu funci√≥n para mostrar los productos
                } else {
                    console.log("No hay productos en la base de datos.");
                    document.getElementById('products-container').innerHTML = '<h2>No hay inventario. Por favor, ejecuta uploadAllProducts() en la Consola.</h2>';
                }
            } catch (e) {
                console.error("Error al cargar productos desde Firebase:", e);
                document.getElementById('products-container').innerHTML = '<h2>Error al cargar inventario. Revisa la consola y la configuraci√≥n de Firebase.</h2>';
            }
        }
        
        // Ejecutar la carga al iniciar
        window.addEventListener('load', loadProductsFromFirebase);


        // =================================================================================
        // FUNCI√ìN PARA ACTUALIZAR STOCK TRAS LA COMPRA (ADAPTADA A REALTIME DB)
        // =================================================================================

        window.sendOrderToWhatsapp = async function() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            if (cart.length === 0) {
                alert("Tu carrito est√° vac√≠o.");
                return;
            }

            try {
                let whatsappMessage = "¬°Hola! Quisiera hacer un pedido:\n\n";
                const transactionPromises = [];

                for (const item of cart) {
                    whatsappMessage += `- ${item.name} (${item.isColorProduct ? item.color : '√önico'}) - Talla ${item.size} x ${item.quantity} unidades\n`;
                    
                    const productPath = `products/${item.id}`;

                    // Usar runTransaction para garantizar que el descuento sea at√≥mico (seguro)
                    const transactionPromise = runTransaction(ref(db, productPath), (currentProduct) => {
                        if (currentProduct) {
                            let newStock = 0;
                            if (item.isColorProduct) {
                                // Stock en Realtime DB: stockByColor/Color/Talla
                                const currentStock = currentProduct.stockByColor?.[item.color]?.[item.size] || 0;
                                newStock = currentStock - item.quantity;
                                
                                if (newStock >= 0) {
                                    if (!currentProduct.stockByColor) currentProduct.stockByColor = {};
                                    if (!currentProduct.stockByColor[item.color]) currentProduct.stockByColor[item.color] = {};
                                    currentProduct.stockByColor[item.color][item.size] = newStock;
                                } else {
                                    // Stock insuficiente
                                    return; 
                                }
                            } else {
                                // Stock en Realtime DB: stock/Talla
                                const currentStock = currentProduct.stock?.[item.size] || 0;
                                newStock = currentStock - item.quantity;
                                
                                if (newStock >= 0) {
                                    if (!currentProduct.stock) currentProduct.stock = {};
                                    currentProduct.stock[item.size] = newStock;
                                } else {
                                    // Stock insuficiente
                                    return;
                                }
                            }
                            return currentProduct; // Retorna el nuevo estado para guardar
                        }
                        return currentProduct; // No hacer cambios si el producto no existe
                    });
                    
                    transactionPromises.push(transactionPromise);
                }

                // Esperar a que todas las transacciones se completen
                await Promise.all(transactionPromises);

                // Enviar mensaje de WhatsApp (debes agregar tu n√∫mero)
                whatsappMessage += `\nTotal a pagar: $${document.getElementById('cart-total').textContent}`;
                const encodedMessage = encodeURIComponent(whatsappMessage);
                window.open(`https://wa.me/TUNUMEROAQUI?text=${encodedMessage}`, '_blank');

                // Limpiar carrito y actualizar vista
                // clearCart(); // Descomenta esta l√≠nea una vez que todas las funciones de tu tienda est√©n completas
                alert("Pedido realizado y stock actualizado en la nube. ¬°Revisa WhatsApp!");
                loadProductsFromFirebase(); // Recargar inventario

            } catch (error) {
                console.error("Error al finalizar la compra y actualizar stock:", error);
                alert("Hubo un error al procesar el pedido. Por favor, int√©ntalo de nuevo.");
            }
        }
        
        // üö® (TUS OTRAS FUNCIONES JS, como renderProducts, toggleCartModal, etc., deben estar aqu√≠)
        
    </script>


    <script>
        // ESTA SECCI√ìN ES SOLO PARA LA MIGRACI√ìN INICIAL.
        // B√ìRRALA O COMENTALA DESPU√âS DE EJECUTAR UPLOADALLPRODUCTS() UNA VEZ.

        function getOriginalInventory() {
            const ORIGINAL_PRODUCTS_DEFINITION = [
                // Modelos est√°ndar (i=1 a i=41)
                { i: 1, name: 'BTS', description: 'Playera Modelo 1', stock: { 'M': 1, 'L' :1, 'XL': 1}, frontFile: 'xime1', backFile: 'Xime2', sideFile: 'blanco' },
                { i: 2, name: 'BTS', description: 'Playera Modelo 2', stock: { 'M': 1, 'L' :1, 'XL': 1}, frontFile: 'Xime3', backFile: 'Xime4', sideFile: 'negro' },
                { i: 3, name: 'MICHAEL JACKSON', description: 'Playera Modelo 3', stock:{ 'S':1, 'M':1, 'L': 1 }, frontFile: 'Abi1', backFile: 'Abi2', sideFile: 'blanco' },
                { i: 4, name: 'MICHAEL JACKSON', description: 'Playera Modelo 4', stock: {'L': 1 }, frontFile: 'Abi3', backFile: 'Abi4', sideFile: 'negro' },
                { i: 5, name: 'ADO', description: 'Playera Modelo 5', stock: {'XL': 1 }, frontFile: 'Lucy1', backFile: 'Lucy2', sideFile: 'blanco' },
                { i: 6, name: 'ADO', description: 'Playera Modelo 6', stock: { 'M': 1, 'L': 1, 'XL':2 }, frontFile: 'Lucy3', backFile: 'Lucy4', sideFile: 'negro' },
                { i: 7, name: 'BRUNO MARS', description: 'Playera Modelo 7', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Raul1', backFile: 'Raul2', sideFile: 'negro' },
                { i: 8, name: 'BRUNO MARS', description: 'Playera Modelo 8', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Raul3', backFile: 'Raul4', sideFile: 'negro' },
                { i: 9, name: 'LATIN MAFIA', description: 'Playera Modelo 9', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Dani1', backFile: 'Dani2', sideFile: 'blanco' },
                { i: 10, name: 'LATIN MAFIA', description: 'Playera Modelo 10', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Dani3', backFile: 'Dani4', sideFile: 'negro' },
                { i: 11, name: 'AESPA', description: 'Playera Modelo 11', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Dali1', backFile: 'Dali2', sideFile: 'negro' },
                { i: 12, name: 'AESPA', description: 'Playera Modelo 12', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Dali3', backFile: 'Dali4', sideFile: 'negro' },
                { i: 13, name: 'BILLIE EILISH', description: 'Playera Modelo 13', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Yose1', backFile: 'Yose2', sideFile: 'negro' },
                { i: 14, name: 'BILLIE EILISH', description: 'Playera Modelo 14', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Yose3', backFile: 'Yose4', sideFile: 'negro' },
                { i: 15, name: 'LANA DEL REY', description: 'Playera Modelo 15', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Keila1', backFile: 'Keila2', sideFile: 'blanco' },
                { i: 16, name: 'LANA DEL REY', description: 'Playera Modelo 16', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Keila3', backFile: 'Keila4', sideFile: 'negro' },
                { i: 17, name: 'MY CHEMICAL ROMANCE', description: 'Playera Modelo 17', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Kenji1', backFile: 'Kenji2', sideFile: 'negro' },
                { i: 18, name: 'MY CHEMICAL ROMANCE', description: 'Playera Modelo 18', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Kenji3', backFile: 'Kenji4', sideFile: 'negro' },
                { i: 19, name: 'TWENTY ONE PILOTS', description: 'Playera Modelo 19', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Alli1', backFile: 'Alli2', sideFile: 'negro' },
                { i: 20, name: 'TWENTY ONE PILOTS', description: 'Playera Modelo 20', stock: { 'M': 1, 'L': 1, 'XL':1 },frontFile: 'Alli3', backFile: 'Alli4', sideFile: 'negro' },
                { i: 21, name: 'SELENA QUINTANILLA', description: 'Playera Modelo 21', stock: { 'XL':1 }, frontFile: 'Ale1', backFile: 'Ale2', sideFile: 'arena' },
                { i: 22, name: 'OLIVIA RODRIGO', description: 'Playera Modelo 22', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Miri1', backFile: 'Miri2', sideFile: 'negro' },
                { i: 23, name: 'OLIVIA RODRIGO', description: 'Playera Modelo 23', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Miri3', backFile: 'Miri4', sideFile: 'negro' },
                { i: 24, name: 'BAD BUNNY', description: 'Playera Modelo 24', stock: { 'M': 1, 'XL':1 }, frontFile: 'Didi1', backFile: 'Didi2', sideFile: 'negro' },
                { i: 25, name: 'BAD BUNNY', description: 'Playera Modelo 25', stock: { 'L': 1, 'XL':1 }, frontFile: 'Didi3', backFile: 'Didi4', sideFile: 'arena' },
                { i: 26, name: 'Taylor SWIFT', description: 'Playera Modelo 26', stock:{ 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Vale1', backFile: 'Vale2', sideFile: 'arena' },
                { i: 27, name: 'TAYLOR SWIFT', description: 'Playera Modelo 27', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Vale3', backFile: 'Vale4', sideFile: 'negro' },
                { i: 28, name: 'HUMBE', description: 'Playera Modelo 28', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Caro1', backFile: 'Caro2', sideFile: 'arena' },
                { i: 29, name: 'HUMBE', description: 'Playera Modelo 29', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Caro3', backFile: 'Caro4', sideFile: 'arena' },
                { i: 30, name: 'KATY PERRY', description: 'Playera Modelo 30', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Gon1', backFile: 'Gon2', sideFile: 'negro' },
                { i: 31, name: 'KATY PERRY', description: 'Playera Modelo 31', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Katy3', backFile: 'Katy4', sideFile: 'blanco' },
                { i: 32, name: 'TAYLOR SWIFT', description: 'Playera Modelo 32', stock: { 'S': 1, 'M': 1, 'L':1 }, frontFile: 'Bere1', backFile: 'Bere2', sideFile: 'blanco2' },
                { i: 33, name: 'TAYLOR SWIFT', description: 'Playera Modelo 33', stock: { 'S': 1, 'M': 1, 'L':1 },frontFile: 'Bere3', backFile: 'Bere4', sideFile: 'negro2' },
                { i: 34, name: 'BTS', description: 'Playera Modelo 34', stock: { 'S': 1, 'M': 1, 'L':1 }, frontFile: 'Dan1', backFile: 'Dan2', sideFile: 'negro2' },
                { i: 35, name: 'BTS', description: 'Playera Modelo 35', stock: { 'S': 1, 'M': 1, 'L':1 }, frontFile: 'Dan3', backFile: 'Dan4', sideFile: 'negro2' },
                { i: 36, name: 'NCT DREAM', description: 'Playera Modelo 36', stock: { 'S': 1, 'M': 1, 'L':1 }, frontFile: 'Gera1', backFile: 'Gera2', sideFile: 'negro2' },
                { i: 37, name: 'NCT DREAM', description: 'Playera Modelo 37', stock: { 'S': 1, 'M': 1, 'L':1 }, frontFile: 'Gera3', backFile: 'Gera4', sideFile: 'negro2' },
                { i: 38, name: 'HUNTRIX/SAJA BOYS', description: 'Playera Modelo 38', stock: { 'S': 1, 'M': 1, 'L':1 }, frontFile: 'Bra1', backFile: 'Bra2', sideFile: 'negro2' },
                { i: 39, name: 'HUNTRIX/SAJA BOYS', description: 'Playera Modelo 39', stock: { 'S': 1, 'M': 1, 'L':1 }, frontFile: 'Bra3', backFile: 'Bra4', sideFile: 'negro2' },
                { i: 40, name: 'HOZIER', description: 'Playera Modelo 40', stock: { 'S': 1, 'M': 1, 'L':1 }, frontFile: 'Adri1', backFile: 'Adri2', sideFile: 'negro2' },
                { i: 41, name: 'HOZIER', description: 'Playera Modelo 41', stock: { 'S': 1, 'M': 1, 'L':1 }, frontFile: 'Adri3', backFile: 'Adri4', sideFile: 'blanco2' },
                
                // --- MODELOS CON OPCI√ìN DE COLOR (i=42 y i=43) ---
                { 
                    i: 42, 
                    name: 'BLACKPINK', 
                    description: 'Modelo 42 con opci√≥n de color', 
                    colors: ['Negro', 'Blanco'], 
                    isColorProduct: true,
                    stockByColor: { 
                        'Blanco': { 'S': 1, 'M': 1 },
                        'Negro': { 'L': 1 }
                    },
                    colorMap: { 
                        'Negro': { front: 'Aro1', back: 'Aro2', side: 'negro2' },
                        'Blanco': { front: 'Aro3', back: 'Aro4', side: 'blanco2' }
                    }
                },
                { 
                    i: 43, 
                    name: 'BLACKPINK', 
                    description: 'Modelo 43 con opci√≥n de color', 
                    colors: [ 'Negro','Blanco'], 
                    isColorProduct: true,
                    stockByColor: { 
                        'Blanco': { 'S': 1, 'M': 1 },
                        'Negro': { 'L': 1 }
                    },
                    colorMap: { 
                        'Negro': { front: 'Aro5', back: 'Aro6', side: 'negro2' },
                        'Blanco': { front: 'Aro7', back: 'Aro8', side: 'blanco2'}
                    }
                },
            ];
            
            // Adaptar el array de productos a la estructura de objeto que requiere Realtime Database
            const productsObject = {};
            ORIGINAL_PRODUCTS_DEFINITION.forEach(p => {
                const paddedIndex = p.i.toString().padStart(3, '0');
                const id = `PROD_${paddedIndex}`;
                
                const doc = {
                    id: id,
                    name: p.name,
                    description: p.description,
                    price: 250.00,
                    isColorProduct: p.isColorProduct || false,
                };

                if (doc.isColorProduct) {
                    doc.colors = p.colors;
                    doc.stockByColor = p.stockByColor;
                    doc.colorMap = p.colorMap;
                    doc.frontFileBase = p.colorMap[p.colors[0]].front;
                    doc.backFileBase = p.colorMap[p.colors[0]].back;
                    doc.sideFileBase = p.colorMap[p.colors[0]].side;
                } else {
                    doc.stock = p.stock;
                    doc.frontFileBase = p.frontFile;
                    doc.backFileBase = p.backFile;
                    doc.sideFileBase = p.sideFile;
                }
                
                productsObject[id] = doc;
            });

            return productsObject;
        }

        // Funci√≥n de migraci√≥n masiva para Realtime Database
        window.uploadAllProducts = async function() {
            const allProductsObject = getOriginalInventory();
            
            if (!window.db || !window.set || !window.ref) {
                console.error("‚ùå ERROR: Realtime Database no est√° inicializada. Aseg√∫rate de que la URL y la configuraci√≥n son correctas.");
                return;
            }
            
            console.log(`‚úÖ Intentando subir ${Object.keys(allProductsObject).length} productos a la colecci√≥n 'products'...`);
            
            try {
                // Subir todo el objeto de productos en el path 'products'
                await set(ref(db, 'products'), allProductsObject);
                console.log("=========================================================");
                console.log("üéâ MIGRACI√ìN TERMINADA. ¬°Verifica tu Realtime Database!");
                console.log("=========================================================");
                // Recargar el inventario despu√©s de la subida para que se muestre en la tienda
                loadProductsFromFirebase(); 
            } catch(e) {
                console.error("‚ùå Error al subir los productos a Realtime Database: ", e);
            }
        }
    </script>
</body>
</html>
