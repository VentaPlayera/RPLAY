<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPLAY - Venta de Playeras</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .product-card {
            border: 1px solid #ddd;
            transition: transform 0.2s;
            margin-bottom: 20px;
        }
        .product-card:hover {
            transform: translateY(-5px);
        }
        .btn-buy {
            background-color: #ff3366;
            color: white;
            border: none;
        }
        .btn-buy:hover {
            background-color: #e6004b;
            color: white;
        }
        .stock-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            color: white;
            z-index: 10;
        }
        .stock-badge.in-stock { background-color: green; }
        .stock-badge.low-stock { background-color: orange; }
        .stock-badge.out-stock { background-color: red; }

        /* --- IMAGEN DEL MODAL --- */
        .modal-image {
            object-fit: contain; 
            height: 450px;       
            width: 100%;         
            display: block;      
            background-color: #f0f0f0; 
        }
    </style>
</head>
<body>

    <div class="container my-5">
        
        <div class="d-flex align-items-center justify-content-center mb-5">
            <img src="https://imgur.com/mpCQaZg.jpg" alt="Logo de mi tienda" style="max-width: 250px; height: auto;">
        </div>
        <h1 class="text-center mb-5" style="color: #ff3366;">RPLAY</h1>
        
        <div class="container mb-5" id="manualManagementPanel" style="display:none;">
            <h3 class="text-danger mb-3">Administración de Pedidos Apartados</h3>
            <p class="text-muted small">Haz clic en "Liberar Stock" si el cliente no confirmó el pago (gestión manual de las 24 horas).</p>
            <div id="ordersList" class="p-3 border rounded bg-white">
                <p class="text-center text-secondary" id="noOrdersMessage">No hay pedidos pendientes actualmente.</p>
            </div>
            <hr>
            <button class="btn btn-sm btn-outline-secondary" onclick="resetAllStock()">REINICIAR TODO EL INVENTARIO</button>
            <p class="text-muted small mt-2">
                Para *modificar el stock inicial*, usa la función setStock en la consola (F12).
                <br>Ejemplo: **setStock('PROD_001', 'Default', 'M', 5)**
            </p>
        </div>
        
        <div class="row" id="product-list">
        </div>
    </div>

    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalLabel">Detalle y Pago</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
                                
                                <div class="carousel-indicators">
                                    <button type="button" data-bs-target="#productCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
                                    <button type="button" data-bs-target="#productCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
                                    <button type="button" data-bs-target="#productCarousel" data-bs-slide-to="2" aria-label="Slide 3"></button>
                                </div>

                                <div class="carousel-inner">
                                    <div class="carousel-item active">
                                        <img id="modal-img-front" src="" class="modal-image" alt="Delantera de la Playera">
                                    </div>
                                    <div class="carousel-item">
                                        <img id="modal-img-back" src="" class="modal-image" alt="Espalda de la Playera">
                                    </div>
                                    <div class="carousel-item">
                                        <img id="modal-img-side" src="" class="modal-image" alt="Vista Lateral de la Playera">
                                    </div>
                                </div>
                                <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                </button>
                            </div>
                            </div>

                        <div class="col-md-6">
                            
                            <div id="selection-step">
                                <h4 class="mt-3" id="product-name"></h4>
                                <p class="text-muted" id="product-description"></p>
                                
                                <div class="mb-4" id="color-selection-container" style="display:none;">
                                    <h6>Color:</h6>
                                    <div id="color-options"></div>
                                </div>

                                <div class="mb-4">
                                    <h6>Talla:</h6>
                                    <div id="size-options"></div>
                                    <small id="size-status" class="text-secondary mt-2"></small>
                                </div>
                                
                                <div class="mb-4">
                                    <h6>Cantidad de Piezas:</h6>
                                    <input type="number" id="quantityInput" class="form-control" value="1" min="1" max="10" style="width: 100px;">
                                    <small id="quantity-status" class="text-secondary mt-2"></small>
                                </div>
                                
                                <hr>
                                
                                <p>Precio Total: <strong id="total-price" class="text-danger"></strong></p>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" value="" id="halfPaymentCheck" checked>
                                    <label class="form-check-label" for="halfPaymentCheck">Pagar la Mitad Ahora (Apartar)</label>
                                </div>
                                <p>Monto a Pagar Ahora: <strong id="payment-due" style="font-size: 1.4rem; color: green;"></strong></p>
                                <small class="text-muted">El resto se pagará al momento de la entrega el 28 de Noviembre.</small>
                            </div>

                            <div id="payment-step" style="display:none;">
                                <h4 class="mt-3 mb-4">Datos del Comprador y Envío</h4>
                                <p class="alert alert-info small">
                                    Estás comprando <strong id="final-quantity-display">1</strong> pieza(s) talla <strong id="final-size-display"></strong> por <strong id="final-price-display"></strong>.
                                    Llena tus datos para guardar el pedido y ver las instrucciones de pago por transferencia.
                                </p>

                                <div class="mb-3">
                                    <label for="clientName" class="form-label">Nombre Completo (*):</label>
                                    <input type="text" class="form-control" id="clientName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="clientPhone" class="form-label">Teléfono/WhatsApp (*):</label>
                                    <input type="tel" class="form-control" id="clientPhone" required>
                                </div>
                                <div class="mb-3">
                                    <label for="clientAddress" class="form-label">Dirección de Envío Completa (*):</label>
                                    <textarea class="form-control" id="clientAddress" rows="2" required></textarea>
                                </div>
                                
                                <div id="payment-error" class="text-danger mb-3" style="display:none;">Por favor, completa todos los campos requeridos (*).</div>
                            </div>
                            
                            <div id="transfer-info" style="display:none;">
                                <h4 class="mt-3 mb-4 text-success">¡Pedido Generado!</h4>
                                <p>Hola <strong id="client-name-display"></strong>. Para confirmar tu compra de <span id="final-qty-conf">1</span> playera(s) (<span id="final-item-display"></span>, Talla <span id="final-size-conf"></span>), realiza la transferencia por el monto de <strong id="final-amount-conf" class="text-success"></strong> a la siguiente cuenta:</p>
                                <hr>
                                
                                <h5 class="text-primary">Datos de Transferencia Bancaria</h5>
                                <p class="mb-1"><strong>Banco:</strong> BANCOMER (BBVA)</p>
                                <p class="mb-1"><strong>Número de Cuenta:</strong> 0123 4567 8901 2345</p>
                                <p class="mb-1"><strong>CLABE Interbancaria:</strong> 012000000000000000</p>
                                <p class="mb-1"><strong>Beneficiario:</strong> MI TIENDA DE PLAYERAS S.A. DE C.V.</p>
                                
                                <hr>
                                <p class="text-center">¡Haz clic en el botón de WhatsApp abajo para enviar tus datos y el comprobante!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <a href="#" target="_blank" class="btn btn-success" id="whatsapp-confirm-button" style="display:none;">
                        Enviar Comprobante por WhatsApp
                    </a>
                    
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="modal-close-button">Cerrar</button>
                    
                    <button type="button" class="btn btn-buy" id="modal-main-button" disabled>Pagar Ahora</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        
        // --- 1. CONFIGURACIÓN GLOBAL ---
        // Número de teléfono para WhatsApp (el número que tú pusiste)
        const WHATSAPP_NUMBER = '5219991480151'; 
        
        // Nueva estructura de inventario: productInventory[id][color][size] = stock
        const productInventory = {};
        const productData = [];
        const DEFAULT_GLOBAL_SIZES = ["M", "L", "XL"]; 
        const FIXED_PRICE = 250.00; 
        const DEFAULT_STOCK_PER_SIZE = 1;
        const PRODUCT_LIST_CONTAINER = document.getElementById('product-list');

        function generateInitialInventory() {
            // Se limita el loop a 44 modelos
            for (let i = 1; i <= 44; i++) { 
                const id = `PROD_${String(i).padStart(3, '0')}`;
                let modelSizes = [...DEFAULT_GLOBAL_SIZES]; 
                let initialStockOverrides = {}; 
                let productName = `Playera Modelo No. ${i}`;
                let productDescription = `Diseño exclusivo #${i} con estampado digital de alta calidad. Tela de algodón 100%.`;
                let variants = {}; // { 'colorName': { img_front: 'url', img_back: 'url', img_side: 'url', stock: { 'M': 1, ... } } }

                let mainImg, frontImg, backImg, sideImg;

                // Bloque para productos de color único: i=1 a 42
                if (i < 44) {
                    // Productos de 1 a 42: Se tratan como variantes de color 'Default'
                    
                    // Asignación de imágenes y stock para i=1 a i=42
                    if (i === 1) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Xime1.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Xime1.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Xime2.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/blanco.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 2) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Xime3.png';
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Xime3.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Xime4.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 3) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Lucy1.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Lucy1.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Lucy2.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/blanco.png'; 
                        initialStockOverrides = {M: 1, XL: 1}; 
                        modelSizes = ['M','XL'];
                    } else if (i === 4) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Lucy3.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Lucy3.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Lucy4.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 2};
                    } else if (i === 5) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Raul1.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Raul1.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Raul2.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 6) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Raul3.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Raul3.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Raul4.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 7) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Abi1.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Abi1.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Abi2.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/blanco.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 8) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Abi3.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Abi3.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Abi4.png';
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 2}; 
                        modelSizes = ['M', 'L'];
                    } else if (i === 9) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Dani1.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Dani1.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Dani2.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/blanco.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 10) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Dani3.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Dani3.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Dani4.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 11) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Dali1.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Dali1.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Dali2.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 12) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Dali3.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Dali3.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Dali4.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 13) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Yose1.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Yose1.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Yose2.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 14) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Yose3.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Yose3.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Yose4.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 15) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Keila1.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Keila1.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Keila2.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/blanco.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 16) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Keila3.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Keila3.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Keila4.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 17) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Kenji1.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Kenji1.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Kenji2.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 18) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Kenji3.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Kenji3.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Kenji4.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 19) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Alli1.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Alli1.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Alli2.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 20) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Alli3.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Alli3.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Alli4.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 21) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Ale1.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Ale1.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Ale2.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/arena.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 22) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Ale3.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Ale3.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Ale4.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/arena.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 23) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Miri1.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Miri1.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Miri2.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 24) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Miri3.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Miri3.png';
                        backImg = 'https://ventaplayera.github.io/RPLAY/Miri4.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 25) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Didi1.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Didi1.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Didi2.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 26) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Didi3.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Didi3.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Didi4.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/arena.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 27) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Vale1.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Vale1.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Vale2.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/arena.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 28) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Vale3.png';
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Vale3.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Vale4.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 29) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Caro1.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Caro1.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Caro2.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 30) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Caro3.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Caro3.png';
                        backImg = 'https://ventaplayera.github.io/RPLAY/Caro4.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 31) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/katy1.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/katy1.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/katy2.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/blanco.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    }else if (i === 32) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Gon3.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Gon3.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Gon4.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/blanco.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    }else if (i === 33) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Bere1.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Bere3.png';
                        backImg = 'https://ventaplayera.github.io/RPLAY/Bere4.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/blanco.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 34) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Bere3.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Bere3.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Bere4.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/blanco.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 35) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Dan1.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Dan1.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Dan2.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 36) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Dan3.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Dan3.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Dan4.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 37) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Gera1.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Gera1.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Gera2.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 38) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Gera3.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Gera3.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Gera4.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 39) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Bra1.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Bra1.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Bra2.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 40) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Bra3.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Bra3.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Bra4.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 41) { 
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Adri1.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Adri1.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Adri2.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 42) { 
                        // Playera 42, ahora es color único (Adriana 3/4)
                        mainImg = 'https://ventaplayera.github.io/RPLAY/Adri3.png'; 
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Adri3.png'; 
                        backImg = 'https://ventaplayera.github.io/RPLAY/Adri4.png'; 
                        sideImg = 'https://ventaplayera.github.io/RPLAY/negro.png'; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } 

                    // Definir stock para la variante 'Default'
                    const stockMap = {};
                    modelSizes.forEach(size => {
                        stockMap[size] = initialStockOverrides[size] !== undefined ? initialStockOverrides[size] : DEFAULT_STOCK_PER_SIZE;
                    });

                    variants['Default'] = {
                        img_front: frontImg,
                        img_back: backImg,
                        img_side: sideImg,
                        stock: stockMap,
                        mainImg: mainImg
                    };

                // Bloque para Producto 43: Blackpink BORN PINK D2 (Multi-Color)
                } else if (i === 43) { 
                    productName = 'Playera Blackpink BORN PINK D2';
                    productDescription = 'Diseño Blackpink "BORN PINK" en negro/blanco. Edición especial.';

                    // Variante Negro: Imágenes actualizadas
                    variants['Negro'] = {
                        img_front: 'https://ventaplayera.github.io/RPLAY/Aro1.png';
                        img_back: 'https://ventaplayera.github.io/RPLAY/Aro2.png';
                        img_side: 'https://ventaplayera.github.io/RPLAY/negro.png';
                        stock: { M: 1, L: 1, XL: 1 },
                        mainImg: 'https://ventaplayera.github.io/RPLAY/Aro1.png';
                    };
                    
                    // Variante Blanco: URLs conservadas
                    variants['Blanco'] = {
                        img_front: 'https://ventaplayera.github.io/RPLAY/Aro3.png';
                        img_back: 'https://ventaplayera.github.io/RPLAY/Aro4.png'; 
                        img_side: 'https://ventaplayera.github.io/RPLAY/blanco.png'; // Corregida a blanco.png si es un color blanco
                        stock: { M: 1, L: 1, XL: 1 },
                        mainImg: 'https://ventaplayera.github.io/RPLAY/Aro3.png';
                    };
                    
                // Bloque para Producto 44: Blackpink Lips D1 (Multi-Color)
                } else if (i === 44) {
                    productName = 'Playera Blackpink Lips D1';
                    productDescription = 'Diseño Blackpink de labios en magenta sobre negro/blanco. Edición especial.';
                    
                    // Variante Negro: Imágenes actualizadas
                    variants['Negro'] = {
                        img_front: 'https://ventaplayera.github.io/RPLAY/Aro5.png';
                        img_back: 'https://ventaplayera.github.io/RPLAY/Aro6.png';
                        img_side: 'https://ventaplayera.github.io/RPLAY/negro.png';
                        stock: { M: 1, L: 1, XL: 1 },
                        mainImg: 'https://ventaplayera.github.io/RPLAY/Aro5.png';
                    };

                    // Variante Blanco: URLs conservadas
                    variants['Blanco'] = {
                        img_front: 'https://ventaplayera.github.io/RPLAY/Aro7.png';
                        img_back: 'https://ventaplayera.github.io/RPLAY/Aro8.png';
                        img_side: 'https://ventaplayera.github.io/RPLAY/blanco.png';
                        stock: { M: 1, L: 1, XL: 1 },
                        mainImg: 'https://ventaplayera.github.io/RPLAY/Aro7.png';
                    };
                }

                // Finalizar estructura del producto y stock
                productData.push({
                    id: id,
                    name: productName,
                    price: FIXED_PRICE.toFixed(2), 
                    description: productDescription,
                    variants: variants 
                });

                productInventory[id] = {};
                Object.keys(variants).forEach(color => {
                    productInventory[id][color] = variants[color].stock;
                });
            }
        }


        // --- 2. GESTIÓN DE STOCK Y ESTADO ---
        let currentProductID = null;
        let currentProductSize = null;
        let currentProductColor = null; 
        let currentQuantity = 1;
        let currentPrice = 0;
        let currentProductName = '';
        
        function getProductData(id) {
            return productData.find(p => p.id === id);
        }

        function getStock(id, color, size) {
            if (!color || !size) return 0; 
            return productInventory[id] && 
                productInventory[id][color] && 
                productInventory[id][color][size] !== undefined ? productInventory[id][color][size] : 0;
        }

        function updateProductBadge(id) {
            const stockElement = document.getElementById(`badge-${id}`);
            if (!stockElement) return;

            let totalStock = 0;
            const colors = Object.keys(productInventory[id] || {});
            colors.forEach(color => {
                const sizes = Object.keys(productInventory[id][color] || {});
                totalStock += sizes.reduce((sum, size) => sum + getStock(id, color, size), 0);
            });

            stockElement.textContent = totalStock > 0 ? `preventa` : 'Agotado'; 
            stockElement.className = 'stock-badge';
            if (totalStock > 0) { 
                stockElement.classList.add('in-stock'); 
            } else {
                stockElement.classList.add('out-stock');
            }
        }
        
        // --- 3. RENDERIZADO DE LA INTERFAZ ---

        function renderProductCards() {
            let html = '';
            productData.forEach(product => {
                // Obtener imagen del primer color ('Default' o 'Negro')
                const firstVariantKey = Object.keys(product.variants)[0];
                const mainImg = product.variants[firstVariantKey].mainImg;

                html += `
                    <div class="col-lg-3 col-md-4 col-sm-6 d-flex">
                        <div class="card product-card flex-fill" data-product-id="${product.id}">
                            <span class="stock-badge" id="badge-${product.id}"></span> 
                            <img src="${mainImg}" class="card-img-top" alt="Playera ${product.name}">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">${product.name}</h5>
                                <p class="card-text text-muted">${product.description.substring(0, 50)}...</p>
                                <div class="mt-auto">
                                    <p class="price mb-2">$${product.price} MXN</p>
                                    <button 
                                        class="btn btn-block btn-buy w-100" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#paymentModal" 
                                        data-product-id="${product.id}"
                                        data-price="${product.price}" 
                                        data-name="${product.name}"
                                        data-description="${product.description}"> 
                                        Ver Detalle y Comprar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            PRODUCT_LIST_CONTAINER.innerHTML = html;
            productData.forEach(product => updateProductBadge(product.id)); 
        }


        // --- 4. GESTIÓN DEL MODAL (Color, Talla, Cantidad) ---

        const paymentModal = document.getElementById('paymentModal');
        const quantityInput = document.getElementById('quantityInput');
        const halfPaymentCheck = document.getElementById('halfPaymentCheck');
        const modalMainButton = document.getElementById('modal-main-button');
        const whatsappButton = document.getElementById('whatsapp-confirm-button');

        function updateModalImages(product, color) {
            const variant = product.variants[color];
            if (variant) {
                document.getElementById('modal-img-front').src = variant.img_front;
                document.getElementById('modal-img-back').src = variant.img_back;
                document.getElementById('modal-img-side').src = variant.img_side;
            }
            // Resetear carrusel a la primera imagen
            const carouselElement = document.getElementById('productCarousel');
            if (carouselElement) {
                const carousel = bootstrap.Carousel.getOrCreateInstance(carouselElement);
                carousel.to(0);
            }
        }
        
        function createColorButtons(product) {
            const colorOptionsDiv = document.getElementById('color-options');
            colorOptionsDiv.innerHTML = '';
            
            Object.keys(product.variants).forEach(color => {
                if (color === 'Default') return; 
                
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'btn btn-outline-secondary me-2 mb-2';
                button.textContent = color;
                button.setAttribute('data-color', color);
                
                button.addEventListener('click', () => {
                    currentProductColor = color;
                    currentProductSize = null; 
                    document.querySelectorAll('#color-options button').forEach(btn => {
                        btn.classList.remove('active', 'btn-danger');
                        btn.classList.add('btn-outline-secondary');
                    });
                    button.classList.add('active', 'btn-danger');
                    button.classList.remove('btn-outline-secondary');
                    
                    updateModalImages(product, color);
                    createSizeButtons(currentProductID, currentProductColor); 
                    updateQuantityStatus(); 
                });
                colorOptionsDiv.appendChild(button);
            });

            // Seleccionar automáticamente el primer color disponible
            const firstColor = Object.keys(product.variants).find(c => c !== 'Default');
            if (firstColor && !currentProductColor) {
                document.querySelector(`#color-options button[data-color="${firstColor}"]`).click();
            }
        }


        function createSizeButtons(id, color) {
            const sizeOptions = document.getElementById('size-options');
            sizeOptions.innerHTML = '';
            document.getElementById('size-status').textContent = 'Selecciona una talla.';

            if (!color || !productInventory[id] || !productInventory[id][color]) {
                sizeOptions.innerHTML = '<p class="text-danger small">Selecciona primero un color.</p>';
                return;
            }
            
            const stockByColor = productInventory[id][color];

            Object.keys(stockByColor).forEach(size => {
                const stock = stockByColor[size];
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'btn btn-outline-secondary me-2 mb-2';
                button.textContent = size;
                button.setAttribute('data-size', size);
                
                if (stock <= 0) {
                    button.disabled = true;
                    button.classList.add('text-danger');
                    button.title = 'Agotado';
                }

                button.addEventListener('click', () => {
                    currentProductSize = size;
                    document.querySelectorAll('#size-options button').forEach(btn => {
                        btn.classList.remove('active', 'btn-danger');
                        btn.classList.add('btn-outline-secondary');
                    });
                    button.classList.add('active', 'btn-danger');
                    button.classList.remove('btn-outline-secondary');
                    updateQuantityStatus();
                    checkModalButtonState();
                });
                sizeOptions.appendChild(button);
            });
        }

        function updateQuantityStatus() {
            const statusElement = document.getElementById('quantity-status');
            const selectedColor = currentProductColor || 'Default';
            
            if (!currentProductSize) {
                statusElement.textContent = "Selecciona una talla.";
                statusElement.classList.remove('text-danger');
                statusElement.classList.add('text-secondary');
                modalMainButton.disabled = true;
                return;
            }

            const stock = getStock(currentProductID, selectedColor, currentProductSize);
            currentQuantity = parseInt(quantityInput.value);

            if (stock <= 0) {
                statusElement.textContent = `Agotado en talla ${currentProductSize}.`;
                statusElement.classList.remove('text-secondary');
                statusElement.classList.add('text-danger');
                quantityInput.max = 0;
                quantityInput.value = 0;
            } else if (currentQuantity > stock) {
                statusElement.textContent = `Solo quedan ${stock} piezas en talla ${currentProductSize}.`;
                statusElement.classList.remove('text-secondary');
                statusElement.classList.add('text-danger');
                quantityInput.max = stock;
                quantityInput.value = stock; 
                currentQuantity = stock;
            } else {
                statusElement.textContent = `Disponible para preventa: ${stock}.`; 
                statusElement.classList.remove('text-danger');
                statusElement.classList.add('text-secondary');
                quantityInput.max = 10; 
            }
            updatePriceDisplays(); 
            checkModalButtonState();
        }

        function updatePriceDisplays() {
            const isHalfPayment = halfPaymentCheck.checked;
            const total = currentPrice * currentQuantity;
            const paymentDue = isHalfPayment ? total / 2 : total;

            document.getElementById('total-price').textContent = `$${total.toFixed(2)} MXN`;
            document.getElementById('payment-due').textContent = `$${paymentDue.toFixed(2)} MXN`;
        }

        function checkModalButtonState() {
            const selectedColor = currentProductColor || 'Default';
            const stock = getStock(currentProductID, selectedColor, currentProductSize);
            const canProceed = currentProductSize !== null && currentQuantity > 0 && stock >= currentQuantity;
            modalMainButton.disabled = !canProceed;
        }

        // Eventos en el Modal
        paymentModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            
            // 1. Cargar datos del producto
            currentProductID = button.getAttribute('data-product-id');
            const product = getProductData(currentProductID);
            currentProductName = product.name;
            currentPrice = parseFloat(product.price); 
            
            document.getElementById('product-name').textContent = currentProductName;
            document.getElementById('product-description').textContent = product.description;
            
            // 2. Resetear la vista y el estado
            resetModalView();

            // 3. Manejo de Color (Modelos 43 y 44)
            const colorContainer = document.getElementById('color-selection-container');
            if (Object.keys(product.variants).length > 1) {
                colorContainer.style.display = 'block';
                createColorButtons(product);
            } else {
                // Producto de un solo color ('Default')
                colorContainer.style.display = 'none';
                currentProductColor = 'Default';
                updateModalImages(product, 'Default');
                createSizeButtons(currentProductID, 'Default');
            }
            
            updatePriceDisplays();
        });

        quantityInput.addEventListener('input', () => {
            if (currentProductID) {
                updateQuantityStatus();
            }
        });

        halfPaymentCheck.addEventListener('change', updatePriceDisplays);


        // --- 5. LÓGICA DE FLUJO DE COMPRA ---

        modalMainButton.addEventListener('click', () => {
            if (modalMainButton.textContent === 'Pagar Ahora') {
                // Paso 1: Pasar a la captura de datos
                document.getElementById('selection-step').style.display = 'none';
                document.getElementById('payment-step').style.display = 'block';

                const total = currentPrice * currentQuantity;
                const paymentDue = halfPaymentCheck.checked ? total / 2 : total;

                document.getElementById('final-quantity-display').textContent = currentQuantity;
                document.getElementById('final-size-display').textContent = currentProductSize;
                document.getElementById('final-price-display').textContent = `$${paymentDue.toFixed(2)} MXN`;
                
                modalMainButton.textContent = 'Confirmar Pedido';
                modalMainButton.disabled = false; 

            } else if (modalMainButton.textContent === 'Confirmar Pedido') {
                // Paso 2: Validar datos y generar orden

                const name = document.getElementById('clientName').value.trim();
                const phone = document.getElementById('clientPhone').value.trim();
                const address = document.getElementById('clientAddress').value.trim();

                if (name === '' || phone === '' || address === '') {
                    document.getElementById('payment-error').style.display = 'block';
                    return;
                }
                document.getElementById('payment-error').style.display = 'none';

                // Generar Pedido (Lógica de inventario)
                generateOrder(name, phone, address);
            }
        });


        // --- 6. GESTIÓN DE ORDEN E INVENTARIO PERSISTENTE ---
        const PENDING_ORDERS = JSON.parse(localStorage.getItem('RPLAY_PENDING_ORDERS')) || [];
        const INVENTORY_STORAGE = JSON.parse(localStorage.getItem('RPLAY_INVENTORY')) || {};

        function loadInventoryStorage() {
            // Cargar stock almacenado, respetando la estructura [id][color][size]
             Object.keys(INVENTORY_STORAGE).forEach(productId => {
                if (productInventory[productId]) {
                    Object.keys(INVENTORY_STORAGE[productId]).forEach(color => {
                        if (productInventory[productId][color]) {
                            Object.keys(INVENTORY_STORAGE[productId][color]).forEach(size => {
                                productInventory[productId][color][size] = INVENTORY_STORAGE[productId][color][size];
                            });
                        }
                    });
                }
            });
        }
        
        // Función para descontar stock (se usa después de que el cliente finaliza la compra por WhatsApp)
        function applyStockReduction(order) {
            if (productInventory[order.productID] && productInventory[order.productID][order.color] && productInventory[order.productID][order.color][order.size] !== undefined) {
                productInventory[order.productID][order.color][order.size] -= order.quantity;
                localStorage.setItem('RPLAY_INVENTORY', JSON.stringify(productInventory));
                updateProductBadge(order.productID);
            }
        }

        function generateOrder(name, phone, address) {
            const orderID = Date.now();
            const total = currentPrice * currentQuantity;
            const paymentDue = halfPaymentCheck.checked ? total / 2 : total;
            const selectedColor = currentProductColor || 'Default';

            const order = {
                id: orderID,
                productID: currentProductID,
                productName: currentProductName,
                color: selectedColor, 
                size: currentProductSize,
                quantity: currentQuantity,
                totalPrice: total,
                paymentDue: paymentDue,
                isHalfPayment: halfPaymentCheck.checked,
                clientName: name,
                clientPhone: phone,
                clientAddress: address,
                timestamp: Date.now(),
                expiration: Date.now() + (24 * 60 * 60 * 1000)
            };

            // 1. Guardar la orden pendiente
            PENDING_ORDERS.push(order);
            localStorage.setItem('RPLAY_PENDING_ORDERS', JSON.stringify(PENDING_ORDERS));
            
            // 2. Mostrar info de transferencia y WhatsApp
            showTransferInfo(order);
        }

        function showTransferInfo(order) {
            document.getElementById('payment-step').style.display = 'none';
            document.getElementById('transfer-info').style.display = 'block';

            const colorDisplay = order.color !== 'Default' ? order.color : 'Color Único';

            document.getElementById('client-name-display').textContent = order.clientName;
            document.getElementById('final-item-display').textContent = `${order.productName} (${colorDisplay})`;
            document.getElementById('final-qty-conf').textContent = order.quantity;
            document.getElementById('final-size-conf').textContent = order.size;
            document.getElementById('final-amount-conf').textContent = `$${order.paymentDue.toFixed(2)} MXN`;

            // Botón de WhatsApp
            const message = `¡Hola! Acabo de generar un pedido de playeras RPLAY (#${order.id}).\n\n- Producto: ${order.productName}\n- Color: ${colorDisplay}\n- Talla: ${order.size}\n- Cantidad: ${order.quantity}\n- Monto pagado/apartado: $${order.paymentDue.toFixed(2)} MXN.\n- Mi nombre es: ${order.clientName}\n- Mi dirección es: ${order.clientAddress}`;
            
            const phoneNumber = WHATSAPP_NUMBER; 

            whatsappButton.href = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            whatsappButton.setAttribute('data-order-id', order.id);
            // Mostrar WhatsApp, ocultar el botón principal
            whatsappButton.style.display = 'block';
            modalMainButton.style.display = 'none';
            document.getElementById('modal-close-button').textContent = 'Cerrar';
        }


        // --- 7. FUNCIONES DE ADMINISTRACIÓN Y RESET ---

        window.releaseStock = (orderId, productId, color, size, quantity) => {
             // 1. Devolver el stock
            if (productInventory[productId] && productInventory[productId][color] && productInventory[productId][color][size] !== undefined) {
                productInventory[productId][color][size] += quantity;
                localStorage.setItem('RPLAY_INVENTORY', JSON.stringify(productInventory));
                updateProductBadge(productId);
            }
           
            // 2. Remover la orden
            const index = PENDING_ORDERS.findIndex(order => order.id === orderId);
            if (index > -1) {
                PENDING_ORDERS.splice(index, 1);
                localStorage.setItem('RPLAY_PENDING_ORDERS', JSON.stringify(PENDING_ORDERS));
            }
        }
        
        window.setStock = (id, color, size, count) => {
             if (productInventory[id] && productInventory[id][color] && productInventory[id][color][size] !== undefined) {
                productInventory[id][color][size] = count;
                localStorage.setItem('RPLAY_INVENTORY', JSON.stringify(productInventory));
                updateProductBadge(id);
             } else {
                 console.error(`Error: El producto ${id} con color ${color} y talla ${size} no existe.`);
             }
        }

        window.resetAllStock = () => {
            if (confirm("ADVERTENCIA: ¿Estás seguro de que quieres REINICIAR TODO EL INVENTARIO A SU ESTADO INICIAL? Esto borra el stock y todas las órdenes pendientes.")) {
                localStorage.removeItem('RPLAY_INVENTORY');
                localStorage.removeItem('RPLAY_PENDING_ORDERS');
                window.location.reload();
            }
        }

        function resetModalView() {
            document.getElementById('selection-step').style.display = 'block';
            document.getElementById('payment-step').style.display = 'none';
            document.getElementById('transfer-info').style.display = 'none';
            document.getElementById('payment-error').style.display = 'none';
            document.getElementById('clientName').value = '';
            document.getElementById('clientPhone').value = '';
            document.getElementById('clientAddress').value = '';
            quantityInput.value = 1;

            currentProductSize = null;
            currentProductColor = null; 
            currentQuantity = 1;
            modalMainButton.textContent = 'Pagar Ahora';
            modalMainButton.disabled = true;
            whatsappButton.style.display = 'none';
            modalMainButton.style.display = 'block';
            document.getElementById('modal-close-button').textContent = 'Cerrar';
            whatsappButton.removeAttribute('data-stock-applied');
        }
        
        // --- 8. LISTENER PARA DESCONTAR STOCK AL ENVIAR WHATSAPP ---
        document.addEventListener('DOMContentLoaded', () => {
            const whatsappButton = document.getElementById('whatsapp-confirm-button');

            if (whatsappButton) {
                whatsappButton.addEventListener('click', (event) => {
                    
                    // Solo descontar stock si no se ha hecho antes
                    if (whatsappButton.getAttribute('data-stock-applied') !== 'true') {
                        
                        const orderIdToApply = parseInt(whatsappButton.getAttribute('data-order-id'));
                        const order = PENDING_ORDERS.find(o => o.id === orderIdToApply);
                        
                        if (order) {
                            applyStockReduction(order);
                            whatsappButton.setAttribute('data-stock-applied', 'true');
                        }
                    }
                });
            }
        });
        
        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            generateInitialInventory();
            loadInventoryStorage();
            renderProductCards();
        });

    </script>
</body>
</html>


