<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPLAY - Preventa Exclusiva</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- ESTILOS GENERALES Y MODERNOS --- */
        :root {
            --primary-color: #d63384; /* Rosa fuerte */
            --secondary-color: #343a40; 
            --accent-color: #ffc107; /* Amarillo para advertencias */
        }
        body { background-color: #f4f7f6; font-family: 'Arial', sans-serif; }
        .container { margin-top: 30px; }
        h1 { color: var(--secondary-color); font-weight: 700; margin-bottom: 40px; }
        
        /* --- TARJETA DE PRODUCTO --- */
        .product-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 8px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s, box-shadow 0.3s;
            overflow: hidden;
            position: relative;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 25px rgba(0,0,0,0.15);
        }
        .product-card img {
            height: 320px;
            width: 100%;
            object-fit: cover;
            border-bottom: 1px solid #eee;
            background-color: #fff;
        }
        .btn-buy {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .btn-buy:hover {
            background-color: #b82b71;
            border-color: #b82b71;
            color: white;
        }

        /* --- BADGES Y STOCK --- */
        .stock-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 5px 10px;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: bold;
            z-index: 10;
        }
        .stock-badge.agotado { background-color: #dc3545; color: white; animation: pulse 1.5s infinite; }
        .stock-badge.ultima { background-color: var(--accent-color); color: var(--secondary-color); }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* --- MODAL Y SELECCI√ìN DE TALLAS --- */
        .modal-header, .modal-footer { border: none; }
        .size-options .size-btn {
            cursor: pointer;
            padding: 8px 16px;
            margin: 4px;
            border: 2px solid #ccc;
            border-radius: 5px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .size-options .size-btn:not(.disabled):hover { border-color: var(--primary-color); }
        .size-options .size-btn.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .size-options .size-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            text-decoration: line-through;
        }

        /* --- ESTILOS DE CARRUSEL (CORRECCI√ìN CR√çTICA) --- */
        #productCarousel {
            height: 400px; 
            overflow: hidden; 
            border-radius: 10px;
            background-color: #fff;
        }
        #productCarousel .carousel-inner { height: 100%; }
        #productCarousel .carousel-item {
            height: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        #productCarousel .carousel-item img {
            max-width: 100%;  
            max-height: 100%;     
            width: auto;
            height: auto;
            object-fit: contain; 
            padding: 5px; 
            display: block;
        }
        /* Corregir el color de las flechas en el carrusel */
        .carousel-control-prev-icon, .carousel-control-next-icon {
            filter: invert(100%); /* Hace las flechas visibles en cualquier fondo */
        }
    </style>
</head>
<body>

    <div class="container">
        <h1 class="text-center">üî• RPLAY - Preventa Exclusiva üî•</h1>
        
        <div id="manualManagementPanel" class="p-3 mb-4 rounded" style="display: none; background-color: #fff3cd; border: 1px solid #ffeeba;">
            <h4 class="text-warning"><i class="fas fa-exclamation-triangle"></i> Panel de Administraci√≥n - INVENTARIO</h4>
            <div id="ordersList" class="my-3"></div>
            <button class="btn btn-sm btn-danger w-100 mt-2" onclick="resetAllStock()">
                <i class="fas fa-trash-restore-alt"></i> Borrar TODAS las Reservas y Restaurar Inventario
            </button>
        </div>

        <div class="row" id="product-list">
            </div>
    </div>

    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalLabel"><span id="product-name"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
                                <div class="carousel-indicators">
                                    <button type="button" data-bs-target="#productCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1 (Frente)"></button>
                                    <button type="button" data-bs-target="#productCarousel" data-bs-slide-to="1" aria-label="Slide 2 (Reverso)"></button>
                                    <button type="button" data-bs-target="#productCarousel" data-bs-slide-to="2" aria-label="Slide 3 (Tallas)"></button> 
                                </div>
                                <div class="carousel-inner">
                                    <div class="carousel-item active"><img id="modal-img-front" class="d-block w-100" alt="Vista Frontal"></div>
                                    <div class="carousel-item"><img id="modal-img-back" class="d-block w-100" alt="Vista Trasera"></div>
                                    <div class="carousel-item"><img id="modal-img-size-guide" class="d-block w-100" alt="Gu√≠a de Tallas"></div>
                                </div>
                                <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Anterior</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Siguiente</span>
                                </button>
                            </div>
                            </div>

                        <div class="col-md-6">
                            <p class="text-muted" id="product-description"></p>
                            
                            <div id="selection-step">
                                <h6 class="mt-4">1. Elige tu Talla</h6>
                                <div id="size-options" class="d-flex flex-wrap"></div>
                                <p id="size-status" class="mt-2 text-danger"></p>
                                
                                <h6 class="mt-3">2. Cantidad</h6>
                                <input type="number" id="quantityInput" class="form-control mb-2" value="1" min="1" disabled>
                                <p id="quantity-status" class="text-secondary small"></p>

                                <hr>
                                <div class="d-flex justify-content-between align-items-center">
                                    <strong>Precio por unidad:</strong>
                                    <strong class="text-primary" id="unit-price-display"></strong>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <strong>TOTAL:</strong>
                                    <strong class="text-success fs-4" id="total-price">$0.00 MXN</strong>
                                </div>
                            </div>
                            
                            <div id="payment-step" style="display: none;">
                                <h6>3. Datos de Env√≠o y Contacto</h6>
                                <div class="mb-3">
                                    <input type="text" id="clientName" class="form-control" placeholder="Nombre completo (Min. 3 caracteres)">
                                </div>
                                <div class="mb-3">
                                    <input type="tel" id="clientPhone" class="form-control" placeholder="Tel√©fono de contacto (Min. 8 d√≠gitos)">
                                </div>
                                <div class="mb-3">
                                    <textarea id="clientAddress" class="form-control" rows="2" placeholder="Direcci√≥n completa para env√≠o (Min. 10 caracteres)"></textarea>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" value="" id="halfPaymentCheck">
                                    <label class="form-check-label" for="halfPaymentCheck">
                                        Pagar solo el 50% para apartar stock
                                    </label>
                                </div>
                                
                                <p class="alert alert-danger p-2" id="payment-error" style="display: none;">
                                    ‚ö†Ô∏è Por favor, completa todos los campos de contacto.
                                </p>

                                <hr>
                                <p class="mb-1">Producto: <strong id="final-item-display2"></strong></p>
                                <p class="mb-1">Talla: <strong id="final-size-display"></strong>, Cantidad: <strong id="final-quantity-display"></strong></p>
                                <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded">
                                    <strong>Monto a pagar (Apartado/Total):</strong>
                                    <strong class="text-primary fs-4" id="payment-due">$0.00 MXN</strong>
                                </div>
                            </div>
                            
                            <div id="transfer-info" style="display: none;">
                                <div class="alert alert-success text-center">
                                    <h4>üéâ ¬°Pedido Generado!</h4>
                                    <p>Tu stock est√° temporalmente apartado, <strong id="client-name-display"></strong>.</p>
                                </div>
                                <p class="mb-1">Confirma tu pedido de <strong id="final-qty-conf"></strong>x <strong id="final-item-display"></strong> (Talla <strong id="final-size-conf"></strong>).</p>
                                <p class="mb-1 fw-bold">Monto a Enviar: <span id="final-amount-conf" class="text-primary"></span></p>
                                
                                <hr>
                                <h6>Datos de Transferencia:</h6>
                                <p><strong>Banco:</strong> B*N*M*X</p>
                                <p><strong>Cuenta CLABE:</strong> 9999999999999999</p>
                                
                                <p class="mt-3">Realiza la transferencia y da clic en el bot√≥n de WhatsApp para adjuntar tu comprobante y completar tu reserva.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer d-flex justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-lg btn-buy" id="modal-main-button">Pagar Ahora</button>
                    
                    <a href="#" target="_blank" class="btn btn-lg btn-success" id="whatsapp-confirm-button" style="display: none;">
                        <i class="fab fa-whatsapp"></i> Enviar Comprobante y Confirmar
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- 1. DATOS INICIALES (Simulados) ---
        const FIXED_PRICE = 280.00;
        const productData = [];
        
        // Inventario base (se utiliza para calcular el stock disponible)
        const productInventory = {}; 

        // Definici√≥n de las tallas y stock inicial para TODOS los productos por defecto (si no se anula)
        const DEFAULT_SIZES = ['S', 'M', 'L', 'XL'];
        const DEFAULT_STOCK = 5; 

        // Funci√≥n para inicializar el inventario
        function initializeInventory(productID, sizes, initialStockOverrides = {}) {
            productInventory[productID] = {};
            sizes.forEach(size => {
                productInventory[productID][size] = initialStockOverrides[size] !== undefined ? initialStockOverrides[size] : DEFAULT_STOCK;
            });
        }

        for (let i = 1; i <= 3; i++) {
            let id = `PROD_00${i}`;
            let mainImg, frontImg, backImg, sizeGuideImg;
            let modelSizes = DEFAULT_SIZES;
            let initialStockOverrides = {};

            // Im√°genes de placeholder por defecto
            mainImg = `https://via.placeholder.com/250x250/F8F8F8?text=Frente+${i}`;
            frontImg = `https://via.placeholder.com/500x500/F8F8F8?text=Frente+${i}`;
            backImg = `https://via.placeholder.com/500x500/F8F8F8?text=Espalda+${i}`;
            sizeGuideImg = `https://via.placeholder.com/500x500/CCCCCC?text=GUIA+DE+TALLAS`;

            // --- L√≥gica para configurar tallas y stock por modelo (Ejemplos) ---
            if (i === 1) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Xime1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Xime1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Xime2.png';
                sizeGuideImg = 'https://ventaplayera.github.io/RPLAY/blanco.png'; // Gu√≠a de tallas espec√≠fica
                modelSizes = ['M', 'L', 'XL']; 
                initialStockOverrides.M = 1; 
                initialStockOverrides.L = 1; 
                initialStockOverrides.XL = 1; 
            } else if (i === 2) {
                // Modelo 2: Im√°genes gen√©ricas con stock limitado en 'S'
                modelSizes = ['S', 'M', 'L'];
                initialStockOverrides.S = 2;
                initialStockOverrides.M = 5;
                initialStockOverrides.L = 5;
            }
            // --- Fin de la L√≥gica por modelo ---

            initializeInventory(id, modelSizes, initialStockOverrides);

            productData.push({
                id: id,
                name: `Playera Modelo No. ${i}`,
                price: FIXED_PRICE.toFixed(2), 
                description: `Dise√±o exclusivo #${i} con estampado digital de alta calidad. Tela de algod√≥n 100%.`,
                img_main: mainImg,
                img_front: frontImg,
                img_back: backImg,
                img_size_guide: sizeGuideImg // <-- NUEVO CAMPO A PASAR AL MODAL
            });
        }
        
        // --- 2. INVENTARIO PERSISTENTE (Pedidos Confirmados) ---
        let localOrders = JSON.parse(localStorage.getItem('simulatedOrders')) || {};
        
        // --- 3. L√≥gica del Sistema ---
        document.addEventListener('DOMContentLoaded', function () {
            
            // --- REFERENCIAS A ELEMENTOS HTML ---
            const productListContainer = document.getElementById('product-list');
            const paymentModal = document.getElementById('paymentModal');
            const selectionStep = document.getElementById('selection-step');
            const paymentStep = document.getElementById('payment-step');
            const transferInfo = document.getElementById('transfer-info');
            const sizeOptionsContainer = document.getElementById('size-options');
            const halfPaymentCheck = document.getElementById('halfPaymentCheck');
            const clientNameInput = document.getElementById('clientName');
            const clientPhoneInput = document.getElementById('clientPhone');
            const clientAddressInput = document.getElementById('clientAddress');
            const mainButton = document.getElementById('modal-main-button');
            const whatsappButton = document.getElementById('whatsapp-confirm-button'); 
            const ordersList = document.getElementById('ordersList'); 
            const sizeStatusEl = document.getElementById('size-status'); 
            const quantityInput = document.getElementById('quantityInput');
            const quantityStatusEl = document.getElementById('quantity-status');
            const unitPriceDisplay = document.getElementById('unit-price-display');
            const managementPanel = document.getElementById('manualManagementPanel');

            // Variables de estado
            let currentPrice = FIXED_PRICE;
            let currentSelectedSize = null;
            let currentProductName = '';
            let currentProductID = ''; 
            const WHATSAPP_PHONE = "529991480151"; 
            
            // --- Funciones de L√≥gica ---
            
            function saveLocalOrders() {
                localStorage.setItem('simulatedOrders', JSON.stringify(localOrders));
                if (managementPanel.style.display === 'block') {
                    renderManualManagementPanel(); 
                }
            }

            function getAvailableStock(productID, size) {
                const stock = productInventory[productID] && productInventory[productID][size] !== undefined ? productInventory[productID][size] : 0;
                const pendingOrders = localOrders[`${productID}-${size}`] || 0; 
                return stock - pendingOrders;
            }
            
            window.setStock = function(productID, size, newStock) {
                if (productInventory[productID] && productInventory[productID][size] !== undefined) {
                    productInventory[productID][size] = Math.max(0, newStock); 
                    initializeBadges();
                    if (currentProductID === productID) {
                        createSizeButtons(currentProductID);
                        resetModalView();
                    }
                    console.log(`‚úÖ Stock inicial modificado: ${productID}, Talla ${size}. Nuevo Stock: ${productInventory[productID][size]}`);
                    alert(`Stock de ${productID} (Talla ${size}) cambiado a ${newStock}.`);
                } else {
                    console.error(`Error: Producto ID '${productID}' o Talla '${size}' no encontrados.`);
                    alert(`Error: Producto ID '${productID}' o Talla '${size}' no encontrados.`);
                }
            };
            
            // DIBUJAR TARJETAS DE PRODUCTO DIN√ÅMICAMENTE
            function renderProductCards() {
                let html = '';
                productData.forEach(product => {
                    html += `
                        <div class="col-lg-3 col-md-4 col-sm-6 d-flex">
                            <div class="card product-card flex-fill" data-product-id="${product.id}">
                                <span class="stock-badge" id="badge-${product.id}"></span> 
                                <img src="${product.img_main}" class="card-img-top" alt="Playera ${product.name}">
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title">${product.name}</h5>
                                    <p class="card-text text-muted">${product.description.substring(0, 50)}...</p>
                                    <div class="mt-auto">
                                        <p class="price mb-2">$${product.price} MXN</p>
                                        <button 
                                            class="btn btn-block btn-buy w-100" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#paymentModal" 
                                            data-product-id="${product.id}"
                                            data-price="${product.price}" 
                                            data-name="${product.name}"
                                            data-description="${product.description}"
                                            data-img-front="${product.img_front}" 
                                            data-img-back="${product.img_back}"
                                            data-size-guide="${product.img_size_guide}"> Ver Detalle y Comprar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                productListContainer.innerHTML = html;
            }

            // FUNCI√ìN: Actualiza el badge de stock en la tarjeta principal
            function updateProductBadge(productID) {
                const badgeEl = document.getElementById(`badge-${productID}`);
                if (!badgeEl) return;
                
                let totalStock = 0;
                let isLastUnit = false;

                if (productInventory[productID]) {
                    Object.keys(productInventory[productID]).forEach(size => {
                        const available = getAvailableStock(productID, size);
                        totalStock += available;
                        if (available === 1) isLastUnit = true;
                    });
                }

                badgeEl.textContent = '';
                badgeEl.className = 'stock-badge';

                if (totalStock === 0) {
                    badgeEl.textContent = 'AGOTADO';
                    badgeEl.classList.add('agotado');
                } else if (isLastUnit || totalStock <= 5) { 
                    badgeEl.textContent = '¬°POCAS UNIDADES!';
                    badgeEl.classList.add('ultima');
                }
            }

            function initializeBadges() {
                productData.forEach(product => updateProductBadge(product.id));
            }
            
            // FUNCI√ìN: Renderiza los botones de talla y maneja stock
            function createSizeButtons(productID) {
                if (!sizeOptionsContainer) return;
                const sizes = productInventory[productID] ? Object.keys(productInventory[productID]) : [];
                sizeOptionsContainer.innerHTML = ''; 
                currentSelectedSize = null; 
                sizeStatusEl.textContent = '';
                mainButton.disabled = true;
                
                quantityInput.disabled = true;
                quantityInput.value = 1;
                quantityStatusEl.textContent = 'Selecciona una talla para continuar.';


                sizes.forEach(size => {
                    const availableStock = getAvailableStock(productID, size); 
                    const button = document.createElement('span');
                    button.textContent = size;
                    button.classList.add('size-btn');
                    button.setAttribute('data-size', size);
                    
                    if (availableStock <= 0) {
                        button.classList.add('disabled');
                        button.title = 'Talla Agotada';
                        button.textContent = `${size} (Agotada)`; 
                    } else {
                        if (availableStock === 1) {
                            button.title = '¬°√öltima Unidad!';
                        }
                        button.addEventListener('click', () => handleSizeSelection(button, size, availableStock));
                    }
                    sizeOptionsContainer.appendChild(button);
                });
            }

            function handleSizeSelection(selectedButton, size, stock) {
                document.querySelectorAll('.size-btn').forEach(btn => btn.classList.remove('selected'));
                selectedButton.classList.add('selected');
                
                currentSelectedSize = size;
                mainButton.disabled = false;
                mainButton.textContent = 'Continuar a Pago';

                // L√ìGICA DE CANTIDAD
                quantityInput.max = stock; 
                quantityInput.value = 1; 
                quantityInput.disabled = (stock <= 1); 

                quantityStatusEl.textContent = `Puedes seleccionar hasta ${stock} unidad${stock !== 1 ? 'es' : ''}.`;
                
                sizeStatusEl.style.display = 'block';
                if (stock === 1) {
                    sizeStatusEl.textContent = '¬°Solo queda 1 unidad! ¬°Ap√∫rate!';
                    sizeStatusEl.className = 'text-danger mt-2';
                } else if (stock <= 3) {
                    sizeStatusEl.textContent = `Quedan ${stock} unidades.`;
                    sizeStatusEl.className = 'text-warning mt-2';
                } else {
                    sizeStatusEl.textContent = `Stock disponible: ${stock} unidades.`;
                    sizeStatusEl.className = 'text-secondary mt-2';
                }
                
                updatePaymentAmounts();
            }
            
            function resetModalView() {
                selectionStep.style.display = 'block';
                paymentStep.style.display = 'none';
                transferInfo.style.display = 'none';
                mainButton.textContent = 'Continuar a Pago';
                mainButton.disabled = true;
                document.getElementById('payment-error').style.display = 'none';
                whatsappButton.style.display = 'none'; 
                sizeStatusEl.style.display = 'none'; 
                quantityInput.value = 1;
            }
            
            function saveClientData() {
                const data = {
                    name: clientNameInput.value,
                    phone: clientPhoneInput.value,
                    address: clientAddressInput.value
                };
                localStorage.setItem('clientFormData', JSON.stringify(data));
            }

            function loadClientData() {
                const data = JSON.parse(localStorage.getItem('clientFormData'));
                if (data) {
                    clientNameInput.value = data.name || '';
                    clientPhoneInput.value = data.phone || '';
                    clientAddressInput.value = data.address || '';
                }
            }
            
            window.releaseOrder = function(orderKey) { /* ... funci√≥n de liberaci√≥n de stock ... */ };
            window.resetAllStock = function() { /* ... funci√≥n de reinicio total ... */ };
            function renderManualManagementPanel() { /* ... funci√≥n de panel de admin ... */ };


            // --- EVENTO PRINCIPAL: FLUJO DE COMPRA ---
            mainButton.addEventListener('click', () => {
                const currentButtonText = mainButton.textContent;
                const quantity = parseInt(quantityInput.value) || 1;
                
                if (currentButtonText === 'Continuar a Pago') {
                    if (!currentSelectedSize) {
                        alert('Por favor, selecciona una talla.');
                        return;
                    }
                    if (quantity < 1 || quantity > getAvailableStock(currentProductID, currentSelectedSize)) {
                        alert('La cantidad excede el stock disponible o es inv√°lida. Por favor, revisa.');
                        return;
                    }
                    
                    selectionStep.style.display = 'none';
                    paymentStep.style.display = 'block';
                    mainButton.textContent = 'Generar Pedido';
                    
                    document.getElementById('final-size-display').textContent = currentSelectedSize;
                    document.getElementById('final-quantity-display').textContent = quantity;
                    document.getElementById('final-item-display2').textContent = currentProductName;
                    
                    loadClientData();
                    
                } else if (currentButtonText === 'Generar Pedido') {
                    
                    const clientName = clientNameInput.value.trim();
                    const clientPhone = clientPhoneInput.value.trim();
                    const clientAddress = clientAddressInput.value.trim();
                    
                    if (clientName.length < 3 || clientPhone.length < 8 || clientAddress.length < 10) {
                        document.getElementById('payment-error').style.display = 'block';
                        return;
                    }
                    
                    saveClientData();
                    
                    if (quantity > getAvailableStock(currentProductID, currentSelectedSize)) {
                        alert('¬°Lo sentimos! La cantidad solicitada excede el stock disponible. El stock fue liberado mientras comprabas.');
                        resetModalView();
                        createSizeButtons(currentProductID);
                        initializeBadges();
                        return;
                    }

                    const amountToPay = document.getElementById('payment-due').textContent; // Obtener el monto del resumen
                    
                    const message = `Hola, acabo de generar un pedido:
*Cliente:* ${clientName}
*Producto:* ${currentProductName} (${quantity} piezas, Talla: ${currentSelectedSize})
*Monto a pagar:* ${amountToPay}
*Tel√©fono de contacto:* ${clientPhone}
*Direcci√≥n:* ${clientAddress}
Por favor, conf√≠rmame los datos. Adjunto el comprobante de pago.`;
                    
                    const encodedMessage = encodeURIComponent(message);
                    const whatsappLink = `https://wa.me/${WHATSAPP_PHONE}?text=${encodedMessage}`;
                    whatsappButton.href = whatsappLink;

                    document.getElementById('payment-error').style.display = 'none';
                    paymentStep.style.display = 'none';
                    transferInfo.style.display = 'block';
                    mainButton.style.display = 'none'; 
                    whatsappButton.style.display = 'inline-block'; 

                    document.getElementById('client-name-display').textContent = clientName;
                    document.getElementById('final-size-conf').textContent = currentSelectedSize;
                    document.getElementById('final-qty-conf').textContent = quantity; 
                    document.getElementById('final-item-display').textContent = currentProductName;
                    document.getElementById('final-amount-conf').textContent = amountToPay;
                }
            });

            // --- EVENTO CRUCIAL: DESCUENTO DE INVENTARIO AL ENVIAR WHATSAPP ---
            whatsappButton.addEventListener('click', function(e) {
                if (transferInfo.style.display === 'block' && currentProductID && currentSelectedSize) {
                    const sizeKey = `${currentProductID}-${currentSelectedSize}`;
                    const quantityToApart = parseInt(quantityInput.value); 
                    
                    // Aumenta el contador de "apartados" por la cantidad elegida
                    localOrders[sizeKey] = (localOrders[sizeKey] || 0) + quantityToApart; 
                    saveLocalOrders(); 
                    
                    // Refresca la vista
                    createSizeButtons(currentProductID);
                    initializeBadges();
                } 
                // Permite que el enlace de WhatsApp se abra
            });
            
            // L√≥gica de Modal (Apertura y cierres)
            paymentModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget; 
                currentProductID = button.getAttribute('data-product-id');
                currentPrice = parseFloat(button.getAttribute('data-price'));
                currentProductName = button.getAttribute('data-name');
                
                // OBTENER IM√ÅGENES
                const imgFront = button.getAttribute('data-img-front');
                const imgBack = button.getAttribute('data-img-back');
                const sizeGuide = button.getAttribute('data-size-guide');
                
                document.getElementById('product-name').textContent = currentProductName;
                document.getElementById('product-description').textContent = button.getAttribute('data-description');
                unitPriceDisplay.textContent = `$${currentPrice.toFixed(2)} MXN`;

                // CARGA DE IM√ÅGENES EN EL CARRUSEL (3 Slides)
                document.getElementById('modal-img-front').src = imgFront;
                document.getElementById('modal-img-back').src = imgBack;
                document.getElementById('modal-img-size-guide').src = sizeGuide; // <-- TERCERA IMAGEN

                // Asegurar que el carrusel inicie en la primera slide
                const carousel = new bootstrap.Carousel(document.getElementById('productCarousel'));
                carousel.to(0);

                resetModalView(); 
                document.getElementById('modal-main-button').style.display = 'inline-block';
                
                createSizeButtons(currentProductID);
                updatePaymentAmounts();
            });

            // Evento para actualizar montos cuando se cambia la cantidad o el check de mitad de pago
            quantityInput.addEventListener('input', updatePaymentAmounts);
            halfPaymentCheck.addEventListener('change', updatePaymentAmounts);
            
            function updatePaymentAmounts() {
                const dueDisplay = document.getElementById('payment-due');
                const totalPriceDisplay = document.getElementById('total-price');
                
                const quantity = parseInt(quantityInput.value) || 1; 

                // Validaci√≥n de cantidad
                const maxStock = parseInt(quantityInput.max);
                if (quantity > maxStock) {
                    quantityInput.value = maxStock;
                    return updatePaymentAmounts(); 
                } else if (quantity < 1) {
                    quantityInput.value = 1;
                    return updatePaymentAmounts(); 
                }
                
                const total = currentPrice * quantity;
                
                totalPriceDisplay.textContent = `$${total.toFixed(2)} MXN`; 

                let amountDue = total;
                if (halfPaymentCheck.checked) {
                    amountDue = total / 2;
                }
                
                dueDisplay.textContent = `$${amountDue.toFixed(2)} MXN`;
            }
            
            window.showAdminPanel = function() { /* ... funci√≥n de admin ... */ };
            
            // üí° INICIALIZACI√ìN FINAL
            renderProductCards();
            initializeBadges();
        });
    </script>
</body>
</html>
