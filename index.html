<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPLAY - Venta de Playeras</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .product-card {
            border: 1px solid #ddd;
            transition: transform 0.2s;
            margin-bottom: 20px;
        }
        .product-card:hover {
            transform: translateY(-5px);
        }
        .btn-buy {
            background-color: #ff3366;
            color: white;
            border: none;
        }
        .btn-buy:hover {
            background-color: #e6004b;
            color: white;
        }
        .stock-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            color: white;
            z-index: 10;
        }
        .stock-badge.in-stock { background-color: green; } /* Usado para "Preventa" */
        .stock-badge.out-stock { background-color: red; } /* Usado para "Agotado" */

        /* --- IMAGEN DEL MODAL --- */
        .modal-image {
            object-fit: contain; 
            height: 450px;       
            width: 100%;         
            display: block;      
            background-color: #f0f0f0; 
        }
        /* Estilos para el panel de administración */
        .order-item {
            border: 1px solid #dee2e6;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>

    <div class="container my-5">
        
        <div class="d-flex align-items-center justify-content-center mb-5">
            <img src="https://imgur.com/mpCQaZg.jpg" alt="Logo de mi tienda" style="max-width: 250px; height: auto;">
        </div>
        <h1 class="text-center mb-5" style="color: #ff3366;">RPLAY</h1>
        
        <div class="container mb-5" id="manualManagementPanel" style="display:none;">
            <h3 class="text-danger mb-3">Administración de Pedidos Apartados</h3>
            <p class="text-muted small">Estos pedidos han sido **reservados temporalmente** (se restó del stock al cliente ver la ficha de pago). Haz clic en "Liberar Stock" si el cliente NO completó el pago.</p>
            <div id="ordersList" class="p-3 border rounded bg-white">
                <p class="text-center text-secondary" id="noOrdersMessage">No hay pedidos pendientes actualmente.</p>
            </div>
            <hr>
            <button class="btn btn-sm btn-outline-danger" onclick="resetAllStock()">REINICIAR TODO EL INVENTARIO Y ÓRDENES</button>
            <p class="text-muted small mt-2">
                Para *modificar el stock inicial*, usa la función **setStock** en la consola (F12).
                <br>Ejemplo: **setStock('PROD_001', 'Default', 'M', 5)**
                <br>Para **mostrar** este panel, usa la función **showAdminPanel()** en la consola.
            </p>
        </div>
        
        <div class="row" id="product-list">
        </div>
    </div>

    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalLabel">Detalle y Pago</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
                                <div class="carousel-indicators">
                                    <button type="button" data-bs-target="#productCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
                                    <button type="button" data-bs-target="#productCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
                                    <button type="button" data-bs-target="#productCarousel" data-bs-slide-to="2" aria-label="Slide 3"></button>
                                </div>
                                <div class="carousel-inner">
                                    <div class="carousel-item active">
                                        <img id="modal-img-front" src="" class="modal-image" alt="Delantera de la Playera">
                                    </div>
                                    <div class="carousel-item">
                                        <img id="modal-img-back" src="" class="modal-image" alt="Espalda de la Playera">
                                    </div>
                                    <div class="carousel-item">
                                        <img id="modal-img-side" src="" class="modal-image" alt="Vista Lateral de la Playera">
                                    </div>
                                </div>
                                <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                </button>
                            </div>
                        </div>

                        <div class="col-md-6">
                            
                            <div id="selection-step">
                                <h4 class="mt-3" id="product-name"></h4>
                                <p class="text-muted" id="product-description"></p>
                                
                                <div class="mb-4" id="color-selection-container" style="display:none;">
                                    <h6>Color:</h6>
                                    <div id="color-options"></div>
                                </div>

                                <div class="mb-4">
                                    <h6>Talla:</h6>
                                    <div id="size-options"></div>
                                    <small id="size-status" class="text-secondary mt-2"></small>
                                </div>
                                
                                <div class="mb-4">
                                    <h6>Cantidad de Piezas:</h6>
                                    <input type="number" id="quantityInput" class="form-control" value="1" min="1" max="10" style="width: 100px;">
                                    <small id="quantity-status" class="text-secondary mt-2"></small>
                                </div>
                                
                                <hr>
                                
                                <p>Precio Total: <strong id="total-price" class="text-danger"></strong></p>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" value="" id="halfPaymentCheck" checked>
                                    <label class="form-check-label" for="halfPaymentCheck">Pagar la Mitad Ahora (Apartar)</label>
                                </div>
                                <p>Monto a Pagar Ahora: <strong id="payment-due" style="font-size: 1.4rem; color: green;"></strong></p>
                                <small class="text-muted">El resto se pagará al momento de la entrega el 28 de Noviembre.</small>
                            </div>

                            <div id="payment-step" style="display:none;">
                                <h4 class="mt-3 mb-4">Datos del Comprador y Envío</h4>
                                <p class="alert alert-info small">
                                    Estás comprando <strong id="final-quantity-display">1</strong> pieza(s) talla <strong id="final-size-display"></strong> por <strong id="final-price-display"></strong>.
                                    Llena tus datos para guardar el pedido y ver las instrucciones de pago por transferencia.
                                </p>

                                <div class="mb-3">
                                    <label for="clientName" class="form-label">Nombre Completo (*):</label>
                                    <input type="text" class="form-control" id="clientName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="clientPhone" class="form-label">Teléfono/WhatsApp (*):</label>
                                    <input type="tel" class="form-control" id="clientPhone" required>
                                </div>
                                <div class="mb-3">
                                    <label for="clientAddress" class="form-label">Dirección de Envío Completa (*):</label>
                                    <textarea class="form-control" id="clientAddress" rows="2" required></textarea>
                                </div>
                                
                                <div id="payment-error" class="text-danger mb-3" style="display:none;">Por favor, completa todos los campos requeridos (*).</div>
                            </div>
                            
                            <div id="transfer-info" style="display:none;">
                                <h4 class="mt-3 mb-4 text-success">¡Pedido Generado!</h4>
                                <p>Hola <strong id="client-name-display"></strong>. Para confirmar tu compra de <span id="final-qty-conf">1</span> playera(s) (<span id="final-item-display"></span>, Talla <span id="final-size-conf"></span>), realiza la transferencia por el monto de <strong id="final-amount-conf" class="text-success"></strong> a la siguiente cuenta:</p>
                                <hr>
                                
                                <h5 class="text-primary">Datos de Transferencia Bancaria</h5>
                                <p class="mb-1"><strong>Banco:</strong> BANCOMER (BBVA)</p>
                                <p class="mb-1"><strong>Número de Cuenta:</strong> 0123 4567 8901 2345</p>
                                <p class="mb-1"><strong>CLABE Interbancaria:</strong> 012000000000000000</p>
                                <p class="mb-1"><strong>Beneficiario:</strong> MI TIENDA DE PLAYERAS S.A. DE C.V.</p>
                                
                                <hr>
                                <p class="text-center">¡Haz clic en el botón de WhatsApp abajo para enviar tus datos y el comprobante! **(El stock se descontará de forma permanente al presionar)**</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <a href="#" target="_blank" class="btn btn-success" id="whatsapp-confirm-button" style="display:none;">
                        Enviar Comprobante por WhatsApp
                    </a>
                    
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="modal-close-button">Cerrar</button>
                    
                    <button type="button" class="btn btn-buy" id="modal-main-button" disabled>Pagar Ahora</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        
        // --- 1. CONFIGURACIÓN GLOBAL ---
        const WHATSAPP_NUMBER = '5219991480151'; // Sustituye con tu número
        const FIXED_PRICE = 250.00; 
        const DEFAULT_STOCK_PER_SIZE = 1;
        const DEFAULT_GLOBAL_SIZES = ["S", "M", "L", "XL"]; 
        const BASE_URL = 'https://ventaplayera.github.io/RPLAY/'; // URL BASE centralizada

        // Estructuras de datos
        const productInventory = {}; 
        const productData = []; 
        let PENDING_ORDERS = []; 
        let orderIdCounter = 0; 

        const PRODUCT_LIST_CONTAINER = document.getElementById('product-list');
        // Valores por defecto para la selección actual. Se inicializan al abrir el modal.
        let currentSelection = { 
            productId: null, 
            color: 'Default', 
            size: 'M', 
            quantity: 1, 
            orderId: null 
        };
        
        // --- FUNCIONES DE ADMINISTRACIÓN (Acceso por Consola) ---
        
        // COMANDO PARA MOSTRAR EL PANEL DE ADMINISTRACIÓN (Requerimiento del usuario)
        function showAdminPanel() {
            const adminPanel = document.getElementById('manualManagementPanel');
            if (adminPanel) {
                adminPanel.style.display = 'block';
                renderOrdersList(); 
                console.log("✅ Panel de Administración de Pedidos activado. Para ocultar: hideAdminPanel()");
            }
        }
        
        function hideAdminPanel() {
            const adminPanel = document.getElementById('manualManagementPanel');
            if (adminPanel) {
                adminPanel.style.display = 'none';
                console.log("Panel de Administración de Pedidos oculto.");
            }
        }

        // Esta función es global y usable en consola.
        function setStock(productId, colorName, size, newStock) {
            if (productInventory[productId] && productInventory[productId][colorName]) {
                productInventory[productId][colorName][size] = newStock;
                saveInventoryStorage();
                renderProductCards();
                renderOrdersList();
                console.log(`Stock actualizado: ${productId}, ${colorName}, Talla ${size} -> ${newStock}`);
            } else {
                console.error('Error: Producto, color o talla no encontrado para actualizar stock.');
            }
        }
        
        // --- 2. GESTIÓN DEL INVENTARIO Y STORAGE ---

        function saveInventoryStorage() {
            localStorage.setItem('productInventory', JSON.stringify(productInventory));
            localStorage.setItem('pendingOrders', JSON.stringify(PENDING_ORDERS));
            localStorage.setItem('orderIdCounter', orderIdCounter);
        }

        function loadInventoryStorage() {
            const storedInventory = localStorage.getItem('productInventory');
            const storedOrders = localStorage.getItem('pendingOrders');
            const storedCounter = localStorage.getItem('orderIdCounter');
            
            // Si hay inventario guardado, lo fusionamos con la estructura inicial.
            if (storedInventory) {
                const tempInventory = JSON.parse(storedInventory);
                for (const productId in tempInventory) {
                    if (productInventory[productId]) {
                        for (const color in tempInventory[productId]) {
                            if (productInventory[productId][color]) {
                                // Sobrescribir el stock actual con el almacenado
                                productInventory[productId][color] = tempInventory[productId][color];
                            }
                        }
                    }
                }
            }
            if (storedOrders) {
                PENDING_ORDERS = JSON.parse(storedOrders);
            }
            if (storedCounter) {
                orderIdCounter = parseInt(storedCounter);
            }
        }

        function getStock(productId, colorName, size) {
            // Usa el inventario real (productInventory) para la verificación
            return productInventory[productId]?.[colorName]?.[size] || 0;
        }
        
        function resetAllStock() {
            if (confirm("¿Estás seguro de que quieres REINICIAR TODO el inventario y borrar todas las órdenes pendientes? Esta acción es irreversible.")) {
                localStorage.removeItem('productInventory');
                localStorage.removeItem('pendingOrders');
                localStorage.removeItem('orderIdCounter');
                // Vuelve a cargar el inventario inicial
                generateInitialInventory(); 
                PENDING_ORDERS = [];
                orderIdCounter = 0;
                renderProductCards();
                renderOrdersList();
                alert("Inventario y órdenes reiniciados con éxito.");
            }
        }
        
        // --- 3. FUNCIONES DE RESERVA Y LIBERACIÓN ---
        
        // Reserva el stock (lo descuenta temporalmente) y crea la orden pendiente
        function reserveStock(productId, colorName, size, quantity, clientName, clientPhone, clientAddress) {
            const currentStock = getStock(productId, colorName, size);
            
            if (currentStock < quantity) {
                return false; 
            }

            // 1. Descontar stock (reserva temporal)
            // Llama a setStock para actualizar el inventario y el storage
            setStock(productId, colorName, size, currentStock - quantity); 

            // 2. Crear y guardar la orden pendiente
            orderIdCounter++;
            const product = productData.find(p => p.id === productId);
            const variantName = product.variants[colorName].name;
            
            const order = {
                id: orderIdCounter,
                timestamp: new Date().getTime(),
                productId: productId,
                colorName: colorName,
                size: size,
                quantity: quantity,
                clientName: clientName,
                clientPhone: clientPhone,
                clientAddress: clientAddress,
                productName: variantName, // Usamos el nombre de la variante para el detalle
                isConfirmed: false 
            };
            
            PENDING_ORDERS.push(order);
            saveInventoryStorage(); // Guardar el nuevo arreglo de órdenes
            renderOrdersList();
            
            return order;
        }
        
        // Descuenta el stock permanentemente (remueve de la lista de gestión, ya se descontó antes)
        function applyStockReduction(order) {
            // Nota: El stock ya fue descontado en `reserveStock`. 
            // Esto solo remueve la orden de la lista de "pendientes por liberar".
            PENDING_ORDERS = PENDING_ORDERS.filter(o => o.id !== order.id);
            saveInventoryStorage();
            renderOrdersList();
        }

        // Libera el stock (lo devuelve al inventario si el pago no se hizo)
        function releaseStock(order) {
            // 1. Devolver el stock al inventario
            const currentStock = getStock(order.productId, order.colorName, order.size);
            // Llama a setStock para devolver el stock, actualizando el inventario y el storage
            setStock(order.productId, order.colorName, order.size, currentStock + order.quantity);

            // 2. Eliminar la orden de la lista de pendientes
            PENDING_ORDERS = PENDING_ORDERS.filter(o => o.id !== order.id);
            saveInventoryStorage();
            renderOrdersList();
            renderProductCards(); // Asegurar que las tarjetas se actualicen
        }

        function releaseOrderManually(orderId) {
            const order = PENDING_ORDERS.find(o => o.id === orderId);
            if (order && confirm(`¿Seguro que quieres liberar la reserva para ${order.clientName} (Talla ${order.size}, Cantidad ${order.quantity})? El stock volverá al inventario.`)) {
                releaseStock(order);
            }
        }

        // --- 4. RENDERIZADO ---
        
        function renderOrdersList() {
            const listContainer = document.getElementById('ordersList');
            if (!listContainer) return; 
            
            listContainer.innerHTML = '';

            if (PENDING_ORDERS.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-secondary" id="noOrdersMessage">No hay pedidos pendientes actualmente.</p>';
                return;
            }

            PENDING_ORDERS.forEach(order => {
                const orderDiv = document.createElement('div');
                orderDiv.className = 'order-item d-flex justify-content-between align-items-center';
                orderDiv.innerHTML = `
                    <div>
                        <small class="text-muted">Pedido #${order.id} | ${new Date(order.timestamp).toLocaleTimeString()}</small><br>
                        <strong>${order.clientName}</strong> (${order.clientPhone})<br>
                        ${order.quantity}x ${order.productName} (Talla: ${order.size})<br>
                        <small>Dir: ${order.clientAddress}</small>
                    </div>
                    <button class="btn btn-sm btn-outline-warning" onclick="releaseOrderManually(${order.id})">Liberar Stock</button>
                `;
                listContainer.appendChild(orderDiv);
            });
        }
        
        function renderProductCards() {
            PRODUCT_LIST_CONTAINER.innerHTML = '';
            productData.forEach(product => {
                const colors = Object.keys(product.variants);
                const firstColor = colors[0] || 'Default';
                const mainVariant = product.variants[firstColor];
                
                let totalStock = 0;
                // Sumar stock de todas las variantes/tallas
                for (const color in productInventory[product.id]) {
                    for (const size in productInventory[product.id][color]) {
                        totalStock += productInventory[product.id][color][size];
                    }
                }

                let badgeClass = 'out-stock';
                let badgeText = 'Agotado';
                
                // --- LÓGICA DE BADGE: Preventa o Agotado (Requerimiento del usuario) ---
                if (totalStock > 0) {
                    badgeClass = 'in-stock'; 
                    badgeText = 'Preventa';
                }

                const cardHtml = `
                    <div class="col-lg-3 col-md-4 col-sm-6">
                        <div class="card product-card" style="position: relative;">
                            <span class="stock-badge ${badgeClass}">${badgeText}</span>
                            <img src="${mainVariant.img_front}" class="card-img-top" alt="${product.name}">
                            <div class="card-body">
                                <h5 class="card-title">${product.name}</h5>
                                <p class="card-text text-muted small">${product.description}</p>
                                <p class="card-text"><strong>$${FIXED_PRICE.toFixed(2)} MXN</strong></p>
                                <button class="btn btn-buy w-100" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#paymentModal" 
                                    data-product-id="${product.id}">
                                    Comprar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                PRODUCT_LIST_CONTAINER.innerHTML += cardHtml;
            });
        }

        // --- 5. DATOS DE INVENTARIO (44 Playeras con URLs correctas) ---

        function generateInitialInventory() {
            // Limpiar datos anteriores para regenerar
            productData.length = 0; 
            for (const key in productInventory) { delete productInventory[key]; }

            for (let i = 1; i <= 44; i++) { 
                const id = `PROD_${String(i).padStart(3, '0')}`;
                let modelSizes = [...DEFAULT_GLOBAL_SIZES]; 
                let initialStockOverrides = {}; 
                let productName = `Playera Modelo No. ${i}`; 
                let productDescription = `Diseño exclusivo #${i}. ¡Modifica este texto!`;
                let variants = {}; 
                let mainImg, frontImg, backImg, sideImg; // Se inicializan a undefined

                if (i < 43) {
                    // --- ZONA DE DATOS DE PRODUCTOS INDIVIDUALES (1 a 42) ---
                    if (i === 1) { 
                        productName = 'BTS'; 
                        productDescription = 'Diseño original de BTS en blanco. ¡Edición especial!';
                        frontImg = 'https://ventaplayera.github.io/RPLAY/Xime1.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Xime2.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/blanco.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                        modelSizes = ['M', 'L', 'XL'];
                    } else if (i === 2) { 
                        productName = 'BTS'; 
                        productDescription = 'Diseño original de BTS en negro. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Xime3.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Xime4.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                        modelSizes = ['M', 'L', 'XL'];
                    } else if (i === 3) { 
                        productName = 'ADO'; 
                        productDescription = 'Diseño original de ADO en blanco. ¡Edición especial!'; 
                        frontImg = `https://ventaplayera.github.io/RPLAY/Lucy1.png`;
                        backImg = `https://ventaplayera.github.io/RPLAY/Lucy2.png`;
                        sideImg = `https://ventaplayera.github.io/RPLAY/blanco.png`;
                        initialStockOverrides = {M: 1, XL: 1}; 
                        modelSizes = ["M", "XL"]; 
                    } else if (i === 4) { 
                        productName = 'ADO'; 
                        productDescription = 'Diseño original de ADO en negro. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Lucy3.png`;
                        backImg = `https://ventaplayera.github.io/RPLAY/Lucy4.png`;
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro.png`;
                        initialStockOverrides = {M: 1, L: 1, XL: 2}; 
                        modelSizes = ["M", "L", "XL"];
                    } else if (i === 5) { 
                        productName = 'BRUNO MARS'; 
                        productDescription = 'Diseño original de BRUNO MARS en negro. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Raul1.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Raul2.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                        modelSizes = ['M', 'L', 'XL'];
                    } else if (i === 6) { 
                        productName = 'BRUNO MARS';
                        productDescription = 'Diseño original de BRUNO MARS en negro. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Raul3.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Raul4.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                        modelSizes = ['M', 'L', 'XL'];
                    } else if (i === 7) { 
                        productName = 'MICHAEL JACKSON'; 
                        productDescription = 'Diseño original de MICHAEL JACKSO en blanco. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Abi1.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Abi2.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/blanco.png`; 
                        initialStockOverrides = {S: 1, M: 1, G: 1};
                        modelSizes = ['S', 'M', 'G'];
                    } else if (i === 8) { 
                        productName = 'MICHAEL JACKSON'; 
                        productDescription = 'Diseño original de MICHAEL JACKSO en negro. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Abi3.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Abi4.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro.png`; 
                        initialStockOverrides = {M: 1, G: 1}; 
                        modelSizes = ['M', 'G'];
                    } else if (i === 9) { 
                        productName = 'LATIN MAFIA';
                        productDescription = 'Diseño original de LATIN MAFIA en blanco. ¡Edición especial!'; 
                        frontImg = `https://ventaplayera.github.io/RPLAY/Dani1.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Dani2.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/blanco.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                        modelSizes = ['M', 'L', 'XL'];
                    } else if (i === 10) { 
                        productName = 'LATIN MAFIA'; 
                        productDescription = 'Diseño original de LATIN MAFIA en negro. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Dani3.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Dani4.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                        modelSizes = ['M', 'L', 'XL'];
                    } else if (i === 11) { 
                        productName = 'AESPA'; 
                        productDescription = 'Diseño original de AESPA en negro. ¡Edición especial!'; 
                        frontImg = `https://ventaplayera.github.io/RPLAY/Dali1.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Dali2.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                        modelSizes = ['M', 'L', 'XL'];
                    } else if (i === 12) { 
                        productName = 'AESPA';
                        productDescription = 'Diseño original de AESPA en negro. ¡Edición especial!'; 
                        frontImg = `https://ventaplayera.github.io/RPLAY/Dali3.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Dali4.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                        modelSizes = ['M', 'L', 'XL'];
                    } else if (i === 13) { 
                        productName = 'BILLIE EILISH'; 
                        productDescription = 'Diseño original de BILLIE EILISH en negro. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Yose1.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Yose2.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro.png`; 
                        initialStockOverrides = {L: 2, XL: 1};
                        modelSizes = ['L', 'XL'];
                    } else if (i === 14) { 
                        productName = 'BILLIE EILISH';  
                        productDescription = 'Diseño original de BILLIE EILISH en negro. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Yose3.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Yose4.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro.png`; 
                        initialStockOverrides = {L: 1, XL: 2};
                        modelSizes = ['L', 'XL'];
                    } else if (i === 15) { 
                        productName = 'LANA DEL REY'; 
                        productDescription = 'Diseño original de LANA DEL REY en blanco. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Keila1.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Keila2.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/blanco.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                        modelSizes = ['M', 'L', 'XL'];
                    } else if (i === 16) { 
                        productName = 'LANA DEL REY';
                        productDescription = 'Diseño original de LANA DEL REY en negro. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Keila3.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Keila4.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                        modelSizes = ['M', 'L', 'XL'];
                    } else if (i === 17) { 
                        productName = 'MY CHEMICAL ROMANCE'; 
                        productDescription = 'Diseño original de MY CHEMICAL ROMANCE en negro. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Kenji1.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Kenji2.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                        modelSizes = ['M', 'L', 'XL'];
                    } else if (i === 18) { 
                        productName = 'MY CHEMICAL ROMANCE'; 
                        productDescription = 'Diseño original de MY CHEMICAL ROMANCE en negro. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Kenji3.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Kenji4.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                        modelSizes = ['M', 'L', 'XL'];
                    } else if (i === 19) { 
                        productName = 'TWENTY ONE PILOTS'; 
                        productDescription = 'Diseño original de TWENTY ONE PILOTS en negro. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Alli1.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Alli2.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                        modelSizes = ['M', 'L', 'XL'];
                    } else if (i === 20) { 
                        productName = 'TWENTY ONE PILOTS'; 
                        productDescription = 'Diseño original de TWENTY ONE PILOTS en negro. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Alli3.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Alli4.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                        modelSizes = ['M', 'L', 'XL'];
                    } else if (i === 21) { 
                        productName = 'ARCTIC MONKEYS'; 
                        productDescription = 'Diseño original de ARCTIC MONKEYS en arena. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Ale1.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Ale2.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/arena.png`; 
                        initialStockOverrides = { XL: 1};
                        modelSizes = [ 'XL'];
                    } else if (i === 22) { 
                        productName = 'ARCTIC MONKEYS'; 
                        productDescription = 'Diseño original de ARCTIC MONKEYS en arena. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Ale3.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Ale4.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/arena.png`; 
                        initialStockOverrides = {XL: 1};
                        modelSizes = ['XL'];
                    } else if (i === 23) { 
                        productName = 'OLIVIA RODRIGO'; 
                        productDescription = 'Diseño original de OLIVIA RODRIGO en negro. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Miri1.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Miri2.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                        modelSizes = ['M', 'L', 'XL'];
                    } else if (i === 24) { 
                        productName = 'OLIVIA RODRIGO'; 
                        productDescription = 'Diseño original de OLIVIA RODRIGO en negro. ¡Edición especial!'; 
                        frontImg = `https://ventaplayera.github.io/RPLAY/Miri3.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Miri4.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                        modelSizes = ['M', 'L', 'XL'];
                    } else if (i === 25) { 
                        productName = 'BAD BUNNY'; 
                        productDescription = 'Diseño original de BAD BUNNY en negro. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Didi1.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Didi2.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                        modelSizes = ['M', 'L', 'XL'];
                    } else if (i === 26) { 
                        productName = 'BAD BUNNY'; 
                        productDescription = 'Diseño original de BAD BUNNY en arena. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Didi3.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Didi4.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/arena.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                        modelSizes = ['M', 'L', 'XL'];
                    } else if (i === 27) { 
                        productName = 'TAYLOR SWIFT'; 
                        productDescription = 'Diseño original de TAYLOR SWIFT en arena. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Vale1.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Vale2.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/arena.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                        modelSizes = ['M', 'L', 'XL'];
                    } else if (i === 28) { 
                        productName = 'TAYLOR SWIFT'; 
                        productDescription = 'Diseño original de TAYLOR SWIFT en negro. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Vale3.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Vale4.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                        modelSizes = ['M', 'L', 'XL'];
                    } else if (i === 29) { 
                        productName = 'HUMBE'; 
                        productDescription = 'Diseño original de HUMBE en negro. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Caro1.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Caro2.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                        modelSizes = ['M', 'L', 'XL'];
                    } else if (i === 30) { 
                        productName = 'HUMBE';  
                        productDescription = 'Diseño original de HUMBE en negro. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Caro3.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Caro4.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                        modelSizes = ['M', 'L', 'XL'];
                    } else if (i === 31) { 
                        productName = 'KATY PERRY'; 
                        productDescription = 'Diseño original de KATY PERRY en negro. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Gon1.PNG`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Gon2.PNG`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                        modelSizes = ['M', 'L', 'XL'];
                    } else if (i === 32) { 
                        productName = 'KATY PERRY';  
                        productDescription = 'Diseño original de KATY PERRY en blanco. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Katy3.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Katy4.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/blanco.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                        modelSizes = ['M', 'L', 'XL'];
                    } else if (i === 33) { 
                        productName = 'TAYLOR SWIFT'; 
                        productDescription = 'Diseño original de TAYLOR SWIFT en blanco. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Bere1.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Bere2.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/blanco2.png`; 
                        initialStockOverrides = {S:1, M: 1, G: 1};
                        modelSizes = ['S', 'M', 'G'];
                    } else if (i === 34) { 
                        productName = 'TAYLOR SWIFT';  
                        productDescription = 'Diseño original de TAYLOR SWIFT en negro. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Bere3.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Bere4.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro2.png`; 
                        initialStockOverrides = {S:1, M: 1, G: 1};
                        modelSizes = ['S', 'M', 'G'];
                    } else if (i === 35) { 
                        productName = 'BTS'; 
                        productDescription = 'Diseño original de BTS en negro. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Dan1.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Dan2.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro2.png`; 
                        initialStockOverrides = {S:1, M: 1, G: 1};
                        modelSizes = ['S', 'M', 'G'];
                    } else if (i === 36) { 
                        productName = 'BTS'; 
                        productDescription = 'Diseño original de BTS en negro. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Dan3.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Dan4.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro2.png`; 
                        initialStockOverrides = {S:1, M: 1, G: 1};
                        modelSizes = ['S', 'M', 'G'];
                    } else if (i === 37) { 
                        productName = 'NCT DREAM'; 
                        productDescription = 'Diseño original de NCT DREAM en negro. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Gera1.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Gera2.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro2.png`; 
                        initialStockOverrides = {S:1, M: 1, G: 1};
                        modelSizes = ['S', 'M', 'G'];
                    } else if (i === 38) { 
                        productName = 'NCT DREAM'; 
                        productDescription = 'Diseño original de NCT DREAM en negro. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Gera3.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Gera4.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro2.png`; 
                        initialStockOverrides = {S:1, M: 1, G: 1};
                        modelSizes = ['S', 'M', 'G'];
                    } else if (i === 39) { 
                        productName = 'HUNTRIX/SJA BOYS'; 
                        productDescription = 'Diseño original de HUNTRIX/SJA BOYS en negro. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Bra1.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Bra2.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro2.png`; 
                        initialStockOverrides = {S:1, M: 1, G: 1};
                        modelSizes = ['S', 'M', 'G'];
                    } else if (i === 40) { 
                        productName = 'HUNTRIX/SJA BOYS';  
                        productDescription = 'Diseño original de HUNTRIX/SJA BOYS en negro. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Bra3.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Bra4.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro2.png`; 
                        initialStockOverrides = {S:1, M: 1, G: 1};
                        modelSizes = ['S', 'M', 'G'];
                    } else if (i === 41) { 
                        productName = 'HOOZIER'; 
                        productDescription = 'Diseño original de HOOZIER en negro. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Adri1.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Adri2.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/negro2.png`; 
                        initialStockOverrides = {S:1, M: 1, G: 1};
                        modelSizes = ['S', 'M', 'G'];
                    } else if (i === 42) { 
                        productName = 'HOOZIER';  
                        productDescription = 'Diseño original de HOOZIER en blanco. ¡Edición especial!';
                        frontImg = `https://ventaplayera.github.io/RPLAY/Adri3.png`; 
                        backImg = `https://ventaplayera.github.io/RPLAY/Adri4.png`; 
                        sideImg = `https://ventaplayera.github.io/RPLAY/blanco2.png`; 
                        initialStockOverrides = {S:1, M: 1, L: 1};
                        modelSizes = ['S', 'M', 'G'];
                    }

                    // --- INICIO DE CORRECCIÓN ---
                    // Si 'frontImg' no se definió, usamos un placeholder robusto
                    if (!frontImg) {
                        productName = `Playera Modelo No. ${i} (FALTA INFO)`;
                        frontImg = `https://via.placeholder.com/300x450?text=Frente+de+${productName.replace(/ /g, '+')}`;
                        backImg = `https://via.placeholder.com/300x450?text=Espalda+de+${productName.replace(/ /g, '+')}`;
                        sideImg = `${BASE_URL}blanco.png`; 
                        initialStockOverrides = {S:1, M: 1, L: 1, XL: 1}; // Stock por defecto
                    }
                    // --- FIN DE CORRECCIÓN ---

                    // 1. Aplicar stock por defecto si no fue sobrescrito
                    let stock = {};
                    modelSizes.forEach(s => {
                        stock[s] = initialStockOverrides[s] !== undefined ? initialStockOverrides[s] : DEFAULT_STOCK_PER_SIZE;
                    });
                    
                    // 2. CREAR LA VARIANTE 'Default'
                    // Esta es la corrección clave para que las tarjetas puedan encontrar la imagen principal.
                    variants['Default'] = {
                        name: productName,
                        img_front: frontImg, 
                        img_back: backImg,
                        img_side: sideImg,
                        stock: stock
                    };
                    
                    mainImg = frontImg;

                } else { // i === 43 or i === 44
                    // --- ZONA DE PRODUCTOS MULTIVARIANTES (43 y 44) ---
                    if (i === 43) { 
                        productName = 'BLACKPINK';
                        productDescription = 'Diseño oridinalde Blackpink en negro/blanco. ¡Edición especial!';
                        modelSizes = ["S", "M", "L"];
                        variants['Negro'] = { 
                            name: 'Playera BLACKPINK (Negro)', 
                            img_front: `https://ventaplayera.github.io/RPLAY/Aro1.png`, 
                            img_back: `https://ventaplayera.github.io/RPLAY/Aro2.png`, 
                            img_side: `https://ventaplayera.github.io/RPLAY/negro2.png`, 
                            stock: {G: 1 } 
                        };
                        variants['Blanco'] = { 
                            name: 'Playera BLACKPINK (Blanco)', 
                            img_front: `https://ventaplayera.github.io/RPLAY/Aro3.png`, 
                            img_back: `https://ventaplayera.github.io/RPLAY/Aro4.png`, 
                            img_side: `https://ventaplayera.github.io/RPLAY/blanco2.png`, 
                            stock: { S: 1, M: 1 } 
                        };
                        mainImg = variants['Blanco'].img_front;

                    } else if (i === 44) { 
                        productName = 'BLACKPINK';
                        productDescription = 'Diseño oridinalde Blackpink en negro/blanco. ¡Edición especial!';
                        modelSizes = ["S", "M", "L", "XL"];
                        variants['Negro'] = { 
                            name: 'Playera K-POP (Negro)', 
                            img_front: `https://ventaplayera.github.io/RPLAY/Aro5.png`, 
                            img_back: `https://ventaplayera.github.io/RPLAY/Aro6.png`, 
                            img_side: `https://ventaplayera.github.io/RPLAY/negro2.png`, 
                            stock: { G: 1 } 
                        };
                        variants['Blanco'] = { 
                            name: 'Playera K-POP (Blanco)', 
                            img_front: `https://ventaplayera.github.io/RPLAY/Aro7.png`, 
                            img_back: `https://ventaplayera.github.io/RPLAY/Aro8.png`, 
                            img_side: `https://ventaplayera.github.io/RPLAY/blanco2.png`, 
                            stock: { S: 1, M: 1 } 
                        };
                        mainImg = variants['Negro'].img_front;
                    }
                }
                
                // Inicializa la estructura del inventario de stock
                productInventory[id] = {};
                for (const colorName in variants) {
                    // Copiar stock de la variante al inventario global
                    productInventory[id][colorName] = { ...variants[colorName].stock };
                }

                // Guarda los datos del producto
                productData.push({
                    id: id,
                    name: productName,
                    description: productDescription,
                    price: FIXED_PRICE,
                    mainImg: mainImg,
                    sizes: modelSizes,
                    variants: variants,
                    hasColors: Object.keys(variants).length > 1
                });
            }
        }

        // --- 6. GESTIÓN DEL MODAL (COMPRA) ---

        let paymentModal;
        
        function updateModalContent(product, selectedColor) {
            const variant = product.variants[selectedColor];
            
            // Actualizar imágenes y descripción
            document.getElementById('modal-img-front').src = variant.img_front;
            document.getElementById('modal-img-back').src = variant.img_back;
            document.getElementById('modal-img-side').src = variant.img_side;
            document.getElementById('product-name').textContent = variant.name;
            document.getElementById('product-description').textContent = product.description;

            // Renderizar opciones de talla (simplificado, asume que siempre hay tallas)
            const sizeOptionsContainer = document.getElementById('size-options');
            sizeOptionsContainer.innerHTML = '';
            // Usar el stock ACTUAL (del productInventory) para mostrar disponibilidad.
            const currentStockForColor = productInventory[product.id][selectedColor] || {}; 
            const sizes = Object.keys(currentStockForColor).sort(); // Ordenar tallas

            sizes.forEach(size => {
                const stock = currentStockForColor[size];
                const button = document.createElement('button');
                button.type = 'button';
                button.className = `btn btn-outline-secondary btn-sm me-2 mb-2 size-option ${stock > 0 ? '' : 'disabled'}`;
                button.textContent = size;
                button.setAttribute('data-size', size);
                button.disabled = stock <= 0;
                
                button.addEventListener('click', () => {
                    document.querySelectorAll('.size-option').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    currentSelection.size = size;
                    updateTotalAndCheckStock();
                });
                sizeOptionsContainer.appendChild(button);
            });

            // Si el producto tiene colores, mostrarlos
            const colorContainer = document.getElementById('color-selection-container');
            if (product.hasColors) {
                colorContainer.style.display = 'block';
                const colorOptions = document.getElementById('color-options');
                colorOptions.innerHTML = '';
                Object.keys(product.variants).forEach(color => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = `btn btn-outline-dark btn-sm me-2 mb-2 color-option ${color === selectedColor ? 'active' : ''}`;
                    button.textContent = color;
                    button.setAttribute('data-color', color);
                    button.addEventListener('click', () => {
                        document.querySelectorAll('.color-option').forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        currentSelection.color = color;
                        // Recargar contenido para la nueva variante (llama a esta misma función)
                        updateModalContent(product, color); 
                    });
                    colorOptions.appendChild(button);
                });
            } else {
                colorContainer.style.display = 'none';
            }

            // Seleccionar la primera talla disponible o la predeterminada
            const defaultSize = sizes.find(size => currentStockForColor[size] > 0) || sizes[0];
            currentSelection.size = defaultSize;

            if (document.querySelector(`.size-option[data-size="${defaultSize}"]`)) {
                document.querySelector(`.size-option[data-size="${defaultSize}"]`).classList.add('active');
            } else {
                 currentSelection.size = null; // Ninguna talla seleccionada si no hay stock
            }
            
            // Forzar actualización de precio y stock al cargar
            updateTotalAndCheckStock();
        }

        function updateTotalAndCheckStock() {
            const sizeStatus = document.getElementById('size-status');
            const quantityStatus = document.getElementById('quantity-status');
            const mainButton = document.getElementById('modal-main-button');
            const quantityInput = document.getElementById('quantityInput');

            // Asegurar que la cantidad es válida
            let quantity = parseInt(quantityInput.value) || 1;
            if (quantity < 1) { quantity = 1; quantityInput.value = 1; }
            currentSelection.quantity = quantity;

            // Obtener stock actual
            const currentStock = getStock(currentSelection.productId, currentSelection.color, currentSelection.size);

            if (currentSelection.size) {
                sizeStatus.textContent = `Stock disponible en Talla ${currentSelection.size}: ${currentStock} pieza(s).`;
                quantityInput.max = currentStock;

                if (currentStock === 0) {
                    mainButton.disabled = true;
                    quantityStatus.textContent = `Agotado. Selecciona otra talla.`;
                } else if (currentStock < currentSelection.quantity) {
                    mainButton.disabled = true;
                    quantityStatus.textContent = `Solo quedan ${currentStock} piezas en stock.`;
                } else {
                    mainButton.disabled = false;
                    quantityStatus.textContent = `Máximo a comprar: ${currentStock} pieza(s).`;
                }

            } else {
                // No hay talla seleccionada (todo agotado)
                sizeStatus.textContent = `No hay stock disponible para este modelo o talla.`;
                mainButton.disabled = true;
            }
            
            const totalPrice = (FIXED_PRICE * quantity).toFixed(2);
            // Si la casilla de pagar mitad está marcada, calcular la mitad
            const isHalfPayment = document.getElementById('halfPaymentCheck').checked;
            const paymentDue = isHalfPayment ? (FIXED_PRICE * quantity / 2).toFixed(2) : totalPrice;
            
            document.getElementById('total-price').textContent = `$${totalPrice} MXN`;
            document.getElementById('payment-due').textContent = `$${paymentDue} MXN`;
        }

        function openModalDetail(productId) {
            const product = productData.find(p => p.id === productId);
            if (!product) return;

            currentSelection.productId = productId;
            // Seleccionar color por defecto (el primero)
            const firstColor = Object.keys(product.variants)[0];
            currentSelection.color = firstColor;

            updateModalContent(product, firstColor);
            
            // Forzar el paso de selección al abrir
            updateModalUI(false); 
        }

        function updateModalUI(step, order = null) {
            const selectionStep = document.getElementById('selection-step');
            const paymentStep = document.getElementById('payment-step');
            const transferInfo = document.getElementById('transfer-info');
            const modalMainButton = document.getElementById('modal-main-button');
            const whatsappButton = document.getElementById('whatsapp-confirm-button');

            // Limpiar campos de cliente y errores
            document.getElementById('clientName').value = '';
            document.getElementById('clientPhone').value = '';
            document.getElementById('clientAddress').value = '';
            document.getElementById('payment-error').style.display = 'none';

            if (step === false) { 
                // Paso 1: Selección de producto/talla/cantidad
                selectionStep.style.display = 'block';
                paymentStep.style.display = 'none';
                transferInfo.style.display = 'none';
                modalMainButton.style.display = 'block';
                modalMainButton.textContent = 'Pagar Ahora';
                modalMainButton.onclick = moveToPaymentStep;
                whatsappButton.style.display = 'none';
                document.getElementById('modal-close-button').textContent = 'Cerrar';
                updateTotalAndCheckStock(); // Revisa si el botón debe estar activo

            } else if (step === 'payment') { 
                // Paso 2: Datos del cliente
                const product = productData.find(p => p.id === currentSelection.productId);
                const quantity = currentSelection.quantity;
                
                // Determinar el monto a pagar ahora
                const isHalfPayment = document.getElementById('halfPaymentCheck').checked;
                const totalAmount = FIXED_PRICE * quantity;
                const paymentDue = isHalfPayment ? (totalAmount / 2).toFixed(2) : totalAmount.toFixed(2);

                document.getElementById('final-quantity-display').textContent = quantity;
                document.getElementById('final-size-display').textContent = currentSelection.size;
                document.getElementById('final-price-display').textContent = `$${paymentDue} MXN`;
                
                selectionStep.style.display = 'none';
                paymentStep.style.display = 'block';
                transferInfo.style.display = 'none';
                modalMainButton.style.display = 'block';
                modalMainButton.textContent = 'Reservar y Ver Pago';
                modalMainButton.disabled = false;
                modalMainButton.onclick = processOrderReservation;
                whatsappButton.style.display = 'none';
                document.getElementById('modal-close-button').textContent = 'Cancelar Pedido';

            } else if (step === 'confirmed') { 
                // Paso 3: Confirmación y Datos de Transferencia
                const product = productData.find(p => p.id === currentSelection.productId);
                const variantName = product.variants[currentSelection.color].name;
                
                // Determinar el monto final pagado
                const isHalfPayment = document.getElementById('halfPaymentCheck').checked;
                const totalAmount = FIXED_PRICE * order.quantity;
                const finalAmountPaid = isHalfPayment ? (totalAmount / 2).toFixed(2) : totalAmount.toFixed(2);

                document.getElementById('client-name-display').textContent = order.clientName;
                document.getElementById('final-qty-conf').textContent = order.quantity;
                document.getElementById('final-item-display').textContent = variantName;
                document.getElementById('final-size-conf').textContent = order.size;
                document.getElementById('final-amount-conf').textContent = `$${finalAmountPaid} MXN`;
                
                // Generar mensaje de WhatsApp
                const paymentTypeText = isHalfPayment ? `Apartado/Medio Pago ($${finalAmountPaid} MXN)` : `Pago Total ($${finalAmountPaid} MXN)`;
                const whatsappMessage = `¡Hola! Acabo de hacer una orden de preventa con ID *#${order.id}*.%0A%0A*Detalles del Pedido:*%0A- Producto: ${variantName}%0A- Talla: ${order.size}%0A- Cantidad: ${order.quantity} pieza(s)%0A- Tipo de Pago: ${paymentTypeText}%0A%0A*Mis Datos:*%0A- Nombre: ${order.clientName}%0A- Teléfono: ${order.clientPhone}%0A- Dirección: ${order.clientAddress}%0A%0AAdjunto el comprobante de pago por transferencia. ¡Gracias!`;
                
                whatsappButton.href = `https://wa.me/${WHATSAPP_NUMBER}?text=${whatsappMessage}`;
                whatsappButton.setAttribute('data-order-id', order.id);

                selectionStep.style.display = 'none';
                paymentStep.style.display = 'none';
                transferInfo.style.display = 'block';
                modalMainButton.style.display = 'none'; 
                whatsappButton.style.display = 'block';
                document.getElementById('modal-close-button').textContent = 'Cerrar';
                whatsappButton.removeAttribute('data-stock-applied');
            }
        }
        
        // --- 7. FLUJO DE COMPRA ---

        function moveToPaymentStep() {
            if (currentSelection.size && currentSelection.quantity > 0) {
                // Verificar stock por última vez
                const currentStock = getStock(currentSelection.productId, currentSelection.color, currentSelection.size);
                if (currentStock >= currentSelection.quantity) {
                     updateModalUI('payment');
                } else {
                    alert(`El stock disponible cambió a ${currentStock}. Por favor, ajusta la cantidad.`);
                    updateTotalAndCheckStock();
                }
            } else {
                alert("Por favor, selecciona una talla y cantidad válidas.");
            }
        }
        
        function processOrderReservation() {
            const clientName = document.getElementById('clientName').value.trim();
            const clientPhone = document.getElementById('clientPhone').value.trim();
            const clientAddress = document.getElementById('clientAddress').value.trim();
            const errorDiv = document.getElementById('payment-error');
            const selectedQuantity = currentSelection.quantity;

            if (!clientName || !clientPhone || !clientAddress) {
                errorDiv.style.display = 'block';
                return;
            }

            errorDiv.style.display = 'none';

            // Intentar reservar el stock (descuenta temporalmente)
            const order = reserveStock(
                currentSelection.productId,
                currentSelection.color,
                currentSelection.size,
                selectedQuantity,
                clientName,
                clientPhone,
                clientAddress
            );

            if (order) {
                // Reserva exitosa, muestra la info de transferencia
                updateModalUI('confirmed', order);
                // Vuelve a renderizar las tarjetas para reflejar el stock descontado
                renderProductCards(); 
            } else {
                alert("Error: El stock se agotó antes de poder reservar. Intenta con una cantidad menor o un producto diferente.");
                updateModalUI(false);
            }
        }

        // --- 8. INICIALIZACIÓN Y LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // 1. Inicializar Bootstrap Modal
            paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'), {});

            // 2. Listener para descontar stock al enviar WhatsApp
            const whatsappButton = document.getElementById('whatsapp-confirm-button');
            if (whatsappButton) {
                whatsappButton.addEventListener('click', (event) => {
                    // Solo descontar stock si no se ha hecho antes
                    if (whatsappButton.getAttribute('data-stock-applied') !== 'true') {
                        const orderIdToApply = parseInt(whatsappButton.getAttribute('data-order-id'));
                        const order = PENDING_ORDERS.find(o => o.id === orderIdToApply);
                        
                        if (order) {
                            // Aplicar la reducción PERMANENTE (remueve de la lista de gestión)
                            applyStockReduction(order); 
                            whatsappButton.setAttribute('data-stock-applied', 'true');
                        }
                    }
                    // El evento sigue su curso y abre WhatsApp
                });
            }
            
            // 3. Listener para abrir el modal desde las tarjetas
            document.getElementById('product-list').addEventListener('click', (e) => {
                const target = e.target.closest('.btn-buy');
                if (target) {
                    const productId = target.getAttribute('data-product-id');
                    openModalDetail(productId); 
                }
            });
            
            // 4. Listener para actualizar precio/stock al cambiar cantidad
            const quantityInput = document.getElementById('quantityInput');
            if (quantityInput) {
                quantityInput.addEventListener('change', updateTotalAndCheckStock);
                quantityInput.addEventListener('input', updateTotalAndCheckStock);
            }
            
            // 5. Listener para actualizar el monto a pagar al marcar/desmarcar "Pagar la Mitad"
            const halfPaymentCheck = document.getElementById('halfPaymentCheck');
            if (halfPaymentCheck) {
                halfPaymentCheck.addEventListener('change', updateTotalAndCheckStock);
            }

            // 6. Resetear el modal al cerrarse
            const paymentModalElement = document.getElementById('paymentModal');
            paymentModalElement.addEventListener('hidden.bs.modal', () => {
                updateModalUI(false); 
            });

            // 7. Cargar datos e inventario
            generateInitialInventory();
            loadInventoryStorage();
            renderProductCards();
        });

    </script>
</body>
</html>

