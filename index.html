<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPLAY - Venta de Playeras</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .product-card {
            border: 1px solid #ddd;
            transition: transform 0.2s;
            margin-bottom: 20px;
        }
        .product-card:hover {
            transform: translateY(-5px);
        }
        .btn-buy {
            background-color: #ff3366;
            color: white;
            border: none;
        }
        .btn-buy:hover {
            background-color: #e6004b;
            color: white;
        }
        .stock-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            color: white;
            z-index: 10;
        }
        .stock-badge.in-stock { background-color: green; } /* Usado para "Preventa" */
        .stock-badge.out-stock { background-color: red; } /* Usado para "Agotado" */

        /* --- IMAGEN DEL MODAL --- */
        .modal-image {
            object-fit: contain; 
            height: 450px;       
            width: 100%;         
            display: block;      
            background-color: #f0f0f0; 
        }
        /* Estilos para el panel de administración */
        .order-item {
            border: 1px solid #dee2e6;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>

    <div class="container my-5">
        
        <div class="d-flex align-items-center justify-content-center mb-5">
            <img src="https://imgur.com/mpCQaZg.jpg" alt="Logo de mi tienda" style="max-width: 250px; height: auto;">
        </div>
        <h1 class="text-center mb-5" style="color: #ff3366;">RPLAY</h1>
        
        <div class="container mb-5" id="manualManagementPanel" style="display:none;">
            <h3 class="text-danger mb-3">Administración de Pedidos Apartados</h3>
            <p class="text-muted small">Estos pedidos han sido **reservados temporalmente** (se restó del stock al cliente ver la ficha de pago). Haz clic en "Liberar Stock" si el cliente NO completó el pago.</p>
            <div id="ordersList" class="p-3 border rounded bg-white">
                <p class="text-center text-secondary" id="noOrdersMessage">No hay pedidos pendientes actualmente.</p>
            </div>
            <hr>
            <button class="btn btn-sm btn-outline-danger" onclick="resetAllStock()">REINICIAR TODO EL INVENTARIO Y ÓRDENES</button>
            <p class="text-muted small mt-2">
                Para *modificar el stock inicial*, usa la función **setStock** en la consola (F12).
                <br>Ejemplo: **setStock('PROD_001', 'Default', 'M', 5)**
                <br>Para **mostrar** este panel, usa la función **showAdminPanel()** en la consola.
            </p>
        </div>
        
        <div class="row" id="product-list">
        </div>
    </div>

    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalLabel">Detalle y Pago</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
                                <div class="carousel-indicators">
                                    <button type="button" data-bs-target="#productCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
                                    <button type="button" data-bs-target="#productCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
                                    <button type="button" data-bs-target="#productCarousel" data-bs-slide-to="2" aria-label="Slide 3"></button>
                                </div>
                                <div class="carousel-inner">
                                    <div class="carousel-item active">
                                        <img id="modal-img-front" src="" class="modal-image" alt="Delantera de la Playera">
                                    </div>
                                    <div class="carousel-item">
                                        <img id="modal-img-back" src="" class="modal-image" alt="Espalda de la Playera">
                                    </div>
                                    <div class="carousel-item">
                                        <img id="modal-img-side" src="" class="modal-image" alt="Vista Lateral de la Playera">
                                    </div>
                                </div>
                                <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                </button>
                            </div>
                        </div>

                        <div class="col-md-6">
                            
                            <div id="selection-step">
                                <h4 class="mt-3" id="product-name"></h4>
                                <p class="text-muted" id="product-description"></p>
                                
                                <div class="mb-4" id="color-selection-container" style="display:none;">
                                    <h6>Color:</h6>
                                    <div id="color-options"></div>
                                </div>

                                <div class="mb-4">
                                    <h6>Talla:</h6>
                                    <div id="size-options"></div>
                                    <small id="size-status" class="text-secondary mt-2"></small>
                                </div>
                                
                                <div class="mb-4">
                                    <h6>Cantidad de Piezas:</h6>
                                    <input type="number" id="quantityInput" class="form-control" value="1" min="1" max="10" style="width: 100px;">
                                    <small id="quantity-status" class="text-secondary mt-2"></small>
                                </div>
                                
                                <hr>
                                
                                <p>Precio Total: <strong id="total-price" class="text-danger"></strong></p>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" value="" id="halfPaymentCheck" checked>
                                    <label class="form-check-label" for="halfPaymentCheck">Pagar la Mitad Ahora (Apartar)</label>
                                </div>
                                <p>Monto a Pagar Ahora: <strong id="payment-due" style="font-size: 1.4rem; color: green;"></strong></p>
                                <small class="text-muted">El resto se pagará al momento de la entrega el 28 de Noviembre.</small>
                            </div>

                            <div id="payment-step" style="display:none;">
                                <h4 class="mt-3 mb-4">Datos del Comprador y Envío</h4>
                                <p class="alert alert-info small">
                                    Estás comprando <strong id="final-quantity-display">1</strong> pieza(s) talla <strong id="final-size-display"></strong> por <strong id="final-price-display"></strong>.
                                    Llena tus datos para guardar el pedido y ver las instrucciones de pago por transferencia.
                                </p>

                                <div class="mb-3">
                                    <label for="clientName" class="form-label">Nombre Completo (*):</label>
                                    <input type="text" class="form-control" id="clientName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="clientPhone" class="form-label">Teléfono/WhatsApp (*):</label>
                                    <input type="tel" class="form-control" id="clientPhone" required>
                                </div>
                                <div class="mb-3">
                                    <label for="clientAddress" class="form-label">Dirección de Envío Completa (*):</label>
                                    <textarea class="form-control" id="clientAddress" rows="2" required></textarea>
                                </div>
                                
                                <div id="payment-error" class="text-danger mb-3" style="display:none;">Por favor, completa todos los campos requeridos (*).</div>
                            </div>
                            
                            <div id="transfer-info" style="display:none;">
                                <h4 class="mt-3 mb-4 text-success">¡Pedido Generado!</h4>
                                <p>Hola <strong id="client-name-display"></strong>. Para confirmar tu compra de <span id="final-qty-conf">1</span> playera(s) (<span id="final-item-display"></span>, Talla <span id="final-size-conf"></span>), realiza la transferencia por el monto de <strong id="final-amount-conf" class="text-success"></strong> a la siguiente cuenta:</p>
                                <hr>
                                
                                <h5 class="text-primary">Datos de Transferencia Bancaria</h5>
                                <p class="mb-1"><strong>Banco:</strong> BANCOMER (BBVA)</p>
                                <p class="mb-1"><strong>Número de Cuenta:</strong> 0123 4567 8901 2345</p>
                                <p class="mb-1"><strong>CLABE Interbancaria:</strong> 012000000000000000</p>
                                <p class="mb-1"><strong>Beneficiario:</strong> MI TIENDA DE PLAYERAS S.A. DE C.V.</p>
                                
                                <hr>
                                <p class="text-center">¡Haz clic en el botón de WhatsApp abajo para enviar tus datos y el comprobante! **(El stock se descontará de forma permanente al presionar)**</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <a href="#" target="_blank" class="btn btn-success" id="whatsapp-confirm-button" style="display:none;">
                        Enviar Comprobante por WhatsApp
                    </a>
                    
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="modal-close-button">Cerrar</button>
                    
                    <button type="button" class="btn btn-buy" id="modal-main-button" disabled>Pagar Ahora</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        
        // --- 1. CONFIGURACIÓN GLOBAL ---
        const WHATSAPP_NUMBER = '5219991480151'; 
        const FIXED_PRICE = 250.00; 
        const DEFAULT_STOCK_PER_SIZE = 1;
        const DEFAULT_GLOBAL_SIZES = ["S", "M", "L", "XL"]; 

        // Estructuras de datos
        const productInventory = {}; 
        const productData = []; 
        let PENDING_ORDERS = []; 
        let orderIdCounter = 0; 

        const PRODUCT_LIST_CONTAINER = document.getElementById('product-list');
        // Valores por defecto para la selección actual. Se inicializan al abrir el modal.
        let currentSelection = { 
            productId: null, 
            color: 'Default', 
            size: 'M', 
            quantity: 1, 
            orderId: null 
        };
        
        // --- FUNCIONES DE ADMINISTRACIÓN (Acceso por Consola) ---
        
        // COMANDO PARA MOSTRAR EL PANEL DE ADMINISTRACIÓN (Requerimiento del usuario)
        function showAdminPanel() {
            const adminPanel = document.getElementById('manualManagementPanel');
            if (adminPanel) {
                adminPanel.style.display = 'block';
                renderOrdersList(); 
                console.log("✅ Panel de Administración de Pedidos activado. Para ocultar: hideAdminPanel()");
            }
        }
        
        function hideAdminPanel() {
            const adminPanel = document.getElementById('manualManagementPanel');
            if (adminPanel) {
                adminPanel.style.display = 'none';
                console.log("Panel de Administración de Pedidos oculto.");
            }
        }

        // Esta función es global y usable en consola.
        function setStock(productId, colorName, size, newStock) {
            if (productInventory[productId] && productInventory[productId][colorName]) {
                productInventory[productId][colorName][size] = newStock;
                saveInventoryStorage();
                renderProductCards();
                renderOrdersList();
                console.log(`Stock actualizado: ${productId}, ${colorName}, Talla ${size} -> ${newStock}`);
            } else {
                console.error('Error: Producto, color o talla no encontrado para actualizar stock.');
            }
        }
        
        // --- 2. GESTIÓN DEL INVENTARIO Y STORAGE ---

        function saveInventoryStorage() {
            localStorage.setItem('productInventory', JSON.stringify(productInventory));
            localStorage.setItem('pendingOrders', JSON.stringify(PENDING_ORDERS));
            localStorage.setItem('orderIdCounter', orderIdCounter);
        }

        function loadInventoryStorage() {
            const storedInventory = localStorage.getItem('productInventory');
            const storedOrders = localStorage.getItem('pendingOrders');
            const storedCounter = localStorage.getItem('orderIdCounter');
            
            // Si hay inventario guardado, lo fusionamos con la estructura inicial.
            if (storedInventory) {
                const tempInventory = JSON.parse(storedInventory);
                for (const productId in tempInventory) {
                    if (productInventory[productId]) {
                        for (const color in tempInventory[productId]) {
                            if (productInventory[productId][color]) {
                                productInventory[productId][color] = tempInventory[productId][color];
                            }
                        }
                    }
                }
            }
            if (storedOrders) {
                PENDING_ORDERS = JSON.parse(storedOrders);
            }
            if (storedCounter) {
                orderIdCounter = parseInt(storedCounter);
            }
        }

        function getStock(productId, colorName, size) {
            return productInventory[productId]?.[colorName]?.[size] || 0;
        }
        
        function resetAllStock() {
            if (confirm("¿Estás seguro de que quieres REINICIAR TODO el inventario y borrar todas las órdenes pendientes? Esta acción es irreversible.")) {
                localStorage.removeItem('productInventory');
                localStorage.removeItem('pendingOrders');
                localStorage.removeItem('orderIdCounter');
                // Vuelve a cargar el inventario inicial
                generateInitialInventory(); 
                PENDING_ORDERS = [];
                orderIdCounter = 0;
                renderProductCards();
                renderOrdersList();
                alert("Inventario y órdenes reiniciados con éxito.");
            }
        }
        
        // --- 3. FUNCIONES DE RESERVA Y LIBERACIÓN ---
        
        // Reserva el stock (lo descuenta temporalmente) y crea la orden pendiente
        function reserveStock(productId, colorName, size, quantity, clientName, clientPhone, clientAddress) {
            const currentStock = getStock(productId, colorName, size);
            
            if (currentStock < quantity) {
                return false; 
            }

            // 1. Descontar stock (reserva temporal)
            setStock(productId, colorName, size, currentStock - quantity);

            // 2. Crear y guardar la orden pendiente
            orderIdCounter++;
            const order = {
                id: orderIdCounter,
                timestamp: new Date().getTime(),
                productId: productId,
                colorName: colorName,
                size: size,
                quantity: quantity,
                clientName: clientName,
                clientPhone: clientPhone,
                clientAddress: clientAddress,
                productName: productData.find(p => p.id === productId).name,
                isConfirmed: false 
            };
            
            PENDING_ORDERS.push(order);
            saveInventoryStorage();
            renderOrdersList();
            
            return order;
        }
        
        // Descuenta el stock permanentemente (remueve de la lista de gestión, ya se descontó antes)
        function applyStockReduction(order) {
            // Nota: El stock ya fue descontado en `reserveStock`. 
            // Esto solo remueve la orden de la lista de "pendientes por liberar".
            PENDING_ORDERS = PENDING_ORDERS.filter(o => o.id !== order.id);
            saveInventoryStorage();
            renderOrdersList();
        }

        // Libera el stock (lo devuelve al inventario si el pago no se hizo)
        function releaseStock(order) {
            // 1. Devolver el stock al inventario
            const currentStock = getStock(order.productId, order.colorName, order.size);
            setStock(order.productId, order.colorName, order.size, currentStock + order.quantity);

            // 2. Eliminar la orden de la lista de pendientes
            PENDING_ORDERS = PENDING_ORDERS.filter(o => o.id !== order.id);
            saveInventoryStorage();
            renderOrdersList();
            renderProductCards(); // Asegurar que las tarjetas se actualicen
        }

        function releaseOrderManually(orderId) {
            const order = PENDING_ORDERS.find(o => o.id === orderId);
            if (order && confirm(`¿Seguro que quieres liberar la reserva para ${order.clientName} (Talla ${order.size}, Cantidad ${order.quantity})? El stock volverá al inventario.`)) {
                releaseStock(order);
            }
        }
        
        // --- 4. RENDERIZADO ---
        
        function renderOrdersList() {
            const listContainer = document.getElementById('ordersList');
            if (!listContainer) return; 
            
            listContainer.innerHTML = '';

            if (PENDING_ORDERS.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-secondary" id="noOrdersMessage">No hay pedidos pendientes actualmente.</p>';
                return;
            }

            PENDING_ORDERS.forEach(order => {
                const orderDiv = document.createElement('div');
                orderDiv.className = 'order-item d-flex justify-content-between align-items-center';
                orderDiv.innerHTML = `
                    <div>
                        <small class="text-muted">Pedido #${order.id} | ${new Date(order.timestamp).toLocaleTimeString()}</small><br>
                        <strong>${order.clientName}</strong> (${order.clientPhone})<br>
                        ${order.quantity}x ${order.productName} (Talla: ${order.size})<br>
                        <small>Dir: ${order.clientAddress}</small>
                    </div>
                    <button class="btn btn-sm btn-outline-warning" onclick="releaseOrderManually(${order.id})">Liberar Stock</button>
                `;
                listContainer.appendChild(orderDiv);
            });
        }
        
        function renderProductCards() {
            PRODUCT_LIST_CONTAINER.innerHTML = '';
            productData.forEach(product => {
                const colors = Object.keys(product.variants);
                const firstColor = colors[0] || 'Default';
                const mainVariant = product.variants[firstColor];
                
                let totalStock = 0;
                // Sumar stock de todas las variantes/tallas
                for (const color in productInventory[product.id]) {
                    for (const size in productInventory[product.id][color]) {
                        totalStock += productInventory[product.id][color][size];
                    }
                }

                let badgeClass = 'out-stock';
                let badgeText = 'Agotado';
                
                // --- LÓGICA DE BADGE: Preventa o Agotado (Requerimiento del usuario) ---
                if (totalStock > 0) {
                    badgeClass = 'in-stock'; 
                    badgeText = 'Preventa';
                }

                const cardHtml = `
                    <div class="col-lg-3 col-md-4 col-sm-6">
                        <div class="card product-card" style="position: relative;">
                            <span class="stock-badge ${badgeClass}">${badgeText}</span>
                            <img src="${mainVariant.img_front}" class="card-img-top" alt="${product.name}">
                            <div class="card-body">
                                <h5 class="card-title">${product.name}</h5>
                                <p class="card-text text-muted small">${product.description}</p>
                                <p class="card-text"><strong>$${FIXED_PRICE.toFixed(2)} MXN</strong></p>
                                <button class="btn btn-buy w-100" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#paymentModal" 
                                    data-product-id="${product.id}">
                                    Comprar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                PRODUCT_LIST_CONTAINER.innerHTML += cardHtml;
            });
        }

        // --- 5. DATOS DE INVENTARIO (44 Playeras con URLs correctas) ---

        function generateInitialInventory() {
            // Limpiar datos anteriores para regenerar
            productData.length = 0; 
            for (const key in productInventory) { delete productInventory[key]; }

            for (let i = 1; i <= 44; i++) { 
                const id = `PROD_${String(i).padStart(3, '0')}`;
                let modelSizes = [...DEFAULT_GLOBAL_SIZES]; 
                let initialStockOverrides = {}; 
                let productName = `Playera Modelo No. ${i}`; 
                let productDescription = `Diseño exclusivo #${i}. ¡Modifica este texto!`;
                let variants = {}; 

                let mainImg, frontImg, backImg, sideImg;

                if (i < 43) {
                    // --- ZONA DE DATOS DE PRODUCTOS INDIVIDUALES (1 a 42) ---
                    const BASE_URL = 'https://ventaplayera.github.io/RPLAY/';

                    if (i === 1) { 
                        productName = 'Playera Dama Xime Blanco'; 
                        productDescription = 'Diseño original de Xime en blanco. ¡Edición especial!';
                        frontImg = `${BASE_URL}Xime1.png`; 
                        backImg = `${BASE_URL}Xime2.png`; 
                        sideImg = `${BASE_URL}blanco.png`; 
                        initialStockOverrides = { M: 1, L: 1, XL: 1};
                    } else if (i === 2) { 
                        productName = 'Playera Dama Xime Negro'; 
                        productDescription = 'Diseño original de Xime en negro. ¡Edición especial!';
                        frontImg = `${BASE_URL}Xime3.png`; 
                        backImg = `${BASE_URL}Xime4.png`; 
                        sideImg = `${BASE_URL}negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 3) { 
                        productName = 'Playera Dama Lucy Diseño 1'; 
                        productDescription = 'Diseño de Lucy #1, disponible en talla M y XL.'; 
                        frontImg = `${BASE_URL}Lucy1.png`; 
                        backImg = `${BASE_URL}Lucy2.png`; 
                        sideImg = `${BASE_URL}negro.png`; 
                        initialStockOverrides = {M: 1, XL: 1}; 
                        modelSizes = ['M','XL'];
                    } else if (i === 4) { 
                        productName = 'Playera Dama Lucy Diseño 2'; 
                        productDescription = 'Diseño de Lucy #2, ¡perfecta para el verano!'; 
                        frontImg = `${BASE_URL}Lucy3.png`; 
                        backImg = `${BASE_URL}Lucy4.png`; 
                        sideImg = `${BASE_URL}blanco.png`; 
                        initialStockOverrides = { M: 1, L:1, XL: 2};
                    } else if (i === 5) { 
                        productName = 'Playera Dama Raúl Diseño 1'; 
                        productDescription = 'Modelo exclusivo Raúl #1, color negro.'; 
                        frontImg = `${BASE_URL}Raul1.png`; 
                        backImg = `${BASE_URL}Raul2.png`; 
                        sideImg = `${BASE_URL}negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 6) { 
                        productName = 'Playera Dama Raúl Diseño 2'; 
                        productDescription = 'Modelo exclusivo Raúl #2, color negro.'; 
                        frontImg = `${BASE_URL}Raul3.png`; 
                        backImg = `${BASE_URL}Raul4.png`; 
                        sideImg = `${BASE_URL}negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 7) { 
                        productName = 'Playera Dama Abi Blanco'; 
                        productDescription = 'Diseño Abi en blanco, estilo minimalista.'; 
                        frontImg = `${BASE_URL}Abi1.png`; 
                        backImg = `${BASE_URL}Abi2.png`; 
                        sideImg = `${BASE_URL}blanco.png`; 
                        initialStockOverrides = {S:1, M: 1, G: 1};
                    } else if (i === 8) { 
                        productName = 'Playera Dama Abi Negro'; 
                        productDescription = 'Diseño Abi en negro, solo en tallas M y L.'; 
                        frontImg = `${BASE_URL}Abi3.png`; 
                        backImg = `${BASE_URL}Abi4.png`;
                        sideImg = `${BASE_URL}negro.png`; 
                        initialStockOverrides = {M: 1, G: 1}; 
                        modelSizes = ['M', 'L'];
                    } else if (i === 9) { 
                        productName = 'Playera Dama Dani Blanco'; 
                        productDescription = 'Playera Dani en color blanco, cómoda y casual.'; 
                        frontImg = `${BASE_URL}Dani1.png`; 
                        backImg = `${BASE_URL}Dani2.png`; 
                        sideImg = `${BASE_URL}blanco.png`; 
                        initialStockOverrides = { M: 1, L: 1, XL: 1};
                    } else if (i === 10) { 
                        productName = 'Playera Dama Dani Negro'; 
                        productDescription = 'Playera Dani en color negro, ideal para cualquier ocasión.'; 
                        frontImg = `${BASE_URL}Dani3.png`; 
                        backImg = `${BASE_URL}Dani4.png`; 
                        sideImg = `${BASE_URL}negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 11) { 
                        productName = 'Playera Dama Dali Diseño 1'; 
                        productDescription = 'Diseño original Dali #1. ¡Atrévete a usarla!'; 
                        frontImg = `${BASE_URL}Dali1.png`; 
                        backImg = `${BASE_URL}Dali2.png`; 
                        sideImg = `${BASE_URL}negro.png`; 
                        initialStockOverrides = { M: 1, L: 1, XL: 1};
                    } else if (i === 12) { 
                        productName = 'Playera Dama Dali Diseño 2'; 
                        productDescription = 'Diseño original Dali #2. La mejor calidad.'; 
                        frontImg = `${BASE_URL}Dali3.png`; 
                        backImg = `${BASE_URL}Dali4.png`; 
                        sideImg = `${BASE_URL}negro.png`; 
                        initialStockOverrides = { M: 1, L: 1, XL: 1};
                    } else if (i === 13) { 
                        productName = 'Playera Yose Diseño 1'; 
                        productDescription = 'Playera unisex Yose, diseño sencillo en negro.'; 
                        frontImg = `${BASE_URL}Yose1.png`; 
                        backImg = `${BASE_URL}Yose2.png`; 
                        sideImg = `${BASE_URL}negro.png`; 
                        initialStockOverrides = {L: 3, XL: 1};
                    } else if (i === 14) { 
                        productName = 'Playera Yose Diseño 2'; 
                        productDescription = 'Playera unisex Yose, diseño impactante en negro.'; 
                        frontImg = `${BASE_URL}Yose3.png`; 
                        backImg = `${BASE_URL}Yose4.png`; 
                        sideImg = `${BASE_URL}negro.png`; 
                        initialStockOverrides = { L: 1, XL: 1};
                    } else if (i === 15) { 
                        productName = 'Playera Keila Blanco'; 
                        productDescription = 'Playera Keila en blanco. Estilo juvenil.'; 
                        frontImg = `${BASE_URL}Keila1.png`; 
                        backImg = `${BASE_URL}Keila2.png`; 
                        sideImg = `${BASE_URL}blanco.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 16) { 
                        productName = 'Playera Keila Negro'; 
                        productDescription = 'Playera Keila en negro. Estilo juvenil.'; 
                        frontImg = `${BASE_URL}Keila3.png`; 
                        backImg = `${BASE_URL}Keila4.png`; 
                        sideImg = `${BASE_URL}negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 17) { 
                        productName = 'Playera Kenji Diseño 1'; 
                        productDescription = 'Playera Kenji con diseño clásico.'; 
                        frontImg = `${BASE_URL}Kenji1.png`; 
                        backImg = `${BASE_URL}Kenji2.png`; 
                        sideImg = `${BASE_URL}negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 18) { 
                        productName = 'Playera Kenji Diseño 2'; 
                        productDescription = 'Playera Kenji con diseño moderno.'; 
                        frontImg = `${BASE_URL}Kenji3.png`; 
                        backImg = `${BASE_URL}Kenji4.png`; 
                        sideImg = `${BASE_URL}negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 19) { 
                        productName = 'Playera Alli Diseño 1'; 
                        productDescription = 'Playera Alli en negro. Estilo casual.'; 
                        frontImg = `${BASE_URL}Alli1.png`; 
                        backImg = `${BASE_URL}Alli2.png`; 
                        sideImg = `${BASE_URL}negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 20) { 
                        productName = 'Playera Alli Diseño 2'; 
                        productDescription = 'Playera Alli en negro. Diseño geométrico.'; 
                        frontImg = `${BASE_URL}Alli3.png`; 
                        backImg = `${BASE_URL}Alli4.png`; 
                        sideImg = `${BASE_URL}negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 21) { 
                        productName = 'Playera Ale Diseño 1'; 
                        productDescription = 'Playera Ale en color arena. Diseño elegante.'; 
                        frontImg = `${BASE_URL}Ale1.png`; 
                        backImg = `${BASE_URL}Ale2.png`; 
                        sideImg = `${BASE_URL}arena.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 22) { 
                        productName = 'Playera Ale Diseño 2'; 
                        productDescription = 'Playera Ale en color arena. Diseño exclusivo.'; 
                        frontImg = `${BASE_URL}Ale3.png`; 
                        backImg = `${BASE_URL}Ale4.png`; 
                        sideImg = `${BASE_URL}arena.png`; 
                        initialStockOverrides = { M: 1, L: 1, XL: 1};
                    } else if (i === 23) { 
                        productName = 'Playera Miri Diseño 1'; 
                        productDescription = 'Playera Miri en negro. Diseño artístico.'; 
                        frontImg = `${BASE_URL}Miri1.png`; 
                        backImg = `${BASE_URL}Miri2.png`; 
                        sideImg = `${BASE_URL}negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 24) { 
                        productName = 'Playera Miri Diseño 2'; 
                        productDescription = 'Playera Miri en negro. Diseño de texto.'; 
                        frontImg = `${BASE_URL}Miri3.png`;
                        backImg = `${BASE_URL}Miri4.png`; 
                        sideImg = `${BASE_URL}negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 25) { 
                        productName = 'Playera Didi Diseño 1'; 
                        productDescription = 'Playera Didi en negro. Diseño simple.'; 
                        frontImg = `${BASE_URL}Didi1.png`; 
                        backImg = `${BASE_URL}Didi2.png`; 
                        sideImg = `${BASE_URL}negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 26) { 
                        productName = 'Playera Didi Diseño 2'; 
                        productDescription = 'Playera Didi en arena. Diseño de texto.'; 
                        frontImg = `${BASE_URL}Didi3.png`; 
                        backImg = `${BASE_URL}Didi4.png`; 
                        sideImg = `${BASE_URL}arena.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 27) { 
                        productName = 'Playera Vale Diseño 1'; 
                        productDescription = 'Playera Vale en arena. Estilo fresco.'; 
                        frontImg = `${BASE_URL}Vale1.png`; 
                        backImg = `${BASE_URL}Vale2.png`; 
                        sideImg = `${BASE_URL}arena.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 28) { 
                        productName = 'Playera Vale Diseño 2'; 
                        productDescription = 'Playera Vale en negro. Diseño de líneas.'; 
                        frontImg = `${BASE_URL}Vale3.png`;
                        backImg = `${BASE_URL}Vale4.png`; 
                        sideImg = `${BASE_URL}negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 29) { 
                        productName = 'Playera Caro Diseño 1'; 
                        productDescription = 'Playera Caro en negro. Diseño de mariposas.'; 
                        frontImg = `${BASE_URL}Caro1.png`; 
                        backImg = `${BASE_URL}Caro2.png`; 
                        sideImg = `${BASE_URL}negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 30) { 
                        productName = 'Playera Caro Diseño 2'; 
                        productDescription = 'Playera Caro en blanco. Diseño floral.'; 
                        frontImg = `${BASE_URL}Caro3.png`; 
                        backImg = `${BASE_URL}Caro4.png`; 
                        sideImg = `${BASE_URL}blanco.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 31) { 
                        productName = 'Playera Mary Diseño 1'; 
                        productDescription = 'Playera Mary en negro. Diseño moderno.'; 
                        frontImg = `${BASE_URL}Gon1.PNG`; 
                        backImg = `${BASE_URL}Gon2.PNG`; 
                        sideImg = `${BASE_URL}negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 32) { 
                        productName = 'Playera Mary Diseño 2'; 
                        productDescription = 'Playera Mary en negro. Diseño de estrellas.'; 
                        frontImg = `${BASE_URL}Katy3.png`; 
                        backImg = `${BASE_URL}Katy4.png`; 
                        sideImg = `${BASE_URL}negro.png`; 
                        initialStockOverrides = {M: 1, L: 1, XL: 1};
                    } else if (i === 33) { 
                        productName = 'Playera Lalo Diseño 1'; 
                        productDescription = 'Playera Lalo en blanco. Diseño simple.'; 
                        frontImg = `${BASE_URL}Bere1.png`; 
                        backImg = `${BASE_URL}Bere2.png`; 
                        sideImg = `${BASE_URL}blanco2.png`; 
                        initialStockOverrides = {S:1, M: 1, G:1};
                    } else if (i === 34) { 
                        productName = 'Playera Lalo Diseño 2'; 
                        productDescription = 'Playera Lalo en negro. Diseño de líneas.'; 
                        frontImg = `${BASE_URL}Bere3.png`; 
                        backImg = `${BASE_URL}Bere4.png`; 
                        sideImg = `${BASE_URL}negro2.png`; 
                        initialStockOverrides = {S:1, M: 1, G: 1;
                    } else if (i === 35) { 
                        productName = 'Playera Dama Vane Diseño 1'; 
                        productDescription = 'Playera Vane en blanco. Diseño primaveral.'; 
                        frontImg = `${BASE_URL}Dan1.png`; 
                        backImg = `${BASE_URL}Dan2.png`; 
                        sideImg = `${BASE_URL}blanco2.png`; 
                        initialStockOverrides = {S:1, M: 1, G: 1};
                    } else if (i === 36) { 
                        productName = 'Playera Dama Vane Diseño 2'; 
                        productDescription = 'Playera Vane en negro. Diseño de mar.'; 
                        frontImg = `${BASE_URL}Dan3.png`; 
                        backImg = `${BASE_URL}Dan4.png`; 
                        sideImg = `${BASE_URL}negro2.png`; 
                        initialStockOverrides = {S:1, M: 1, G: 1};
                    } else if (i === 37) { 
                        productName = 'Playera Dama Caro Diseño 3'; 
                        productDescription = 'Playera Caro en arena. Diseño elegante.'; 
                        frontImg = `${BASE_URL}Gera1.png`; 
                        backImg = `${BASE_URL}Gera2.png`; 
                        sideImg = `${BASE_URL}negro2.png`; 
                        initialStockOverrides = {S:1, M: 1, G: 1};
                    } else if (i === 38) { 
                        productName = 'Playera Dama Caro Diseño 4'; 
                        productDescription = 'Playera Caro en negro. Diseño de luna.'; 
                        frontImg = `${BASE_URL}Gera3.png`; 
                        backImg = `${BASE_URL}Gera4.png`; 
                        sideImg = `${BASE_URL}negro2.png`; 
                        initialStockOverrides = {S:1, M: 1, G: 1};
                    } else if (i === 39) { 
                        productName = 'Playera Dama Neli Diseño 1'; 
                        productDescription = 'Playera Neli en blanco. Diseño de gato.'; 
                        frontImg = `${BASE_URL}Bra1.png`; 
                        backImg = `${BASE_URL}Bra2.png`; 
                        sideImg = `${BASE_URL}blanco2.png`; 
                        initialStockOverrides = {S:1, M: 1, G: 1};
                    } else if (i === 40) { 
                        productName = 'Playera Dama Neli Diseño 2'; 
                        productDescription = 'Playera Neli en negro. Diseño de texto.'; 
                        frontImg = `${BASE_URL}Bra3.png`; 
                        backImg = `${BASE_URL}Bra4.png`; 
                        sideImg = `${BASE_URL}negro2.png`; 
                        initialStockOverrides = {S:1, M: 1, G: 1};
                    } else if (i === 41) { 
                        productName = 'Playera Dama Sol Diseño 1'; 
                        productDescription = 'Playera Sol en blanco. Diseño de frase.'; 
                        frontImg = `${BASE_URL}Adri1.png`; 
                        backImg = `${BASE_URL}Adri2.png`; 
                        sideImg = `${BASE_URL}blanco2.png`; 
                        initialStockOverrides = {S:1, M: 1, G: 1};
                    } else if (i === 42) { 
                        productName = 'Playera Dama Sol Diseño 2'; 
                        productDescription = 'Playera Sol en negro. Diseño de mariposas.'; 
                        frontImg = `${BASE_URL}Adri3.png`; 
                        backImg = `${BASE_URL}Adri4.png`; 
                        sideImg = `${BASE_URL}negro2.png`; 
                        initialStockOverrides = {S:1, M: 1, G: 1};
                    }

                    // Lógica para productos de un solo color (Default)
                    let stock = {};
                    modelSizes.forEach(s => {
                        stock[s] = initialStockOverrides[s] !== undefined ? initialStockOverrides[s] : DEFAULT_STOCK_PER_SIZE;
                    });
                    
                    variants['Default'] = {
                        name: productName, 
                        img_front: frontImg,
                        img_back: backImg,
                        img_side: sideImg,
                        stock: stock
                    };
                    
                } else if (i === 43) { 
                    // Producto 43 con variantes de color Blanco y Negro
                    productName = 'Playera BLACKPINK BORN PINK (Multicolor)'; 
                    productDescription = 'Diseño Blackpink "BORN PINK" en negro/blanco. Edición especial.'; 
                    
                    variants['Blanco'] = {
                        name: 'Playera BLACKPINK (Blanca)', 
                        img_front: 'https://ventaplayera.github.io/RPLAY/Aro1.png',
                        img_back: 'https://ventaplayera.github.io/RPLAY/Aro2.png',
                        img_side: 'https://ventaplayera.github.io/RPLAY/blanco2.png',
                        stock: { S: 1, M: 1 } 
                    };
                    variants['Negro'] = {
                        name: 'Playera BLACKPINK (Negra)', 
                        img_front: 'https://ventaplayera.github.io/RPLAY/Aro3.png',
                        img_back: 'https://ventaplayera.github.io/RPLAY/Aro4.png',
                        img_side: 'https://ventaplayera.github.io/RPLAY/negro2.png',
                        stock: { G:1 }
                    };
                    mainImg = variants['Blanco'].img_front; 
                } else if (i === 44) { 
                    // Producto 44 con variantes de color Blanco y Negro
                    productName = 'Playera K-POP Diseño Coreano (Multicolor)'; 
                    productDescription = 'Diseño K-Pop minimalista, alta durabilidad.'; 
                    
                    variants['Blanco'] = {
                        name: 'Playera K-POP (Blanca)', 
                        img_front: 'https://ventaplayera.github.io/RPLAY/Aro5.png',
                        img_back: 'https://ventaplayera.github.io/RPLAY/Aro6.png',
                        img_side: 'https://ventaplayera.github.io/RPLAY/blanco2.png',
                        stock: { S: 1, M: 1}
                    };
                    variants['Negro'] = {
                        name: 'Playera K-POP (Negra)', 
                        img_front: 'https://ventaplayera.github.io/RPLAY/Aro7.png',
                        img_back: 'https://ventaplayera.github.io/RPLAY/Aro8.png',
                        img_side: 'https://ventaplayera.github.io/RPLAY/negro2.png',
                        stock: { G: 1 }
                    };
                    mainImg = variants['Negro'].img_front; 
                }
                
                // Inicializa la estructura del inventario de stock
                productInventory[id] = {};
                for (const colorName in variants) {
                    productInventory[id][colorName] = variants[colorName].stock;
                }

                // Guarda los datos del producto
                productData.push({
                    id: id,
                    name: productName,
                    description: productDescription,
                    price: FIXED_PRICE,
                    mainImg: mainImg,
                    sizes: modelSizes,
                    variants: variants,
                    hasColors: Object.keys(variants).length > 1
                });
            }
        }


        // --- 6. LÓGICA DEL MODAL (Ajustada para funcionar con la estructura de datos) ---
        
        function updateModalContent(product, selectedColor) {
            const variant = product.variants[selectedColor];
            
            document.getElementById('modal-img-front').src = variant.img_front;
            document.getElementById('modal-img-back').src = variant.img_back;
            document.getElementById('modal-img-side').src = variant.img_side;
            
            document.getElementById('product-name').textContent = variant.name;
            document.getElementById('product-description').textContent = product.description;

            // Renderizar opciones de talla (simplificado, asume que siempre hay tallas)
            const sizeOptionsContainer = document.getElementById('size-options');
            sizeOptionsContainer.innerHTML = '';
            
            const sizes = Object.keys(variant.stock).sort(); // Ordenar tallas

            sizes.forEach(size => {
                const stock = variant.stock[size];
                const button = document.createElement('button');
                button.type = 'button';
                button.className = `btn btn-outline-secondary btn-sm me-2 mb-2 size-option ${stock > 0 ? '' : 'disabled'}`;
                button.textContent = size;
                button.setAttribute('data-size', size);
                button.disabled = stock <= 0;
                button.addEventListener('click', () => {
                    document.querySelectorAll('.size-option').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    currentSelection.size = size;
                    updateTotalAndCheckStock();
                });
                sizeOptionsContainer.appendChild(button);
            });
            
            // Si el producto tiene colores, mostrarlos
            const colorContainer = document.getElementById('color-selection-container');
            if (product.hasColors) {
                colorContainer.style.display = 'block';
                const colorOptions = document.getElementById('color-options');
                colorOptions.innerHTML = '';
                Object.keys(product.variants).forEach(color => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = `btn btn-outline-dark btn-sm me-2 mb-2 color-option ${color === selectedColor ? 'active' : ''}`;
                    button.textContent = color;
                    button.setAttribute('data-color', color);
                    button.addEventListener('click', () => {
                        document.querySelectorAll('.color-option').forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        currentSelection.color = color;
                        updateModalContent(product, color); // Recargar contenido para la nueva variante
                        // Resetear la talla al cambiar de color
                        currentSelection.size = sizes[0]; 
                        updateTotalAndCheckStock();
                    });
                    colorOptions.appendChild(button);
                });
            } else {
                colorContainer.style.display = 'none';
            }

            // Seleccionar la primera talla disponible o la predeterminada
            const defaultSize = sizes.find(size => variant.stock[size] > 0) || sizes[0];
            currentSelection.size = defaultSize;

            if (document.querySelector(`.size-option[data-size="${defaultSize}"]`)) {
                document.querySelector(`.size-option[data-size="${defaultSize}"]`).classList.add('active');
            } else {
                 currentSelection.size = null; // Ninguna talla seleccionada si no hay stock
            }

            updateTotalAndCheckStock();
        }


        function updateTotalAndCheckStock() {
            const product = productData.find(p => p.id === currentSelection.productId);
            const quantityInput = document.getElementById('quantityInput');
            let quantity = parseInt(quantityInput.value);
            const size = currentSelection.size;
            const color = currentSelection.color;
            
            if (isNaN(quantity) || quantity < 1) {
                quantity = 1;
                quantityInput.value = 1;
            }

            currentSelection.quantity = quantity;
            
            let currentStock = 0;
            if (size && product && product.variants[color] && product.variants[color].stock[size] !== undefined) {
                currentStock = product.variants[color].stock[size];
            }

            const isAvailable = currentStock >= quantity;
            const stockStatus = document.getElementById('size-status');
            const mainButton = document.getElementById('modal-main-button');
            
            if (currentStock === 0) {
                 stockStatus.textContent = `Agotada en Talla ${size}.`;
                 mainButton.disabled = true;
            } else if (!isAvailable) {
                stockStatus.textContent = `Solo quedan ${currentStock} pieza(s) en Talla ${size}. Ajusta la cantidad.`;
                mainButton.disabled = true;
            } else {
                stockStatus.textContent = `Disponible: ${currentStock} pieza(s) en Talla ${size}.`;
                mainButton.disabled = false;
            }

            if (!currentSelection.size) { // Si no hay talla seleccionada (todo agotado)
                stockStatus.textContent = `No hay stock disponible para este modelo.`;
                mainButton.disabled = true;
            }
            
            const totalPrice = (FIXED_PRICE * quantity).toFixed(2);
            const halfPayment = (FIXED_PRICE * quantity / 2).toFixed(2);

            document.getElementById('total-price').textContent = `$${totalPrice} MXN`;
            document.getElementById('payment-due').textContent = `$${halfPayment} MXN`;
        }

        function openModalDetail(productId) {
            const product = productData.find(p => p.id === productId);
            if (!product) return;
            
            currentSelection.productId = productId;
            // Seleccionar color por defecto (el primero)
            const firstColor = Object.keys(product.variants)[0];
            currentSelection.color = firstColor;

            updateModalContent(product, firstColor); 
            // Forzar el paso de selección al abrir
            updateModalUI(false); 
        }

        function updateModalUI(step, order = null) {
            const selectionStep = document.getElementById('selection-step');
            const paymentStep = document.getElementById('payment-step');
            const transferInfo = document.getElementById('transfer-info');
            const modalMainButton = document.getElementById('modal-main-button');
            const whatsappButton = document.getElementById('whatsapp-confirm-button');
            
            // Limpiar errores
            document.getElementById('payment-error').style.display = 'none';

            if (step === false) { // Paso 1: Selección de producto/talla/cantidad
                selectionStep.style.display = 'block';
                paymentStep.style.display = 'none';
                transferInfo.style.display = 'none';
                modalMainButton.style.display = 'block';
                modalMainButton.textContent = 'Pagar Ahora';
                modalMainButton.onclick = moveToPaymentStep;
                whatsappButton.style.display = 'none';
                updateTotalAndCheckStock(); // Revisa si el botón debe estar activo
            } else if (step === 'payment') { // Paso 2: Datos del cliente
                selectionStep.style.display = 'none';
                paymentStep.style.display = 'block';
                transferInfo.style.display = 'none';
                modalMainButton.style.display = 'block';
                modalMainButton.textContent = 'Reservar y Ver Pago';
                modalMainButton.disabled = false;
                modalMainButton.onclick = processOrderReservation;
                whatsappButton.style.display = 'none';
            } else if (step === 'confirmed' && order) { // Paso 3: Info de transferencia
                selectionStep.style.display = 'none';
                paymentStep.style.display = 'none';
                transferInfo.style.display = 'block';
                modalMainButton.style.display = 'none';
                
                // Preparar la info final
                const halfPrice = (FIXED_PRICE * order.quantity / 2).toFixed(2);
                const whatsappMsg = `¡Hola! Acabo de hacer un apartado. Mi orden es *#${order.id}*.\n\n*Producto:* ${order.productName}\n*Color:* ${order.colorName}\n*Talla:* ${order.size}\n*Cantidad:* ${order.quantity}\n*Monto de Apartado:* $${halfPrice} MXN\n\n*Mis Datos:*\n*Nombre:* ${order.clientName}\n*Teléfono:* ${order.clientPhone}\n*Dirección:* ${order.clientAddress}\n\nAquí adjunto el comprobante de pago por $${halfPrice} MXN.`;

                whatsappButton.href = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(whatsappMsg)}`;
                whatsappButton.setAttribute('data-order-id', order.id);
                whatsappButton.style.display = 'block';
                
                // Actualizar la UI de confirmación
                document.getElementById('client-name-display').textContent = order.clientName;
                document.getElementById('final-qty-conf').textContent = order.quantity;
                document.getElementById('final-item-display').textContent = order.productName;
                document.getElementById('final-size-conf').textContent = order.size;
                document.getElementById('final-amount-conf').textContent = `$${halfPrice} MXN`;
                document.getElementById('modal-close-button').textContent = 'Cerrar';
                whatsappButton.removeAttribute('data-stock-applied'); 
            }
        }
        
        function moveToPaymentStep() {
            // Se asume que updateTotalAndCheckStock ya se ejecutó y validó la disponibilidad
            if (document.getElementById('modal-main-button').disabled) {
                return; 
            }
            
            const selectedProduct = productData.find(p => p.id === currentSelection.productId);
            const quantity = currentSelection.quantity;
            const totalPrice = (FIXED_PRICE * quantity).toFixed(2);
            
            document.getElementById('final-quantity-display').textContent = quantity;
            document.getElementById('final-size-display').textContent = currentSelection.size;
            document.getElementById('final-price-display').textContent = `$${totalPrice} MXN`;
            
            updateModalUI('payment');
        }

        function processOrderReservation() {
            const clientName = document.getElementById('clientName').value.trim();
            const clientPhone = document.getElementById('clientPhone').value.trim();
            const clientAddress = document.getElementById('clientAddress').value.trim();
            const errorDiv = document.getElementById('payment-error');
            const selectedQuantity = currentSelection.quantity;

            if (!clientName || !clientPhone || !clientAddress) {
                errorDiv.style.display = 'block';
                return;
            }

            errorDiv.style.display = 'none';
            
            // Intentar reservar el stock (descuenta temporalmente)
            const order = reserveStock(
                currentSelection.productId,
                currentSelection.color, 
                currentSelection.size,  
                selectedQuantity, 
                clientName,
                clientPhone,
                clientAddress
            );

            if (order) {
                // Reserva exitosa, muestra la info de transferencia
                updateModalUI('confirmed', order);
            } else {
                // Esto no debería ocurrir si el botón se desactiva correctamente, pero es una buena medida de seguridad
                alert("Error de stock: Lo sentimos, se ha agotado el stock de esa talla/cantidad mientras realizabas el pedido. Por favor, intenta con otra selección.");
                updateModalUI(false); 
            }
        }


        // --- 7. LISTENERS PRINCIPALES ---
        
        document.addEventListener('DOMContentLoaded', () => {
            generateInitialInventory();
            loadInventoryStorage();
            renderProductCards();
            
            // Listener para el botón de WhatsApp (descuenta el stock permanentemente)
            const whatsappButton = document.getElementById('whatsapp-confirm-button');

            if (whatsappButton) {
                whatsappButton.addEventListener('click', (event) => {
                    
                    if (whatsappButton.getAttribute('data-stock-applied') !== 'true') {
                        
                        const orderIdToApply = parseInt(whatsappButton.getAttribute('data-order-id'));
                        const order = PENDING_ORDERS.find(o => o.id === orderIdToApply);
                        
                        if (order) {
                            // Aplicar la reducción PERMANENTE (remueve de la lista de gestión)
                            applyStockReduction(order); 
                            whatsappButton.setAttribute('data-stock-applied', 'true');
                        }
                    }
                    // El evento sigue su curso y abre WhatsApp
                });
            }
            
            // Listener para abrir el modal desde las tarjetas
            document.getElementById('product-list').addEventListener('click', (e) => {
                if (e.target.matches('.btn-buy')) {
                    const productId = e.target.getAttribute('data-product-id');
                    openModalDetail(productId); 
                }
            });
            
            // Listener para actualizar precio/stock al cambiar cantidad
            const quantityInput = document.getElementById('quantityInput');
            if (quantityInput) {
                quantityInput.addEventListener('change', updateTotalAndCheckStock);
                quantityInput.addEventListener('input', updateTotalAndCheckStock);
            }

            // Resetear el modal al cerrarse
            const paymentModal = document.getElementById('paymentModal');
            paymentModal.addEventListener('hidden.bs.modal', () => {
                updateModalUI(false); 
            });

        });

    </script>
</body>
</html>


