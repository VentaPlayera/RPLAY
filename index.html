<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPLAY</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type='image/png' href="https://ventaplayera.github.io/RPLAY/logo.png">
    <style>
        /* Estilos Generales */
        body { background-color: #f7f7f7; }
        .price { font-size: 1.5rem; font-weight: 700; color: #ff3366; }
        .btn-buy { background-color: #ff3366; color: white; border: none; transition: background-color 0.3s; }
        .btn-buy:hover { background-color: #e6004c; color: white; }
        
        /* Estilos de las Tarjetas de Producto */
        .product-card {
            border: none; border-radius: 12px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease; margin-bottom: 25px; overflow: hidden; background-color: white;
            position: relative; 
        }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); }
        /* Imagen de producto adaptada a m√≥viles */
        .product-card img { 
            height: 250px; 
            object-fit: contain;
            background-color: #f0f0f0;
            border-top-left-radius: 12px; 
            border-top-right-radius: 12px; 
            width: 100%; 
        }

        /* Estilos del Badge de Stock */
        .stock-badge {
            position: absolute; top: 10px; right: 10px;
            padding: 5px 10px; border-radius: 5px;
            font-weight: 700; font-size: 0.85rem;
            z-index: 10;
        }
        .stock-badge.agotado { background-color: #6c757d; color: white; } 
        .stock-badge.ultima { background-color: #ffc107; color: #343a40; } 

        /* Estilos para los Botones de Talla */
        .size-btn {
            border: 1px solid #ccc; padding: 5px 15px; margin-right: 5px; cursor: pointer;
            border-radius: 5px; transition: all 0.2s; background-color: white; display: inline-block;
        }
        .size-btn:hover:not(.selected):not(.disabled) { border-color: #ff3366; color: #ff3366; }
        .size-btn.selected { background-color: #ff3366; color: white; border-color: #ff3366; }
        .size-btn.disabled {
            background-color: #f7f7f7; color: #ccc; text-decoration: line-through;
            cursor: not-allowed; border-color: #f7f7f7;
        }
        
        /* Ajustes para el Modal de Detalle en m√≥viles */
        @media (max-width: 767.98px) {
            .modal-body .row > div {
                margin-bottom: 15px;
            }
        }

        /* üîí OCULTAR PANELES DE ADMINISTRACI√ìN POR DEFECTO üîí */
        #manualManagementPanel { display: none; } 
        #admin-login-btn { 
            position: absolute; 
            bottom: 10px; 
            right: 10px; 
            padding: 5px; 
            font-size: 0.7rem; 
            background: none; 
            border: none;
            color: #ccc; 
        }
    </style>
</head>
<body>

    <div class="container my-5">
        
        <div class="d-flex flex-column align-items-center justify-content-center mb-5">
            <img src="https://imgur.com/mpCQaZg.jpg" alt="Logo de mi tienda" style="max-width: 250px; height: auto;">
            <h1 style="color: #ff3366; margin: 0;">RPLAY</h1>
        </div>
        
        <div class="container mb-5" id="manualManagementPanel">
            <h3 class="text-danger mb-3">Administraci√≥n de Pedidos Apartados</h3>
            <p class="text-muted small">Haz clic en "Liberar Stock" si el cliente no confirm√≥ el pago (gesti√≥n manual de las 24 horas).</p>
            <div id="ordersList" class="p-3 border rounded bg-white">
                <p class="text-center text-secondary" id="noOrdersMessage">No hay pedidos pendientes actualmente.</p>
            </div>
            <hr>
            <button class="btn btn-sm btn-outline-secondary" onclick="resetAllStock()">REINICIAR TODO EL INVENTARIO</button>
            <p class="text-muted small mt-2">
                Para **modificar el stock inicial**, usa la funci√≥n `setStock` en la consola (F12).
                <br>Ejemplo: **`setStock('PROD_001', 'M', 5)`**
            </p>
        </div>
        
        <div class="row" id="product-list">
        </div>
    </div>

    <button id="admin-login-btn" type="button">Admin Login</button>

    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalLabel">Detalle y Pago</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
                                <div class="carousel-inner">
                                    <div class="carousel-item active">
                                        <img id="modal-img-front" src="" class="d-block w-100" alt="Delantera de la Playera">
                                    </div>
                                    <div class="carousel-item">
                                        <img id="modal-img-back" src="" class="d-block w-100" alt="Espalda de la Playera">
                                    </div>
                                </div>
                                <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                </button>
                            </div>
                        </div>

                        <div class="col-md-6">
                            
                            <div id="selection-step">
                                <h4 class="mt-3" id="product-name"></h4>
                                <p class="text-muted" id="product-description"></p>
                                
                                <div class="mb-4">
                                    <h6>Talla:</h6>
                                    <div id="size-options"></div>
                                    <small id="size-status" class="text-secondary mt-2"></small>
                                </div>
                                
                                <div class="mb-4">
                                    <h6>Cantidad de Piezas:</h6>
                                    <input type="number" id="quantityInput" class="form-control" value="1" min="1" max="10" style="width: 100px;">
                                    <small id="quantity-status" class="text-secondary mt-2"></small>
                                </div>
                                
                                <hr>
                                
                                <p>Precio Total: <strong id="total-price" class="text-danger"></strong></p>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" value="" id="halfPaymentCheck" checked>
                                    <label class="form-check-label" for="halfPaymentCheck">Pagar la Mitad Ahora (Apartar)</label>
                                </div>
                                <p>Monto a Pagar Ahora: <strong id="payment-due" style="font-size: 1.4rem; color: green;"></strong></p>
                                <small class="text-muted">El resto se pagar√° al momento de la entrega el 28 de Noviembre.</small>
                            </div>

                            <div id="payment-step" style="display:none;">
                                <h4 class="mt-3 mb-4">Datos del Comprador y Env√≠o</h4>
                                <p class="alert alert-info small">
                                    Est√°s comprando <strong id="final-quantity-display">1</strong> pieza(s) talla <strong id="final-size-display"></strong> por <strong id="final-price-display"></strong>.
                                    Llena tus datos para guardar el pedido y ver las instrucciones de pago por transferencia.
                                </p>

                                <div class="mb-3">
                                    <label for="clientName" class="form-label">Nombre Completo (*):</label>
                                    <input type="text" class="form-control" id="clientName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="clientPhone" class="form-label">Tel√©fono/WhatsApp (*):</label>
                                    <input type="tel" class="form-control" id="clientPhone" required>
                                </div>
                                <div class="mb-3">
                                    <label for="clientAddress" class="form-label">Direcci√≥n de Env√≠o Completa (*):</label>
                                    <textarea class="form-control" id="clientAddress" rows="2" required></textarea>
                                </div>
                                
                                <div id="payment-error" class="text-danger mb-3" style="display:none;">Por favor, completa todos los campos requeridos (*).</div>
                            </div>
                            
                            <div id="transfer-info" style="display:none;">
                                <h4 class="mt-3 mb-4 text-success">¬°Pedido Generado!</h4>
                                <p>Hola <strong id="client-name-display"></strong>. Para confirmar tu compra de <span id="final-qty-conf">1</span> playera(s) (<span id="final-item-display"></span>, Talla <span id="final-size-conf"></span>), realiza la transferencia por el monto de <strong id="final-amount-conf" class="text-success"></strong> a la siguiente cuenta:</p>
                                <hr>
                                
                                <h5 class="text-primary">Datos de Transferencia Bancaria</h5>
                                <p class="mb-1"><strong>Banco:</strong> BANCOMER (BBVA)</p>
                                <p class="mb-1"><strong>N√∫mero de Cuenta:</strong> 0123 4567 8901 2345</p>
                                <p class="mb-1"><strong>CLABE Interbancaria:</strong> 012000000000000000</p>
                                <p class="mb-1"><strong>Beneficiario:</strong> MI TIENDA DE PLAYERAS S.A. DE C.V.</p>
                                
                                <hr>
                                <p class="text-center">¬°Haz clic en el bot√≥n de WhatsApp abajo para enviar tus datos y el comprobante!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <a href="#" target="_blank" class="btn btn-success" id="whatsapp-confirm-button" style="display:none;">
                        <i class="fab fa-whatsapp"></i> Enviar Comprobante por WhatsApp
                    </a>
                    
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="modal-close-button">Cerrar</button>
                    
                    <button type="button" class="btn btn-buy" id="modal-main-button" disabled>Pagar Ahora</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        
        // --- 1. GENERACI√ìN DIN√ÅMICA DE INVENTARIO INICIAL (70 Productos) ---
        // Se definen fuera del DOMContentLoaded para ser accedidas por las funciones globales de admin
        const productInventory = {};
        const productData = [];
        const DEFAULT_GLOBAL_SIZES = ["M", "L", "XL"];
        const FIXED_PRICE = 250.00; 
        const DEFAULT_STOCK_PER_SIZE = 1;
        const WHATSAPP_PHONE = "529991480151";
        
        // Utiliza un hash simple (MD5 o SHA1) de una clave secreta que NO se expone directamente.
        // Si la clave original fuera 'SUPERADMIN2025', el hash aqu√≠ evita que se vea.
        // ADVERTENCIA: Este hash es visible en el c√≥digo, pero es mejor que la contrase√±a en claro.
        const ADMIN_HASH = "819c99d25145b5c9b740751939331908"; // Ejemplo de hash simple para 'SUPERADMIN2025'
        
        for (let i = 1; i <= 70; i++) {
            const id = `PROD_${String(i).padStart(3, '0')}`;
            let mainImg, frontImg, backImg;
            let modelSizes = [...DEFAULT_GLOBAL_SIZES]; 
            let initialStockOverrides = {};
            
            mainImg = 'https://via.placeholder.com/250x250/F4E3F5?text=Modelo+' + i;
            frontImg = 'https://via.placeholder.com/500x500/F4E3F5?text=Frente+' + i;
            backImg = 'https://via.placeholder.com/500x500/F4E3F5?text=Espalda+' + i;

            // ==========================================================
            // INICIO DE ASIGNACI√ìN DE RUTAS DE IMAGEN √öNICAS
            // ==========================================================
            if (i === 1) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Xime1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Xime1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Xime2.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            } else if (i === 2) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Xime3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Xime3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Xime4.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            } else if (i === 3) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Lucy1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Lucy1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Lucy2.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            } else if (i === 4) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Lucy3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Lucy3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Lucy4.png';
            } else if (i === 5) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Raul1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Raul1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Raul2.png';
            } else if (i === 6) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Raul3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Raul3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Raul4.png';
            } else if (i === 7) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Abi1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Abi1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Abi2.png';
            } else if (i === 8) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Abi3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Abi3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Abi4.png';
            } else if (i === 9) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Dani1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Dani1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Dani2.png';
            } else if (i === 10) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Dani3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Dani3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Dani4.png';
            } else if (i === 11) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Dali1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Dali1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Dali2.png';
            } else if (i === 12) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Dali3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Dali3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Dali4.png';
            } else if (i === 13) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Yose1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Yose1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Yose2.png';
            } else if (i === 14) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Yose3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Yose3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Yose4.png';
            } else if (i === 15) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Keila1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Keila1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Keila2.png';
            } else if (i === 16) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Keila3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Keila3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Keila4.png';
            } else if (i === 17) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Kenji1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Kenji1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Kenji2.png';
            } else if (i === 18) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Kenji3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Kenji3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Kenji4.png';
            } else if (i === 19) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Alli1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Alli1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Alli2.png';
            } else if (i === 20) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Alli3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Alli3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Alli4.png';
            } else if (i >= 21 && i <= 70) { 
                // Los modelos 21 al 34 usan las mismas im√°genes que el modelo 8.
                mainImg = 'https://ventaplayera.github.io/RPLAY/Ale1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Ale1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Ale2.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            }else if (i >= 22 && i <= 70) { 
                // Los modelos 21 al 34 usan las mismas im√°genes que el modelo 8.
                mainImg = 'https://ventaplayera.github.io/RPLAY/Ale3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Ale3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Ale4.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            }else if (i >= 23 && i <= 70) { 
                // Los modelos 21 al 34 usan las mismas im√°genes que el modelo 8.
                mainImg = 'https://ventaplayera.github.io/RPLAY/Miri1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Miri1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Miri2.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            }else if (i >= 24 && i <= 70) { 
                // Los modelos 21 al 34 usan las mismas im√°genes que el modelo 8.
                mainImg = 'https://ventaplayera.github.io/RPLAY/Miri3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Miri3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Miri4.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            }else if (i >= 25 && i <= 70) { 
                // Los modelos 21 al 34 usan las mismas im√°genes que el modelo 8.
                mainImg = 'https://ventaplayera.github.io/RPLAY/Didi1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Didi1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Didi2.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            }else if (i >= 26 && i <= 70) { 
                // Los modelos 21 al 34 usan las mismas im√°genes que el modelo 8.
                mainImg = 'https://ventaplayera.github.io/RPLAY/Didi3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Didi3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Didi4.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            }else if (i >= 27 && i <= 70) { 
                // Los modelos 21 al 34 usan las mismas im√°genes que el modelo 8.
                mainImg = 'https://ventaplayera.github.io/RPLAY/Caro1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Caro1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Caro2.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            }else if (i >= 28 && i <= 70) { 
                // Los modelos 21 al 34 usan las mismas im√°genes que el modelo 8.
                mainImg = 'https://ventaplayera.github.io/RPLAY/Caro3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Caro3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Caro4.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            }else if (i >= 29 && i <= 70) { 
                // Los modelos 21 al 34 usan las mismas im√°genes que el modelo 8.
                mainImg = 'https://ventaplayera.github.io/RPLAY/Vale1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Vale1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Vale2.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            }else if (i >= 30 && i <= 70) { 
                // Los modelos 21 al 34 usan las mismas im√°genes que el modelo 8.
                mainImg = 'https://ventaplayera.github.io/RPLAY/Valei3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Vale3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Vale4.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            }
            // Los modelos del 35 al 70 usan las im√°genes de placeholder por defecto.
            
            // 1. Crear el objeto de stock para este producto
            const stock = {};
            modelSizes.forEach(size => {
                stock[size] = initialStockOverrides[size] !== undefined ? initialStockOverrides[size] : DEFAULT_STOCK_PER_SIZE;
            });
            // 2. Asignar al inventario global
            productInventory[id] = stock;
            // 3. A√±adir a la lista de productos
            productData.push({
                id: id,
                name: `Playera Modelo No. ${i}`,
                price: FIXED_PRICE.toFixed(2), 
                description: `Dise√±o exclusivo #${i} con estampado digital de alta calidad. Tela de algod√≥n 100%.`,
                img_main: mainImg,
                img_front: frontImg,
                img_back: backImg
            });
        }
        
        // --- 2. INVENTARIO PERSISTENTE (Pedidos Ya Confirmados) ---
        // Carga los pedidos guardados para persistencia (el stock no se reinicia al cargar la p√°gina)
        let localOrders = JSON.parse(localStorage.getItem('simulatedOrders')) || {};
        
        // --- 3. L√≥gica del Sistema ---

        document.addEventListener('DOMContentLoaded', function () {
            
            // --- REFERENCIAS A ELEMENTOS HTML (Mejoradas) ---
            const productListContainer = document.getElementById('product-list');
            const paymentModalElement = document.getElementById('paymentModal'); // El elemento del modal
            const paymentModal = new bootstrap.Modal(paymentModalElement); // Objeto Modal de Bootstrap
            const selectionStep = document.getElementById('selection-step');
            const paymentStep = document.getElementById('payment-step');
            const transferInfo = document.getElementById('transfer-info');
            const sizeOptionsContainer = document.getElementById('size-options');
            const halfPaymentCheck = document.getElementById('halfPaymentCheck');
            const clientNameInput = document.getElementById('clientName');
            const clientPhoneInput = document.getElementById('clientPhone');
            const clientAddressInput = document.getElementById('clientAddress');
            const mainButton = document.getElementById('modal-main-button');
            const whatsappButton = document.getElementById('whatsapp-confirm-button'); 
            const ordersList = document.getElementById('ordersList'); 
            const sizeStatusEl = document.getElementById('size-status'); 
            const quantityInput = document.getElementById('quantityInput');
            const quantityStatusEl = document.getElementById('quantity-status');
            const adminLoginBtn = document.getElementById('admin-login-btn');
            
            // üîí ELEMENTOS DE ADMINISTRACI√ìN OCULTOS
            const managementPanel = document.getElementById('manualManagementPanel');

            // Variables de estado
            let currentPrice = FIXED_PRICE;
            let currentSelectedSize = null;
            let currentSelectedQuantity = 1;
            let currentProductName = '';
            let currentProductID = ''; 
            let modalStep = 1; // 1: Selecci√≥n, 2: Datos, 3: Confirmaci√≥n
            
            // --- Funciones de L√≥gica ---
            
            function saveLocalOrders() {
                localStorage.setItem('simulatedOrders', JSON.stringify(localOrders));
                if (managementPanel.style.display === 'block') {
                    renderManualManagementPanel(); 
                }
            }
            
            /**
             * FUNCI√ìN CLAVE: Devuelve el stock real disponible 
             * (Inventario Inicial - Pedidos Apartados)
             */
            function getAvailableStock(productID, size) {
                const stock = productInventory[productID] && productInventory[productID][size] !== undefined ? productInventory[productID][size] : 0;
                const pendingOrders = localOrders[`${productID}-${size}`] || 0; 
                return stock - pendingOrders;
            }
            
            /**
             * FUNCI√ìN CRUCIAL: Modifica el stock INICIAL de un producto/talla 
             * (Para uso externo en la consola F12)
             * @param {string} productID - ID del producto (e.g., 'PROD_001')
             * @param {string} size - Talla (e.g., 'M')
             * @param {number} newStock - Nuevo stock inicial.
             */
            window.setStock = function(productID, size, newStock) {
                if (productInventory[productID] && productInventory[productID][size] !== undefined) {
                    newStock = parseInt(newStock);
                    if (isNaN(newStock) || newStock < 0) {
                        alert("Error: El stock debe ser un n√∫mero positivo.");
                        return;
                    }
                    productInventory[productID][size] = newStock;
                    saveLocalOrders(); // Re-guarda localOrders (aunque solo el inventario inicial cambi√≥)
                    initializeBadges();
                    alert(`‚úÖ Stock inicial de ${productID} - Talla ${size} modificado a ${newStock}.`);
                } else {
                    alert("Error: Producto o talla no encontrados.");
                }
            };

            /**
             * FUNCI√ìN DE ADMINISTRADOR: Libera la cantidad de un pedido
             * y lo devuelve al stock (usando la llave √∫nica).
             */
            window.releaseOrder = function(orderKey) {
                if (localOrders[orderKey]) {
                    const quantityToRelease = localOrders[orderKey];
                    delete localOrders[orderKey];
                    saveLocalOrders();
                    initializeBadges();
                    alert(`‚úÖ Pedido ${orderKey} liberado. ${quantityToRelease} unidad(es) devueltas al stock.`);
                } else {
                    alert("Error: Pedido no encontrado.");
                }
            };
            
            /**
             * FUNCI√ìN DE ADMINISTRADOR: Borra todos los pedidos apartados.
             */
            window.resetAllStock = function() {
                if (confirm("¬°ADVERTENCIA! ¬øEst√°s seguro de querer borrar TODOS los pedidos apartados (reservas) y restaurar el stock a su estado inicial? Esta acci√≥n no se puede deshacer.")) {
                    localOrders = {};
                    saveLocalOrders();
                    initializeBadges();
                    alert("‚úÖ Inventario restaurado. Todos los pedidos apartados han sido borrados.");
                }
            };
            
            // Funci√≥n auxiliar para simular un hash simple (para el login)
            function simpleHash(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash |= 0; 
                }
                return hash.toString(16).replace('-', 'f'); // Convertir a hexadecimal y manejar negativos
            }


            // L√≥gica de Renderizado y UI

            function updateProductBadge(productID) {
                const badgeElement = document.getElementById(`badge-${productID}`);
                if (!badgeElement) return;

                let totalAvailable = 0;
                const productSizes = productInventory[productID] ? Object.keys(productInventory[productID]) : [];
                
                productSizes.forEach(size => {
                    totalAvailable += getAvailableStock(productID, size);
                });

                badgeElement.className = 'stock-badge';
                if (totalAvailable <= 0) {
                    badgeElement.classList.add('agotado');
                    badgeElement.textContent = 'AGOTADO';
                } else if (totalAvailable <= 3) {
                    badgeElement.classList.add('ultima');
                    badgeElement.textContent = '¬°POCAS UNIDADES!';
                } else {
                    badgeElement.textContent = '';
                }
            }

            function initializeBadges() {
                productData.forEach(p => updateProductBadge(p.id));
            }
            
            function renderProductCards() {
                productListContainer.innerHTML = ''; 
                productData.forEach(product => {
                    const col = document.createElement('div');
                    col.className = 'col-6 col-md-4 col-lg-3'; 
                    col.innerHTML = `
                        <div class="card product-card" data-product-id="${product.id}">
                            <span class="stock-badge" id="badge-${product.id}"></span>
                            <img src="${product.img_main}" class="card-img-top" alt="${product.name}">
                            <div class="card-body text-center">
                                <h5 class="card-title mb-1">${product.name}</h5>
                                <p class="price mb-2">$${product.price} MXN</p>
                                <button type="button" class="btn btn-buy" data-bs-toggle="modal" data-bs-target="#paymentModal" data-product-id="${product.id}">
                                    Ver Detalle y Comprar
                                </button>
                            </div>
                        </div>
                    `;
                    productListContainer.appendChild(col);
                });
                initializeBadges(); // Inicializar badges despu√©s de renderizar
            }
            
            function createSizeButtons(productID) {
                sizeOptionsContainer.innerHTML = '';
                currentSelectedSize = null; // Reiniciar selecci√≥n de talla
                mainButton.disabled = true; // Deshabilitar bot√≥n principal

                const sizes = productInventory[productID] ? Object.keys(productInventory[productID]) : [];

                if (sizes.length === 0) {
                    sizeOptionsContainer.innerHTML = '<p class="text-danger">Producto no disponible.</p>';
                    return;
                }
                
                sizes.forEach(size => {
                    const stock = getAvailableStock(productID, size);
                    const button = document.createElement('span');
                    button.className = 'size-btn';
                    button.textContent = size;
                    button.setAttribute('data-size', size);

                    if (stock <= 0) {
                        button.classList.add('disabled');
                        button.title = 'Agotado';
                    } else {
                        button.addEventListener('click', () => handleSizeSelection(size, productID));
                    }
                    sizeOptionsContainer.appendChild(button);
                });
                
                // Si solo hay una talla y est√° disponible, seleccionarla por defecto
                if (sizes.length === 1 && getAvailableStock(productID, sizes[0]) > 0) {
                    handleSizeSelection(sizes[0], productID);
                }
            }
            
            function handleSizeSelection(size, productID) {
                const stock = getAvailableStock(productID, size);
                
                if (stock <= 0) return; // No permitir seleccionar agotado

                // Desmarcar todas las tallas
                document.querySelectorAll('.size-btn').forEach(btn => btn.classList.remove('selected'));
                
                // Marcar la talla seleccionada
                const selectedButton = document.querySelector(`.size-btn[data-size="${size}"]`);
                if (selectedButton) {
                    selectedButton.classList.add('selected');
                }

                currentSelectedSize = size;
                
                // Actualizar info de stock y cantidad
                sizeStatusEl.textContent = stock > 5 ? `¬°${stock} unidades disponibles!` : `¬°Quedan s√≥lo ${stock} unidades! ¬°Aparta la tuya!`;
                
                // Actualizar el input de cantidad
                quantityInput.max = stock;
                currentSelectedQuantity = Math.min(quantityInput.value, stock);
                quantityInput.value = currentSelectedQuantity;
                quantityInput.disabled = (stock <= 1); // Deshabilita si solo queda 1
                quantityStatusEl.textContent = stock <= 1 ? "M√°ximo 1 unidad por pedido." : `Puedes pedir hasta ${stock} unidades.`;

                updatePaymentAmounts();
                mainButton.disabled = false;
            }

            function updatePaymentAmounts() {
                if (!currentSelectedSize) return;
                
                const total = currentPrice * currentSelectedQuantity;
                const paymentDue = halfPaymentCheck.checked ? total / 2 : total;
                
                document.getElementById('total-price').textContent = `$${total.toFixed(2)} MXN`;
                document.getElementById('payment-due').textContent = `$${paymentDue.toFixed(2)} MXN`;
            }
            
            function resetModalView() {
                modalStep = 1;
                selectionStep.style.display = 'block';
                paymentStep.style.display = 'none';
                transferInfo.style.display = 'none';
                
                mainButton.style.display = 'inline-block';
                whatsappButton.style.display = 'none';
                document.getElementById('modal-close-button').style.display = 'inline-block';
                
                mainButton.textContent = 'Continuar a Pago';
                mainButton.disabled = currentSelectedSize === null;
                
                // Limpiar campos del cliente
                clientNameInput.value = '';
                clientPhoneInput.value = '';
                clientAddressInput.value = '';
                document.getElementById('payment-error').style.display = 'none';
            }
            
            function renderManualManagementPanel() {
                ordersList.innerHTML = '';
                let hasOrders = false;

                for (const key in localOrders) {
                    if (localOrders.hasOwnProperty(key)) {
                        hasOrders = true;
                        const [productID, size] = key.split('-');
                        const quantity = localOrders[key];
                        
                        const product = productData.find(p => p.id === productID);
                        const productName = product ? product.name : productID;

                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'd-flex justify-content-between align-items-center border-bottom py-2';
                        itemDiv.innerHTML = `
                            <span>**${productName}** (Talla: ${size}, Cant: ${quantity})</span>
                            <button class="btn btn-sm btn-danger" onclick="releaseOrder('${key}')">Liberar Stock</button>
                        `;
                        ordersList.appendChild(itemDiv);
                    }
                }
                document.getElementById('noOrdersMessage').style.display = hasOrders ? 'none' : 'block';
            }


            // --- Manejo de Eventos ---

            // Evento al abrir el modal
            paymentModalElement.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                currentProductID = button.getAttribute('data-product-id');
                const product = productData.find(p => p.id === currentProductID);
                
                if (product) {
                    currentProductName = product.name;
                    currentPrice = parseFloat(product.price);
                    
                    document.getElementById('paymentModalLabel').textContent = product.name;
                    document.getElementById('product-name').textContent = product.name;
                    document.getElementById('product-description').textContent = product.description;
                    document.getElementById('modal-img-front').src = product.img_front;
                    document.getElementById('modal-img-back').src = product.img_back;
                    
                    resetModalView();
                    createSizeButtons(currentProductID);
                    updatePaymentAmounts(); 
                }
            });

            // Evento al cambiar la talla seleccionada o la cantidad
            quantityInput.addEventListener('change', function() {
                const maxStock = parseInt(quantityInput.max);
                let newQuantity = parseInt(this.value);
                
                if (isNaN(newQuantity) || newQuantity < 1) {
                    newQuantity = 1;
                }
                if (newQuantity > maxStock) {
                    newQuantity = maxStock;
                }
                this.value = newQuantity;
                currentSelectedQuantity = newQuantity;
                updatePaymentAmounts();
            });

            halfPaymentCheck.addEventListener('change', updatePaymentAmounts);

            // Bot√≥n Principal del Modal (Continuar/Generar Pedido)
            mainButton.addEventListener('click', function() {
                
                if (modalStep === 1) {
                    // Transici√≥n: Selecci√≥n -> Datos del Cliente
                    modalStep = 2;
                    selectionStep.style.display = 'none';
                    paymentStep.style.display = 'block';
                    mainButton.textContent = 'Generar Pedido';
                    
                    // Actualizar resumen final
                    const total = currentPrice * currentSelectedQuantity;
                    document.getElementById('final-quantity-display').textContent = currentSelectedQuantity;
                    document.getElementById('final-size-display').textContent = currentSelectedSize;
                    document.getElementById('final-price-display').textContent = `$${total.toFixed(2)} MXN`;

                } else if (modalStep === 2) {
                    // Transici√≥n: Datos del Cliente -> Instrucciones de Transferencia
                    
                    const name = clientNameInput.value.trim();
                    const phone = clientPhoneInput.value.trim();
                    const address = clientAddressInput.value.trim();

                    if (!name || !phone || !address) {
                        document.getElementById('payment-error').style.display = 'block';
                        return;
                    }
                    document.getElementById('payment-error').style.display = 'none';
                    
                    // ** L√ìGICA CLAVE DE APARTADO DE STOCK **
                    const orderKey = `${currentProductID}-${currentSelectedSize}`;
                    localOrders[orderKey] = (localOrders[orderKey] || 0) + currentSelectedQuantity;
                    saveLocalOrders();
                    initializeBadges();
                    
                    modalStep = 3;
                    paymentStep.style.display = 'none';
                    transferInfo.style.display = 'block';
                    mainButton.style.display = 'none';
                    whatsappButton.style.display = 'inline-block';
                    document.getElementById('modal-close-button').textContent = 'Listo';

                    // Actualizar datos de confirmaci√≥n
                    const total = currentPrice * currentSelectedQuantity;
                    const paymentDue = halfPaymentCheck.checked ? total / 2 : total;
                    const paymentType = halfPaymentCheck.checked ? 'Apartado (50%)' : 'Total (100%)';

                    document.getElementById('client-name-display').textContent = name;
                    document.getElementById('final-qty-conf').textContent = currentSelectedQuantity;
                    document.getElementById('final-item-display').textContent = currentProductName;
                    document.getElementById('final-size-conf').textContent = currentSelectedSize;
                    document.getElementById('final-amount-conf').textContent = `$${paymentDue.toFixed(2)} MXN (${paymentType})`;

                    // Configurar el mensaje de WhatsApp (URL Encode)
                    const whatsappMessage = `*¬°NUEVO PEDIDO GENERADO!*
-------------------------
**PRODUCTO:** ${currentProductName}
**TALLA:** ${currentSelectedSize}
**CANTIDAD:** ${currentSelectedQuantity}
**PAGO INICIAL:** $${paymentDue.toFixed(2)} MXN
**FORMA DE PAGO:** ${paymentType}
-------------------------
**DATOS DEL CLIENTE:**
**Nombre:** ${name}
**Tel√©fono:** ${phone}
**Direcci√≥n:** ${address}
-------------------------
Adjunta aqu√≠ tu comprobante de pago. ¬°Gracias!`;

                    whatsappButton.href = `https://wa.me/${WHATSAPP_PHONE}?text=${encodeURIComponent(whatsappMessage)}`;
                }
            });

            // L√≥gica del Login del Administrador (MEJORA DE SEGURIDAD)
            adminLoginBtn.addEventListener('click', function() {
                const enteredPassword = prompt("Introduce la contrase√±a de Administrador:");
                if (enteredPassword) {
                    // Simple hash de la contrase√±a ingresada
                    const enteredHash = simpleHash(enteredPassword); 
                    
                    if (enteredHash === ADMIN_HASH) {
                        managementPanel.style.display = 'block';
                        renderManualManagementPanel();
                        alert("‚úÖ Acceso de administrador concedido.");
                    } else {
                        alert("‚ùå Contrase√±a incorrecta. Acceso denegado.");
                    }
                }
            });
            
            // --- INICIALIZACI√ìN ---
            renderProductCards();
        });
        
    </script>
</body>
</html>

