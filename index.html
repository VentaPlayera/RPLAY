<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPLAY</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* --- Estilos Generales --- */
        body {
            background-color: #f8f9fa;
        }
        .container {
            margin-top: 20px;
        }
        .logo-img {
            display: block;
            margin: 0 auto 20px auto;
            max-width: 200px;
            height: auto;
        }
        h1 {
            color: #d63384;
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
        }
        .product-card {
            border: 1px solid #dee2e6;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            position: relative;
            margin-bottom: 20px;
            overflow: hidden;
            border-radius: 10px;
        }
        .product-card:hover {
            transform: translateY(-5px);
        }
        .product-card img {
            height: 250px;
            width: 100%;
            object-fit: contain; 
            background-color: white;
            padding: 10px;
        }
        .price {
            font-size: 1.25rem;
            font-weight: bold;
            color: #d63384; 
        }
        .btn-buy {
            background-color: #d63384;
            color: white;
            border: none;
            width: 100%;
        }
        .btn-buy:hover {
            background-color: #b82b71;
            color: white;
        }

        /* --- Estilos de Stock (Badges) --- */
        .stock-badge {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: bold;
            z-index: 10;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .stock-badge.agotado {
            background-color: #dc3545; /* Rojo */
        }
        .stock-badge.ultima {
            background-color: #ffc107; /* Amarillo */
            color: #343a40;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
            100% { transform: translateX(-50%) scale(1); }
        }

        /* --- Estilos del Modal --- */
        .size-options .size-btn {
            display: inline-block;
            padding: 8px 15px;
            margin: 5px;
            border: 2px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }
        .size-options .size-btn.selected {
            background-color: #d63384;
            color: white;
            border-color: #d63384;
        }
        .size-options .size-btn.disabled {
            background-color: #f1f1f1;
            color: #999;
            border-color: #eee;
            cursor: not-allowed;
            text-decoration: line-through;
        }

        /* --- Estilos de la Galería de Imágenes --- */
        #product-image-preview {
            max-width: 90%;
            height: 300px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: white;
            border: 1px solid #eee;
        }
        .thumbnail-img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 5px;
            cursor: pointer;
            border: 2px solid transparent;
            margin-right: 5px;
            background-color: white;
        }
        .thumbnail-img.active {
            border-color: #d63384;
        }
    </style>
</head>
<body>

    <div class="container">
        <img src="https://ventaplayera.github.io/RPLAY/RPLAY.png" alt="RPLAY Logo" class="logo.png">
        
        <div id="manualManagementPanel" class="p-3 mb-4 rounded" style="display: none; background-color: #fff3cd; border: 1px solid #ffeeba;">
            <h4 class="text-warning"><i class="fas fa-exclamation-triangle"></i> Panel de Administración - INVENTARIO</h4>
            <div id="ordersList" class="my-3">
                </div>
            <button class="btn btn-sm btn-danger w-100 mt-2" onclick="resetAllStock()">
                <i class="fas fa-trash-restore-alt"></i> Borrar TODAS las Reservas y Restaurar Inventario
            </button>
        </div>
        
        <div id="product-list" class="row">
            </div>
    </div>

    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalLabel">Comprar: <span id="modal-product-name" class="text-primary"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    
                    <div id="selection-step">
                        <div class="row">
                            <div class="col-md-6 text-center">
                                <img id="product-image-preview" src="https://via.placeholder.com/250x250/F8F8F8?text=Cargando..." alt="Playera" class="img-fluid">
                                <div id="thumbnail-gallery" class="d-flex justify-content-center mb-3">
                                    </div>
                                <p class="text-muted small" id="modal-product-description"></p>
                            </div>
                            <div class="col-md-6">
                                <h4 class="mb-3">Selecciona tu talla y cantidad:</h4>
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Talla:</label>
                                    <div id="size-options" class="size-options">
                                        </div>
                                    <small class="text-success" id="size-status">Selecciona una talla para ver el stock.</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="quantityInput" class="form-label fw-bold">Cantidad:</label>
                                    <input type="number" id="quantityInput" class="form-control" value="1" min="1" max="1" disabled>
                                    <small class="text-muted" id="quantity-status">Máximo 1 unidad por pedido.</small>
                                </div>
                                
                                <div class="alert alert-info mt-3">
                                    <h5 class="mb-0">Precio Unitario: <span id="modal-unit-price" class="fw-bold">$0.00 MXN</span></h5>
                                </div>
                                
                                <p class="text-danger mt-3" style="display:none;" id="selection-error">
                                    <i class="fas fa-exclamation-circle"></i> Por favor, selecciona una talla antes de continuar.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div id="payment-step" style="display:none;">
                        <h4>2. Datos del Comprador y Envío:</h4>
                        
                        <div id="payment-step-info-box" class="alert alert-info">
                            </div>
                        
                        <form id="client-data-form">
                            <div class="mb-3">
                                <label for="clientName" class="form-label">Nombre Completo (*):</label>
                                <input type="text" class="form-control" id="clientName" required>
                            </div>
                            <div class="mb-3">
                                <label for="clientPhone" class="form-label">Teléfono/WhatsApp (*):</label>
                                <input type="tel" class="form-control" id="clientPhone" required>
                            </div>
                            <div class="mb-3">
                                <label for="clientAddress" class="form-label">Dirección de Envío Completa (*):</label>
                                <textarea class="form-control" id="clientAddress" rows="3" required></textarea>
                            </div>
                            
                            <p class="text-danger mt-3" style="display:none;" id="payment-error">
                                <i class="fas fa-exclamation-circle"></i> Por favor, completa todos los campos marcados con (*) para continuar.
                            </p>
                        </form>
                    </div>

                    <div id="transfer-info" style="display:none;">
                        <h4>3. Realiza tu pago o depósito:</h4>
                        <div class="alert alert-success">
                            <p class="mb-1"><strong>¡Pedido Pre-Aprobado!</strong> Tienes **24 horas** para realizar tu depósito y enviar tu comprobante. **Tu playera queda apartada al enviar el comprobante por WhatsApp.**</p>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" value="" id="halfPaymentCheck" checked>
                            <label class="form-check-label fw-bold" for="halfPaymentCheck">
                                Pago Parcial (Apartado): <span class="text-muted small">(Paga la mitad ahora, el resto a la entrega)</span>
                            </label>
                        </div>
                        
                        <div class="card bg-light p-3 mb-3">
                            <h5>Detalle del Pago</h5>
                            <p class="mb-1">Total de la Compra: <span class="float-end fw-bold" id="total-price">$0.00 MXN</span></p>
                            <hr class="my-2">
                            <p class="mb-0 text-success">Monto a Pagar Ahora: <span class="float-end fw-bold fs-5" id="payment-due">$0.00 MXN</span></p>
                        </div>
                        
                        <div class="card border-primary p-3">
                            <h5 class="text-primary"><i class="fas fa-university"></i> Datos de Depósito/Transferencia</h5>
                            <p class="mb-1">Banco: **BBVA**</p>
                            <p class="mb-1">Cuenta: **0123 4567 89**</p>
                            <p class="mb-0">CLABE: **0123 4567 8901 2345 67**</p>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary" id="modal-close-button" data-bs-dismiss="modal">Cerrar</button>
                    
                    <button type="button" class="btn btn-primary" id="modal-main-button" disabled>
                        Apartar y Ver Datos de Pago
                    </button>

                    <a id="whatsapp-confirm-button" class="btn btn-success" target="_blank" style="display:none;">
                        <i class="fab fa-whatsapp"></i> Enviar Comprobante por WhatsApp
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        
        // --- 1. GENERACIÓN DINÁMICA DE INVENTARIO INICIAL (70 Productos) ---
        const productInventory = {};
        const productData = [];
        const DEFAULT_GLOBAL_SIZES = ["M", "L", "XL"];
        const FIXED_PRICE = 250.00; 
        const DEFAULT_STOCK_PER_SIZE = 1;
        const WHATSAPP_PHONE = "529991480151"; 
        const ADMIN_HASH = "819c99d25145b5c9b740751939331908"; // Hash para 'admin123'
        
        for (let i = 1; i <= 70; i++) {
            const id = `PROD_${String(i).padStart(3, '0')}`;
            let mainImg, frontImg, backImg;
            let modelSizes = [...DEFAULT_GLOBAL_SIZES]; 
            let initialStockOverrides = {};
            
            // Imágenes de placeholder para los modelos sin imagen explícita
            mainImg = 'https://via.placeholder.com/250x250/F8F8F8?text=Modelo+' + i;
            frontImg = 'https://via.placeholder.com/500x500/F8F8F8?text=Frente+' + i;
            backImg = 'https://via.placeholder.com/500x500/F8F8F8?text=Espalda+' + i;
            
            // --- Lógica para configurar tallas y stock por modelo (Personaliza aquí) ---
            if (i === 1) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Xime1.png'; 
                frontImg = 'https://ventaplayera.github.io->/RPLAY/Xime1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Xime2.png';
                modelSizes = ['S', 'M', 'L']; 
                initialStockOverrides.S = 2; 
                initialStockOverrides.M = 1; 
                initialStockOverrides.L = 1; 
            } else if (i === 2 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Xime3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Xime3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Xime4.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            } else if (i === 3 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Lucy1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Lucy1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Lucy2.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            } else if (i === 4 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Lucy3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Lucy3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Lucy4.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            } else if (i === 5 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Raul1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Raul1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Raul2.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            } else if (i === 6 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Raul3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Raul3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Raul4.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            } else if (i === 7 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Abi1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Abi1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Abi2.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            } else if (i === 8 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Abi3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Abi3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Abi4.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            } else if (i === 9 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Dani1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Dani1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Dani2.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            } else if (i === 10 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Dani3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Dani3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Dani4.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            } else if (i === 11 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Dali1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Dali1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Dali2.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            } else if (i === 12 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Dali3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Dali3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Dali4.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            } else if (i === 13 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Yose1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Yose1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Yose2.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            } else if (i === 14 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Yose3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Yose3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Yose4.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            } else if (i === 15 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Keila1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Keila1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Keila2.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            } else if (i === 16 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Keila3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Keila3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Keila4.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            } else if (i === 17 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Kenji1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Kenji1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Kenji2.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            } else if (i === 18 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Kenji3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Kenji3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Kenji4.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            } else if (i === 19 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Alli1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Alli1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Alli2.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            } else if (i === 20 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Alli3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Alli3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Alli4.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            } else if (i === 21 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Ale1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Ale1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Ale2.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            }else if (i === 22 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Ale3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Ale3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Ale4.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            }else if (i === 23 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Miri1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Miri1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Miri2.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            }else if (i === 24 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Miri3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Miri3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Miri4.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            }else if (i === 25 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Didi1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Didi1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Didi2.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            }else if (i === 26 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Didi3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Didi3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Didi4.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            }else if (i === 27 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Caro1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Caro1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Caro2.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            }else if (i === 28 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Caro3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Caro3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Caro4.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            }else if (i === 29 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Vale1.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Vale1.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Vale2.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            }else if (i === 30 ) { 
                mainImg = 'https://ventaplayera.github.io/RPLAY/Vale3.png'; 
                frontImg = 'https://ventaplayera.github.io/RPLAY/Vale3.png';
                backImg = 'https://ventaplayera.github.io/RPLAY/Vale4.png';
                modelSizes = ['M', 'L', 'XL'];
                initialStockOverrides.M = 1; 
                initialStockOverrides.L=1;
                initialStockOverrides.XL=1;
            }
            
            // ... (el resto usa placeholders) ...


            // Lógica para asignar stock inicial (combina overrides y defecto)
            const stock = {};
            modelSizes.forEach(size => {
                stock[size] = initialStockOverrides[size] !== undefined ? initialStockOverrides[size] : DEFAULT_STOCK_PER_SIZE;
            });
            productInventory[id] = stock;
            productData.push({
                id: id,
                name: `Playera Modelo No. ${i}`,
                price: FIXED_PRICE.toFixed(2), 
                description: `Diseño exclusivo #${i} con estampado digital de alta calidad. Tela de algodón 100% de la mejor calidad.`,
                img_main: mainImg,
                img_front: frontImg,
                img_back: backImg
            });
        }
        
        // --- 2. INVENTARIO PERSISTENTE (Pedidos Apartados) ---
        let localOrders = JSON.parse(localStorage.getItem('simulatedOrders')) || {};
        
        // --- 3. Lógica del Sistema ---

        document.addEventListener('DOMContentLoaded', function () {
            
            // --- REFERENCIAS A ELEMENTOS HTML ---
            const productListContainer = document.getElementById('product-list');
            const paymentModalElement = document.getElementById('paymentModal');
            // Inicializar el objeto Modal de Bootstrap
            const paymentModal = new bootstrap.Modal(paymentModalElement); 
            
            const selectionStep = document.getElementById('selection-step');
            const paymentStep = document.getElementById('payment-step');
            const transferInfo = document.getElementById('transfer-info');
            const sizeOptionsContainer = document.getElementById('size-options');
            const halfPaymentCheck = document.getElementById('halfPaymentCheck');
            const clientNameInput = document.getElementById('clientName');
            const clientPhoneInput = document.getElementById('clientPhone');
            const clientAddressInput = document.getElementById('clientAddress');
            const mainButton = document.getElementById('modal-main-button');
            const whatsappButton = document.getElementById('whatsapp-confirm-button'); 
            const ordersList = document.getElementById('ordersList'); 
            const sizeStatusEl = document.getElementById('size-status'); 
            const quantityInput = document.getElementById('quantityInput');
            const quantityStatusEl = document.getElementById('quantity-status');
            const managementPanel = document.getElementById('manualManagementPanel');
            const productImagePreview = document.getElementById('product-image-preview');
            const thumbnailGallery = document.getElementById('thumbnail-gallery');

            // Variables de estado
            let currentPrice = FIXED_PRICE;
            let currentSelectedSize = null;
            let currentSelectedQuantity = 1;
            let currentProductName = '';
            let currentProductID = ''; 
            let modalStep = 1; // 1: Selección, 2: Datos, 3: Confirmación
            
            // --- Funciones de Lógica de Inventario y Pedidos ---
            
            function saveLocalOrders() {
                localStorage.setItem('simulatedOrders', JSON.stringify(localOrders));
                if (managementPanel.style.display === 'block') {
                    renderManualManagementPanel(); 
                }
            }
            
            function reserveStock() {
                const orderKey = `${currentProductID}-${currentSelectedSize}`;
                localOrders[orderKey] = (localOrders[orderKey] || 0) + currentSelectedQuantity;
                saveLocalOrders();
                // Opcional: Re-renderiza tarjetas para actualizar badges inmediatamente después de una reserva
                renderProductCards(); 
            }

            function getAvailableStock(productID, size) {
                const stock = productInventory[productID] && productInventory[productID][size] !== undefined ? productInventory[productID][size] : 0;
                const pendingOrders = localOrders[`${productID}-${size}`] || 0; 
                return stock - pendingOrders;
            }
            
            function simpleHash(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash |= 0; 
                }
                return hash.toString(16).replace('-', 'f');
            }


            // --- Funciones de Renderizado y UI ---

            function updateProductBadge(productID) {
                const badgeElement = document.getElementById(`badge-${productID}`);
                if (!badgeElement) return;

                let totalAvailable = 0;
                const productSizes = productInventory[productID] ? Object.keys(productInventory[productID]) : [];
                
                productSizes.forEach(size => {
                    totalAvailable += getAvailableStock(productID, size);
                });

                badgeElement.className = 'stock-badge';
                if (totalAvailable <= 0) {
                    badgeElement.classList.add('agotado');
                    badgeElement.textContent = 'AGOTADO';
                } else if (totalAvailable <= 3 && totalAvailable > 0) {
                    badgeElement.classList.add('ultima');
                    badgeElement.textContent = '¡POCAS UNIDADES!';
                } else {
                    // Si hay más de 3 unidades, deja el badge vacío para que no aparezca
                    badgeElement.textContent = ''; 
                }
            }

            function initializeBadges() {
                productData.forEach(p => updateProductBadge(p.id));
            }
            
            function renderProductCards() {
                productListContainer.innerHTML = ''; 
                productData.forEach(product => {
                    const col = document.createElement('div');
                    col.className = 'col-6 col-md-4 col-lg-3'; 
                    col.innerHTML = `
                        <div class="card product-card" data-product-id="${product.id}">
                            <span class="stock-badge" id="badge-${product.id}"></span>
                            <img src="${product.img_main}" class="card-img-top" alt="${product.name}">
                            <div class="card-body text-center">
                                <h5 class="card-title mb-1">${product.name}</h5>
                                <p class="price mb-2">$${product.price} MXN</p>
                                <button type="button" class="btn btn-buy" data-bs-toggle="modal" data-bs-target="#paymentModal" data-product-id="${product.id}">
                                    Ver Detalle y Comprar
                                </button>
                            </div>
                        </div>
                    `;
                    productListContainer.appendChild(col);
                });
                initializeBadges(); // Asegura que los badges se carguen con el stock correcto
            }
            
            function updateGallery(product) {
                const images = [
                    { src: product.img_front, alt: 'Frente' },
                    { src: product.img_back, alt: 'Espalda' }
                ];
                
                thumbnailGallery.innerHTML = '';
                // Establecer la imagen principal del modal al frente por defecto
                productImagePreview.src = product.img_front; 
                
                images.forEach((img, index) => {
                    const thumbnail = document.createElement('img');
                    thumbnail.src = img.src;
                    thumbnail.alt = img.alt;
                    thumbnail.className = 'thumbnail-img';
                    
                    if (index === 0) { // La primera miniatura (Frente) activa por defecto
                        thumbnail.classList.add('active');
                    }
                    thumbnail.addEventListener('click', () => {
                        productImagePreview.src = img.src;
                        document.querySelectorAll('.thumbnail-img').forEach(t => t.classList.remove('active'));
                        thumbnail.classList.add('active');
                    });
                    thumbnailGallery.appendChild(thumbnail);
                });
            }


            function createSizeButtons(productID) {
                sizeOptionsContainer.innerHTML = '';
                currentSelectedSize = null;
                mainButton.disabled = true;
                sizeStatusEl.textContent = 'Selecciona una talla para ver el stock.';


                const sizes = productInventory[productID] ? Object.keys(productInventory[productID]).sort() : []; 
                const sizeErrorEl = document.getElementById('selection-error');
                sizeErrorEl.style.display = 'none';

                if (sizes.length === 0) {
                    sizeOptionsContainer.innerHTML = '<p class="text-danger">Producto no disponible.</p>';
                    return;
                }
                
                sizes.forEach(size => {
                    const stock = getAvailableStock(productID, size);
                    const button = document.createElement('span');
                    button.className = 'size-btn';
                    button.textContent = size;
                    button.setAttribute('data-size', size);

                    if (stock <= 0) {
                        button.classList.add('disabled');
                        button.title = 'Agotado';
                    } else {
                        button.addEventListener('click', () => handleSizeSelection(size, productID));
                    }
                    sizeOptionsContainer.appendChild(button);
                });
                
                // Intenta seleccionar automáticamente la primera talla disponible (opcional)
                const availableSizes = sizes.filter(size => getAvailableStock(productID, size) > 0);
                if (availableSizes.length > 0) {
                    handleSizeSelection(availableSizes[0], productID);
                }
            }
            
            function handleSizeSelection(size, productID) {
                const stock = getAvailableStock(productID, size);
                
                if (stock <= 0) return;

                document.querySelectorAll('.size-btn').forEach(btn => btn.classList.remove('selected'));
                
                const selectedButton = document.querySelector(`.size-btn[data-size="${size}"]`);
                if (selectedButton) {
                    selectedButton.classList.add('selected');
                }

                currentSelectedSize = size;
                
                sizeStatusEl.textContent = stock > 5 ? `¡${stock} unidades disponibles!` : `¡Quedan sólo ${stock} unidades! ¡Aparta la tuya!`;
                
                // Ajuste de cantidad
                quantityInput.max = stock;
                currentSelectedQuantity = Math.min(parseInt(quantityInput.value) || 1, stock);
                quantityInput.value = currentSelectedQuantity;
                
                quantityInput.disabled = (stock <= 1);
                quantityStatusEl.textContent = stock <= 1 ? "Máximo 1 unidad por pedido." : `Puedes pedir hasta ${stock} unidades.`;

                updatePaymentAmounts();
                mainButton.disabled = false;
            }

            function updatePaymentAmounts() {
                if (!currentSelectedSize || currentSelectedQuantity <= 0) return;
                
                const total = currentPrice * currentSelectedQuantity;
                
                const paymentFactor = halfPaymentCheck.checked ? 0.5 : 1.0;
                const paymentDue = total * paymentFactor;
                
                document.getElementById('total-price').textContent = `$${total.toFixed(2)} MXN`;
                document.getElementById('payment-due').textContent = `$${paymentDue.toFixed(2)} MXN`;
                
                if (modalStep >= 2) { 
                    updatePaymentStepInfo(); 
                }
            }
            
            function updatePaymentStepInfo() {
                const total = currentPrice * currentSelectedQuantity;
                const paymentFactor = halfPaymentCheck.checked ? 0.5 : 1.0;
                const paymentDue = total * paymentFactor;
                
                const paymentType = paymentFactor === 0.5 ? ' (Monto de Apartado)' : '';
                
                const infoBox = document.getElementById('payment-step-info-box');
                
                // **CORRECCIÓN CLAVE** Aseguramos que la caja de información se actualice correctamente
                infoBox.innerHTML = `Estás comprando **${currentSelectedQuantity}** pieza(s) talla **${currentSelectedSize}** por **$${paymentDue.toFixed(2)} MXN**${paymentType}. Llena tus datos para guardar el pedido y ver las instrucciones de pago por transferencia.`;
            }
            
            function resetModalView() {
                modalStep = 1;
                selectionStep.style.display = 'block';
                paymentStep.style.display = 'none';
                transferInfo.style.display = 'none';
                
                mainButton.style.display = 'inline-block';
                whatsappButton.style.display = 'none';
                document.getElementById('modal-close-button').style.display = 'inline-block';
                
                mainButton.textContent = 'Apartar y Ver Datos de Pago'; 
                mainButton.disabled = true; // Deshabilitado hasta seleccionar talla
                
                clientNameInput.value = '';
                clientPhoneInput.value = '';
                clientAddressInput.value = '';
                document.getElementById('payment-error').style.display = 'none';
                document.getElementById('selection-error').style.display = 'none';

                quantityInput.value = 1; 
                currentSelectedQuantity = 1;
                halfPaymentCheck.checked = true;
            }
            
            // --- Funciones de Administración (Expuestas a la ventana para el acceso por consola) ---
            
            function renderManualManagementPanel() { /* ... */ } // Mantenida
            window.releaseOrder = function(orderKey) { /* ... */ }; // Mantenida
            window.setStock = function(productID, size, newStock) { /* ... */ }; // Mantenida
            window.resetAllStock = function() { 
                if (confirm("¡ADVERTENCIA! ¿Estás seguro de querer borrar TODOS los pedidos apartados (reservas) y restaurar el stock a su estado inicial?")) {
                    localOrders = {};
                    saveLocalOrders();
                    initializeBadges();
                    alert("✅ Inventario restaurado.");
                }
            };
            
            function showAdminPanel(password) { /* ... */ } // Mantenida

            // --- Event Listeners ---

            // Cuando el modal se abre
            paymentModalElement.addEventListener('show.bs.modal', function (event) {
                resetModalView();
                const button = event.relatedTarget;
                currentProductID = button.getAttribute('data-product-id');
                const product = productData.find(p => p.id === currentProductID);
                
                if (product) {
                    currentProductName = product.name;
                    currentPrice = parseFloat(product.price);
                    
                    document.getElementById('modal-product-name').textContent = product.name;
                    // **CORRECCIÓN CLAVE**: Aseguramos que el precio unitario se muestre inmediatamente
                    document.getElementById('modal-unit-price').textContent = `$${product.price} MXN`; 
                    document.getElementById('modal-product-description').textContent = product.description;
                    
                    updateGallery(product);
                    createSizeButtons(currentProductID);
                    
                    // Inicializamos los totales con el precio unitario por defecto (1 unidad, 50% de apartado)
                    updatePaymentAmounts(); 
                } else {
                    alert('Error: Producto no encontrado.');
                    paymentModal.hide();
                }
            });

            // Cuando el modal se cierra
            paymentModalElement.addEventListener('hide.bs.modal', function () {
                initializeBadges();
            });
            
            // Lógica para avanzar entre pasos del modal
            mainButton.addEventListener('click', function () {
                document.getElementById('payment-error').style.display = 'none';
                document.getElementById('selection-error').style.display = 'none';

                if (modalStep === 1) {
                    if (!currentSelectedSize) {
                        document.getElementById('selection-error').style.display = 'block';
                        return;
                    }
                    if (getAvailableStock(currentProductID, currentSelectedSize) < currentSelectedQuantity) {
                        alert("¡Lo sentimos! El stock disponible ha cambiado. Por favor, revisa y ajusta tu pedido.");
                        createSizeButtons(currentProductID); 
                        return;
                    }

                    modalStep = 2;
                    selectionStep.style.display = 'none';
                    paymentStep.style.display = 'block';
                    mainButton.textContent = 'Ver Datos de Pago y Confirmar Apartado';
                    mainButton.disabled = false;
                    
                    updatePaymentStepInfo();
                
                } else if (modalStep === 2) {
                    const name = clientNameInput.value.trim();
                    const phone = clientPhoneInput.value.trim();
                    const address = clientAddressInput.value.trim();

                    if (!name || !phone || !address) {
                        document.getElementById('payment-error').style.display = 'block';
                        return;
                    }
                    
                    modalStep = 3;
                    paymentStep.style.display = 'none';
                    transferInfo.style.display = 'block';
                    
                    mainButton.style.display = 'none';
                    whatsappButton.style.display = 'inline-block';
                    
                    updatePaymentAmounts();
                }
            });
            
            // Listener para el cambio de cantidad
            quantityInput.addEventListener('input', function() {
                // Validación para asegurarse de que siempre es al menos 1 y no supera el stock
                let value = parseInt(this.value);
                const stock = getAvailableStock(currentProductID, currentSelectedSize);
                
                if (isNaN(value) || value < 1) {
                    value = 1;
                }
                if (value > stock) {
                    value = stock;
                }
                this.value = value;
                currentSelectedQuantity = value;
                updatePaymentAmounts();
            });

            // Listener para el cambio en el tipo de pago (Total/Mitad)
            halfPaymentCheck.addEventListener('change', updatePaymentAmounts);
            
            
            // --- LÓGICA CLAVE: Apartar al enviar comprobante (Paso 3) ---
            whatsappButton.addEventListener('click', function (event) {
                reserveStock(); 
                
                const total = currentPrice * currentSelectedQuantity;
                const paymentFactor = halfPaymentCheck.checked ? 0.5 : 1.0;
                const paymentDue = total * paymentFactor;
                const paymentType = halfPaymentCheck.checked ? 'Apartado (50%)' : 'Pago Total (100%)';

                const orderDetails = `*Playera:* ${currentProductName}\n*Talla:* ${currentSelectedSize}\n*Cantidad:* ${currentSelectedQuantity}\n*Total:* $${total.toFixed(2)} MXN\n*Monto a Pagar:* $${paymentDue.toFixed(2)} MXN (${paymentType})\n\n*Datos del Cliente:*\n*Nombre:* ${clientNameInput.value.trim()}\n*Teléfono:* ${clientPhoneInput.value.trim()}\n*Dirección:* ${clientAddressInput.value.trim()}\n\n¡Adjunto mi comprobante de pago!\nGracias.`;

                const whatsappLink = `https://wa.me/${WHATSAPP_PHONE}?text=${encodeURIComponent('¡Hola! Quiero confirmar mi pedido:\n\n' + orderDetails)}`;
                
                this.href = whatsappLink;

                setTimeout(() => {
                    paymentModal.hide();
                }, 500); 
            });


            // EXPOSICIÓN GLOBAL PARA ACCESO POR CONSOLA
            window.admin = function(password) {
                showAdminPanel(password);
            };
            
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.shiftKey && e.key === 'A') { 
                    e.preventDefault();
                    const password = prompt("Introduce la contraseña de administrador:");
                    if (password) {
                        showAdminPanel(password);
                    }
                }
            });

            // --- INICIALIZACIÓN ---
            renderProductCards();
        });
    </script>
</body>
</html>

