<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPLAY - CatÃ¡logo Completo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* ======================================= */
        /* ESTILOS CSS GENERALES */
        /* ======================================= */
        body {
            background-color: #f8f9fa;
        }
        .product-card {
            border: 1px solid #ddd;
            transition: transform 0.2s;
            margin-bottom: 20px;
        }
        .product-card:hover {
            transform: translateY(-5px);
        }
        .btn-buy {
            background-color: #ff3366;
            color: white;
            border: none;
        }
        .btn-buy:hover {
            background-color: #e6004b;
            color: white;
        }
        /* Esto oculta el badge de stock en la tarjeta */
        .stock-badge {
            display: none !important; 
        }
        .carousel-item img {
            max-height: 500px;
            object-fit: contain;
        }
        /* Estilo para el botÃ³n de WhatsApp fijo */
        .whatsapp-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: #25d366;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 60px;
            font-size: 30px;
            z-index: 1000;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .whatsapp-button:hover {
            background-color: #128c7e;
        }
        .whatsapp-button i {
            display: inline-block;
            transform: translateY(10%);
        }
        /* Estilos para el carrusel de imÃ¡genes */
        .carousel-indicators [data-bs-target] {
            background-color: #ff3366;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            opacity: 0.5;
        }
        .carousel-indicators .active {
            opacity: 1;
        }

        /* ======================================= */
        /* ESTILOS NUEVOS PARA COLOR SWATCH */
        /* ======================================= */
        .color-swatch {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #ccc;
            cursor: pointer;
            display: inline-block;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        /* AsignaciÃ³n de color */
        .color-swatch[data-color-key="NEGRO"] { background-color: black; }
        .color-swatch[data-color-key="BLANCO"] { background-color: white; border-color: #666; }

        .color-swatch.active {
            border-color: #ff3366; /* Color de acento */
            box-shadow: 0 0 5px #ff3366;
            transform: scale(1.1);
        }
    </style>
</head>
<body>

    <a href="https://wa.me/529991480151" target="_blank" class="whatsapp-button" title="Haz tu pedido por WhatsApp">
        &#x2705; 
    </a>

    <header class="p-3 mb-4 bg-white shadow-sm">
        <div class="container d-flex justify-content-between align-items-center">
            <img src='https://ventaplayera.github.io/RPLAY/logo.png' alt="Logo de mi tienda" style="max-width: 250px; height: auto;">
            <h1 class="h3 text-primary d-none d-md-block">CatÃ¡logo RPLAY</h1>
            <button class="btn btn-outline-secondary" onclick="openOrdersModal()">
                Pedidos <span class="badge text-bg-primary" id="ordersCounter">0</span>
            </button>
        </div>
    </header>

    <main class="container">
        <div class="row" id="product-list">
            </div>

    </main>

    <div class="modal fade" id="productDetailModal" tabindex="-1" aria-labelledby="productDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productDetailModalLabel">Detalles del Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
                                <div class="carousel-indicators" id="carouselIndicators"></div>
                                <div class="carousel-inner" id="carouselInner"></div>
                                <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Previous</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Next</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h2 id="modalProductName" class="text-primary"></h2>
                            <p id="modalProductDescription" class="text-muted"></p>
                            
                            <h3 id="modalProductPrice" class="my-3 text-success"></h3>
                            
                            <form id="orderForm">
                                <input type="hidden" id="modalProductId" name="productId">
                                <input type="hidden" id="selectedColorKey" name="colorKey"> 

                                <div class="mb-3" id="colorSelectorContainer">
                                    </div>

                                <div class="mb-3">
                                    <label for="sizeSelect" class="form-label">Talla:</label>
                                    <select class="form-select" id="sizeSelect" name="size" required></select>
                                </div>

                                <div class="mb-3">
                                    <label for="quantityInput" class="form-label">Cantidad:</label>
                                    <input type="number" class="form-control" id="quantityInput" name="quantity" value="1" min="1" required>
                                </div>

                                <div class="mb-3" style="display:none;">
                                    <span id="stockIndicator" class="badge"></span>
                                </div>

                                <button type="submit" class="btn btn-buy w-100" id="addToOrderButton">AÃ±adir al Pedido</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="ordersModal" tabindex="-1" aria-labelledby="ordersModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="ordersModalLabel">Mi Pedido</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="list-group mb-4" id="currentOrdersList">
                        <li class="list-group-item text-center text-muted" id="emptyOrdersMessage" style="display: none;">Tu pedido estÃ¡ vacÃ­o.</li>
                    </ul>

                    <h4 class="mb-3">Total a Pagar: <span id="ordersTotal" class="text-success">$0.00</span></h4>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" value="" id="halfPaymentCheck">
                        <label class="form-check-label" for="halfPaymentCheck">
                            Pagar el 50% de anticipo (<span id="halfPaymentAmount">$0.00</span>)
                        </label>
                    </div>

                    <hr>

                    <form id="clientDataForm" class="mt-4">
                        <h5 class="text-primary">Datos para EnvÃ­o y Contacto</h5>
                        <div class="mb-3">
                            <label for="clientName" class="form-label">Nombre Completo:</label>
                            <input type="text" class="form-control" id="clientName" required>
                        </div>
                        <div class="mb-3">
                            <label for="clientAddress" class="form-label">DirecciÃ³n Completa (Calle, NÃºmero, Colonia, C.P.):</label>
                            <textarea class="form-control" id="clientAddress" rows="2" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="clientPhone" class="form-label">TelÃ©fono (WhatsApp):</label>
                            <input type="tel" class="form-control" id="clientPhone" required>
                        </div>
                    </form>

                    <div id="paymentDetailsSection" style="display: none;">
                        <hr>
                        <h5 class="text-primary">Datos de Transferencia Bancaria</h5>
                        <p class="mb-1"><strong>Banco:</strong> ðŸš¨ TU BANCO ðŸš¨</p>
                        <p class="mb-1"><strong>NÃºmero de Cuenta:</strong> ðŸš¨ TU NÃšMERO DE CUENTA REAL ðŸš¨</p>
                        <p class="mb-1"><strong>CLABE Interbancaria:</strong> ðŸš¨ TU CLABE INTERBANCARIA REAL ðŸš¨</p>
                        <p class="mb-1"><strong>Beneficiario:</strong> ðŸš¨ TU NOMBRE/EMPRESA ðŸš¨</p>
                        
                        <p class="mt-3 text-muted">Una vez hecha la transferencia o depÃ³sito, presiona "Enviar Pedido por WhatsApp" y adjunta tu comprobante.</p>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Seguir Comprando</button>
                    <button type="button" class="btn btn-buy" id="finalizeOrderButton" disabled onclick="sendOrderToWhatsapp()">
                        Enviar Pedido por WhatsApp
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // =======================================================
        // 1. CONFIGURACIÃ“N INICIAL Y VARIABLES GLOBALES
        // =======================================================
        const PRODUCT_PRICE = 450.00; 
        const MINIMUM_TO_SHIP = 1;   
        
        // NÃºmero de WhatsApp para el pedido final
        const WHATSAPP_NUMBER = '529991480151'; 
        
        let productData = []; 
        let productInventory = {}; 
        let currentOrder = []; 

        let orderIdCounter = 0;
        let PENDING_ORDERS = []; 

        // Tallas por defecto para casi todos los modelos
        const DEFAULT_GLOBAL_SIZES = ['S', 'M', 'L', 'XL'];
        const DEFAULT_COLOR_KEY = 'NEGRO'; 

        // =======================================================
        // 2. FUNCIÃ“N DE INVENTARIO INICIAL (Genera todos los modelos 1 a 44)
        // =======================================================

        function generateInitialInventory() {
            productData.length = 0; 
            for (const key in productInventory) { delete productInventory[key]; }

            const GENERIC_SIDE_IMAGE = 'https://i.imgur.com/uR1j9sW.png'; 
            // ðŸš¨ AsegÃºrate de que todas estas imÃ¡genes existan en tu GITHUB para que el color dinÃ¡mico funcione
            const GITHUB_BASE_URL = 'https://ventaplayera.github.io/RPLAY/'; 
            
            let initialStock = 50; 
            
            for (let i = 1; i <= 44; i++) {
                const id = `PROD_${String(i).padStart(3, '0')}`;
                
                let modelSizes = [...DEFAULT_GLOBAL_SIZES]; 
                let productName = `Playera Modelo No. ${i}`;
                let productDescription = `DiseÃ±o exclusivo #${i}. Â¡Modifica este texto!`;
                
                let frontImg, backImg, sideImg = GENERIC_SIDE_IMAGE;
                
                let colorVariations = [];
                let hasColors = false;

                // --- AJUSTE DE DATOS, ENLACES DE IMAGEN Y TALLAS POR MODELO ---
                
                if (i === 1) { 
                    productName = 'BTS (Blanco)'; 
                    productDescription = 'DiseÃ±o original de BTS en blanco. EdiciÃ³n especial.';
                    frontImg = GITHUB_BASE_URL + 'Xime1.png';
                    backImg = GITHUB_BASE_URL + 'Xime2.png';
                    sideImg = GITHUB_BASE_URL + 'blanco.png'; 
                } 
                else if (i === 2) { 
                    productName = 'BTS (Negro)'; 
                    productDescription = 'DiseÃ±o original de BTS en negro. EdiciÃ³n especial.';
                    frontImg = GITHUB_BASE_URL + 'Xime3.png';
                    backImg = GITHUB_BASE_URL + 'Xime4.png';
                    sideImg = GITHUB_BASE_URL + 'negro.png'; 
                } 
                else if (i === 5) { 
                    productName = 'BRUNO MARS'; 
                    productDescription = 'Playera inspirada en Bruno Mars. Â¡Stock limitado en tallas!'; 
                    modelSizes = ['M', 'L']; 
                } 
                else if (i === 43) { 
                    // ðŸš¨ MODELO 43 CON VARIACIÃ“N DE COLOR
                    productName = 'Playera BLACKPINK';
                    productDescription = 'DiseÃ±o oficial de Blackpink, disponible en negro y blanco.';
                    modelSizes = ['S', 'M', 'L', 'XL'];
                    hasColors = true;
                    colorVariations = [
                        // ASEGÃšRATE QUE LAS SIGUIENTES RUTAS EXISTAN:
                        { name: 'Negro', key: 'NEGRO', mainImg: GITHUB_BASE_URL + '43_negro_frente.png', backImg: GITHUB_BASE_URL + '43_negro_espalda.png' },
                        { name: 'Blanco', key: 'BLANCO', mainImg: GITHUB_BASE_URL + '43_blanco_frente.png', backImg: GITHUB_BASE_URL + '43_blanco_espalda.png' }
                    ];
                }
                else if (i === 44) { 
                    // ðŸš¨ MODELO 44 CON VARIACIÃ“N DE COLOR
                    productName = 'Playera Modelo 44 (Dama)';
                    productDescription = 'DiseÃ±o con corte ajustado para dama, disponible en negro y blanco.';
                    modelSizes = ['S', 'M', 'L'];
                    hasColors = true;
                    colorVariations = [
                        // ASEGÃšRATE QUE LAS SIGUIENTES RUTAS EXISTAN:
                        { name: 'Negro', key: 'NEGRO', mainImg: GITHUB_BASE_URL + '44_negro_frente.png', backImg: GITHUB_BASE_URL + '44_negro_espalda.png' },
                        { name: 'Blanco', key: 'BLANCO', mainImg: GITHUB_BASE_URL + '44_blanco_frente.png', backImg: GITHUB_BASE_URL + '44_blanco_espalda.png' }
                    ];
                }
                
                // --- CONVENCIÃ“N DE NOMBRES POR DEFECTO ---
                if (!hasColors) {
                    if (!frontImg) {
                        frontImg = `${GITHUB_BASE_URL}xime${i}_frente.png`; 
                        backImg = `${GITHUB_BASE_URL}xime${i}_espalda.png`; 
                    }
                } else {
                    // Si tiene colores, la imagen principal de la tarjeta es el primer color (Negro)
                    frontImg = colorVariations.find(c => c.key === DEFAULT_COLOR_KEY)?.mainImg || colorVariations[0].mainImg;
                    backImg = colorVariations.find(c => c.key === DEFAULT_COLOR_KEY)?.backImg || colorVariations[0].backImg;
                }
                
                const mainImg = frontImg; 

                // --- INVENTARIO INICIAL ---
                if (hasColors) {
                    colorVariations.forEach(color => {
                        for (const size of modelSizes) {
                            // Key incluye color: PROD_043_NEGRO_S
                            productInventory[`${id}_${color.key}_${size}`] = initialStock;
                        }
                    });
                } else {
                    for (const size of modelSizes) {
                        // Key normal: PROD_001_S
                        productInventory[`${id}_${size}`] = initialStock;
                    }
                }
                
                // --- CREACIÃ“N DEL OBJETO PRODUCTO ---
                const product = {
                    id: id,
                    name: productName,
                    description: productDescription,
                    price: PRODUCT_PRICE,
                    sizes: modelSizes, 
                    hasColors: hasColors, 
                    colors: colorVariations, 
                    mainImg: mainImg, // Imagen de la tarjeta
                    frontImg: frontImg, 
                    backImg: backImg,
                    sideImg: sideImg,
                };

                productData.push(product);
            }
        }

        // =======================================================
        // 3. FUNCIONES DE ALMACENAMIENTO (STORAGE)
        // =======================================================

        function saveInventoryStorage() {
            localStorage.setItem('productInventory', JSON.stringify(productInventory));
        }

        function loadInventoryStorage() {
            const storedInventory = localStorage.getItem('productInventory');
            if (storedInventory) {
                productInventory = JSON.parse(storedInventory); 
            } else {
                // Si no hay inventario guardado, generarlo y guardarlo
                generateInitialInventory(); 
                saveInventoryStorage();
            }
        }
        
        function saveOrdersStorage() {
            localStorage.setItem('pendingOrders', JSON.stringify(PENDING_ORDERS));
            localStorage.setItem('orderIdCounter', orderIdCounter);
            document.getElementById('ordersCounter').textContent = currentOrder.length;
        }

        function loadOrdersStorage() {
            const storedOrders = localStorage.getItem('pendingOrders');
            if (storedOrders) {
                PENDING_ORDERS = JSON.parse(storedOrders);
            }
            const storedCounter = localStorage.getItem('orderIdCounter');
            if (storedCounter) {
                orderIdCounter = parseInt(storedCounter);
            }
        }

        // =======================================================
        // 4. LÃ“GICA DE STOCKS (Ahora acepta Color)
        // =======================================================

        function getStock(productId, size, colorKey = null) {
            // La clave de stock incluye color solo si colorKey NO es null
            const key = colorKey ? `${productId}_${colorKey}_${size}` : `${productId}_${size}`;
            return productInventory[key] || 0; 
        }

        // =======================================================
        // 5. RENDERIZACIÃ“N DE TARJETAS DE PRODUCTO
        // =======================================================

        function renderProductCards() {
            const list = document.getElementById('product-list');
            list.innerHTML = ''; 

            productData.forEach(product => {
                const maxStock = product.sizes.reduce((max, size) => {
                    if (product.hasColors) {
                        return product.colors.reduce((c_max, color) => Math.max(c_max, getStock(product.id, size, color.key)), max);
                    } else {
                        return Math.max(max, getStock(product.id, size));
                    }
                }, 0);
                
                const status = maxStock >= MINIMUM_TO_SHIP ? 'Disponible' : 'Agotado'; 
                const statusClass = maxStock >= MINIMUM_TO_SHIP ? 'bg-success' : 'bg-danger';

                const card = `
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card product-card h-100">
                            <span class="stock-badge ${statusClass}">${status}</span> 
                            <img src="${product.mainImg}" class="card-img-top p-2" alt="${product.name}">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">${product.name}</h5>
                                <p class="card-text text-success fw-bold">$${product.price.toFixed(2)}</p>
                                <button class="btn btn-buy mt-auto btn-block btn-lg" data-product-id="${product.id}">
                                    Ver / Pedir
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                list.innerHTML += card;
            });
        }
        
        // =======================================================
        // 6. LÃ“GICA DE MODAL DE DETALLE Y ADD TO ORDER
        // =======================================================
        
        // FunciÃ³n maestra para actualizar la UI del modal de detalle
        function updateModalDetailsUI(product, colorKey, size) {
            // Obtiene las imÃ¡genes especÃ­ficas para el color seleccionado (si aplica)
            let currentImages = { frontImg: product.frontImg, backImg: product.backImg, sideImg: product.sideImg };

            if (product.hasColors && colorKey) {
                const colorInfo = product.colors.find(c => c.key === colorKey);
                if (colorInfo) {
                    currentImages.frontImg = colorInfo.mainImg;
                    currentImages.backImg = colorInfo.backImg;
                    // Mantener el sideImg genÃ©rico o especÃ­fico del producto si no cambia por color
                    // currentImages.sideImg = product.sideImg; 
                }
            }

            renderCarousel(currentImages);
            updateTotalAndCheckStock(product.id, size, colorKey);
        }

        function openModalDetail(productId) {
            const product = productData.find(p => p.id === productId);
            if (!product) return;

            // 1. InicializaciÃ³n de campos de texto
            document.getElementById('modalProductId').value = productId;
            document.getElementById('modalProductName').textContent = product.name;
            document.getElementById('modalProductDescription').textContent = product.description;
            document.getElementById('modalProductPrice').textContent = `$${product.price.toFixed(2)}`;
            
            // 2. Tallas
            const sizeSelect = document.getElementById('sizeSelect');
            sizeSelect.innerHTML = '';
            product.sizes.forEach(size => {
                const option = document.createElement('option');
                option.value = size;
                option.textContent = size;
                sizeSelect.appendChild(option);
            });
            document.getElementById('quantityInput').value = 1;

            // 3. Colores (NUEVO)
            const colorContainer = document.getElementById('colorSelectorContainer');
            let defaultColorKey = null;

            if (product.hasColors) {
                colorContainer.innerHTML = '<label class="form-label">Color:</label><div id="colorSwatches" data-product-id="' + productId + '"></div>';
                defaultColorKey = product.colors[0].key; 
                document.getElementById('selectedColorKey').value = defaultColorKey; 
                renderColorSelector(product, defaultColorKey);
            } else {
                colorContainer.innerHTML = ''; // Ocultar si no tiene colores
                document.getElementById('selectedColorKey').value = null; // Asegurar que es null si no aplica
            }
            
            // 4. Valores iniciales
            const initialSize = sizeSelect.value;
            updateModalDetailsUI(product, defaultColorKey, initialSize);
            
            // 5. Adjuntar Listeners para actualizar UI
            sizeSelect.onchange = () => {
                const newSize = sizeSelect.value;
                const currentColor = document.getElementById('selectedColorKey').value;
                updateModalDetailsUI(product, currentColor, newSize);
            };
            
            const quantityInput = document.getElementById('quantityInput');
            quantityInput.onchange = () => updateTotalAndCheckStock(productId, sizeSelect.value, document.getElementById('selectedColorKey').value);
            quantityInput.oninput = () => updateTotalAndCheckStock(productId, sizeSelect.value, document.getElementById('selectedColorKey').value);

            // 6. Mostrar Modal
            const modal = new bootstrap.Modal(document.getElementById('productDetailModal'));
            modal.show();
        }
        
        // ðŸ”´ NUEVA FUNCIÃ“N: RENDERIZA LOS BOTONES DE COLOR
        function renderColorSelector(product, defaultColorKey) {
            const swatchesContainer = document.getElementById('colorSwatches');
            swatchesContainer.innerHTML = '';
            
            product.colors.forEach(color => {
                const swatch = document.createElement('span');
                swatch.className = 'color-swatch';
                swatch.title = color.name;
                swatch.setAttribute('data-color-key', color.key);
                
                if (color.key === defaultColorKey) {
                    swatch.classList.add('active');
                }

                swatch.onclick = function() {
                    // 1. Obtener datos y actualizar el campo oculto
                    const productId = swatchesContainer.getAttribute('data-product-id');
                    const currentProduct = productData.find(p => p.id === productId);
                    const newColorKey = color.key;
                    document.getElementById('selectedColorKey').value = newColorKey;
                    
                    // 2. Desactivar todos y activar el actual
                    swatchesContainer.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 3. Actualizar carrusel y stock
                    const size = document.getElementById('sizeSelect').value;
                    updateModalDetailsUI(currentProduct, newColorKey, size);
                };
                
                swatchesContainer.appendChild(swatch);
            });
        }
        
        // FunciÃ³n para renderizar carrusel con imÃ¡genes correctas
        function renderCarousel(images) {
            const indicators = document.getElementById('carouselIndicators');
            const inner = document.getElementById('carouselInner');
            indicators.innerHTML = '';
            inner.innerHTML = '';

            // Utilizamos las imÃ¡genes pasadas (que ya fueron resueltas por color si aplica)
            const imageSet = [
                { url: images.frontImg, alt: `Frente` },
                { url: images.backImg, alt: `Espalda` },
                { url: images.sideImg, alt: `Lateral` }
            ];

            imageSet.forEach((img, index) => {
                indicators.innerHTML += `
                    <button type="button" data-bs-target="#productCarousel" data-bs-slide-to="${index}" 
                        class="${index === 0 ? 'active' : ''}" aria-current="${index === 0 ? 'true' : 'false'}" 
                        aria-label="Slide ${index + 1}">
                    </button>
                `;
                
                inner.innerHTML += `
                    <div class="carousel-item ${index === 0 ? 'active' : ''}">
                        <img src="${img.url}" class="d-block w-100" alt="${img.alt}">
                    </div>
                `;
            });
            // Reiniciar el carrusel para mostrar la primera imagen (frontal)
            const carouselElement = document.getElementById('productCarousel');
            const carousel = bootstrap.Carousel.getInstance(carouselElement) || new bootstrap.Carousel(carouselElement);
            carousel.to(0);
        }
        
        // FunciÃ³n para actualizar stock (Ahora usa Color)
        function updateTotalAndCheckStock(productId, size, colorKey = null) {
            const quantityInput = document.getElementById('quantityInput');
            let quantity = parseInt(quantityInput.value);
            
            const stock = getStock(productId, size, colorKey);
            const addButton = document.getElementById('addToOrderButton');

            if (quantity < 1 || isNaN(quantity)) {
                quantityInput.value = 1;
                quantity = 1;
            }

            if (quantity > stock && stock > 0) {
                quantityInput.value = stock;
                quantity = stock;
            }

            if (stock > 0 && quantity > 0) {
                addButton.disabled = false;
                addButton.textContent = `AÃ±adir ${quantity} a Pedido`;
            } else {
                addButton.disabled = true;
                addButton.textContent = 'AÃ±adir al Pedido (Agotado)';
            }
            
            document.getElementById('stockIndicator').textContent = `Stock: ${stock}`;
        }


        // ðŸ”´ CRÃTICO: MANEJO DEL ENVÃO DEL FORMULARIO 'AÃ±adir al Pedido' (Ahora con Color)
        document.getElementById('orderForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const productId = document.getElementById('modalProductId').value;
            const product = productData.find(p => p.id === productId);
            const size = document.getElementById('sizeSelect').value;
            const colorKey = document.getElementById('selectedColorKey').value;
            const quantity = parseInt(document.getElementById('quantityInput').value);

            if (!product || quantity <= 0 || !size) return;

            // Chequeo de Stock con Color
            const stock = getStock(productId, size, colorKey);

            if (quantity > stock) {
                alert(`Error: Solo quedan ${stock} unidades disponibles en ${colorKey ? colorKey + ' ' : ''} talla ${size}. Por favor, reduce la cantidad.`);
                return;
            }
            
            // Obtener el nombre del color para mostrarlo en el carrito
            const colorName = colorKey 
                ? product.colors.find(c => c.key === colorKey)?.name || colorKey
                : null;


            const existingItemIndex = currentOrder.findIndex(item => 
                item.productId === productId && item.size === size && item.colorKey === colorKey
            );

            if (existingItemIndex !== -1) {
                currentOrder[existingItemIndex].quantity += quantity;
            } else {
                currentOrder.push({
                    productId: productId,
                    name: product.name,
                    size: size,
                    colorKey: colorKey, 
                    colorName: colorName, 
                    quantity: quantity,
                    price: product.price
                });
            }

            const detailModal = bootstrap.Modal.getInstance(document.getElementById('productDetailModal'));
            detailModal.hide();
            openOrdersModal(); 
        });

        // =======================================================
        // 7. LÃ“GICA DE MODAL DE PEDIDOS (Carrito) (Ahora con Color)
        // =======================================================

        function openOrdersModal() {
            renderOrdersList();
            const modal = new bootstrap.Modal(document.getElementById('ordersModal'));
            modal.show();
        }

        function renderOrdersList() {
            const list = document.getElementById('currentOrdersList');
            const emptyMessage = document.getElementById('emptyOrdersMessage');
            
            list.querySelectorAll('li:not(#emptyOrdersMessage)').forEach(item => item.remove());
            
            if (currentOrder.length === 0) {
                emptyMessage.style.display = 'block';
                document.getElementById('finalizeOrderButton').disabled = true;
                updateOrdersCounter(0);
                updateModalUI(false);
                updateOrdersTotal(); 
                return;
            }

            emptyMessage.style.display = 'none';

            currentOrder.forEach((item, index) => {
                const totalPrice = item.quantity * item.price;
                const colorDisplay = item.colorName ? ` (${item.colorName})` : ''; // Mostrar color si existe

                const listItem = document.createElement('li');
                listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                listItem.innerHTML = `
                    <div>
                        <span class="fw-bold">${item.name}</span>${colorDisplay} (${item.size}) x ${item.quantity}
                        <div class="text-muted small">$${item.price.toFixed(2)} c/u</div>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="fw-bold text-primary me-3">$${totalPrice.toFixed(2)}</span>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeItemFromOrder(${index})">
                            &times;
                        </button>
                    </div>
                `;
                list.insertBefore(listItem, emptyMessage);
            });
            
            updateOrdersCounter(currentOrder.length);
            updateModalUI(true);
            updateOrdersTotal();
        }

        function removeItemFromOrder(index) {
            currentOrder.splice(index, 1);
            renderOrdersList();
        }

        function updateOrdersTotal() {
            const totalElement = document.getElementById('ordersTotal');
            const halfPaymentElement = document.getElementById('halfPaymentAmount');
            const halfPaymentCheck = document.getElementById('halfPaymentCheck');
            
            const subtotal = currentOrder.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            
            const halfAmount = subtotal / 2;
            halfPaymentElement.textContent = `$${halfAmount.toFixed(2)}`;

            if (halfPaymentCheck.checked) {
                totalElement.textContent = `$${halfAmount.toFixed(2)}`;
            } else {
                totalElement.textContent = `$${subtotal.toFixed(2)}`;
            }
        }
        
        function updateOrdersCounter(count) {
            document.getElementById('ordersCounter').textContent = count;
        }

        function updateModalUI(hasItems) {
            const finalizeButton = document.getElementById('finalizeOrderButton');
            const clientDataForm = document.getElementById('clientDataForm');
            const paymentDetailsSection = document.getElementById('paymentDetailsSection');
            
            // Si hay items y los datos del cliente son vÃ¡lidos, el botÃ³n estÃ¡ habilitado
            if (hasItems) {
                finalizeButton.disabled = !clientDataForm.checkValidity(); 
                clientDataForm.style.display = 'block';
                paymentDetailsSection.style.display = 'block';
            } else {
                finalizeButton.disabled = true;
                clientDataForm.style.display = 'none';
                paymentDetailsSection.style.display = 'none';
            }
        }

        // =======================================================
        // 8. LÃ“GICA DE ENVÃO POR WHATSAPP (Ahora con Color)
        // =======================================================

        function sendOrderToWhatsapp() {
            if (currentOrder.length === 0 || !document.getElementById('clientDataForm').checkValidity()) {
                alert("Por favor, aÃ±ade productos al pedido y completa tus datos de envÃ­o.");
                return;
            }

            const clientName = document.getElementById('clientName').value;
            const clientAddress = document.getElementById('clientAddress').value;
            const clientPhone = document.getElementById('clientPhone').value;
            const isHalfPayment = document.getElementById('halfPaymentCheck').checked;
            
            const total = currentOrder.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            const amountToPay = isHalfPayment ? total / 2 : total;

            let orderText = `*PEDIDO #${orderIdCounter + 1} - RPLAY*\n\n`;
            orderText += `*Total a Pagar:* $${amountToPay.toFixed(2)} (${isHalfPayment ? 'Anticipo 50%' : 'Pago Completo'})\n`;
            orderText += `*Productos:*\n`;
            
            currentOrder.forEach((item, index) => {
                const colorDisplay = item.colorName ? ` (${item.colorName})` : '';
                orderText += `${index + 1}. ${item.name}${colorDisplay} (${item.size}) - ${item.quantity} pza(s) - $${(item.quantity * item.price).toFixed(2)}\n`;
            });

            orderText += `\n*Datos del Cliente:*\n`;
            orderText += `Nombre: ${clientName}\n`;
            orderText += `TelÃ©fono: ${clientPhone}\n`;
            orderText += `DirecciÃ³n: ${clientAddress}\n`;
            orderText += `\n*IMPORTANTE:* Adjunta aquÃ­ tu comprobante de pago o transferencia para confirmar tu pedido.`;

            const whatsappURL = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(orderText)}`;

            // 1. Guardar historial y aumentar el contador
            orderIdCounter++;
            PENDING_ORDERS.push({
                id: orderIdCounter,
                items: JSON.parse(JSON.stringify(currentOrder)), 
                client: { name: clientName, address: clientAddress, phone: clientPhone },
                total: total,
                amountPaid: amountToPay,
                date: new Date().toLocaleString()
            });

            // 2. APLICAR EL DESCUENTO DEL STOCK (Ahora usa Color)
            currentOrder.forEach(item => {
                const colorPart = item.colorKey ? `${item.colorKey}_` : '';
                const key = `${item.productId}_${colorPart}${item.size}`;
                
                if (productInventory[key] >= item.quantity) {
                    productInventory[key] -= item.quantity;
                } else {
                    productInventory[key] = 0; 
                }
            });

            // 3. Limpiar el pedido actual y guardar todo
            currentOrder = [];
            saveInventoryStorage();
            saveOrdersStorage();
            renderProductCards();
            
            // 4. Cerrar el modal y redirigir a WhatsApp
            const ordersModal = bootstrap.Modal.getInstance(document.getElementById('ordersModal'));
            ordersModal.hide();
            
            window.open(whatsappURL, '_blank');
        }

        // =======================================================
        // 9. FUNCIÃ“N DE ADMINISTRACIÃ“N (SOLO POR CONSOLA)
        // =======================================================
        
        // âš ï¸ Esta funciÃ³n SOLO se puede llamar desde la consola del navegador.
        window.resetInventoryAndOrders = function() {
            if (!confirm("â›” ADMINISTRADOR: Â¿EstÃ¡s seguro de que quieres REINICIAR el inventario y todos los pedidos? Esto es SOLO para pruebas.")) return;
            
            generateInitialInventory();
            saveInventoryStorage();
            
            PENDING_ORDERS = [];
            orderIdCounter = 0;
            currentOrder = [];
            saveOrdersStorage();
            
            renderProductCards();
            
            const ordersModal = bootstrap.Modal.getInstance(document.getElementById('ordersModal'));
            if(ordersModal) ordersModal.hide();
            
            alert("Inventario y Ã³rdenes reiniciados con Ã©xito. Â¡DEBES RECARGAR LA PÃGINA AHORA (F5) para asegurar una carga limpia!");
        }

        // =======================================================
        // 10. INICIALIZACIÃ“N
        // =======================================================

        document.addEventListener('DOMContentLoaded', () => {
            
            loadOrdersStorage();
            
            // 1. Listener para abrir el modal de detalle
            document.getElementById('product-list').addEventListener('click', (e) => {
                const target = e.target.closest('.btn-buy');
                if (target) {
                    const productId = target.getAttribute('data-product-id');
                    openModalDetail(productId); 
                }
            });
            
            // 2. Listener para revalidar el botÃ³n de pedido final al cambiar los datos del cliente
            const clientDataForm = document.getElementById('clientDataForm');
            if (clientDataForm) {
                clientDataForm.addEventListener('input', () => updateModalUI(currentOrder.length > 0));
            }

            // 3. Listener para actualizar el monto a pagar al marcar/desmarcar "Pagar la Mitad"
            const halfPaymentCheck = document.getElementById('halfPaymentCheck');
            if (halfPaymentCheck) {
                halfPaymentCheck.addEventListener('change', updateOrdersTotal);
            }

            // Llamada a la inicializaciÃ³n de datos y renderizaciÃ³n
            generateInitialInventory();
            loadInventoryStorage(); // Cargar inventario guardado o inicial por defecto
            renderProductCards();
        });

    </script>
</body>
</html>
