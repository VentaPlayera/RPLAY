<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPLAY - Venta de Playeras</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .product-card {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .product-image {
            width: 100%;
            height: auto;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .stock-label {
            font-size: 0.9em;
            color: #d9534f;
            font-weight: bold;
        }
        .product-details {
            cursor: pointer;
        }
        .color-option {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            border: 1px solid #000;
            cursor: pointer;
        }
        .color-option.selected {
            border: 3px solid #007bff;
        }
        .modal-image {
            width: 100%;
            height: 400px;
            object-fit: cover;
            border-radius: 8px;
        }
    </style>
</head>
<body>

    <div class="container mt-5">
        <h1 class="mb-4 text-center">RPLAY - Venta de Playeras</h1>
        
        <div class="d-flex justify-content-between mb-4">
            <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#cartOffcanvas" aria-controls="cartOffcanvas">
                游 Carrito (<span id="cart-count">0</span>)
            </button>
        </div>

        <div id="products-container" class="row">
            </div>
    </div>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="cartOffcanvas" aria-labelledby="cartOffcanvasLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="cartOffcanvasLabel">游 Tu Carrito</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div id="cart-items">
                </div>
            <hr>
            <h5 class="mb-3">Total: <span id="cart-total">$0.00</span></h5>
            <button class="btn btn-success w-100" onclick="sendOrderToWhatsapp()" id="checkout-button" disabled>
                Finalizar Pedido por WhatsApp
            </button>
        </div>
    </div>

    <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalLabel">Detalles del Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div id="imageCarousel" class="carousel slide" data-bs-ride="carousel">
                                <div class="carousel-inner" id="modal-images-container">
                                    </div>
                                <button class="carousel-control-prev" type="button" data-bs-target="#imageCarousel" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Previous</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#imageCarousel" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Next</span>
                                </button>
                                <div class="carousel-indicators" id="modal-indicators-container">
                                    </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h2 id="modal-name"></h2>
                            <p id="modal-description"></p>
                            <h3 class="text-success" id="modal-price"></h3>

                            <div id="modal-color-container" class="mb-3" style="display: none;">
                                <label class="form-label">Color:</label>
                                <div id="modal-colors-options">
                                    </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="modal-size" class="form-label">Talla:</label>
                                <select class="form-select" id="modal-size">
                                    </select>
                                <small id="modal-stock-info" class="stock-label mt-1"></small>
                            </div>

                            <div class="mb-3">
                                <label for="modal-quantity" class="form-label">Cantidad:</label>
                                <input type="number" id="modal-quantity" class="form-control" value="1" min="1" max="1">
                            </div>

                            <button class="btn btn-danger w-100" id="add-to-cart-button" onclick="addToCart()">A침adir a Carrito</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
        // Importa las funciones necesarias para Firestore (DB)
        import { getFirestore, collection, getDocs, updateDoc, doc, runTransaction } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";
        
        // =======================================================
        // 1. TU CONFIGURACI칍N DE FIREBASE (Proyecto RPLAY)
        // =======================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCtgsjjbNIS0lv5aLdb8nkpN_9-4sXIJVE", 
            authDomain: "rplay-f04dc.firebaseapp.com",
            projectId: "rplay-f04dc",
            storageBucket: "rplay-f04dc.appspot.com",
            messagingSenderId: "787828282738",
            appId: "1:787828282738:web:00c1ff1a7008c0e02b79eb",
            measurementId: "G-XEKR4KEDMR"
        };

        // Inicializa Firebase
        const app = initializeApp(firebaseConfig);
        // Obtiene la instancia de Firestore
        const db = getFirestore(app);

        // Hace que las funciones de Firebase sean globales para que el c칩digo antiguo (en el otro script) las pueda usar
        window.db = db;
        window.getDocs = getDocs;
        window.collection = collection;
        window.updateDoc = updateDoc;
        window.doc = doc;
        window.runTransaction = runTransaction;
    </script>
    
    <script>
        // Variables globales (DEBEN coincidir con la estructura de tu base de datos)
        const PRODUCT_PRICE = 250.00;
        const IMAGE_EXTENSION = ".jpg";
        const GITHUB_BASE_URL = "https://venta-playeras.github.io/RPLAY/img/";
        const GENERIC_SIDE_PLACEHOLDER = "xime3"; 

        // 游뚿 Base de datos local (solo para respaldo y carrito)
        let productData = []; // Lista de objetos de productos (para detalles en el modal)
        let productInventory = {}; // Mapa: clave (ID_TALLA_COLOR) -> stock (n칰mero)
        let cart = []; // Lista de objetos en el carrito

        let currentProduct = null;
        let selectedSize = '';
        let selectedColor = '';
        let maxQuantity = 1;

        // =======================================================
        // FUNCIONES DE BACKUP (Tu inventario anterior, solo si Firebase falla)
        // =======================================================
        function generateFallbackInventory() {
            // Limpia por si acaso
            productData.length = 0;
            productInventory = {};

            // 游뚿 SOLO EL EJEMPLO BTS 1 (Debes agregar el resto de tus productos aqu칤 si quieres un backup)
            const id = 'PROD_001';
            const data = {
                id: id,
                name: 'BTS (Backup)',
                price: 250,
                isColorProduct: false,
                stock: { 'M': 1, 'L': 1, 'XL': 1 }, 
                frontFileBase: 'xime1',
                backFileBase: 'Xime2',
                sideFileBase: GENERIC_SIDE_PLACEHOLDER
            };
            
            productData.push({
                id: id,
                name: data.name,
                description: 'Playera Modelo 1 - Backup local.',
                price: data.price,
                sizes: ['M', 'L', 'XL'],
                isColorProduct: data.isColorProduct, 
                colors: [], colorMap: {}, stockByColor: {},
                mainImg: `${GITHUB_BASE_URL}${data.frontFileBase}${IMAGE_EXTENSION}`,
                frontFileBase: data.frontFileBase,
                backFileBase: data.backFileBase,
                sideFileBase: data.sideFileBase,
            });

            productInventory[`${id}_M`] = 1;
            productInventory[`${id}_L`] = 1;
            productInventory[`${id}_XL`] = 1;
            
            console.log("Inventario cargado desde backup local.");
        }

        // =======================================================
        // 游뚿 NUEVA FUNCI칍N: CARGAR INVENTARIO DESDE FIRESTORE
        // =======================================================
        async function loadInventoryFromFirebase() {
            console.log("Cargando inventario desde Firebase...");
            
            productData.length = 0; // Limpiar la lista de productos
            productInventory = {}; // Limpiar el mapa de stock

            try {
                // 1. Obtener todos los documentos de la colecci칩n 'products'
                const productsCol = collection(db, "products");
                const productSnapshot = await getDocs(productsCol);
                
                productSnapshot.forEach(doc => {
                    const data = doc.data();
                    const id = data.id; 
                    
                    let sizes = [];
                    
                    // Procesar stock para productos sin color (BTS)
                    if (data.stock && !data.isColorProduct) {
                        for (const size in data.stock) {
                            const stockAmount = data.stock[size];
                            if (stockAmount > 0) {
                                // Clave de inventario: PROD_001_M
                                productInventory[`${id}_${size}`] = stockAmount;
                                sizes.push(size);
                            }
                        }
                    }
                    
                    // Procesar stock para productos con color (BLACKPINK)
                    if (data.stockByColor && data.isColorProduct) {
                        for (const color in data.stockByColor) {
                            const sizesByColor = data.stockByColor[color];
                            for (const size in sizesByColor) {
                                const stockAmount = sizesByColor[size];
                                if (stockAmount > 0) {
                                    // Clave de inventario: PROD_042_M_Negro
                                    productInventory[`${id}_${size}_${color}`] = stockAmount;
                                    
                                    // Recolectar todas las tallas disponibles (sin repetir)
                                    if (!sizes.includes(size)) {
                                        sizes.push(size);
                                    }
                                }
                            }
                        }
                    }
                    
                    // 2. Crear el objeto producto para renderizar
                    const product = {
                        id: id,
                        name: data.name,
                        description: data.description || `Playera Modelo ${id.split('_')[1]}`,
                        price: data.price || PRODUCT_PRICE,
                        sizes: sizes.sort(), // Tallas disponibles
                        isColorProduct: data.isColorProduct || false, 
                        colors: data.colors || [], 
                        colorMap: data.colorMap || {},
                        stockByColor: data.stockByColor || {},
                        
                        // Imagen principal (USAMOS LOS NOMBRES DEL DOCUMENTO)
                        mainImg: `${GITHUB_BASE_URL}${data.frontFileBase || 'xime1'}${IMAGE_EXTENSION}`,
                        frontFileBase: data.frontFileBase || 'xime1',
                        backFileBase: data.backFileBase || 'Xime2',
                        sideFileBase: data.sideFileBase || GENERIC_SIDE_PLACEHOLDER,
                    };

                    productData.push(product);
                });
                
                // Si la colecci칩n est치 vac칤a en Firebase, cargamos el backup
                if (productData.length === 0) {
                     generateFallbackInventory();
                }

            } catch (error) {
                console.error("Error al leer de Firebase. Usando inventario de respaldo:", error);
                // Si hay un error de conexi칩n, usamos el inventario de respaldo
                generateFallbackInventory();
            }
        }

        // =======================================================
        // FUNCI칍N PRINCIPAL DE RENDERIZADO
        // =======================================================
        function renderProducts() {
            const container = document.getElementById('products-container');
            container.innerHTML = ''; // Limpiar
            
            productData.forEach(product => {
                const stockTotal = calculateTotalStock(product.id, product.isColorProduct ? product.colors : ['N/A']);
                const stockText = stockTotal > 0 ? `Stock Total: ${stockTotal}` : 'AGOTADO';
                const stockClass = stockTotal > 0 ? 'text-success' : 'stock-label';

                const cardHtml = `
                    <div class="col-md-4">
                        <div class="product-card">
                            <div class="product-details" data-product-id="${product.id}" onclick="showProductModal('${product.id}')">
                                <img src="${product.mainImg}" alt="${product.name}" class="product-image">
                                <h4>${product.name}</h4>
                                <p>${product.description}</p>
                                <h5 class="text-success">$${product.price.toFixed(2)}</h5>
                                <p class="${stockClass}">${stockText}</p>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += cardHtml;
            });
        }
        
        function calculateTotalStock(productId, colors) {
            let total = 0;
            // Si es producto con colores (ej: PROD_042)
            if (colors.length > 0 && colors[0] !== 'N/A') { 
                productData.find(p => p.id === productId).colors.forEach(color => {
                    const stockByColor = productData.find(p => p.id === productId).stockByColor[color];
                    if (stockByColor) {
                        for (const size in stockByColor) {
                             total += stockByColor[size];
                        }
                    }
                });
            } else {
                // Producto simple (ej: PROD_001)
                for (const key in productInventory) {
                    if (key.startsWith(productId)) {
                        total += productInventory[key];
                    }
                }
            }
            return total;
        }

        // =======================================================
        // FUNCIONES DE MODAL Y CARRITO
        // (Estas no cambian mucho, solo usan las variables globales actualizadas)
        // =======================================================
        function showProductModal(productId) {
            currentProduct = productData.find(p => p.id === productId);
            if (!currentProduct) return;

            document.getElementById('modal-name').textContent = currentProduct.name;
            document.getElementById('modal-description').textContent = currentProduct.description;
            document.getElementById('modal-price').textContent = `$${currentProduct.price.toFixed(2)}`;

            // Limpiar y configurar color
            const colorContainer = document.getElementById('modal-color-container');
            const colorOptionsDiv = document.getElementById('modal-colors-options');
            colorOptionsDiv.innerHTML = '';
            selectedColor = '';
            
            if (currentProduct.isColorProduct && currentProduct.colors.length > 0) {
                colorContainer.style.display = 'block';
                currentProduct.colors.forEach((color, index) => {
                    const colorHtml = `<div class="color-option ${color === selectedColor ? 'selected' : ''}" style="background-color: ${color.toLowerCase() === 'negro' ? '#000' : 'white'};" data-color="${color}" onclick="selectColor('${color}')"></div>`;
                    colorOptionsDiv.innerHTML += colorHtml;
                    if (index === 0) { // Seleccionar el primer color por defecto
                        selectedColor = color;
                    }
                });
            } else {
                colorContainer.style.display = 'none';
                selectedColor = 'N/A';
            }

            // Seleccionar el primer color si aplica, para configurar la talla
            selectColor(selectedColor); // Esto actualizar치 el carrusel y las tallas
            
            const modal = new bootstrap.Modal(document.getElementById('productModal'));
            modal.show();
        }

        function selectColor(color) {
            selectedColor = color;
            
            document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
            const selectedEl = document.querySelector(`.color-option[data-color='${color}']`);
            if (selectedEl) selectedEl.classList.add('selected');

            updateModalSizes();
            updateModalImages();
        }

        function updateModalSizes() {
            const sizeSelect = document.getElementById('modal-size');
            sizeSelect.innerHTML = '';
            selectedSize = '';
            
            let availableSizes = [];

            if (currentProduct.isColorProduct && selectedColor !== 'N/A') {
                // Producto con color (usa stockByColor)
                const stockMap = currentProduct.stockByColor[selectedColor];
                if (stockMap) {
                    for (const size in stockMap) {
                        const stock = stockMap[size];
                        if (stock > 0) {
                            availableSizes.push({ size: size, stock: stock });
                        }
                    }
                }
            } else {
                // Producto simple (usa productInventory)
                currentProduct.sizes.forEach(size => {
                    const stock = productInventory[`${currentProduct.id}_${size}`] || 0;
                    if (stock > 0) {
                        availableSizes.push({ size: size, stock: stock });
                    }
                });
            }
            
            if (availableSizes.length === 0) {
                sizeSelect.innerHTML = '<option value="">AGOTADO</option>';
                document.getElementById('modal-stock-info').textContent = 'AGOTADO';
                document.getElementById('add-to-cart-button').disabled = true;
                document.getElementById('modal-quantity').max = 0;
                document.getElementById('modal-quantity').value = 0;
                return;
            }

            // Llenar el select con tallas disponibles
            availableSizes.forEach((item, index) => {
                sizeSelect.innerHTML += `<option value="${item.size}">Talla ${item.size} (Stock: ${item.stock})</option>`;
                if (index === 0) selectedSize = item.size;
            });

            // Seleccionar la primera talla y actualizar stock/cantidad
            sizeSelect.value = selectedSize;
            sizeSelect.onchange = (e) => {
                selectedSize = e.target.value;
                updateModalStockInfo();
            };

            updateModalStockInfo(); // Actualiza info del stock
        }

        function updateModalStockInfo() {
            const stockInfo = document.getElementById('modal-stock-info');
            const quantityInput = document.getElementById('modal-quantity');
            const addButton = document.getElementById('add-to-cart-button');

            const stock = getCurrentStock();
            maxQuantity = stock;

            stockInfo.textContent = `Stock: ${stock}`;
            quantityInput.max = stock;
            quantityInput.value = Math.min(quantityInput.value, stock) || 1;
            
            if (stock > 0) {
                addButton.disabled = false;
            } else {
                addButton.disabled = true;
                quantityInput.value = 0;
            }
        }
        
        function getCurrentStock() {
            const key = currentProduct.isColorProduct && selectedColor !== 'N/A'
                ? `${currentProduct.id}_${selectedSize}_${selectedColor}`
                : `${currentProduct.id}_${selectedSize}`;
            
            // Si es un producto simple, lee de productInventory
            if (!currentProduct.isColorProduct) {
                return productInventory[key] || 0;
            }

            // Si es un producto con color, lee directamente de la estructura anidada del producto
            if (currentProduct.stockByColor[selectedColor]) {
                return currentProduct.stockByColor[selectedColor][selectedSize] || 0;
            }
            
            return 0;
        }

        function updateModalImages() {
            const imagesContainer = document.getElementById('modal-images-container');
            const indicatorsContainer = document.getElementById('modal-indicators-container');
            imagesContainer.innerHTML = '';
            indicatorsContainer.innerHTML = '';

            let baseFiles = [];
            
            if (currentProduct.isColorProduct && currentProduct.colorMap[selectedColor]) {
                // Usar im치genes espec칤ficas del color
                const colorMap = currentProduct.colorMap[selectedColor];
                baseFiles = [colorMap.front, colorMap.back, colorMap.side].filter(f => f);
            } else {
                // Usar im치genes gen칠ricas del producto
                baseFiles = [currentProduct.frontFileBase, currentProduct.backFileBase, currentProduct.sideFileBase].filter(f => f);
            }

            baseFiles.forEach((fileBase, index) => {
                const isActive = index === 0;
                const imageUrl = `${GITHUB_BASE_URL}${fileBase}${IMAGE_EXTENSION}`;
                
                // Im치genes
                imagesContainer.innerHTML += `
                    <div class="carousel-item ${isActive ? 'active' : ''}">
                        <img src="${imageUrl}" class="d-block modal-image" alt="Vista ${index + 1}">
                    </div>
                `;
                // Indicadores
                indicatorsContainer.innerHTML += `
                    <button type="button" data-bs-target="#imageCarousel" data-bs-slide-to="${index}" class="${isActive ? 'active' : ''}" aria-current="${isActive ? 'true' : 'false'}" aria-label="Slide ${index + 1}"></button>
                `;
            });
        }
        
        function addToCart() {
            const quantity = parseInt(document.getElementById('modal-quantity').value);
            const stock = getCurrentStock();

            if (quantity <= 0 || quantity > stock) {
                alert("Cantidad inv치lida o superior al stock disponible.");
                return;
            }

            const itemKey = currentProduct.isColorProduct
                ? `${currentProduct.id}_${selectedSize}_${selectedColor}`
                : `${currentProduct.id}_${selectedSize}`;

            // Buscar si el item ya existe en el carrito
            const existingItemIndex = cart.findIndex(item => item.key === itemKey);

            if (existingItemIndex > -1) {
                // Si existe, sumar cantidad
                cart[existingItemIndex].quantity += quantity;
            } else {
                // Si no existe, a침adir nuevo item
                cart.push({
                    key: itemKey,
                    id: currentProduct.id,
                    name: currentProduct.name,
                    price: currentProduct.price,
                    size: selectedSize,
                    color: currentProduct.isColorProduct ? selectedColor : null,
                    quantity: quantity
                });
            }

            // Cerrar modal y actualizar carrito
            const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
            modal.hide();
            
            saveOrdersStorage();
            updateCartUI();
            
            // Actualizar stock local despu칠s de a침adir al carrito
            // Nota: El stock real se descuenta en Firebase al hacer el checkout
            if (currentProduct.isColorProduct) {
                 currentProduct.stockByColor[selectedColor][selectedSize] -= quantity;
            } else {
                productInventory[itemKey] -= quantity;
            }
            // Recargar para mostrar el stock actualizado en la tarjeta del producto
            renderProducts(); 
        }

        // =======================================================
        // FUNCI칍N DE CHECKOUT (Descuenta stock en Firebase)
        // =======================================================
        async function sendOrderToWhatsapp() {
            if (cart.length === 0) return;

            document.getElementById('checkout-button').disabled = true;
            document.getElementById('checkout-button').textContent = 'Procesando Stock...';

            const transactions = [];
            const itemsToUpdate = {};

            // 1. Prepara las transacciones y el mensaje de WhatsApp
            let whatsappMessage = "춰Hola! Mi pedido RPLAY es:\n\n";
            let totalCost = 0;

            for (const item of cart) {
                // Calcula el costo total del pedido para el mensaje
                totalCost += item.price * item.quantity;

                // Construye el mensaje para WhatsApp
                const colorStr = item.color ? ` - Color: ${item.color}` : '';
                whatsappMessage += `${item.quantity}x Playera ${item.name} (Talla: ${item.size}${colorStr}) - $${(item.price * item.quantity).toFixed(2)}\n`;

                // Prepara la actualizaci칩n para Firestore
                const itemKey = item.id;
                const size = item.size;
                const color = item.color;
                const quantityToSubtract = item.quantity;
                
                // A침ade la funci칩n de transacci칩n a la lista
                transactions.push(async (transaction) => {
                    const docRef = doc(db, "products", itemKey);
                    
                    try {
                        const productDoc = await transaction.get(docRef);
                        if (!productDoc.exists()) {
                            throw new Error(`El producto ${itemKey} no existe en la base de datos.`);
                        }
                        
                        const data = productDoc.data();
                        let currentStock = 0;
                        let newStock = 0;
                        let updateField = {};
                        
                        if (data.isColorProduct) {
                            // L칩gica para producto con color (anidado)
                            currentStock = data.stockByColor[color][size];
                            if (currentStock < quantityToSubtract) {
                                throw new Error(`Stock insuficiente para ${item.name} (${size}, ${color}). Solo quedan ${currentStock}.`);
                            }
                            newStock = currentStock - quantityToSubtract;
                            // Prepara el objeto de actualizaci칩n anidado para Firestore
                            updateField[`stockByColor.${color}.${size}`] = newStock;
                            
                        } else {
                            // L칩gica para producto simple (usa stock directamente)
                            currentStock = data.stock[size];
                            if (currentStock < quantityToSubtract) {
                                throw new Error(`Stock insuficiente para ${item.name} (${size}). Solo quedan ${currentStock}.`);
                            }
                            newStock = currentStock - quantityToSubtract;
                            // Prepara el objeto de actualizaci칩n para Firestore
                            updateField[`stock.${size}`] = newStock;
                        }

                        // Aplica la actualizaci칩n del stock
                        transaction.update(docRef, updateField);

                    } catch (error) {
                        console.error(`Error en transacci칩n para ${item.name}:`, error.message);
                        throw error; // Re-lanza el error para que runTransaction lo maneje
                    }
                });
            }

            // 2. Ejecuta todas las transacciones de Firestore
            try {
                // Ejecuta todas las transacciones secuencialmente (simulando Promise.all para transacciones)
                for (const transactionFunc of transactions) {
                    await runTransaction(db, transactionFunc);
                }
                
                // 칄XITO: El stock se descont칩 correctamente en la nube
                whatsappMessage += `\nCosto Total: $${totalCost.toFixed(2)}\n\n(Stock descontado de la Base de Datos)`;

                // 3. Env칤a el mensaje de WhatsApp y limpia
                const whatsappUrl = `https://wa.me/5215512345678?text=${encodeURIComponent(whatsappMessage)}`; // 游뚿 Reemplaza el n칰mero 5215512345678 con tu n칰mero real
                window.open(whatsappUrl, '_blank');

                // Limpiar carrito y recargar
                cart = [];
                saveOrdersStorage();
                updateCartUI();
                await loadInventoryFromFirebase(); // Recarga el stock actualizado
                renderProducts();

            } catch (error) {
                // ERROR: Alguna transacci칩n fall칩 (probablemente por stock insuficiente)
                alert(`Error al procesar el pedido y descontar stock: ${error.message}. Por favor, revisa el carrito.`);
                console.error("Error fatal en el checkout:", error);
            } finally {
                // Vuelve a habilitar el bot칩n
                document.getElementById('checkout-button').textContent = 'Finalizar Pedido por WhatsApp';
                document.getElementById('checkout-button').disabled = false;
            }
        }

        function updateCartUI() {
            const itemsContainer = document.getElementById('cart-items');
            const totalSpan = document.getElementById('cart-total');
            const countSpan = document.getElementById('cart-count');
            const checkoutButton = document.getElementById('checkout-button');

            itemsContainer.innerHTML = '';
            let total = 0;
            let count = 0;

            cart.forEach((item, index) => {
                const subtotal = item.price * item.quantity;
                total += subtotal;
                count += item.quantity;
                const colorStr = item.color ? ` (${item.color})` : '';

                const itemHtml = `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>${item.quantity}x ${item.name} (Talla ${item.size}${colorStr})</span>
                        <div>
                            <strong>$${subtotal.toFixed(2)}</strong>
                            <button class="btn btn-sm btn-danger ms-2" onclick="removeItemFromCart(${index})">X</button>
                        </div>
                    </div>
                `;
                itemsContainer.innerHTML += itemHtml;
            });

            totalSpan.textContent = `$${total.toFixed(2)}`;
            countSpan.textContent = count;
            checkoutButton.disabled = cart.length === 0;
        }

        function removeItemFromCart(index) {
             const item = cart[index];
             
             // 1. DEVOLVER EL STOCK AL INVENTARIO LOCAL
             const key = item.key;
             const quantity = item.quantity;
             
             // 游뚿 Se asume que el stock original est치 en Firebase, pero localmente lo revertimos para la UI
             const product = productData.find(p => p.id === item.id);
             
             if (product.isColorProduct) {
                 product.stockByColor[item.color][item.size] += quantity;
            } else {
                productInventory[key] += quantity;
            }
             
            // 2. ELIMINAR DEL CARRITO
            cart.splice(index, 1);
            saveOrdersStorage();
            updateCartUI();
            
            // 3. Volver a renderizar productos para mostrar el stock devuelto
            renderProducts();
        }


        // =======================================================
        // MANEJO DE ALMACENAMIENTO LOCAL (Carrito)
        // =======================================================
        function saveOrdersStorage() {
            localStorage.setItem('rplayCart', JSON.stringify(cart));
        }

        function loadOrdersStorage() {
            const savedCart = localStorage.getItem('rplayCart');
            if (savedCart) {
                cart = JSON.parse(savedCart);
            }
        }

        // =======================================================
        // INICIALIZACI칍N
        // =======================================================
        document.addEventListener('DOMContentLoaded', async () => {
            
            loadOrdersStorage();
            
            // 游뚿 Cargar productos desde Firebase (con backup local si falla)
            await loadInventoryFromFirebase(); 

            renderProducts();
            updateCartUI();
        });
    </script>
</body>
</html>
