<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda RPLAY</title>
    <style>
        /* Estilos b치sicos para que el c칩digo funcione visualmente */
        body { font-family: sans-serif; margin: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #products-container { display: flex; flex-wrap: wrap; gap: 20px; }
        .product-card { border: 1px solid #ccc; padding: 15px; width: 300px; }
        .product-card img { max-width: 100%; height: auto; }
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 1000px; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
        .cart-item { border-bottom: 1px dashed #eee; padding: 10px 0; }
        .stock-option { margin-right: 10px; padding: 5px 10px; border: 1px solid #ccc; cursor: pointer; }
        .stock-option.active { background-color: #007bff; color: white; }
        
        /* Estilos para el modal del producto */
        #modal-product-view { display: flex; gap: 20px; }
        #modal-images { flex: 1; display: flex; flex-direction: column; gap: 10px;}
        #modal-images img { max-width: 100%; height: auto; border: 1px solid #eee;}
        #modal-details { flex: 1;}
        .image-toggle-buttons button { margin-right: 5px; padding: 8px; cursor: pointer;}
        #color-buttons button { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #ccc; margin: 5px; cursor: pointer;}
        .size-chart table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        .size-chart th, .size-chart td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    </style>
</head>
<body>

    <header>
        <h1>Tienda RPLAY</h1>
        <button onclick="window.toggleCartModal()">游 Carrito (<span id="cart-count">0</span>)</button>
    </header>

    <main id="products-container">
        <h2>Cargando inventario desde Realtime Database...</h2>
    </main>
    
    <div id="cart-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="window.toggleCartModal()">&times;</span>
            <h3>Tu Carrito</h3>
            <div id="cart-items">
                </div>
            <p>Total: $<span id="cart-total">0.00</span></p>
            <button onclick="window.sendOrderToWhatsapp()">Finalizar Compra por WhatsApp</button>
            <button onclick="window.clearCart()">Vaciar Carrito</button>
        </div>
    </div>

    <div id="product-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="window.closeProductModal()">&times;</span>
            <div id="modal-product-view">
                <div id="modal-images">
                    <img id="main-product-image" src="" alt="Producto">
                    <div class="image-toggle-buttons">
                        <button onclick="window.changeModalImage('front')">Frente</button>
                        <button onclick="window.changeModalImage('back')">Espalda</button>
                    </div>
                    <div class="size-chart" id="size-chart-container">
                        </div>
                </div>

                <div id="modal-details">
                    <div id="modal-content-details">
                        </div>

                    <div id="product-options">
                        </div>

                    <label for="quantity">Cantidad:</label>
                    <input type="number" id="quantity" value="1" min="1" max="100" style="width: 60px; margin-bottom: 20px;"> 

                    <button id="add-to-cart-button" onclick="" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; cursor: pointer;">A침adir al Carrito</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // 游뚿 CONFIGURACI칍N DE FIREBASE (TU PROYECTO RPLAY)
        const firebaseConfig = {
            apiKey: "AIzaSyCtgsjjbNIS0lv5aLD8nkpN_9-4sXIJVE", 
            authDomain: "rplay-f04dc.firebaseapp.com",
            databaseURL: "https://rplay-f04dc-default-rtdb.firebaseio.com", 
            projectId: "rplay-f04dc",
            storageBucket: "rplay-f04dc.appspot.com",
            messagingSenderId: "787828282738",
            appId: "1:787828282738:web:00c1ff1a7008c0e02b79eb",
            measurementId: "G-XEKR4KEDMR"
        };
        
        // 游뚿 IMPORTAR LIBRER칈AS DE FIREBASE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
        import { getDatabase, ref, get, runTransaction } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";

        // Inicializar Firebase y Realtime Database
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // =================================================================================
        // FUNCI칍N PRINCIPAL PARA CARGAR PRODUCTOS DESDE REALTIME DATABASE
        // =================================================================================

        window.inventory = []; // El inventario se almacena globalmente
        window.currentProductInModal = null; // Para rastrear el producto actual

        window.loadProductsFromFirebase = async function() {
            try {
                console.log("Cargando inventario desde Realtime Database...");
                const snapshot = await get(ref(db, 'products'));
                
                if (snapshot.exists()) {
                    const productsObject = snapshot.val();
                    window.inventory = Object.values(productsObject); 
                    
                    console.log(`Inventario cargado: ${window.inventory.length} productos.`);
                    window.renderProducts(); // Llama a la funci칩n de renderizado
                } else {
                    console.log("No hay productos en la base de datos.");
                    document.getElementById('products-container').innerHTML = '<h2>춰Inventario vac칤o! Contacta al administrador.</h2>';
                }
            } catch (e) {
                console.error("Error al cargar productos desde Firebase:", e);
                document.getElementById('products-container').innerHTML = '<h2>Error al cargar inventario. Revisa la Consola y las Reglas de RTDB.</h2>';
            }
        }
        
        // Ejecutar la carga al iniciar
        window.addEventListener('load', window.loadProductsFromFirebase);


        // =================================================================================
        // FUNCI칍N PARA ACTUALIZAR STOCK TRAS LA COMPRA (ADAPTADA A REALTIME DB)
        // =================================================================================

        window.sendOrderToWhatsapp = async function() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            if (cart.length === 0) {
                alert("Tu carrito est치 vac칤o.");
                return;
            }

            try {
                let whatsappMessage = "춰Hola! Quisiera hacer un pedido:\n\n";
                const transactionPromises = [];

                for (const item of cart) {
                    whatsappMessage += `- ${item.name} (${item.isColorProduct ? item.color : '칔nico'}) - Talla ${item.size} x ${item.quantity} unidades\n`;
                    
                    const productPath = `products/${item.id}`;

                    // Usar runTransaction para garantizar que el descuento sea at칩mico (seguro)
                    const transactionPromise = runTransaction(ref(db, productPath), (currentProduct) => {
                        if (currentProduct) {
                            let newStock = 0;
                            if (item.isColorProduct) {
                                const currentStock = currentProduct.stockByColor?.[item.color]?.[item.size] || 0;
                                newStock = currentStock - item.quantity;
                                
                                if (newStock >= 0) {
                                    if (!currentProduct.stockByColor) currentProduct.stockByColor = {};
                                    if (!currentProduct.stockByColor[item.color]) currentProduct.stockByColor[item.color] = {};
                                    currentProduct.stockByColor[item.color][item.size] = newStock;
                                } else {
                                    return; // Stock insuficiente
                                }
                            } else {
                                const currentStock = currentProduct.stock?.[item.size] || 0;
                                newStock = currentStock - item.quantity;
                                
                                if (newStock >= 0) {
                                    if (!currentProduct.stock) currentProduct.stock = {};
                                    currentProduct.stock[item.size] = newStock;
                                } else {
                                    return; // Stock insuficiente
                                }
                            }
                            return currentProduct; // Retorna el nuevo estado para guardar
                        }
                        return currentProduct; // No hacer cambios
                    });
                    
                    transactionPromises.push(transactionPromise);
                }

                await Promise.all(transactionPromises);

                whatsappMessage += `\nTotal a pagar: $${document.getElementById('cart-total').textContent}`;
                // 游뚿 Reemplaza "TUNUMEROAQUI" con tu n칰mero de WhatsApp
                const whatsappNumber = "TUNUMEROAQUI"; 
                const encodedMessage = encodeURIComponent(whatsappMessage);
                window.open(`https://wa.me/${whatsappNumber}?text=${encodedMessage}`, '_blank');

                window.clearCart(); // Limpia el carrito
                alert("Pedido realizado y stock actualizado en la nube. 춰Revisa WhatsApp!");
                window.loadProductsFromFirebase(); // Recargar inventario

            } catch (error) {
                console.error("Error al finalizar la compra y actualizar stock:", error);
                alert("Hubo un error al procesar el pedido. Por favor, int칠ntalo de nuevo.");
            }
        }
        
    </script>


    <script>
        // Funciones auxiliares
        function saveCart(cart) {
            localStorage.setItem('cart', JSON.stringify(cart));
            window.updateCartDisplay();
        }

        window.clearCart = function() {
            saveCart([]);
        }

        function calculateTotal(cart) {
            return cart.reduce((total, item) => total + (item.price * item.quantity), 0).toFixed(2);
        }

        window.updateCartDisplay = function() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const cartCountElement = document.getElementById('cart-count');
            const cartItemsContainer = document.getElementById('cart-items');
            const cartTotalElement = document.getElementById('cart-total');

            cartCountElement.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartTotalElement.textContent = calculateTotal(cart);
            cartItemsContainer.innerHTML = '';

            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p>El carrito est치 vac칤o.</p>';
                return;
            }

            cart.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'cart-item';
                itemDiv.innerHTML = `
                    <p>
                        ${item.name} (${item.isColorProduct ? item.color : '칔nico'}) - Talla ${item.size}
                        x ${item.quantity} - $${(item.price * item.quantity).toFixed(2)}
                    </p>
                `;
                cartItemsContainer.appendChild(itemDiv);
            });
        }

        window.toggleCartModal = function() {
            const modal = document.getElementById('cart-modal');
            if (modal.style.display === "block") {
                modal.style.display = "none";
            } else {
                window.updateCartDisplay();
                modal.style.display = "block";
            }
        }
        
        window.closeProductModal = function() {
            document.getElementById('product-modal').style.display = "none";
        }


        // =================================================================================
        // FUNCI칍N PRINCIPAL DE RENDERIZADO DE PRODUCTOS (TARJETAS)
        // =================================================================================

        window.renderProducts = function() {
            const container = document.getElementById('products-container');
            container.innerHTML = ''; 

            if (!window.inventory || window.inventory.length === 0) {
                container.innerHTML = '<h2>No se encontraron productos disponibles.</h2>';
                return;
            }

            window.inventory.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';

                // Obtener el nombre base del archivo de Firebase
                const rawImageFile = product.frontFileBase || (product.isColorProduct ? product.colorMap[product.colors[0]].front : '');
                
                let imageFile = rawImageFile;

                // Aplicar la l칩gica de capitalizaci칩n espec칤fica
                if (rawImageFile && rawImageFile.toLowerCase() !== 'xime1') {
                    // Capitalizar la primera letra si no es 'xime1'
                    imageFile = rawImageFile.charAt(0).toUpperCase() + rawImageFile.slice(1);
                } 

                // RUTA RA칈Z Y EXTENSI칍N .png
                card.innerHTML = `
                    <h3>${product.name}</h3>
                    <img src="${imageFile}.png" alt="${product.name}" /> 
                    <p>${product.description}</p>
                    <p><strong>$${product.price.toFixed(2)}</strong></p>
                    <button onclick="window.showProductModal('${product.id}')">Ver / Pedir</button>
                `;
                container.appendChild(card);
            });
        }

        // =================================================================================
        // L칍GICA DE MODAL DE PRODUCTO (IMAGENES, COLORES Y TABLA)
        // =================================================================================

        function getFileName(product, view, color = null) {
            const rawFileName = product.isColorProduct && color
                ? product.colorMap[color][view]
                : product[`${view}FileBase`];

            if (!rawFileName) return null;

            let fileName = rawFileName;
            // Aplicar la l칩gica de capitalizaci칩n espec칤fica
            if (fileName && fileName.toLowerCase() !== 'xime1') {
                fileName = fileName.charAt(0).toUpperCase() + fileName.slice(1);
            } 
            return `${fileName}.png`; // Se mantiene .png y ruta ra칤z
        }

        window.changeModalImage = function(view) {
            const product = window.currentProductInModal;
            if (!product) return;

            const selectedColor = product.isColorProduct ? document.querySelector('#color-options .active').dataset.color : null;
            const fileName = getFileName(product, view, selectedColor);

            if (fileName) {
                document.getElementById('main-product-image').src = fileName;
            }
        }

        window.changeColorAndSize = function(product, newColor) {
            // Actualizar botones de color (quitar 'active' de todos y ponerlo en el nuevo)
            document.querySelectorAll('#color-options button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`button[data-color="${newColor}"]`).classList.add('active');

            // Actualizar imagen principal a la vista frontal del nuevo color
            const fileName = getFileName(product, 'front', newColor);
            document.getElementById('main-product-image').src = fileName;

            // Generar y actualizar opciones de talla y stock para el nuevo color
            const sizeOptionsContainer = document.getElementById('size-options');
            sizeOptionsContainer.innerHTML = generateSizeOptionsHTML(product, newColor);

            // Actualizar bot칩n de a침adir al carrito
            document.getElementById('add-to-cart-button').onclick = () => window.addToCart(product.id, newColor);
        }

        window.showProductModal = function(productId) {
            const product = window.inventory.find(p => p.id === productId);
            if (!product) return;
            window.currentProductInModal = product;

            const detailsHTML = `
                <h2>${product.name}</h2>
                <p>${product.description}</p>
                <p>Precio: <strong>$${product.price.toFixed(2)}</strong></p>
            `;
            document.getElementById('modal-content-details').innerHTML = detailsHTML;

            const optionsContainer = document.getElementById('product-options');
            optionsContainer.innerHTML = '';
            
            let initialColor = null;

            if (product.isColorProduct) {
                // 1. Mostrar botones de colores
                let colorButtonsHTML = '<p>Color:</p><div id="color-options">';
                initialColor = product.colors[0]; // Seleccionar el primer color por defecto
                
                product.colors.forEach(colorName => {
                    const colorCode = product.colorMap[colorName].hex;
                    const isActive = colorName === initialColor ? 'active' : '';
                    colorButtonsHTML += `
                        <button 
                            data-color="${colorName}" 
                            style="background-color: ${colorCode}; border-color: ${colorCode};"
                            class="${isActive}"
                            onclick="window.changeColorAndSize(window.currentProductInModal, '${colorName}')"
                            title="${colorName}"
                        ></button>
                    `;
                });
                colorButtonsHTML += '</div>';
                optionsContainer.innerHTML += colorButtonsHTML;

            } else {
                // Producto de color 칰nico
                optionsContainer.innerHTML += '<p>Color: 칔nico</p>';
                initialColor = null;
            }

            // 2. Contenedor de tallas
            optionsContainer.innerHTML += '<div id="size-options"></div>';


            // 3. Inicializar imagen principal y tallas
            if (product.isColorProduct) {
                // Para productos con color: inicializa imagen y tallas con el primer color.
                window.changeColorAndSize(product, initialColor);
            } else {
                // Para productos sin color: inicializa tallas y setea la imagen frontal por defecto.
                document.getElementById('size-options').innerHTML = generateSizeOptionsHTML(product, null);
                const fileName = getFileName(product, 'front', null);
                document.getElementById('main-product-image').src = fileName;

                // Actualizar bot칩n de a침adir al carrito
                document.getElementById('add-to-cart-button').onclick = () => window.addToCart(product.id, 'N/A');
            }
            
            // 4. Mostrar tabla de tallas
            if (product.sizeChartHTML) {
                document.getElementById('size-chart-container').innerHTML = `
                    <h4>Tabla de Tallas</h4>
                    ${product.sizeChartHTML}
                `;
            } else {
                 document.getElementById('size-chart-container').innerHTML = '';
            }
            

            document.getElementById('product-modal').style.display = "block";
        }


        function generateSizeOptionsHTML(product, selectedColor) {
            let stockMap = product.stock;
            let title = 'Tallas disponibles:';
            let activeColor = selectedColor || 'N/A';
            let productCodeForTitle = product.productCode || 'N/A';

            if (product.isColorProduct && selectedColor) {
                stockMap = product.stockByColor?.[selectedColor] || {};
                title = `Tallas disponibles para ${selectedColor}:`;
                productCodeForTitle = product.colorMap[selectedColor]?.productCode || product.productCode || 'N/A';
            }
            
            const sizes = Object.keys(stockMap).sort((a, b) => {
                // Ordenar tallas comunes (XS, S, M, L, XL, etc.) si es posible
                const order = ['XS', 'S', 'M', 'L', 'XL', 'XXL', '3XL', '4XL'];
                return order.indexOf(a) - order.indexOf(b);
            }).filter(size => stockMap[size] > 0);

            let html = `<p>C칩digo Producto: <strong>${productCodeForTitle}</strong></p>
                        <p>${title}</p>
                        <div id="size-buttons-container">`;

            if (sizes.length === 0) {
                html += '<p>No hay stock disponible para esta selecci칩n.</p>';
                return html + '</div>';
            }
            
            let firstSize = sizes[0];

            sizes.forEach(size => {
                const isActive = size === firstSize ? 'active' : '';
                html += `
                    <button class="stock-option ${isActive}" 
                            data-size="${size}"
                            onclick="window.selectSize('${size}')">
                        ${size} (${stockMap[size]})
                    </button>
                `;
            });
            
            html += `</div>
                     <input type="hidden" id="selected-size" value="${firstSize}">
                     <p style="margin-top: 10px;">Talla seleccionada: <strong id="display-size">${firstSize}</strong></p>`;
            
            return html;
        }

        window.selectSize = function(size) {
            document.getElementById('selected-size').value = size;
            document.getElementById('display-size').textContent = size;
            
            // Opcional: Actualizar el estado 'active' de los botones
            document.querySelectorAll('#size-buttons-container button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`button[data-size="${size}"]`).classList.add('active');
        }


        window.addToCart = function(productId, color) {
            const product = window.inventory.find(p => p.id === productId);
            if (!product) return;

            const quantity = parseInt(document.getElementById('quantity').value);
            const size = document.getElementById('selected-size')?.value;
            
            const finalColor = color === 'N/A' ? '칔nico' : color;
            
            if (!size || quantity <= 0) {
                alert("Por favor, selecciona una talla y una cantidad v치lida.");
                return;
            }

            let availableStock = 0;
            if (product.isColorProduct) {
                availableStock = product.stockByColor?.[finalColor]?.[size] || 0;
            } else {
                availableStock = product.stock?.[size] || 0;
            }

            if (quantity > availableStock) {
                alert(`Solo hay ${availableStock} unidades de la Talla ${size} disponibles.`);
                return;
            }

            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const cartItemId = `${productId}-${finalColor}-${size}`;

            const existingItemIndex = cart.findIndex(item => item.cartItemId === cartItemId);

            if (existingItemIndex > -1) {
                const newQuantity = cart[existingItemIndex].quantity + quantity;
                if (newQuantity > availableStock) {
                    alert(`No puedes agregar m치s. Stock m치ximo: ${availableStock}`);
                    return;
                }
                cart[existingItemIndex].quantity = newQuantity;
            } else {
                cart.push({
                    cartItemId: cartItemId,
                    id: productId,
                    name: product.name,
                    price: product.price,
                    size: size,
                    color: finalColor,
                    isColorProduct: product.isColorProduct,
                    quantity: quantity
                });
            }

            saveCart(cart);
            window.closeProductModal();
            alert(`춰${quantity} unidad(es) de ${product.name} (${finalColor}) a침adida(s) al carrito!`);
        }

        // Inicializar el carrito al cargar la p치gina
        window.addEventListener('load', window.updateCartDisplay);

    </script>
</body>
</html>
