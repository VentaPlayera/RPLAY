<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPLAY - Venta de Playeras</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .product-card {
            border: 1px solid #ddd;
            transition: transform 0.2s;
            margin-bottom: 20px;
        }
        .product-card:hover {
            transform: translateY(-5px);
        }
        .btn-buy {
            background-color: #ff3366;
            color: white;
            border: none;
        }
        .btn-buy:hover {
            background-color: #e6004b;
            color: white;
        }
        /* ESTO OCULTA EL BADGE DE STOCK EN LA TARJETA Y EN EL MODAL DE DETALLE */
        .stock-badge, #stockIndicator {
            display: none !important; 
        }
        .carousel-item img {
            max-height: 500px;
            object-fit: contain;
        }
        /* Estilo para el bot칩n de WhatsApp fijo */
        .whatsapp-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: #25d366;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 60px;
            font-size: 30px;
            z-index: 1000;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .whatsapp-button:hover {
            background-color: #128c7e;
        }
        .whatsapp-button i {
            display: inline-block;
            transform: translateY(10%);
        }
        /* Estilos para el carrusel de im치genes */
        .carousel-indicators [data-bs-target] {
            background-color: #ff3366;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            opacity: 0.5;
        }
        .carousel-indicators .active {
            opacity: 1;
        }
    </style>
</head>
<body>

    <a href="https://wa.me/529991480151" target="_blank" class="whatsapp-button" title="Haz tu pedido por WhatsApp">
        &#x2705; 
    </a>

    <header class="p-3 mb-4 bg-white shadow-sm">
        <div class="container d-flex justify-content-between align-items-center">
            <img src='https://ventaplayera.github.io/RPLAY/logo.png' style="max-width: 150px; height: auto;">
            <h1 class="h3 text-primary d-none d-md-block">RPLAY</h1>
            <button class="btn btn-outline-secondary" onclick="openOrdersModal()">
                Pedidos <span class="badge text-bg-primary" id="ordersCounter">0</span>
            </button>
        </div>
    </header>

    <main class="container">
        <div class="row" id="product-list">
            </div>

        </main>

    <div class="modal fade" id="productDetailModal" tabindex="-1" aria-labelledby="productDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productDetailModalLabel">Detalles del Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
                                <div class="carousel-indicators" id="carouselIndicators">
                                    </div>
                                <div class="carousel-inner" id="carouselInner">
                                    </div>
                                <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Previous</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Next</span>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h2 id="modalProductName" class="text-primary"></h2>
                            <p id="modalProductDescription" class="text-muted"></p>
                            
                            <h3 id="modalProductPrice" class="my-3 text-success"></h3>
                            
                            <form id="orderForm">
                                <input type="hidden" id="modalProductId" name="productId">

                                <div class="mb-3" id="colorSelectContainer" style="display:none;">
                                    <label for="colorSelect" class="form-label">Color:</label>
                                    <select class="form-select" id="colorSelect" name="color">
                                        </select>
                                </div>
                                <div class="mb-3">
                                    <label for="sizeSelect" class="form-label">Talla:</label>
                                    <select class="form-select" id="sizeSelect" name="size" required>
                                        </select>
                                </div>

                                <div class="mb-3">
                                    <label for="quantityInput" class="form-label">Cantidad:</label>
                                    <input type="number" class="form-control" id="quantityInput" name="quantity" value="1" min="1" required>
                                </div>

                                <div class="mb-3">
                                    <span id="stockIndicator" class="badge"></span>
                                </div>

                                <button type="submit" class="btn btn-buy w-100" id="addToOrderButton">A침adir al Pedido</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="ordersModal" tabindex="-1" aria-labelledby="ordersModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="ordersModalLabel">Mi Pedido</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="list-group mb-4" id="currentOrdersList">
                        <li class="list-group-item text-center text-muted" id="emptyOrdersMessage" style="display: none;">Tu pedido est치 vac칤o.</li>
                    </ul>

                    <h4 class="mb-3">Total a Pagar: <span id="ordersTotal" class="text-success">$0.00</span></h4>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" value="" id="halfPaymentCheck">
                        <label class="form-check-label" for="halfPaymentCheck">
                            Pagar el 50% de anticipo (<span id="halfPaymentAmount">$0.00</span>)
                        </label>
                    </div>

                    <hr>

                    <form id="clientDataForm" class="mt-4">
                        <h5 class="text-primary">Datos para Env칤o y Contacto</h5>
                        <div class="mb-3">
                            <label for="clientName" class="form-label">Nombre Completo:</label>
                            <input type="text" class="form-control" id="clientName" required>
                        </div>
                        <div class="mb-3">
                            <label for="clientAddress" class="form-label">Direcci칩n de Correo</label>
                            <textarea class="form-control" id="clientAddress" rows="2" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="clientPhone" class="form-label">Tel칠fono (WhatsApp):</label>
                            <input type="tel" class="form-control" id="clientPhone" required>
                        </div>
                    </form>

                    <div id="paymentDetailsSection" style="display: none;">
                        <hr>
                        <h5 class="text-primary">Datos de Transferencia Bancaria</h5>
                        <p class="mb-1"><strong>Banco:</strong>BBVA</p>
                        <p class="mb-1"><strong>N칰mero de Cuenta:</strong> 4152314029419622</p>
                        <p class="mb-1"><strong>Beneficiario:</strong> RPLAY</p>
                        
                        <p class="mt-3 text-muted">Una vez hecha la transferencia o dep칩sito, presiona "Enviar Pedido por WhatsApp" y adjunta tu comprobante.</p>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Seguir Comprando</button>
                    <button type="button" class="btn btn-buy" id="finalizeOrderButton" disabled onclick="sendOrderToWhatsapp()">
                        Enviar Pedido por WhatsApp
                    </button>
                </div>
            </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // =======================================================
        // DECLARACI칍N DE VARIABLES GLOBALES Y CONSTANTES
        // =======================================================
        const PRODUCT_PRICE = 250.00; 
        const MINIMUM_TO_SHIP = 1;   
        const WHATSAPP_NUMBER = '529991480151'; 
        
        // --- CONSTANTES DE IMAGEN ---
        const IMAGE_EXTENSION = '.png';
        const GENERIC_SIDE_IMAGE = 'https://i.imgur.com/uR1j9sW.png'; 
        const SIZE_CHART_FILE = 'tabla_medidas'; // Nombre del archivo de la tabla de medidas (e.g., tabla_medidas.png)
        
        // 游뚿 ENLACE CR칈TICO: DEBES VERIFICAR QUE ESTA URL ES TU RUTA REAL DE IM츼GENES EN GITHUB PAGES
        const GITHUB_BASE_URL = 'https://ventaplayera.github.io/RPLAY/';
        
        // Placeholder para la imagen lateral gen칠rica (se usar치 si no defines sideFile)
        const GENERIC_SIDE_PLACEHOLDER = 'generic_side_image_placeholder';

        let productData = []; 
        let productInventory = {}; 
        let currentOrder = []; 

        let orderIdCounter = 0;
        let PENDING_ORDERS = []; 

        // =======================================================
        // FUNCI칍N DE INVENTARIO INICIAL (CONFIGURACI칍N DE STOCK POR TALLA/COLOR)
        // =======================================================

        function generateInitialInventory() {
            productData.length = 0; 
            for (const key in productInventory) { delete productInventory[key]; }

            // --- STOCK BASE PARA MODELOS NO DEFINIDOS (M츼XIMO 2 TALLAS) ---
            const defaultStock = { 'M': 1, 'L': 1 }; 
            
            // 游뚿游뚿 LISTA DE MODELOS INTEGRADA BASADA EN TUS ARCHIVOS SUBIDOS (.png) 游뚿游뚿
            const initialProducts = [
                // Modelos sin opci칩n de color (Color Fijo)
                { i: 1, name: 'BTS', description: 'Playera Modelo 1', stock: { 'M': 1, 'L' :1, 'XL': 1}, frontFile: 'xime1', backFile: 'Xime2', sideFile: 'blanco' },
                { i: 2, name: 'BTS', description: 'Playera Modelo 2', stock: { 'M': 1, 'L' :1, 'XL': 1}, frontFile: 'Xime3', backFile: 'Xime4', sideFile: 'negro' },
                { i: 3, name: 'MICHAEL JACKSON', description: 'Playera Modelo 3', stock:{ 'S':1, 'M':1, 'L': 1 },  frontFile: 'Abi1', backFile: 'Abi2', sideFile: 'blanco' },
                { i: 4, name: 'MICHAEL JACKSON', description: 'Playera Modelo 4', stock: {'L': 1 }, frontFile: 'Abi3', backFile: 'Abi4', sideFile: 'negro' },
                { i: 5, name: 'ADO', description: 'Playera Modelo 5', stock: {'XL': 1 }, frontFile: 'Lucy1', backFile: 'Lucy2', sideFile: 'blanco' },
                { i: 6, name: 'ADO', description: 'Playera Modelo 6', stock: { 'M': 1, 'L': 1, 'XL':2 }, frontFile: 'Lucy3', backFile: 'Lucy4', sideFile: 'negro' },
                { i: 7, name: 'BRUNO MARS', description: 'Playera Modelo 7', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Raul1', backFile: 'Raul2', sideFile: 'negro' },
                { i: 8, name: 'BRUNO MARS', description: 'Playera Modelo 8', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Raul3', backFile: 'Raul4', sideFile: 'negro' },
                { i: 9, name: 'LATIN MAFIA', description: 'Playera Modelo 9', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Dani1', backFile: 'Dani2', sideFile: 'blanco' },
                { i: 10, name: 'LATIN MAFIA', description: 'Playera Modelo 10', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Dani3', backFile: 'Dani4', sideFile: 'negro' },
                { i: 11, name: 'AESPA', description: 'Playera Modelo 11', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Dali1', backFile: 'Dali2', sideFile: 'negro' },
                { i: 12, name: 'AESPA', description: 'Playera Modelo 12', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Dali3', backFile: 'Dali4', sideFile: 'negro' },
                { i: 13, name: 'BILLIE EILISH', description: 'Playera Modelo 13', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Yose1', backFile: 'Yose2', sideFile: 'negro' },
                { i: 14, name: 'BILLIE EILISH', description: 'Playera Modelo 14', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Yose3', backFile: 'Yose4', sideFile: 'negro' },
                { i: 15, name: 'LANA DEL REY', description: 'Playera Modelo 15', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Keila1', backFile: 'Keila2', sideFile: 'blanco' },
                { i: 16, name: 'LANA DEL REY', description: 'Playera Modelo 16', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Keila3', backFile: 'Keila4', sideFile: 'negro' },
                { i: 17, name: 'MY CHEMICAL ROMANCE', description: 'Playera Modelo 17', stock: { 'M': 1, 'L': 1, 'XL':1 },  frontFile: 'Kenji1', backFile: 'Kenji2', sideFile: 'negro' },
                { i: 18, name: 'MY CHEMICAL ROMANCE', description: 'Playera Modelo 18', stock: { 'M': 1, 'L': 1, 'XL':1 },  frontFile: 'Kenji3', backFile: 'Kenji4', sideFile: 'negro' },
                { i: 19, name: 'TWENTY ONE PILOTS', description: 'Playera Modelo 19', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Alli1', backFile: 'Alli2', sideFile: 'negro' },
                { i: 20, name: 'WENTY ONE PILOTS', description: 'Playera Modelo 20', stock: { 'M': 1, 'L': 1, 'XL':1 },frontFile: 'Alli3', backFile: 'Alli4', sideFile: 'negro' },
                { i: 21, name: 'SELENA QUINTANILLA', description: 'Playera Modelo 21', stock: { 'XL':1 }, frontFile: 'Ale1', backFile: 'Ale2', sideFile: 'arena' },
                { i: 22, name: 'OLIVIA RODRIGO', description: 'Playera Modelo 22', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Miri1', backFile: 'Miri2', sideFile: 'negro' },
                { i: 23, name: 'OLIVIA RODRIGO', description: 'Playera Modelo 23', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Miri3', backFile: 'Miri4', sideFile: 'negro' },
                { i: 24, name: 'BAD BUNNY', description: 'MPlayera Modelo 24', stock: { 'M': 1, 'XL':1 }, frontFile: 'Didi1', backFile: 'Didi2', sideFile: 'negro' },
                { i: 25, name: 'BAD BUNNY', description: 'Playera Modelo 25', stock: { 'L': 1, 'XL':1 }, frontFile: 'Didi3', backFile: 'Didi4', sideFile: 'arena' },
                { i: 26, name: 'Taylor SWIFT', description: 'Playera Modelo 26', stock:{ 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Vale1', backFile: 'Vale2', sideFile: 'arena' },
                { i: 27, name: 'TAYLOR SWIFT', description: 'Playera Modelo 27', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Vale3', backFile: 'Vale4', sideFile: 'negro' },
                { i: 28, name: 'HUMBE', description: 'Playera Modelo 28', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Caro1', backFile: 'Caro2', sideFile: 'arena' },
                { i: 29, name: 'HUMBE', description: 'Playera Modelo 29', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Caro3', backFile: 'Caro4', sideFile: 'arena' },
                { i: 30, name: 'KATY PERRY', description: 'Playera Modelo 30', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Gon1', backFile: 'Gon2', sideFile: 'negro' },
                { i: 31, name: 'KATY PERRY', description: 'Playera Modelo 31', stock: { 'M': 1, 'L': 1, 'XL':1 }, frontFile: 'Katy3', backFile: 'Katy4', sideFile: 'blanco' },
                { i: 32, name: 'TAYLOR SWIFT', description: 'Playera Modelo 32', stock: { 'S': 1, 'M ': 1, 'L':1 }, frontFile: 'Bere1', backFile: 'Bere2', sideFile: 'blanco2' },
                { i: 33, name: 'TAYLOR SWIFT', description: 'Playera Modelo 33', stock: { 'S': 1, 'M ': 1, 'L':1 },frontFile: 'Bere3', backFile: 'Bere4', sideFile: 'negro2' },
                { i: 34, name: 'BTS', description: 'Playera Modelo 34', stock: { 'S': 1, 'M ': 1, 'L':1 }, frontFile: 'Dan1', backFile: 'Dan2', sideFile: 'negro2' },
                { i: 35, name: 'BTS', description: 'Playera Modelo 35', stock: { 'S': 1, 'M ': 1, 'L':1 }, frontFile: 'Dan3', backFile: 'Dan4', sideFile: 'negro2' },
                { i: 36, name: 'NCT DREAM', description: 'Playera Modelo 36', stock: { 'S': 1, 'M ': 1, 'L':1 }, frontFile: 'Gera1', backFile: 'Gera2', sideFile: 'negra2' },
                { i: 37, name: 'NCT DREAM', description: 'Playera Modelo 37', stock: { 'S': 1, 'M ': 1, 'L':1 }, frontFile: 'Gera3', backFile: 'Gera4', sideFile: 'negro2' },
                { i: 38, name: 'HUNTRIX/SAJA BOYS', description: 'Playera Modelo 38', stock: { 'S': 1, 'M ': 1, 'L':1 }, frontFile: 'Bra1', backFile: 'Bra2', sideFile: 'negro2' },
                { i: 39, name: 'HUNTRIX/SAJA BOYS', description: 'Playera Modelo 39', stock: { 'S': 1, 'M ': 1, 'L':1 }, frontFile: 'Bra3', backFile: 'Bra4', sideFile: 'negro2' },
                { i: 40, name: 'HOZIER', description: 'Playera Modelo 40', stock:  { 'S': 1, 'M ': 1, 'L':1 }, frontFile: 'Adri1', backFile: 'Adri2', sideFile: 'negro2' },
                { i: 41, name: 'HOZIER', description: 'Playera Modelo 41', stock:  { 'S': 1, 'M ': 1, 'L':1 }, frontFile: 'Adri3', backFile: 'Adri4', sideFile: 'blanco2' }, 
               
                // --- MODELOS CON OPCI칍N DE COLOR (42 Y 43) ---
                { 
                    i: 42, 
                    name: 'BLACKPINK', 
                    description: 'Modelo 42 con opci칩n de color.', 
                    colors: ['Blanco', 'Negro'],
                    // ESTO MAPEA EL NOMBRE DEL COLOR (usado para stock) AL SUFIJO DEL ARCHIVO (usado para imagen)
                    colorSuffixMap: { 
                        'Blanco': 'blanco2',
                        'Negro': 'negro2',
                    },
                    inventoryByColor: { 
                        'Blanco': { 'S': 1, 'M': 1, 'L': 1 },
                        'Negro': { 'S': 1, 'M': 1, 'L': 1 },
                    },
                    frontFile: 'Aro1', 
                    backFile: 'Aro2',
                    sideFile: SIZE_CHART_FILE 
                },
                { 
                    i: 43, 
                    name: 'BLACKPINK', 
                    description: 'Modelo 43 con opci칩n de color.', 
                    colors: ['Blanco', 'Negro'],
                    // ESTO MAPEA EL NOMBRE DEL COLOR (usado para stock) AL SUFIJO DEL ARCHIVO (usado para imagen)
                    colorSuffixMap: { 
                        'Blanco': 'blanco2',
                        'Negro': 'negro2',
                    },
                    inventoryByColor: { 
                        'Blanco': { 'S': 1, 'M': 1, 'L': 1 },
                        'Negro': { 'S': 1, 'M': 1, 'L': 1 },
                    },
                    frontFile: 'Aro3', 
                    backFile: 'Aro4',
                    sideFile: SIZE_CHART_FILE 
                },
            ];

            // Rellenar hasta el modelo 43 con stock por defecto si no est치n definidos
            const MAX_MODELS = 43;
            const existingIndices = initialProducts.map(p => p.i);
            
            for (let i = 1; i <= MAX_MODELS; i++) {
                if (!existingIndices.includes(i)) {
                    initialProducts.push({
                        i: i,
                        name: `Playera Modelo No. ${i} (Faltan Im치genes)`,
                        description: `Dise침o exclusivo #${i}. 춰Modifica este texto!`,
                        stock: defaultStock,
                        frontFile: `xime${i}_frente_DEFAULT`, // Placeholder para recordar actualizar
                        backFile: `xime${i}_espalda_DEFAULT`,
                        sideFile: GENERIC_SIDE_PLACEHOLDER
                    });
                }
            }
            initialProducts.sort((a, b) => a.i - b.i);


            // --- L칍GICA DE PROCESAMIENTO ---
            initialProducts.forEach(prod => {
                const i = prod.i;
                const id = `PROD_${String(i).padStart(3, '0')}`;
                
                // ASIGNACI칍N DE NOMBRES DE ARCHIVO
                const frontFileBase = prod.frontFile || `xime${i}_frente_FALLBACK`;
                const backFileBase = prod.backFile || `xime${i}_espalda_FALLBACK`;
                const sideFileBase = prod.sideFile || GENERIC_SIDE_PLACEHOLDER; 
                
                let modelSizes = new Set(); // Usamos Set para evitar tallas duplicadas

                // 1. INVENTARIO PARA PRODUCTOS CON COLORES
                if (prod.colors && prod.colors.length > 0 && prod.inventoryByColor) {
                    prod.colors.forEach(color => {
                        const stockByColor = prod.inventoryByColor[color] || {};
                        for (const size in stockByColor) {
                            const stockAmount = stockByColor[size];
                            if (stockAmount > 0) {
                               // CLAVE DE INVENTARIO POR COLOR: ID_TALLA_COLOR
                               // Se limpia el nombre del color para la clave por si trae espacios (aunque no deber칤a)
                               const colorKey = color.replace(/\s/g, ''); 
                               productInventory[`${id}_${size}_${colorKey}`] = stockAmount; 
                               modelSizes.add(size);
                            }
                        }
                    });
                }
                // 2. INVENTARIO PARA PRODUCTOS SIN COLORES (L칩gica original)
                else {
                    const stock = prod.stock || {};
                    for (const size in stock) {
                        const stockAmount = stock[size];
                        if (stockAmount > 0) {
                           // CLAVE DE INVENTARIO SIN COLOR: ID_TALLA
                           productInventory[`${id}_${size}`] = stockAmount;
                           modelSizes.add(size);
                        }
                    }
                }

                // --- CREACI칍N DEL OBJETO PRODUCTO ---
                const product = {
                    id: id,
                    name: prod.name,
                    description: prod.description,
                    price: PRODUCT_PRICE,
                    sizes: Array.from(modelSizes), // Convierte el Set de tallas a Array
                    colors: prod.colors || [], 
                    colorSuffixMap: prod.colorSuffixMap || {}, 
                    
                    // Almacena solo la URL de la imagen de frente para la tarjeta
                    mainImg: `${GITHUB_BASE_URL}${frontFileBase}${IMAGE_EXTENSION}`,
                    
                    // Guarda las bases de los nombres de archivo (corregido para usarlo en el carrusel)
                    frontFileBase: frontFileBase,
                    backFileBase: backFileBase,
                    sideFileBase: sideFileBase,
                };

                productData.push(product);
            });
        }

        // =======================================================
        // FUNCI칍N DE ADMINISTRACI칍N OCULTA (SOLO COMANDOS)
        // =======================================================
        
        // Reporte de Stock para el Administrador (se llama desde la consola)
        window.showInventoryReport = function() {
            console.log("\n==============================================");
            console.log("     REPORTE DE INVENTARIO (ADMIN)");
            console.log("==============================================");
            
            let totalStock = 0;
            const report = [];

            productData.forEach(product => {
                const isColorProduct = product.colors && product.colors.length > 0;
                
                product.sizes.forEach(size => {
                    if (isColorProduct) {
                        product.colors.forEach(color => {
                            const colorKey = color.replace(/\s/g, ''); 
                            const key = `${product.id}_${size}_${colorKey}`;
                            const stock = productInventory[key] || 0;
                             if (stock > 0) {
                                report.push(`Modelo: ${product.name} (${color}) | Talla: ${size} | Stock: ${stock} unidades`);
                                totalStock += stock;
                            }
                        });
                    } else {
                        const key = `${product.id}_${size}`;
                        const stock = productInventory[key] || 0;
                        
                        if (stock > 0) {
                            report.push(`Modelo: ${product.name} | Talla: ${size} | Stock: ${stock} unidades`);
                            totalStock += stock;
                        }
                    }
                });
            });

            if (report.length > 0) {
                console.log(report.join('\n'));
                console.log("----------------------------------------------");
                console.log(`TOTAL DE ART칈CULOS EN STOCK: ${totalStock}`);
            } else {
                console.log("El inventario est치 vac칤o.");
            }
            console.log("==============================================");
            return "Inventario impreso en la consola.";
        }
        
        // Funci칩n de Reinicio para el Administrador (se llama desde la consola)
        window.resetInventoryAndOrders = function() {
            if (!confirm("ADVERTENCIA (ADMIN): 쮼st치s seguro de que quieres REINICIAR el inventario y todos los pedidos? Esto es SOLO para pruebas.")) return;
            
            // 1. Carga el inventario inicial con la nueva estructura de 2 tallas
            generateInitialInventory(); 
            // 2. Guarda ese nuevo inventario en la memoria local (storage)
            saveInventoryStorage();
            
            PENDING_ORDERS = [];
            orderIdCounter = 0;
            currentOrder = [];
            saveOrdersStorage();
            
            renderProductCards();
            
            const ordersModal = bootstrap.Modal.getInstance(document.getElementById('ordersModal'));
            if(ordersModal) ordersModal.hide();
            
            alert("Inventario y 칩rdenes reiniciados con 칠xito. 춰DEBES RECARGAR LA P츼GINA AHORA (F5) para asegurar una carga limpia!");
        }


        // =======================================================
        // FUNCIONES DE ALMACENAMIENTO (STORAGE)
        // =======================================================

        function saveInventoryStorage() {
            localStorage.setItem('productInventory', JSON.stringify(productInventory));
        }

        function loadInventoryStorage() {
            const storedInventory = localStorage.getItem('productInventory');
            if (storedInventory) {
                const loadedInventory = JSON.parse(storedInventory); 
                // La diferencia es que solo cargamos datos para las tallas que existen en el nuevo inventario base
                for (const key in loadedInventory) {
                    if (productInventory.hasOwnProperty(key)) {
                        productInventory[key] = loadedInventory[key];
                    }
                }
            }
        }
        
        function saveOrdersStorage() {
            localStorage.setItem('pendingOrders', JSON.stringify(PENDING_ORDERS));
            localStorage.setItem('orderIdCounter', orderIdCounter);
            document.getElementById('ordersCounter').textContent = currentOrder.length;
        }

        function loadOrdersStorage() {
            const storedOrders = localStorage.getItem('pendingOrders');
            if (storedOrders) {
                PENDING_ORDERS = JSON.parse(storedOrders);
            }
            const storedCounter = localStorage.getItem('orderIdCounter');
            if (storedCounter) {
                orderIdCounter = parseInt(storedCounter);
            }
        }

        // =======================================================
        // L칍GICA DE STOCKS
        // =======================================================

        function getStock(productId, size, color = null) { 
            let key;
            if (color) {
                // Usa el nombre del color (ej. 'Blanco') para la clave de inventario
                const colorKey = color.replace(/\s/g, ''); 
                key = `${productId}_${size}_${colorKey}`; 
            } else {
                key = `${productId}_${size}`; 
            }
            return productInventory[key] || 0; 
        }

        // =======================================================
        // RENDERIZACI칍N DE TARJETAS DE PRODUCTO
        // =======================================================

        function renderProductCards() {
            const list = document.getElementById('product-list');
            list.innerHTML = ''; 

            productData.forEach(product => {
                // C치lculo de stock m치ximo (ahora debe iterar sobre colores si existen)
                let maxStock = 0;
                
                if (product.colors.length > 0) {
                    product.colors.forEach(color => {
                        product.sizes.forEach(size => {
                            maxStock = Math.max(maxStock, getStock(product.id, size, color));
                        });
                    });
                } else {
                    maxStock = product.sizes.reduce((max, size) => Math.max(max, getStock(product.id, size)), 0);
                }

                const status = maxStock >= MINIMUM_TO_SHIP ? 'Disponible' : 'Agotado'; 
                const statusClass = maxStock >= MINIMUM_TO_SHIP ? 'bg-success' : 'bg-danger';

                const card = `
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card product-card h-100">
                            <span class="stock-badge ${statusClass} badge fs-6 p-2 rounded-0">${status}</span> 
                            <img src="${product.mainImg}" class="card-img-top p-2" alt="${product.name}">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">${product.name}</h5>
                                <p class="card-text text-success fw-bold">$${product.price.toFixed(2)}</p>
                                <button class="btn btn-buy mt-auto btn-block btn-lg" data-product-id="${product.id}" 
                                        ${maxStock === 0 ? 'disabled' : ''}>
                                    ${maxStock === 0 ? 'Agotado' : (product.colors.length > 0 ? 'Ver Colores / Pedir' : 'Ver / Pedir')}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                list.innerHTML += card;
            });
        }
        
        // =======================================================
        // L칍GICA DE MODAL DE DETALLE
        // =======================================================

        function openModalDetail(productId) {
            const product = productData.find(p => p.id === productId);
            if (!product) return;

            document.getElementById('modalProductId').value = productId;
            document.getElementById('modalProductName').textContent = product.name;
            document.getElementById('modalProductDescription').textContent = product.description;
            document.getElementById('modalProductPrice').textContent = `$${product.price.toFixed(2)}`;
            
            const colorContainer = document.getElementById('colorSelectContainer');
            const colorSelect = document.getElementById('colorSelect');
            const sizeSelect = document.getElementById('sizeSelect');
            
            let defaultColor = null;

            // 1. Manejar el Selector de Color
            if (product.colors && product.colors.length > 0) {
                colorContainer.style.display = 'block';
                colorSelect.innerHTML = '';
                product.colors.forEach(color => {
                    const option = document.createElement('option');
                    option.value = color;
                    option.textContent = color;
                    colorSelect.appendChild(option);
                });
                
                defaultColor = product.colors[0]; 
                
                colorSelect.onchange = () => {
                    const selectedColor = colorSelect.value;
                    // Al cambiar color, re-renderizar carrusel y actualizar stock/tallas
                    renderCarousel(product, selectedColor);
                    updateSizesAndStock(product, selectedColor); // Llamar a la funci칩n para actualizar tallas
                };

            } else {
                colorContainer.style.display = 'none';
                colorSelect.innerHTML = '';
            }
            
            // 2. Renderizar Carrusel con el color inicial o est치ndar
            renderCarousel(product, defaultColor);


            // 3. Renderizar Tallas y Stock
            updateSizesAndStock(product, defaultColor);
            
            document.getElementById('quantityInput').value = 1;

            const modal = new bootstrap.Modal(document.getElementById('productDetailModal'));
            modal.show();
            
            sizeSelect.onchange = updateTotalAndCheckStock;
            document.getElementById('quantityInput').onchange = updateTotalAndCheckStock;
        }

        // FUNCI칍N CLAVE PARA ACTUALIZAR TALLAS DISPONIBLES EN EL SELECT SEG칔N EL COLOR
        function updateSizesAndStock(product, color = null) {
            const sizeSelect = document.getElementById('sizeSelect');
            sizeSelect.innerHTML = '';
            let firstAvailableSize = null;

            // Recorrer todas las tallas que el producto tiene definidas en general
            product.sizes.forEach(size => {
                // Usar getStock con color (si existe) para comprobar si hay stock
                const stock = getStock(product.id, size, color); 
                
                if (stock > 0) {
                    const option = document.createElement('option');
                    option.value = size;
                    option.textContent = `${size}`; 
                    sizeSelect.appendChild(option);

                    if (!firstAvailableSize) {
                        firstAvailableSize = size;
                    }
                }
            });
            
            // Si hay tallas disponibles, selecciona la primera. Si no hay, la lista estar치 vac칤a.
            if (firstAvailableSize) {
                sizeSelect.value = firstAvailableSize;
            }
            
            updateTotalAndCheckStock(); 
        }
        
        // FUNCI칍N CLAVE PARA RENDERIZAR IM츼GENES
        function renderCarousel(product, color = null) {
            const indicators = document.getElementById('carouselIndicators');
            const inner = document.getElementById('carouselInner');
            indicators.innerHTML = '';
            inner.innerHTML = '';
            
            const isColorProduct = product.colors && product.colors.length > 0;
            
            let fileSuffix = '';
            let imageSuffix = '';

            // 1. Determinar el sufijo para productos con color (si aplica)
            if (color && isColorProduct) {
                // Obtiene el sufijo del archivo (ej: 'negro2')
                fileSuffix = product.colorSuffixMap[color]; 
                // Crea el sufijo completo (ej: '_negro2')
                imageSuffix = fileSuffix ? `_${fileSuffix.toLowerCase()}` : ''; 
            }

            let imageVariants = [];
            
            if (isColorProduct) {
                // Para productos con color (42, 43): 
                // 1. Frente (con sufijo de color), 
                // 2. Espalda (con sufijo de color), 
                // 3. Tabla de Tallas (CON sufijo de color).
                imageVariants = [
                    { fileBase: product.frontFileBase, alt: `Frente ${color ? `(${color})` : ''}`, suffix: imageSuffix, isPlaceholder: false }, 
                    { fileBase: product.backFileBase, alt: `Espalda ${color ? `(${color})` : ''}`, suffix: imageSuffix, isPlaceholder: false },
                    { fileBase: SIZE_CHART_FILE, alt: 'Tabla de Tallas', suffix: imageSuffix, isPlaceholder: false } // AHORA USA imageSuffix (TABLA DIN츼MICA)
                ];
            } else {
                 // Para productos simples (1-41): Frente, Espalda, Lateral/Color. Todos est치ticos.
                 imageVariants = [
                    { fileBase: product.frontFileBase, alt: 'Frente', suffix: '', isPlaceholder: false }, 
                    { fileBase: product.backFileBase, alt: 'Espalda', suffix: '', isPlaceholder: false },
                    { fileBase: product.sideFileBase, alt: 'Muestra de Color', suffix: '', isPlaceholder: product.sideFileBase === GENERIC_SIDE_PLACEHOLDER } 
                ];
            }


            let index = 0;
            
            imageVariants.forEach((item) => {
                let imgUrl;
                
                if (item.isPlaceholder) {
                    // Si el archivo lateral es el placeholder gen칠rico, usa la URL fija
                    imgUrl = GENERIC_SIDE_IMAGE; 
                } else {
                    // Construye la URL: BASE + NombreBase + Sufijo(si existe, ej: _negro2) + Extensi칩n
                    imgUrl = `${GITHUB_BASE_URL}${item.fileBase}${item.suffix}${IMAGE_EXTENSION}`;
                }


                indicators.innerHTML += `
                    <button type="button" data-bs-target="#productCarousel" data-bs-slide-to="${index}" 
                        class="${index === 0 ? 'active' : ''}" aria-current="${index === 0 ? 'true' : 'false'}" 
                        aria-label="Slide ${index + 1}">
                    </button>
                `;
                
                inner.innerHTML += `
                    <div class="carousel-item ${index === 0 ? 'active' : ''}">
                        <img src="${imgUrl}" class="d-block w-100" alt="${item.alt}">
                    </div>
                `;
                index++;
            });
        }

        function updateTotalAndCheckStock() {
            const productId = document.getElementById('modalProductId').value;
            const size = document.getElementById('sizeSelect').value;
            const quantityInput = document.getElementById('quantityInput');
            let quantity = parseInt(quantityInput.value);
            
            // Obtener el color seleccionado
            const colorSelect = document.getElementById('colorSelect');
            // Obtiene el color solo si el selector es visible
            const color = colorSelect.style.display !== 'none' ? colorSelect.value : null;

            // Usar el color en getStock para verificar el stock exacto
            const stock = getStock(productId, size, color); 

            const stockIndicator = document.getElementById('stockIndicator');
            const addToOrderButton = document.getElementById('addToOrderButton');

            // 1. Validar la cantidad
            if (quantity > stock) {
                quantity = stock; 
                quantityInput.value = quantity;
                stockIndicator.textContent = `Solo quedan ${stock} unidades en esta talla y color.`;
                stockIndicator.className = 'badge text-bg-warning';
            } else if (stock === 0) {
                stockIndicator.textContent = 'Agotado en esta talla y color.';
                stockIndicator.className = 'badge text-bg-danger';
                addToOrderButton.disabled = true;
            } else {
                stockIndicator.textContent = `${stock} unidades disponibles`;
                stockIndicator.className = 'badge text-bg-info';
            }

            // 2. Controlar la habilitaci칩n del bot칩n
            if (quantity > 0 && quantity <= stock) {
                addToOrderButton.disabled = false;
            } else {
                addToOrderButton.disabled = true;
            }
        }
        
        // =======================================================
        // L칍GICA DE PEDIDOS (칍RDENES)
        // =======================================================

        document.getElementById('orderForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productId = document.getElementById('modalProductId').value;
            const product = productData.find(p => p.id === productId);
            const size = document.getElementById('sizeSelect').value;
            const quantity = parseInt(document.getElementById('quantityInput').value);
            
            // Obtener el color
            const colorSelect = document.getElementById('colorSelect');
            const color = colorSelect.style.display !== 'none' ? colorSelect.value : null;
            
            const stockKey = color ? `${productId}_${size}_${color.replace(/\s/g, '')}` : `${productId}_${size}`;
            
            if (quantity > 0 && productInventory[stockKey] >= quantity) {
                
                // 1. Reducir stock en la memoria (inventory)
                productInventory[stockKey] -= quantity;
                saveInventoryStorage();
                
                // 2. A침adir a la orden actual
                currentOrder.push({
                    productId: productId,
                    name: product.name,
                    price: product.price,
                    size: size,
                    color: color,
                    quantity: quantity,
                    subtotal: product.price * quantity,
                });

                document.getElementById('ordersCounter').textContent = currentOrder.length;
                
                // 3. Cerrar modal y mostrar confirmaci칩n
                const modal = bootstrap.Modal.getInstance(document.getElementById('productDetailModal'));
                if(modal) modal.hide();
                
                alert(`A침adido al pedido: ${quantity} x ${product.name} (Talla: ${size}${color ? ', Color: ' + color : ''})`);
                
                // 4. Rerenderizar tarjetas para actualizar stock visual (opcional si ocultas stock)
                renderProductCards();
                
            } else {
                alert('Error: La cantidad solicitada no est치 disponible o es inv치lida.');
            }
        });

        function openOrdersModal() {
            const list = document.getElementById('currentOrdersList');
            const totalDisplay = document.getElementById('ordersTotal');
            const emptyMessage = document.getElementById('emptyOrdersMessage');
            const finalizeButton = document.getElementById('finalizeOrderButton');
            const halfPaymentCheck = document.getElementById('halfPaymentCheck');
            const halfPaymentAmountSpan = document.getElementById('halfPaymentAmount');
            const paymentDetailsSection = document.getElementById('paymentDetailsSection');
            
            list.innerHTML = '';
            let total = 0;
            
            if (currentOrder.length === 0) {
                emptyMessage.style.display = 'block';
                finalizeButton.disabled = true;
                halfPaymentCheck.disabled = true;
                paymentDetailsSection.style.display = 'none';
            } else {
                emptyMessage.style.display = 'none';
                finalizeButton.disabled = false;
                halfPaymentCheck.disabled = false;
                paymentDetailsSection.style.display = halfPaymentCheck.checked ? 'block' : 'none';

                currentOrder.forEach((item, index) => {
                    total += item.subtotal;
                    
                    const colorText = item.color ? ` - ${item.color}` : '';
                    
                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    listItem.innerHTML = `
                        <div>
                            ${item.quantity} x ${item.name} <span class="badge text-bg-secondary">${item.size}${colorText}</span>
                        </div>
                        <div class="text-end">
                            <span class="text-muted small">$${item.price.toFixed(2)} c/u</span>
                            <span class="text-success ms-2 fw-bold">$${item.subtotal.toFixed(2)}</span>
                            <button class="btn btn-sm btn-outline-danger ms-2" onclick="removeItemFromOrder(${index})">
                                &times;
                            </button>
                        </div>
                    `;
                    list.appendChild(listItem);
                });
            }

            totalDisplay.textContent = `$${total.toFixed(2)}`;
            
            const halfPayment = total / 2;
            halfPaymentAmountSpan.textContent = `$${halfPayment.toFixed(2)}`;

            halfPaymentCheck.onchange = () => {
                const finalTotal = halfPaymentCheck.checked ? halfPayment : total;
                totalDisplay.textContent = `$${finalTotal.toFixed(2)}`;
                paymentDetailsSection.style.display = halfPaymentCheck.checked ? 'block' : 'none';
            };
            
            // Inicializar el total correcto basado en el estado del checkbox al abrir el modal
            halfPaymentCheck.dispatchEvent(new Event('change')); 

            const modal = new bootstrap.Modal(document.getElementById('ordersModal'));
            modal.show();
        }

        function removeItemFromOrder(index) {
            const item = currentOrder[index];
            
            // 1. Devolver stock al inventario
            const colorKey = item.color ? item.color.replace(/\s/g, '') : null;
            const stockKey = colorKey ? `${item.productId}_${item.size}_${colorKey}` : `${item.productId}_${item.size}`;
            
            productInventory[stockKey] = (productInventory[stockKey] || 0) + item.quantity;
            saveInventoryStorage();

            // 2. Eliminar de la orden actual
            currentOrder.splice(index, 1);
            document.getElementById('ordersCounter').textContent = currentOrder.length;

            // 3. Rerenderizar modal y tarjetas
            renderProductCards();
            openOrdersModal(); 
        }

        function sendOrderToWhatsapp() {
            const clientName = document.getElementById('clientName').value;
            const clientAddress = document.getElementById('clientAddress').value;
            const clientPhone = document.getElementById('clientPhone').value;
            const halfPaymentChecked = document.getElementById('halfPaymentCheck').checked;
            const ordersTotal = document.getElementById('ordersTotal').textContent;

            if (!clientName || !clientAddress || !clientPhone) {
                alert('Por favor, completa todos los campos de datos de contacto y env칤o.');
                return;
            }

            if (currentOrder.length === 0) {
                alert('Tu pedido est치 vac칤o.');
                return;
            }

            // 1. Generar ID y almacenar la orden
            orderIdCounter++;
            const newOrder = {
                id: `ORD-${orderIdCounter}`,
                client: { name: clientName, address: clientAddress, phone: clientPhone },
                items: currentOrder,
                total: ordersTotal,
                paymentType: halfPaymentChecked ? '50% Anticipo' : '100% Total',
                date: new Date().toISOString(),
            };
            PENDING_ORDERS.push(newOrder);
            saveOrdersStorage();
            
            // 2. Generar mensaje de WhatsApp
            let message = `*춰NUEVO PEDIDO DE RPLAY!* %0A`;
            message += `*ID de Pedido:* ${newOrder.id}%0A`;
            message += `*Cliente:* ${clientName}%0A`;
            message += `*Tel칠fono:* ${clientPhone}%0A`;
            message += `*Direcci칩n de Correo:* ${clientAddress}%0A%0A`;
            message += `*Detalle del Pedido:*%0A`;
            
            currentOrder.forEach((item, index) => {
                const colorText = item.color ? ` (${item.color})` : '';
                message += `${index + 1}. ${item.quantity}x ${item.name} - Talla ${item.size}${colorText} ($${item.subtotal.toFixed(2)})%0A`;
            });

            message += `%0A*TOTAL A PAGAR:* ${ordersTotal}%0A`;
            message += `*M칠todo de Pago:* ${newOrder.paymentType}%0A%0A`;
            
            if (halfPaymentChecked) {
                message += `*Instrucciones:* Se requiere adjuntar el comprobante de pago del anticipo o total.`;
            } else {
                message += `*Instrucciones:* Se requiere adjuntar el comprobante de pago del total.`;
            }

            const whatsappURL = `https://wa.me/${WHATSAPP_NUMBER}?text=${message}`;

            // 3. Limpiar la orden actual
            currentOrder.length = 0; 
            document.getElementById('ordersCounter').textContent = 0;
            document.getElementById('clientDataForm').reset();
            
            // 4. Cerrar el modal y redirigir
            const ordersModal = bootstrap.Modal.getInstance(document.getElementById('ordersModal'));
            ordersModal.hide();

            // 5. Rerenderizar las tarjetas 
            renderProductCards();
            
            window.open(whatsappURL, '_blank');
        }

        // =======================================================
        // INICIALIZACI칍N
        // =======================================================

        document.addEventListener('DOMContentLoaded', () => {
            
            loadOrdersStorage();
            
            generateInitialInventory();
            loadInventoryStorage(); 

            document.getElementById('product-list').addEventListener('click', (e) => {
                const target = e.target.closest('.btn-buy');
                if (target && !target.disabled) {
                    const productId = target.getAttribute('data-product-id');
                    openModalDetail(productId); 
                }
            });
            
            const quantityInput = document.getElementById('quantityInput');
            if (quantityInput) {
                quantityInput.addEventListener('change', updateTotalAndCheckStock);
                quantityInput.addEventListener('input', updateTotalAndCheckStock);
            }
            
            renderProductCards();
        });

    </script>
</body>
</html>
